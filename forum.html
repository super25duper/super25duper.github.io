<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>פורום מאובטח</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- firebase.initializeApp + const db -->
  <script src="firebaseConfig.js"></script>
</head>
<body>

<h1>פורום</h1>
<div id="posts">טוען...</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /* ===============================
     1️⃣ חובה: משתמש מחובר ב-Auth
     =============================== */
  firebase.auth().onAuthStateChanged(function (user) {

    if (!user) {
      // אין Auth → חסימה
      window.location.replace("forbidden.html");
      return;
    }

    const uid = user.uid;

    /* ===============================
       2️⃣ קבלת token מהאפליקציה
       =============================== */
    let token = "";

    function waitForToken() {
      try {
        token = window.AppInventor.getWebViewString();
      } catch (e) {
        token = "";
      }

      if (!token || token === "null" || token === "0") {
        setTimeout(waitForToken, 300);
        return;
      }

      validateToken(uid, token);
    }

    waitForToken();
  });

  /* ===============================
     3️⃣ אימות token מול session
     =============================== */
  function validateToken(uid, token) {
    firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then(function (snap) {

        if (!snap.exists() || snap.val() !== token) {
          // token לא תואם → חסימה
          window.location.replace("forbidden.html");
          return;
        }

        // Auth + token תקינים
        loadPosts();
      })
      .catch(function () {
        window.location.replace("forbidden.html");
      });
  }

  /* ===============================
     4️⃣ טעינת פוסטים
     =============================== */
  function loadPosts() {
    firebase.database()
      .ref("posts")
      .once("value")
      .then(function (snap) {

        let html = "";

        snap.forEach(function (pSnap) {
          const p = pSnap.val();
          html += `
            <div style="border:1px solid #ccc;padding:12px;margin:8px;">
              <h3>${p.title || ""}</h3>
              <p>${p.text || ""}</p>
              <small>מאת: ${p.author || ""}</small>
            </div>
          `;
        });

        if (!html) {
          html = "<p>אין עדיין פוסטים.</p>";
        }

        document.getElementById("posts").innerHTML = html;
      })
      .catch(function () {
        window.location.replace("forbidden.html");
      });
  }

});
</script>

</body>
</html>