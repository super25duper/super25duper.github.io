<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¤×•×¨×•× ×××•×‘×˜×—</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">

  <style>
    /* NOTE: ×œ×¤×™ ×”×‘×§×©×” ×©×œ×š â€“ ×‘×œ×™ ×”×”× ×¤×©×” ×”×”×™× */

    /* =====================================================================================
       Image support - minimal inlined safety styles (doesn't replace your css/forum.css)
       ===================================================================================== */
    .post-image-wrap {
      margin-top: 10px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.03);
    }
    .post-image {
      width: 100%;
      height: auto;
      display: block;
      max-height: 360px;
      object-fit: cover;
      background: #fff;
    }
    .image-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.03);
      font-size: 12px;
      opacity: 0.9;
      user-select: none;
    }
    .image-actions-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
    }
    .img-btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fff;
      cursor: pointer;
      font-weight: bold;
    }
    .img-btn-primary {
      border: none;
      background: rgb(17,17,87);
      color: #fff;
    }
    .img-btn-danger {
      border: 1px solid rgba(255,0,0,0.35);
      background: rgba(255,0,0,0.06);
      color: #8a0000;
    }
    .img-preview {
      width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      overflow: hidden;
      background: rgba(0,0,0,0.03);
    }
    .img-preview img {
      width: 100%;
      height: auto;
      display: block;
      max-height: 320px;
      object-fit: cover;
      background: #fff;
    }
    .progress-wrap {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,0.12);
      overflow: hidden;
      background: rgba(0,0,0,0.04);
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: rgb(17,17,87);
    }

    /* Fullscreen image viewer overlay (no animation) */
    #imageViewerOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.78);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      box-sizing: border-box;
      z-index: 10000;
    }
    #imageViewerInner {
      width: min(920px, 100%);
      background: rgba(255,255,255,0.96);
      border-radius: 16px;
      padding: 12px;
      box-sizing: border-box;
    }
    #imageViewerInner img {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 14px;
      background: #fff;
      border: 1px solid rgba(0,0,0,0.12);
      max-height: 78vh;
      object-fit: contain;
    }
    #imageViewerTop {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    #closeImageViewer {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      padding: 8px 10px;
      border-radius: 10px;
    }

    /* =====================================================================================
       ×©×™× ×•×™×™ ×¤×•×¨×•× â€“ ×¢×™×¦×•×‘ ×‘×œ×‘×“
       ===================================================================================== */

    /* Badge ×§×˜×Ÿ ×¢×‘×•×¨ ×¤×•×¡×˜ ×©×™×© ×œ×• ×ª××•× ×” (×‘×¦×‘×¢×™ ×”××ª×¨) */
    .has-image-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgb(17,17,87);
      color: #fff;
      font-size: 11px;
      font-weight: bold;
      line-height: 1.2;
      margin-right: 8px; /* RTL: ×™×•×¤×™×¢ ×œ×¤× ×™ ×”×˜×§×¡×˜ ×‘×¦×•×¨×” ×˜×‘×¢×™×ª */
      user-select: none;
      opacity: 0.95;
      border: 1px solid rgba(0,0,0,0.08);
    }

    /* ×©×•×¨×ª ××˜× ×ª×—×ª×•× ×” â€“ ×–××Ÿ ××™××™×Ÿ, ××•× ×” ×ª×’×•×‘×•×ª ××©×××œ */
    .post-bottom-meta-row {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      direction: ltr; /* ×œ×©××•×¨ ×™××™×Ÿ/×©×××œ ×™×¦×™×‘ */
    }
    .post-bottom-meta-row small {
      display: inline-block;
    }

    /* ××•× ×” ×ª×’×•×‘×•×ª */
    .post-comments-count {
      opacity: 0.85;
      font-size: 12px;
    }
    .post-comments-none {
      opacity: 0.7;
    }
  </style>
</head>

<body>

<header class="top-bar">
  <h1>×¤×•×¨×•× ×”×‘× ×™×™×“×™×!</h1>
</header>

<!-- Pull To Refresh indicator -->
<div id="pull-indicator" style="
  display:none;
  text-align:center;
  padding:6px;
  user-select:none;
">
  <div class="loader"></div>
</div>

<!-- ======= TOP ACTIONS (New Post + Search + Sort) ======= -->
<div id="top-actions" style="
  max-width:900px;
  margin:auto;
  padding: 10px 20px 0 20px;
  box-sizing:border-box;
">
  <div style="
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  ">
    <button id="openCreatePost" type="button" style="
      padding:10px 12px;
      border-radius:10px;
      border:none;
      background: rgb(17,17,87);
      color:#fff;
      cursor:pointer;
      font-weight:bold;
    ">â• ×¦×•×¨ ×¤×•×¡×˜</button>

    <input id="searchBox" type="search" placeholder="×—×™×¤×•×© ×‘×¤×•×¡×˜×™×..."
      style="
        flex:1;
        min-width:180px;
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(0,0,0,0.15);
        outline:none;
        box-sizing:border-box;
      "
    />

    <select id="sortMode" style="
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.15);
      outline:none;
      background:#fff;
      cursor:pointer;
    ">
      <option value="newest">××™×•×Ÿ: ×”×—×“×©×™× ×œ××¢×œ×”</option>
      <option value="oldest">××™×•×Ÿ: ×”×™×©× ×™× ×œ××¢×œ×”</option>
      <option value="author">××™×•×Ÿ: ×œ×¤×™ ××—×‘×¨</option>
      <option value="title">××™×•×Ÿ: ×œ×¤×™ ×›×•×ª×¨×ª</option>
      <option value="lastComment">××™×•×Ÿ: ×ª×’×•×‘×” ××—×¨×•× ×”</option>
    </select>
  </div>

  <div id="statusBar" style="
    margin-top:10px;
    padding:8px 10px;
    border-radius:10px;
    background: rgba(0,0,0,0.04);
    color:#111;
    font-size:13px;
    display:none;
  "></div>
</div>

<main class="forum-container">
  <div id="posts">
    <div class="loader"></div>
  </div>
</main>

<!-- ======= CREATE POST MODAL (UI ONLY, AUTH STILL REQUIRED) ======= -->
<div id="createPostOverlay" style="
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  box-sizing:border-box;
  z-index:9999;
">
  <div id="createPostModal" style="
    width:min(720px, 100%);
    background:#fff;
    border-radius:16px;
    padding:16px;
    box-sizing:border-box;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:bold; font-size:18px;">×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×©</div>
      <button id="closeCreatePost" type="button" style="
        border:none;
        background:transparent;
        font-size:18px;
        cursor:pointer;
      ">âœ•</button>
    </div>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <input id="newPostTitle" type="text" placeholder="×›×•×ª×¨×ª"
        maxlength="80"
        style="
          padding:12px;
          border-radius:12px;
          border:1px solid rgba(0,0,0,0.18);
          outline:none;
          box-sizing:border-box;
        "
      />

      <textarea id="newPostText" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜..."
        rows="6"
        maxlength="2000"
        style="
          padding:12px;
          border-radius:12px;
          border:1px solid rgba(0,0,0,0.18);
          outline:none;
          box-sizing:border-box;
          resize:vertical;
        "
      ></textarea>

      <!-- =====================================================================================
           IMAGE UPLOAD UI
           ===================================================================================== -->
      <div id="newPostImageBlock" style="
        border:1px solid rgba(0,0,0,0.10);
        border-radius:14px;
        padding:12px;
        background: rgba(0,0,0,0.02);
      ">
        <div class="image-actions-row">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <div style="font-weight:bold;">×ª××•× ×” ×œ×¤×•×¡×˜ (××•×¤×¦×™×•× ×œ×™)</div>
            <div id="newPostImageMeta" style="font-size:12px; opacity:.75;">
              ×¤×•×¨××˜×™× × ×ª××›×™×: JPG/PNG/WebP. ××•××œ×¥ ×¢×“ 9MB.
            </div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="chooseImageBtn" type="button" class="img-btn img-btn-primary">×‘×—×¨ ×ª××•× ×”</button>
            <button id="removeImageBtn" type="button" class="img-btn img-btn-danger" style="display:none;">×”×¡×¨ ×ª××•× ×”</button>
          </div>
        </div>

        <input id="newPostImage" type="file" accept="image/*" style="display:none;" />

        <div id="imagePreviewWrap" style="display:none; margin-top:12px;">
          <div class="img-preview">
            <img id="imagePreview" alt="×ª×¦×•×’×” ××§×“×™××”" src="" />
          </div>

          <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
            <span id="imageChip" class="image-chip" style="display:none;">ğŸ–¼ï¸ ×ª××•× ×” ××•×›× ×”</span>
            <span id="imageWarn" style="display:none; font-size:12px; color:#7a4b00; opacity:.95;"></span>
          </div>

          <div id="uploadProgressArea" style="display:none; margin-top:10px;">
            <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
              <span style="font-size:12px; opacity:.75;">××¢×œ×” ×ª××•× ×”â€¦</span>
              <span id="uploadProgressText" style="font-size:12px; opacity:.75;">0%</span>
            </div>
            <div class="progress-wrap" style="margin-top:6px;">
              <div id="uploadProgressBar" class="progress-bar"></div>
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div id="newPostHint" style="font-size:12px; color:#444;">
          ×˜×™×¤: ×ª×›×ª×•×‘ ×‘×¨×•×¨, ×•×ª×©××™×¨ ××§×•× ×œ×ª×’×•×‘×•×ª.
        </div>
        <div style="display:flex; gap:10px;">
          <button id="submitPost" type="button" style="
            padding:10px 14px;
            border-radius:12px;
            border:none;
            background: rgb(17,17,87);
            color:#fff;
            cursor:pointer;
            font-weight:bold;
          ">×¤×¨×¡×</button>
          <button id="cancelPost" type="button" style="
            padding:10px 14px;
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.18);
            background:#fff;
            cursor:pointer;
            font-weight:bold;
          ">×‘×™×˜×•×œ</button>
        </div>
      </div>

      <div id="createPostError" style="
        display:none;
        padding:10px 12px;
        border-radius:12px;
        background: rgba(255,0,0,0.08);
        color:#8a0000;
        font-size:13px;
      "></div>
    </div>
  </div>
</div>

<!-- =====================================================================================
     FULLSCREEN IMAGE VIEWER (× ×©××¨; ×‘×¤×•×¨×•× ×œ× ××¦×™×’×™× ×ª××•× ×•×ª, ××‘×œ ×œ× ××¤×¨×™×¢)
     ===================================================================================== -->
<div id="imageViewerOverlay">
  <div id="imageViewerInner">
    <div id="imageViewerTop">
      <div style="font-weight:bold;">×ª××•× ×”</div>
      <button id="closeImageViewer" type="button">âœ•</button>
    </div>
    <img id="imageViewerImg" alt="×ª××•× ×”" src="" />
    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
      <span id="imageViewerHint" style="font-size:12px; opacity:.75;">×œ×—×¥ ××—×•×¥ ×œ×ª×™×‘×” ×›×“×™ ×œ×¡×’×•×¨</span>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
<script>
/* =========================================================================================
   âš ï¸ ××‘×˜×—×” â€“ ×œ× × ×•×’×¢×™× ×•×œ× ××©× ×™× ×©×™×˜×”
   ========================================================================================= */

/* ===============================
   ×—×¡×™××” ××™×™×“×™×ª â€“ ×œ× WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor || typeof window.AppInventor.getWebViewString !== "function") {
      location.replace("forbidden.html");
      return;
    }
  } catch (e) {
    location.replace("forbidden.html");
    return;
  }
})();

/* =========================================================================================
   Cache (A) â€“ ×ª×¦×•×’×” ××™×™×“×™×ª
   ========================================================================================= */
var cached = null;
try { cached = sessionStorage.getItem("cachedPosts"); } catch (e1) { cached = null; }
if (cached) {
  var postsHost = document.getElementById("posts");
  if (postsHost) postsHost.innerHTML = cached;
}

/* =========================================================================================
   Utilities
   ========================================================================================= */
function escapeHTML(str) {
  if (str === undefined || str === null) str = "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}
function safeText(str) {
  if (str === undefined || str === null) str = "";
  return String(str);
}
function userColor(key) {
  var colors = ["#60a5fa","#34d399","#f472b6","#fbbf24","#a78bfa","#fb7185","#22d3ee"];
  var hash = 0;
  var s = safeText(key || "");
  for (var i = 0; i < s.length; i++) hash = s.charCodeAt(i) + ((hash << 5) - hash);
  return colors[Math.abs(hash) % colors.length];
}

/* =========================================================================================
   Image URL safety
   ========================================================================================= */
function sanitizeImageUrl(url) {
  if (url === undefined || url === null) return "";
  var u = safeText(url).trim();
  if (!u) return "";
  if (u.indexOf("https://") === 0 || u.indexOf("http://") === 0) return u;
  return "";
}
function isLikelyImageFile(file) {
  try {
    if (!file) return false;
    var t = safeText(file.type || "").toLowerCase();
    if (t.indexOf("image/") === 0) return true;
    var n = safeText(file.name || "").toLowerCase();
    if (n.indexOf(".jpg") > -1 || n.indexOf(".jpeg") > -1 || n.indexOf(".png") > -1 || n.indexOf(".webp") > -1) return true;
    return false;
  } catch (e) { return false; }
}
function bytesToHuman(n) {
  try {
    var x = Number(n || 0);
    if (!x) return "0B";
    if (x < 1024) return x + "B";
    if (x < 1024 * 1024) return Math.round(x / 1024) + "KB";
    return (Math.round((x / (1024 * 1024)) * 10) / 10) + "MB";
  } catch (e) { return ""; }
}

/* ===============================
   FIX: WebView compatibility helpers (××§×•×‘×¥ 1)
   =============================== */
function dataURLToBlob(dataUrl) {
  try {
    var parts = safeText(dataUrl || "").split(",");
    if (parts.length < 2) return null;
    var meta = parts[0];
    var b64 = parts[1];
    var mime = "application/octet-stream";
    var m = /data:([^;]+);base64/i.exec(meta);
    if (m && m[1]) mime = m[1];
    var bin = atob(b64);
    var len = bin.length;
    var arr = new Uint8Array(len);
    for (var i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
    return new Blob([arr], { type: mime });
  } catch (e) { return null; }
}
function canvasToBlobSafe(canvas, outType, quality, cb) {
  try {
    if (canvas && typeof canvas.toBlob === "function") {
      canvas.toBlob(function (blob) { cb(blob); }, outType, quality);
      return;
    }
  } catch (e1) { }
  try {
    var dataUrl = "";
    try { dataUrl = canvas.toDataURL(outType, quality); } catch (e2) { dataUrl = canvas.toDataURL(); }
    var blob2 = dataURLToBlob(dataUrl);
    cb(blob2);
  } catch (e3) { cb(null); }
}
function getPreviewUrlForFile(file, done) {
  try {
    if (window.URL && typeof URL.createObjectURL === "function") {
      try {
        var u = URL.createObjectURL(file);
        done(u, true);
        return;
      } catch (eObj) { }
    }
  } catch (e0) { }
  try {
    var r = new FileReader();
    r.onerror = function () { done("", false); };
    r.onload = function () { done(safeText(r.result || ""), false); };
    r.readAsDataURL(file);
  } catch (e1) { done("", false); }
}

/* ===============================
   Viewer (× ×©××¨)
   =============================== */
function openImageViewer(url) {
  var overlay = document.getElementById("imageViewerOverlay");
  var img = document.getElementById("imageViewerImg");
  var closeBtn = document.getElementById("closeImageViewer");

  if (!overlay || !img) return;
  var safe = sanitizeImageUrl(url);
  if (!safe) return;

  img.setAttribute("src", safe);
  overlay.style.display = "flex";

  if (closeBtn && !closeBtn.__bound) {
    closeBtn.__bound = true;
    closeBtn.addEventListener("click", function () {
      overlay.style.display = "none";
      img.setAttribute("src", "");
    });
  }

  if (!overlay.__bound) {
    overlay.__bound = true;
    overlay.addEventListener("click", function (e) {
      if (e.target === overlay) {
        overlay.style.display = "none";
        img.setAttribute("src", "");
      }
    });
  }
}

function nowTs() { return Date.now(); }
function setStatus(msg, type) {
  if (type === undefined || type === null) type = "info";
  var bar = document.getElementById("statusBar");
  if (!bar) return;

  if (!msg) {
    bar.style.display = "none";
    bar.textContent = "";
    return;
  }

  bar.style.display = "block";
  bar.textContent = msg;

  if (type === "error") {
    bar.style.background = "rgba(255,0,0,0.08)";
    bar.style.color = "#8a0000";
  } else if (type === "ok") {
    bar.style.background = "rgba(0,128,0,0.08)";
    bar.style.color = "#0b5a0b";
  } else if (type === "warn") {
    bar.style.background = "rgba(255,165,0,0.10)";
    bar.style.color = "#7a4b00";
  } else {
    bar.style.background = "rgba(0,0,0,0.04)";
    bar.style.color = "#111";
  }
}
function debounce(fn, ms) {
  var t = null;
  return function () {
    var args = arguments;
    clearTimeout(t);
    t = setTimeout(function () { fn.apply(null, args); }, ms);
  };
}

/* =========================================================================================
   Global State
   ========================================================================================= */
var payload = null;
var uid = null;
var isRefreshing = false;
var isAuthed = false;

var postsCacheData = [];
var renderedHtmlCache = "";
var lastNavAt = 0;
var lastOpenId = "";
var pullStartY = 0;
var pulling = false;
var didTriggerRefresh = false;
var realUsername = "××©×ª××©";

/* =========================================================================================
   Image state (âœ… ××§×•×‘×¥ 1)
   ========================================================================================= */
var selectedImageFile = null;
var selectedImagePreviewUrl = "";
var selectedImagePreviewCanRevoke = false;
var selectedImagePrepared = null; // kept (not required)
var selectedImageDataUrl = "";    // fallback
var isPublishingNow = false;

/* =========================================================================================
   lastComment hydration (×¤×©×•×˜, ×™×¦×™×‘)
   ========================================================================================= */
var lastCommentHydrationInFlight = false;

document.addEventListener("DOMContentLoaded", function () {
  var postsEl = document.getElementById("posts");
  var indicator = document.getElementById("pull-indicator");

  var searchBox = document.getElementById("searchBox");
  var sortMode = document.getElementById("sortMode");

  var openCreatePostBtn = document.getElementById("openCreatePost");
  var overlay = document.getElementById("createPostOverlay");
  var closeCreatePostBtn = document.getElementById("closeCreatePost");
  var cancelPostBtn = document.getElementById("cancelPost");
  var submitPostBtn = document.getElementById("submitPost");
  var newPostTitle = document.getElementById("newPostTitle");
  var newPostText = document.getElementById("newPostText");
  var createPostError = document.getElementById("createPostError");

  /* Image UI elements */
  var newPostImage = document.getElementById("newPostImage");
  var chooseImageBtn = document.getElementById("chooseImageBtn");
  var removeImageBtn = document.getElementById("removeImageBtn");
  var imagePreviewWrap = document.getElementById("imagePreviewWrap");
  var imagePreview = document.getElementById("imagePreview");
  var imageChip = document.getElementById("imageChip");
  var imageWarn = document.getElementById("imageWarn");
  var uploadProgressArea = document.getElementById("uploadProgressArea");
  var uploadProgressText = document.getElementById("uploadProgressText");
  var uploadProgressBar = document.getElementById("uploadProgressBar");
  var newPostImageMeta = document.getElementById("newPostImageMeta");

  if (!postsEl) { location.replace("forbidden.html"); return; }

  if (searchBox) {
    searchBox.addEventListener("input", debounce(function () { renderPostsFromCache(); }, 120));
  }
  if (sortMode) {
    sortMode.addEventListener("change", function () {
      // ×× ×‘×—×¨×• lastComment â€“ × ×©×œ×™× lastCommentTime ×œ×¤×•×¡×˜×™× ×©×—×¡×¨ ×œ×”×
      try {
        if ((sortMode.value || "") === "lastComment") hydrateLastCommentTimesIfNeeded();
      } catch (eLC) { }
      renderPostsFromCache();
    });
  }

  function createPostErrorShow(msg) {
    if (!createPostError) return;
    createPostError.textContent = msg;
    createPostError.style.display = "block";
  }
  function createPostErrorHide() {
    if (!createPostError) return;
    createPostError.textContent = "";
    createPostError.style.display = "none";
  }

  function setUploadProgress(pct) {
    try {
      var x = Math.max(0, Math.min(100, Number(pct || 0)));
      if (uploadProgressArea) uploadProgressArea.style.display = "block";
      if (uploadProgressText) uploadProgressText.textContent = x + "%";
      if (uploadProgressBar) uploadProgressBar.style.width = x + "%";
    } catch (e) { }
  }

  /* =====================================================================================
     âœ… IMAGE HANDLERS (×”×•×¢×ª×§ ××§×•×‘×¥ 1)
     ===================================================================================== */

  function readFileAsDataURLWithRetry(file, tries, done) {
    try {
      var left = Number(tries || 1);
      if (left < 1) left = 1;

      var attempt = function () {
        try {
          var r = new FileReader();
          r.onerror = function () {
            left--;
            if (left <= 0) { done("", false); return; }
            setTimeout(attempt, 140);
          };
          r.onload = function () {
            var dataUrl = safeText(r.result || "");
            if (!dataUrl || dataUrl.indexOf("data:") !== 0) {
              left--;
              if (left <= 0) { done("", false); return; }
              setTimeout(attempt, 140);
              return;
            }
            done(dataUrl, true);
          };
          r.readAsDataURL(file);
        } catch (e1) {
          left--;
          if (left <= 0) { done("", false); return; }
          setTimeout(attempt, 140);
        }
      };

      attempt();
    } catch (e0) {
      done("", false);
    }
  }

  function clearSelectedImage(resetInput) {
    try {
      if (selectedImagePreviewUrl && selectedImagePreviewCanRevoke) {
        try { URL.revokeObjectURL(selectedImagePreviewUrl); } catch (eRv2) { }
      }
    } catch (eRv3) { }

    selectedImageFile = null;
    selectedImagePreviewUrl = "";
    selectedImagePreviewCanRevoke = false;
    selectedImagePrepared = null;
    selectedImageDataUrl = "";

    try {
      if (imagePreview) imagePreview.setAttribute("src", "");
      if (imagePreviewWrap) imagePreviewWrap.style.display = "none";
      if (removeImageBtn) removeImageBtn.style.display = "none";
      if (imageChip) imageChip.style.display = "none";
      if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }

      if (uploadProgressArea) uploadProgressArea.style.display = "none";
      if (uploadProgressText) uploadProgressText.textContent = "0%";
      if (uploadProgressBar) uploadProgressBar.style.width = "0%";

      if (resetInput && newPostImage) newPostImage.value = "";

      if (newPostImageMeta) newPostImageMeta.textContent = "×¤×•×¨××˜×™× × ×ª××›×™×: JPG/PNG/WebP. ××•××œ×¥ ×¢×“ 9MB.";
    } catch (eImg3) { }
  }

  if (chooseImageBtn && newPostImage) {
    chooseImageBtn.addEventListener("click", function () {
      try {
        newPostImage.value = "";
        newPostImage.click();
      } catch (eImg0) { }
    });
  }

  if (removeImageBtn) {
    removeImageBtn.addEventListener("click", function () {
      clearSelectedImage(true);
    });
  }

  if (newPostImage) {
    newPostImage.addEventListener("change", function () {
      try {
        var f = (newPostImage.files && newPostImage.files[0]) ? newPostImage.files[0] : null;
        if (!f) return;

        if (!isLikelyImageFile(f)) {
          createPostErrorShow("×§×•×‘×¥ ×œ× × ×ª××š. ×‘×—×¨ ×ª××•× ×” (JPG/PNG/WebP).");
          clearSelectedImage(true);
          return;
        }

        var MAX = 9 * 1024 * 1024; // 9MB
        if (Number(f.size || 0) > MAX) {
          createPostErrorShow("×”×ª××•× ×” ×’×“×•×œ×” ××“×™ (" + bytesToHuman(f.size) + "). ××•××œ×¥ ×¢×“ 9MB.");
          clearSelectedImage(true);
          return;
        }

        selectedImageFile = f;
        selectedImagePrepared = null;
        selectedImageDataUrl = "";
        if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }

        try {
          if (selectedImagePreviewUrl && selectedImagePreviewCanRevoke) {
            try { URL.revokeObjectURL(selectedImagePreviewUrl); } catch (eRv0) { }
          }
        } catch (eRv1) { }
        selectedImagePreviewUrl = "";
        selectedImagePreviewCanRevoke = false;

        // UI: ××¦×™×’ ×©× ×‘×—×¨×” ×ª××•× ×” ××™×™×“ (×’× ×× preview ×™×™×›×©×œ)
        try {
          if (imagePreviewWrap) imagePreviewWrap.style.display = "block";
          if (removeImageBtn) removeImageBtn.style.display = "inline-block";
          if (imageChip) { imageChip.style.display = "inline-flex"; imageChip.textContent = "ğŸ–¼ï¸ " + bytesToHuman(f.size); }
          if (newPostImageMeta) newPostImageMeta.textContent = "× ×‘×—×¨×” ×ª××•× ×”: " + safeText(f.name) + " (" + bytesToHuman(f.size) + ")";
        } catch (eUI0) { }

        // Preview: ObjectURL first, fallback to DataURL (×œ× ×—×•×¡×)
        getPreviewUrlForFile(f, function (srcUrl, canRevoke) {
          try {
            if (srcUrl) {
              selectedImagePreviewUrl = srcUrl;
              selectedImagePreviewCanRevoke = !!canRevoke;
              if (imagePreview) imagePreview.setAttribute("src", selectedImagePreviewUrl);
              if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }
              return;
            }
          } catch (ePrev0) { }

          readFileAsDataURLWithRetry(f, 2, function (dataUrl, ok) {
            try {
              if (ok && dataUrl) {
                selectedImagePreviewUrl = dataUrl;
                selectedImagePreviewCanRevoke = false;
                if (imagePreview) imagePreview.setAttribute("src", selectedImagePreviewUrl);
                if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }
              } else {
                if (imageWarn) {
                  imageWarn.style.display = "block";
                  imageWarn.textContent = "×œ× × ×™×ª×Ÿ ×œ×”×¦×™×’ ×ª×¦×•×’×” ××§×“×™××” ×›×¨×’×¢ â€” ××‘×œ ×”×ª××•× ×” ×ª×¢×œ×” ×‘×¤×¨×¡×•×.";
                }
              }
            } catch (ePrev1) { }
          });
        });

      } catch (eImg2) { }
    });
  }

  /* =====================================================================================
     Modal open/close
     ===================================================================================== */
  function openCreatePostModal() {
    createPostErrorHide();
    if (newPostTitle) newPostTitle.value = "";
    if (newPostText) newPostText.value = "";
    clearSelectedImage(true);
    isPublishingNow = false;
    if (overlay) overlay.style.display = "flex";
    setTimeout(function () { try { if (newPostTitle) newPostTitle.focus(); } catch (e) { } }, 50);
  }
  function closeCreatePostModal() {
    createPostErrorHide();
    if (overlay) overlay.style.display = "none";
    clearSelectedImage(true);
    isPublishingNow = false;
  }

  if (openCreatePostBtn) {
    openCreatePostBtn.addEventListener("click", function () {
      if (!isAuthed) { setStatus("×¢×•×“ ×œ× ××•××ª×ª ××•×œ ×”×©×¨×ª. ×—×›×” ×©× ×™×™×” ×•××– × ×¡×” ×©×•×‘.", "error"); return; }
      openCreatePostModal();
    });
  }
  if (closeCreatePostBtn) closeCreatePostBtn.addEventListener("click", closeCreatePostModal);
  if (cancelPostBtn) cancelPostBtn.addEventListener("click", closeCreatePostModal);

  if (overlay) {
    overlay.addEventListener("click", function (e) {
      if (e.target === overlay) closeCreatePostModal();
    });
  }

  if (submitPostBtn) {
    submitPostBtn.addEventListener("click", function () {
      createPostErrorHide();

      if (!isAuthed) { createPostErrorShow("××ª×” ×œ× ×××•××ª ×¢×“×™×™×Ÿ. × ×¡×” ×©×•×‘ ×¢×•×“ ×¨×’×¢."); return; }
      if (isPublishingNow) return;

      var title = safeText(newPostTitle && newPostTitle.value ? newPostTitle.value : "").trim();
      var text  = safeText(newPostText && newPostText.value ? newPostText.value : "").trim();

      if (title.length < 3) { createPostErrorShow("×›×•×ª×¨×ª ×§×¦×¨×” ××“×™. ××™× ×™××•× 3 ×ª×•×•×™×."); return; }
      if (text.length < 3)  { createPostErrorShow("×ª×•×›×Ÿ ×§×¦×¨ ××“×™. ××™× ×™××•× 3 ×ª×•×•×™×."); return; }

      if (selectedImageFile) {
        if (!isLikelyImageFile(selectedImageFile)) {
          createPostErrorShow("×”×ª××•× ×” ×©× ×‘×—×¨×” ×œ× ×ª×§×™× ×”. ×‘×—×¨ ×ª××•× ×” ××—×“×©.");
          clearSelectedImage(true);
          return;
        }
        var MAX2 = 9 * 1024 * 1024;
        if (Number(selectedImageFile.size || 0) > MAX2) {
          createPostErrorShow("×”×ª××•× ×” ×’×“×•×œ×” ××“×™. ×‘×—×¨ ×ª××•× ×” ×§×˜× ×” ×™×•×ª×¨.");
          return;
        }
      }

      publishPost(title, text);
    });
  }

  /* =====================================================================================
     Pull To Refresh
     ===================================================================================== */
  document.addEventListener("touchstart", function (e) {
    try {
      if (window.scrollY === 0 && !isRefreshing) {
        pullStartY = e.touches[0].clientY;
        pulling = true;
        didTriggerRefresh = false;
      }
    } catch (err1) { }
  }, { passive: true });

  document.addEventListener("touchmove", function (e) {
    if (!pulling || isRefreshing) return;

    var diff = e.touches[0].clientY - pullStartY;
    if (diff <= 0) return;

    if (indicator) indicator.style.display = "block";

    var THRESHOLD = 90;
    if (diff > THRESHOLD && !didTriggerRefresh) {
      didTriggerRefresh = true;
      pulling = false;
      isRefreshing = true;

      try { sessionStorage.removeItem("cachedPosts"); } catch (err2) { }

      loadPosts(true);
    }
  }, { passive: true });

  document.addEventListener("touchend", function () {
    pulling = false;
    if (!isRefreshing && indicator) indicator.style.display = "none";
  }, { passive: true });

  /* =====================================================================================
     Auth flow
     ===================================================================================== */
  waitForPayload();
  function waitForPayload() {
    var raw = "";
    try {
      raw = window.AppInventor.getWebViewString();
      if (!raw) { setTimeout(waitForPayload, 200); return; }
      payload = JSON.parse(raw);
    } catch (e) {
      setTimeout(waitForPayload, 200);
      return;
    }
    loginToFirebase(payload);
  }

  function loginToFirebase(data) {
    if (!data || !data.email || !data.password || !data.token) { location.replace("forbidden.html"); return; }
    firebase.auth()
      .signInWithEmailAndPassword(data.email, data.password)
      .then(function (c) { validateToken(c.user.uid, data.token); })
      .catch(function () { location.replace("forbidden.html"); });
  }

  function validateToken(userId, token) {
    firebase.database()
      .ref("sessions/" + userId + "/token")
      .once("value")
      .then(function (snap) {
        if (!snap.exists() || snap.val() !== token) { location.replace("forbidden.html"); return; }

        uid = userId;
        isAuthed = true;

        firebase.database()
          .ref("users/" + uid + "/username")
          .once("value")
          .then(function (uSnap) {
            realUsername = uSnap.val() || "××©×ª××©";
            setStatus("××—×•×‘×¨ ×›Ö¾" + realUsername, "ok");
            loadPosts(false);
            attachLivePostListeners();
          })
          .catch(function () {
            realUsername = "××©×ª××©";
            setStatus("××—×•×‘×¨", "ok");
            loadPosts(false);
            attachLivePostListeners();
          });
      })
      .catch(function () { location.replace("forbidden.html"); });
  }

  function loadPosts(fromRefresh) {
    if (fromRefresh === undefined || fromRefresh === null) fromRefresh = false;
    setStatus(fromRefresh ? "××¨×¢× ×Ÿ ×¤×•×¡×˜×™×â€¦" : "×˜×•×¢×Ÿ ×¤×•×¡×˜×™×â€¦", "info");

    firebase.database()
      .ref("posts")
      .orderByChild("time")
      .limitToLast(300)
      .once("value")
      .then(function (snap) {
        var items = [];
        snap.forEach(function (pSnap) {
          var p = pSnap.val() || {};
          var postId = pSnap.key;

          items.push({
            id: postId,
            title: safeText(p.title),
            text: safeText(p.text),
            author: safeText(p.author),
            time: Number(p.time || 0),
            likes: Number(p.likes || 0),
            commentsCount: Number(p.commentsCount || 0),
            image: sanitizeImageUrl(p.image || ""),
            lastCommentTime: Number(p.lastCommentTime || 0)
          });
        });

        items.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });
        postsCacheData = items;

        // ×× ×›×¨×’×¢ ×‘××¦×‘ lastComment â€“ × ×©×œ×™× lastCommentTime ×× ×—×¡×¨
        try {
          if (sortMode && sortMode.value === "lastComment") hydrateLastCommentTimesIfNeeded();
        } catch (eLC0) { }

        renderPostsFromCache();
        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e2) { }

        if (fromRefresh) {
          setTimeout(function () {
            isRefreshing = false;
            if (indicator) indicator.style.display = "none";
            setStatus("×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”.", "ok");
          }, 250);
        } else {
          setStatus("×¤×•×¡×˜×™× × ×˜×¢× ×•.", "ok");
        }
      })
      .catch(function () { location.replace("forbidden.html"); });
  }

  function renderPostsFromCache() {
    var q = "";
    var mode = "newest";

    if (searchBox && typeof searchBox.value === "string") q = searchBox.value;
    q = safeText(q).trim().toLowerCase();

    if (sortMode && typeof sortMode.value === "string") mode = sortMode.value;
    mode = safeText(mode) || "newest";

    var list = postsCacheData.slice();

    if (q) {
      list = list.filter(function (p) {
        var t = (p.title || "").toLowerCase();
        var x = (p.text || "").toLowerCase();
        var a = (p.author || "").toLowerCase();
        var im = (p.image || "").toLowerCase();
        var hasImg = im ? "×ª××•× ×”" : "";
        return t.indexOf(q) !== -1 || x.indexOf(q) !== -1 || a.indexOf(q) !== -1 || hasImg.indexOf(q) !== -1;
      });
    }

    if (mode === "oldest") {
      list.sort(function (a, b) { return (a.time || 0) - (b.time || 0); });
    } else if (mode === "author") {
      list.sort(function (a, b) { return (a.author || "").localeCompare(b.author || "", "he"); });
    } else if (mode === "title") {
      list.sort(function (a, b) { return (a.title || "").localeCompare(b.title || "", "he"); });
    } else if (mode === "lastComment") {
      list.sort(function (a, b) {
        var ta = Number(a.lastCommentTime || 0) || 0;
        var tb = Number(b.lastCommentTime || 0) || 0;
        if (!ta) ta = Number(a.time || 0) || 0;
        if (!tb) tb = Number(b.time || 0) || 0;
        return tb - ta;
      });
    } else {
      list.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });
    }

    var html = "";
    if (!list.length) {
      html = q ? "<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×©.</p>" : "<p>××™×Ÿ ×¢×“×™×™×Ÿ ×¤×•×¡×˜×™×.</p>";
    } else {
      for (var i = 0; i < list.length; i++) html += buildPostCardHTML(list[i]);
    }

    postsEl.innerHTML = html;
    renderedHtmlCache = html;

    try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (eC) { }
  }

  function formatCommentsCountText(n) {
    try {
      var x = Number(n || 0);
      if (!x) return "××™×Ÿ ×ª×’×•×‘×•×ª";
      if (x === 1) return "×ª×’×•×‘×” ××—×ª";
      return x + " ×ª×’×•×‘×•×ª";
    } catch (e) { return "××™×Ÿ ×ª×’×•×‘×•×ª"; }
  }

  function buildPostCardHTML(p) {
    var title = escapeHTML(p.title || "");
    var text = escapeHTML(p.text || "");
    var author = escapeHTML(p.author || "");
    var idRaw = safeText(p.id || "");
    var id = escapeHTML(idRaw);

    var timeStr = "";
    if (p.time) {
      try {
        timeStr = new Date(p.time).toLocaleString("he-IL", {
          hour: "2-digit",
          minute: "2-digit",
          day: "2-digit",
          month: "2-digit"
        });
      } catch (e) { timeStr = ""; }
    }

    var imgUrl = sanitizeImageUrl(p.image || "");
    var hasImg = !!imgUrl;
    var badge = hasImg ? '<span class="has-image-badge">ğŸ“· ×ª××•× ×”</span>' : "";

    var authorClr = userColor(p.author || "");
    var commentsCount = Number(p.commentsCount || 0);
    var commentsText = formatCommentsCountText(commentsCount);
    var commentsCls = commentsCount ? "post-comments-count" : "post-comments-count post-comments-none";

    return (
      '\n<div class="post" data-id="' + id + '" data-image="' + escapeHTML(imgUrl) + '"' +
        ' style="border-right:4px solid ' + escapeHTML(authorClr) + ';">' +
        '\n  <h3>' + badge + title + '</h3>' +
        '\n  <p>' + text + '</p>' +
        '\n  <small style="color:' + escapeHTML(authorClr) + ';">×××ª: ' + author + '</small>' +
        '\n  <div class="post-bottom-meta-row">' +
        '\n    <small class="' + commentsCls + '">' + escapeHTML(commentsText) + '</small>' +
        '\n    <small class="post-time-small">' + escapeHTML(timeStr) + '</small>' +
        '\n  </div>' +
      '\n</div>\n'
    );
  }

  function bindPostNavigation(container) {
    if (container.__navBound) return;
    container.__navBound = true;

    container.addEventListener("click", function (e) {
      if (isRefreshing || pulling) return;

      var postEl = null;
      try { postEl = e.target.closest(".post"); } catch (err) { postEl = null; }
      if (!postEl) return;

      var id = postEl.getAttribute("data-id");
      if (!id) return;

      var now = Date.now();
      if (now - lastNavAt < 350 && lastOpenId === id) return;
      lastNavAt = now;
      lastOpenId = id;

      openPost(id, postEl);
    }, false);
  }
  bindPostNavigation(postsEl);

  function openPost(postId, el) {
    try {
      var h3 = el.querySelector("h3");
      var p = el.querySelector("p");
      var smalls = el.querySelectorAll("small");

      // author line ×”×•× ×”×¨××©×•×Ÿ (×××ª), meta row ××—×¨ ×›×š
      var author = "";
      try {
        if (smalls && smalls.length) {
          author = (smalls[0].innerText || "").replace("×××ª:", "").trim();
        }
      } catch (eA) { author = ""; }

      var title = h3 ? (h3.innerText || "") : "";
      // × × ×§×” ××ª ×”×‘×“×’' ××”×›×•×ª×¨×ª ×›×“×™ ×©×”×›×•×ª×¨×ª ×œ× ×ª×›×œ×•×œ "ğŸ“· ×ª××•× ×”"
      try { title = title.replace("ğŸ“· ×ª××•× ×”", "").trim(); } catch (eT) { }

      var text = p ? (p.innerText || "") : "";

      var imageUrl = "";
      try { imageUrl = sanitizeImageUrl(el.getAttribute("data-image") || ""); } catch (eDI) { imageUrl = ""; }

      sessionStorage.setItem("currentPost", JSON.stringify({
        id: postId,
        title: title || "",
        text: text || "",
        author: author || "",
        image: imageUrl || ""
      }));
    } catch (e) { }

    location.href = "post.html?postId=" + encodeURIComponent(postId);
  }

  function attachLivePostListeners() {
    if (window.__postsLiveAttached) return;
    window.__postsLiveAttached = true;

    var ref = firebase.database().ref("posts").orderByChild("time").limitToLast(50);

    ref.on("child_added", function (snap) {
      var id = snap.key;
      var v = snap.val() || {};

      var item = {
        id: id,
        title: safeText(v.title),
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || 0),
        likes: Number(v.likes || 0),
        commentsCount: Number(v.commentsCount || 0),
        image: sanitizeImageUrl(v.image || ""),
        lastCommentTime: Number(v.lastCommentTime || 0)
      };

      for (var i = 0; i < postsCacheData.length; i++) {
        if (postsCacheData[i] && postsCacheData[i].id === id) return;
      }
      postsCacheData.unshift(item);

      if (!isRefreshing) {
        renderPostsFromCache();
        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e5) { }
      }
    });

    ref.on("child_changed", function (snap) {
      var id = snap.key;
      var v = snap.val() || {};

      var idx = -1;
      for (var i = 0; i < postsCacheData.length; i++) {
        if (postsCacheData[i] && postsCacheData[i].id === id) { idx = i; break; }
      }
      if (idx === -1) return;

      var prev = postsCacheData[idx] || {};

      postsCacheData[idx] = {
        id: id,
        title: safeText(v.title),
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || prev.time || 0),
        likes: Number(v.likes || prev.likes || 0),
        commentsCount: Number(v.commentsCount || prev.commentsCount || 0),
        image: sanitizeImageUrl(v.image || prev.image || ""),
        lastCommentTime: Number(v.lastCommentTime || prev.lastCommentTime || 0)
      };

      if (!isRefreshing) {
        renderPostsFromCache();
        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e6) { }
      }
    });
  }

  function hydrateLastCommentTimesIfNeeded() {
    try {
      if (!isAuthed) return;
      if (lastCommentHydrationInFlight) return;
      lastCommentHydrationInFlight = true;

      // ×¨×§ ×œ××™ ×©×—×¡×¨ lastCommentTime
      var need = [];
      for (var i = 0; i < postsCacheData.length; i++) {
        var p = postsCacheData[i];
        if (!p || !p.id) continue;
        if (Number(p.lastCommentTime || 0) > 0) continue;
        need.push(p.id);
      }
      if (!need.length) { lastCommentHydrationInFlight = false; return; }

      var idx = 0;
      var CONC = 6;
      var inFlight = 0;

      setStatus("××›×™×Ÿ ××™×•×Ÿ ×œ×¤×™ ×ª×’×•×‘×” ××—×¨×•× ×”â€¦", "info");

      var next = function () {
        while (inFlight < CONC && idx < need.length) {
          (function (postId) {
            inFlight++;
            firebase.database()
              .ref("comments/" + postId)
              .orderByChild("time")
              .limitToLast(1)
              .once("value")
              .then(function (snap) {
                var t = 0;
                try {
                  snap.forEach(function (c) {
                    var v = c.val() || {};
                    t = Number(v.time || 0) || 0;
                  });
                } catch (eT) { t = 0; }

                // ×¢×“×›×•×Ÿ ××§×•××™
                for (var j = 0; j < postsCacheData.length; j++) {
                  if (postsCacheData[j] && postsCacheData[j].id === postId) {
                    postsCacheData[j].lastCommentTime = t;
                    break;
                  }
                }
              })
              .catch(function () { })
              .finally(function () {
                inFlight--;
                if (idx >= need.length && inFlight === 0) {
                  lastCommentHydrationInFlight = false;
                  renderPostsFromCache();
                  setStatus("×¢×•×“×›×Ÿ ××™×•×Ÿ ×œ×¤×™ ×ª×’×•×‘×” ××—×¨×•× ×”.", "ok");
                } else {
                  next();
                }
              });
          })(need[idx++]);
        }
      };

      next();
    } catch (e0) {
      lastCommentHydrationInFlight = false;
    }
  }

  /* =====================================================================================
     âœ… publishPost ×¢× ×”×¢×œ××ª ×ª××•× ×” (××§×•×‘×¥ 1)
     ===================================================================================== */
  function publishPost(title, text) {
    if (!isAuthed || !uid) return;

    if (isPublishingNow) return;
    isPublishingNow = true;

    var btn = submitPostBtn;
    if (btn) btn.disabled = true;

    var postObj = {
      title: title,
      text: text,
      author: realUsername,
      time: nowTs(),
      image: null
    };

    var postsRef = firebase.database().ref("posts");
    var newRef = postsRef.push();
    var postId = newRef.key;

    if (!selectedImageFile) {
      postObj.image = null;

      newRef.set(postObj)
        .then(function () {
          closeCreatePostModal();
          setStatus("×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”.", "ok");
          try { window.scrollTo(0, 0); } catch (e4) { }
        })
        .catch(function () {
          createPostErrorShow("×©×’×™××” ×‘×¤×¨×¡×•×. × ×¡×” ×©×•×‘.");
        })
        .finally(function () {
          if (btn) btn.disabled = false;
          isPublishingNow = false;
        });

      return;
    }

    setStatus("××¢×œ×” ×ª××•× ×”â€¦", "info");
    setUploadProgress(1);

    var ext0 = "jpg";
    try {
      var n0 = safeText(selectedImageFile.name || "");
      if (n0.indexOf(".") !== -1) ext0 = n0.split(".").pop().toLowerCase();
    } catch (eExt) { ext0 = "jpg"; }

    var uploadDirectFirst = function () {
      return uploadPostImageEx(
        selectedImageFile,
        safeText(selectedImageFile.type || ""),
        ext0,
        postId,
        uid,
        function (pct) { setUploadProgress(pct); }
      );
    };

    var uploadFallbackDataUrl = function () {
      var ensureDataUrl = function () {
        return new Promise(function (resolve, reject) {
          try {
            if (selectedImageDataUrl && selectedImageDataUrl.indexOf("data:") === 0) {
              resolve(selectedImageDataUrl);
              return;
            }
            readFileAsDataURLWithRetry(selectedImageFile, 3, function (durl, ok) {
              if (!ok) { reject("read_failed"); return; }
              resolve(durl);
            });
          } catch (e) { reject(e); }
        });
      };

      return ensureDataUrl()
        .then(function (dataUrl) {
          selectedImageDataUrl = safeText(dataUrl || "");
          if (!selectedImageDataUrl || selectedImageDataUrl.indexOf("data:") !== 0) throw "read_failed";

          return uploadPostImageDataUrlEx(
            selectedImageDataUrl,
            ext0,
            postId,
            uid,
            function (pct) { setUploadProgress(pct); }
          );
        });
    };

    uploadDirectFirst()
      .catch(function () {
        try {
          if (imageWarn) {
            imageWarn.style.display = "block";
            imageWarn.textContent = "×”×¢×œ××” ×™×©×™×¨×” × ×›×©×œ×”, ×× ×¡×” ×©×™×˜×ª ×’×™×‘×•×™â€¦";
          }
        } catch (eW) { }
        return uploadFallbackDataUrl();
      })
      .then(function (imageUrl) {
        imageUrl = sanitizeImageUrl(imageUrl || "");
        postObj.image = imageUrl || null;

        setStatus("×©×•××¨ ×¤×•×¡×˜â€¦", "info");
        setUploadProgress(100);

        return newRef.set(postObj);
      })
      .then(function () {
        closeCreatePostModal();
        setStatus("×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”.", "ok");
        try { window.scrollTo(0, 0); } catch (e4) { }
      })
      .catch(function () {
        try { if (postId) firebase.database().ref("posts/" + postId).remove(); } catch (eRm) { }
        createPostErrorShow("×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×”/×¤×¨×¡×•×. × ×¡×” ×©×•×‘.");
        setStatus("×©×’×™××” ×‘×¤×¨×¡×•×.", "error");
      })
      .finally(function () {
        if (uploadProgressArea) uploadProgressArea.style.display = "none";
        if (btn) btn.disabled = false;
        isPublishingNow = false;
      });
  }

});

/* =========================================================================================
   âœ… Upload DataURL + progress + timeout (××§×•×‘×¥ 1)
   ========================================================================================= */
function uploadPostImageDataUrlEx(dataUrl, ext, postId, uid, onProgress) {
  return new Promise(function (resolve, reject) {
    try {
      if (!dataUrl || !postId || !uid) { reject("missing params"); return; }

      var safeExt = safeText(ext || "").toLowerCase();
      if (!safeExt) safeExt = "jpg";
      if (safeExt.length > 8) safeExt = "jpg";

      var name = Date.now() + "_" + uid + "." + safeExt;
      var ref = firebase.storage().ref("post-images/" + postId + "/" + name);

      var finished = false;
      var task = ref.putString(dataUrl, "data_url");

      var timer = setTimeout(function () {
        if (finished) return;
        finished = true;
        try { if (task && typeof task.cancel === "function") task.cancel(); } catch (eC) { }
        reject("upload_timeout");
      }, 90000); // 90s watchdog

      task.on("state_changed",
        function (snap) {
          try {
            if (!snap) return;
            var bytes = Number(snap.bytesTransferred || 0);
            var total = Number(snap.totalBytes || 0);
            if (total > 0) {
              var pct = Math.round((bytes / total) * 100);
              if (typeof onProgress === "function") onProgress(pct);
            }
          } catch (eP) { }
        },
        function (err) {
          if (finished) return;
          finished = true;
          try { clearTimeout(timer); } catch (eT) { }
          reject(err);
        },
        function () {
          try {
            task.snapshot.ref.getDownloadURL()
              .then(function (url) {
                if (finished) return;
                finished = true;
                try { clearTimeout(timer); } catch (eT2) { }
                resolve(url);
              })
              .catch(function (eU) {
                if (finished) return;
                finished = true;
                try { clearTimeout(timer); } catch (eT3) { }
                reject(eU);
              });
          } catch (eU2) {
            if (finished) return;
            finished = true;
            try { clearTimeout(timer); } catch (eT4) { }
            reject(eU2);
          }
        }
      );
    } catch (e0) { reject(e0); }
  });
}

/* =========================================================================================
   âœ… Direct upload with progress (××§×•×‘×¥ 1)
   ========================================================================================= */
function uploadPostImageEx(blobOrFile, contentType, ext, postId, uid, onProgress) {
  return new Promise(function (resolve, reject) {
    try {
      if (!blobOrFile || !postId || !uid) { reject("missing params"); return; }

      var safeExt = safeText(ext || "").toLowerCase();
      if (!safeExt) safeExt = "jpg";
      if (safeExt.length > 8) safeExt = "jpg";

      var name = Date.now() + "_" + uid + "." + safeExt;
      var ref = firebase.storage().ref("post-images/" + postId + "/" + name);

      var meta = {};
      try { if (contentType) meta.contentType = contentType; } catch (eM) { }

      var task = null;
      try { task = ref.put(blobOrFile, meta); }
      catch (ePut) { task = ref.put(blobOrFile); }

      task.on("state_changed",
        function (snap) {
          try {
            if (!snap) return;
            var bytes = Number(snap.bytesTransferred || 0);
            var total = Number(snap.totalBytes || 0);
            if (total > 0) {
              var pct = Math.round((bytes / total) * 100);
              if (typeof onProgress === "function") onProgress(pct);
            }
          } catch (eP) { }
        },
        function (err) { reject(err); },
        function () {
          try {
            task.snapshot.ref.getDownloadURL()
              .then(function (url) { resolve(url); })
              .catch(reject);
          } catch (eU) { reject(eU); }
        }
      );
    } catch (e0) { reject(e0); }
  });
}
</script>

</body>
</html>