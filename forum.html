<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>פורום מאובטח</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- כאן נמצא firebase.initializeApp + const db = firebase.database(); -->
  <script src="firebaseConfig.js"></script>
</head>
<body>

  <h1>פורום</h1>
  <div id="posts">טוען...</div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {

    // 1. הגנה – לעבוד רק מתוך WebView של אנדרואיד
    const ua = navigator.userAgent.toLowerCase();
    if (!(ua.includes("wv") || ua.includes("android"))) {
      window.location.href = "forbidden.html";
      return;
    }

    // 2. מחכים ל-token מהאפליקציה
    let token = "";

    function waitForToken() {
      try {
        token = window.AppInventor.getWebViewString();
      } catch (e) {
        token = "";
      }

      // אם אין token עדיין – מחכים עוד קצת
      if (!token || token === "0" || token === "null") {
        setTimeout(waitForToken, 400);
        return;
      }

      // יש token → בודקים בפיירבייס
      validateToken(token);
    }

    waitForToken();

    // 3. אימות token בפיירבייס
    function validateToken(token) {
      db.ref("users").once("value").then(function (snap) {
        let approved = false;

        snap.forEach(function (child) {
          const u = child.val();
          if (u.token == token && u.approved === true) {
            approved = true;
          }
        });

        if (!approved) {
          // token לא קיים / לא מאושר → בלוק
          window.location.href = "forbidden.html";
          return;
        }

        // מאושר → טוענים פוסטים
        loadPosts();
      }).catch(function () {
        document.getElementById("posts").innerText = "שגיאה בטעינת הנתונים.";
      });
    }

    // 4. טעינת פוסטים מה־DB
    function loadPosts() {
      db.ref("posts").once("value").then(function (snap) {
        let html = "";

        snap.forEach(function (pSnap) {
          const p = pSnap.val();
          html +=
            '<div style="border:1px solid #ccc;padding:12px;margin:8px;">' +
              '<h3>' + (p.title || '') + '</h3>' +
              '<p>' + (p.text || '') + '</p>' +
              '<small>מאת: ' + (p.author || '') + '</small>' +
            '</div>';
        });

        if (!html) {
          html = "<p>אין עדיין פוסטים.</p>";
        }

        document.getElementById("posts").innerHTML = html;
      }).catch(function () {
        document.getElementById("posts").innerText = "שגיאה בטעינת הפוסטים.";
      });
    }

  });
  </script>

</body>
</html>