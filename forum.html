<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>פורום מאובטח</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- firebase.initializeApp + const db -->
  <script src="firebaseConfig.js"></script>
</head>
<body>

  <h1>פורום</h1>
  <div id="posts">טוען...</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  /* =========================
     שכבה 1 – זיהוי WebView
     ========================= */

  const isKodularWebView =
    window.AppInventor &&
    typeof window.AppInventor.getWebViewString === "function";

  if (!isKodularWebView) {
    // דפדפן רגיל – חסימה מיידית
    window.location.href = "forbidden.html";
    return;
  }

  /* =========================
     שכבה 2 – Timeout על token
     ========================= */

  let tokenReceived = false;

  setTimeout(function () {
    if (!tokenReceived) {
      // WebView אבל לא מהאפליקציה / בלי token
      window.location.href = "forbidden.html";
    }
  }, 2000);

  /* =========================
     שכבה 3 – קבלת token
     ========================= */

  function waitForToken() {
    let token = "";

    try {
      token = window.AppInventor.getWebViewString();
    } catch (e) {
      token = "";
    }

    if (token && token !== "0" && token !== "null") {
      tokenReceived = true;
      validateToken(token);
    } else {
      setTimeout(waitForToken, 300);
    }
  }

  waitForToken();

  /* =========================
     שכבה 4 – אימות token
     ========================= */

  function validateToken(token) {
    db.ref("users").once("value").then(function (snap) {

      let approved = false;

      snap.forEach(function (child) {
        const u = child.val();
        if (u.token == token && u.approved === true) {
          approved = true;
        }
      });

      if (!approved) {
        window.location.href = "forbidden.html";
        return;
      }

      // משתמש מאושר
      loadPosts();

    }).catch(function () {
      document.getElementById("posts").innerText =
        "שגיאה בטעינת הנתונים.";
    });
  }

  /* =========================
     טעינת פוסטים
     ========================= */

  function loadPosts() {
    db.ref("posts").once("value").then(function (snap) {

      let html = "";

      snap.forEach(function (pSnap) {
        const p = pSnap.val();
        html += `
          <div style="border:1px solid #ccc;padding:12px;margin:8px;">
            <h3>${p.title || ""}</h3>
            <p>${p.text || ""}</p>
            <small>מאת: ${p.author || ""}</small>
          </div>
        `;
      });

      if (!html) {
        html = "<p>אין עדיין פוסטים.</p>";
      }

      document.getElementById("posts").innerHTML = html;

    }).catch(function () {
      document.getElementById("posts").innerText =
        "שגיאה בטעינת הפוסטים.";
    });
  }

});
</script>

</body>
</html>