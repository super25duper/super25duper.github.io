<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¤×•×¨×•× ×××•×‘×˜×—</title>

  <!-- ===============================
       Firebase SDKs
       =============================== -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- ===============================
       Base CSS
       =============================== -->
  <link rel="stylesheet" href="css/forum.css">

  <style>
    /* =========================================================
       NOTE:
       ×œ×¤×™ ×“×¨×™×©×” ××¤×•×¨×©×ª:
       âŒ ××™×Ÿ ×× ×™××¦×™×•×ª ×œ×—×™×¦×”
       âŒ ××™×Ÿ scale / opacity / active effects
       ========================================================= */

    .post {
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    button {
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>

<body>

<header class="top-bar">
  <h1>×¤×•×¨×•× ×”×‘× ×™×™×“×™×!</h1>
</header>

<!-- =========================================================
     Pull To Refresh Indicator
     ========================================================= -->
<div id="pull-indicator" style="
  display:none;
  text-align:center;
  padding:6px;
  user-select:none;
">
  <div class="loader"></div>
</div>

<!-- =========================================================
     Top Actions: Create / Search / Sort
     ========================================================= -->
<div id="top-actions" style="
  max-width:900px;
  margin:auto;
  padding:10px 20px 0 20px;
  box-sizing:border-box;
">
  <div style="
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  ">
    <button id="openCreatePost" type="button"
      style="
        padding:10px 12px;
        border-radius:10px;
        border:none;
        background:rgb(17,17,87);
        color:#fff;
        cursor:pointer;
        font-weight:bold;
      ">
      â• ×¦×•×¨ ×¤×•×¡×˜
    </button>

    <input id="searchBox" type="search" placeholder="×—×™×¤×•×© ×‘×¤×•×¡×˜×™×..."
      style="
        flex:1;
        min-width:180px;
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(0,0,0,0.15);
        outline:none;
        box-sizing:border-box;
      "
    />

    <select id="sortMode"
      style="
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(0,0,0,0.15);
        outline:none;
        background:#fff;
        cursor:pointer;
      ">
      <option value="newest">×—×“×©×™× ×œ××¢×œ×”</option>
      <option value="oldest">×™×©× ×™× ×œ××¢×œ×”</option>
      <option value="author">×œ×¤×™ ××—×‘×¨</option>
      <option value="title">×œ×¤×™ ×›×•×ª×¨×ª</option>
    </select>
  </div>

  <div id="statusBar"
    style="
      margin-top:10px;
      padding:8px 10px;
      border-radius:10px;
      background:rgba(0,0,0,0.04);
      color:#111;
      font-size:13px;
      display:none;
    ">
  </div>
</div>

<!-- =========================================================
     Posts Container
     ========================================================= -->
<main class="forum-container">
  <div id="posts">
    <div class="loader"></div>
  </div>
</main>

<!-- =========================================================
     Create Post Modal
     ========================================================= -->
<div id="createPostOverlay" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  box-sizing:border-box;
  z-index:9999;
">
  <div style="
    width:min(720px,100%);
    background:#fff;
    border-radius:16px;
    padding:16px;
    box-sizing:border-box;
  ">

    <div style="display:flex;justify-content:space-between;align-items:center;">
      <strong>×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×©</strong>
      <button id="closeCreatePost" type="button">âœ•</button>
    </div>

    <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
      <input id="newPostTitle" placeholder="×›×•×ª×¨×ª" maxlength="80">
      <textarea id="newPostText" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜..." rows="6" maxlength="2000"></textarea>

      <div style="display:flex;justify-content:space-between;">
        <button id="submitPost">×¤×¨×¡×</button>
        <button id="cancelPost">×‘×™×˜×•×œ</button>
      </div>

      <div id="createPostError" style="display:none;color:#8a0000;"></div>
    </div>

  </div>
</div>

<script>
/* =========================================================================================
   ğŸ”’ SECURITY GUARD â€“ CRITICAL
   ========================================================================================= */
(function () {
  try {
    if (
      !window.AppInventor ||
      typeof window.AppInventor.getWebViewString !== "function"
    ) {
      location.replace("forbidden.html");
      throw new Error("Not WebView");
    }
  } catch (e) {
    location.replace("forbidden.html");
    throw e;
  }
})();

/* =========================================================================================
   Utilities
   ========================================================================================= */
function escapeHTML(str="") {
  return String(str)
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}
function nowTs(){ return Date.now(); }

/* =========================================================================================
   Global State
   ========================================================================================= */
let payload = null;
let uid = null;
let realUsername = "××©×ª××©";
let isAuthed = false;
let isRefreshing = false;
let postsCache = [];
let renderedHtml = "";
let lastNavAt = 0;
let lastPostId = "";

/* =========================================================================================
   Cache Preview (UI only)
   ========================================================================================= */
const cached = sessionStorage.getItem("cachedPosts");
if (cached) {
  const host = document.getElementById("posts");
  if (host) host.innerHTML = cached;
}

/* =========================================================================================
   DOM Ready
   ========================================================================================= */
document.addEventListener("DOMContentLoaded", function () {

  const postsEl = document.getElementById("posts");
  const statusBar = document.getElementById("statusBar");

  /* ---------------- Status Helper ---------------- */
  function setStatus(msg, type="info") {
    if (!msg) {
      statusBar.style.display="none";
      return;
    }
    statusBar.style.display="block";
    statusBar.textContent=msg;
  }

  /* ---------------- Navigation ---------------- */
  postsEl.addEventListener("click", function(e){
    const post = e.target.closest(".post");
    if (!post) return;

    const id = post.dataset.id;
    if (!id) return;

    const now = Date.now();
    if (now - lastNavAt < 400 && lastPostId === id) return;

    lastNavAt = now;
    lastPostId = id;

    sessionStorage.setItem("currentPost", JSON.stringify({
      id,
      title: post.querySelector("h3")?.innerText || "",
      text: post.querySelector("p")?.innerText || "",
      author: post.querySelector("small")?.innerText.replace("×××ª:","").trim() || ""
    }));

    location.href = "post.html?postId=" + encodeURIComponent(id);
  });

  /* =====================================================================================
     Payload Wait (Fail-Safe)
     ===================================================================================== */
  let payloadAttempts = 0;
  const MAX_ATTEMPTS = 50;

  function waitForPayload() {
    payloadAttempts++;
    if (payloadAttempts > MAX_ATTEMPTS) {
      location.replace("forbidden.html");
      return;
    }

    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload,200);
      payload = JSON.parse(raw);
    } catch {
      return setTimeout(waitForPayload,200);
    }

    login(payload);
  }

  /* =====================================================================================
     Firebase Auth + Token Validation
     ===================================================================================== */
  function login(data) {
    firebase.auth()
      .signInWithEmailAndPassword(data.email, data.password)
      .then(c => validateToken(c.user.uid, data.token))
      .catch(()=>location.replace("forbidden.html"));
  }

  function validateToken(userId, token) {
    firebase.database().ref("sessions/"+userId+"/token").once("value")
      .then(s=>{
        if (!s.exists() || s.val()!==token) {
          location.replace("forbidden.html");
          return;
        }

        uid = userId;
        isAuthed = true;

        return firebase.database()
          .ref("users/"+uid+"/username")
          .once("value");
      })
      .then(snap=>{
        realUsername = snap.val() || "××©×ª××©";
        setStatus("××—×•×‘×¨ ×›Ö¾"+realUsername,"ok");
        loadPosts();
        attachLive();
      })
      .catch(()=>location.replace("forbidden.html"));
  }

  /* =====================================================================================
     Load Posts
     ===================================================================================== */
  function loadPosts() {
    setStatus("×˜×•×¢×Ÿ ×¤×•×¡×˜×™×â€¦");

    firebase.database().ref("posts")
      .orderByChild("time")
      .limitToLast(300)
      .once("value")
      .then(snap=>{
        const list=[];
        snap.forEach(p=>{
          const v=p.val()||{};
          list.push({
            id:p.key,
            title:v.title||"",
            text:v.text||"",
            author:v.author||"",
            time:v.time||0
          });
        });

        list.sort((a,b)=>b.time-a.time);
        postsCache=list;
        renderPosts();
        sessionStorage.setItem("cachedPosts",renderedHtml);
        setStatus("×¤×•×¡×˜×™× × ×˜×¢× ×•","ok");
      });
  }

  function renderPosts(){
    let html="";
    for(const p of postsCache){
      html+=`
        <div class="post" data-id="${escapeHTML(p.id)}">
          <h3>${escapeHTML(p.title)}</h3>
          <p>${escapeHTML(p.text)}</p>
          <small>×××ª: ${escapeHTML(p.author)}</small>
        </div>
      `;
    }
    postsEl.innerHTML=html||"<p>××™×Ÿ ×¤×•×¡×˜×™×.</p>";
    renderedHtml=html;
  }

  /* =====================================================================================
     Live Updates
     ===================================================================================== */
  function attachLive(){
    if (window.__liveAttached) return;
    window.__liveAttached=true;

    firebase.database().ref("posts").limitToLast(50)
      .on("child_added",snap=>{
        if(postsCache.some(p=>p.id===snap.key)) return;
        const v=snap.val()||{};
        postsCache.unshift({
          id:snap.key,
          title:v.title||"",
          text:v.text||"",
          author:v.author||"",
          time:v.time||0
        });
        renderPosts();
      });
  }

  /* =====================================================================================
     Start
     ===================================================================================== */
  waitForPayload();

});
</script>

</body>
</html>