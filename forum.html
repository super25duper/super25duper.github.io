<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>פורום מאובטח</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebaseConfig.js"></script>

</head>
<body>

<h1>פורום</h1>

<div id="posts">טוען...</div>

<script>
// 1. בדיקת WebView (ולא דפדפן רגיל)
const ua = navigator.userAgent.toLowerCase();
if (!(ua.includes("wv") || ua.includes("android"))) {
    window.location.href = "forbidden.html";
}

// 2. קבלת token מהאפליקציה (WebViewString)
function getToken() {
    try {
        return window.AppInventor.getWebViewString();
    } catch (e) {
        return "";
    }
}

let token = "";
let interval = setInterval(() => {
    token = getToken();
    if (token) {
        clearInterval(interval);
        validateToken(token);
    }
}, 150);

// 3. אימות token בפיירבייס
function validateToken(token) {
    db.ref("users").once("value").then(snap => {
        let ok = false;

        snap.forEach(child => {
            const u = child.val();
            if (u.token === token && u.approved === true) ok = true;
        });

        if (!ok) {
            window.location.href = "forbidden.html";
            return;
        }

        // אם הכל טוב — טוענים פוסטים
        loadPosts();
    });
}

// 4. טעינת פוסטים
function loadPosts() {
    db.ref("posts").once("value").then(snap => {
        let html = "";
        snap.forEach(pSnap => {
            const p = pSnap.val();
            html += `
                <div style="border:1px solid #ccc;padding:12px;margin:8px;">
                    <h3>${p.title}</h3>
                    <p>${p.text}</p>
                    <small>מאת: ${p.author}</small>
                </div>`;
        });

        if (html === "") {
            html = "<p>אין עדיין פוסטים.</p>";
        }

        document.getElementById("posts").innerHTML = html;
    });
}
</script>

</body>
</html>
