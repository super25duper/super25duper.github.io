<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>פורום מאובטח</title>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebaseConfig.js"></script>

</head>
<body>

<h1>פורום</h1>

<!-- תיבת לוג -->
<div id="log" style="padding:15px;font-size:18px;background:#eee;border:1px solid #ccc;margin-bottom:10px;">
נטען...
</div>

<!-- תיבת פוסטים -->
<div id="posts">טוען...</div>

<script>

function log(msg) {
    document.getElementById("log").innerText = "לוג: " + msg;
}

// 0. בדיקת WebView
log("בודק WebView...");

const ua = navigator.userAgent.toLowerCase();
if (!(ua.includes("wv") || ua.includes("android"))) {
    log("לא WebView → הפניה ל-forbidden.html");
    window.location.href = "forbidden.html";
}

// 1. התחברות לפיירבייס
log("Firebase נטען...");

const db = firebase.database();

// 2. המתנה ל-token מהאפליקציה
let token = "";

function waitForToken() {

    try {
        token = window.AppInventor.getWebViewString();
    } catch(e) {
        token = "";
    }

    if (!token) {
        log("ממתין ל-token... ערך נוכחי: [" + token + "]");
        setTimeout(waitForToken, 500);
        return;
    }

    log("קיבלתי token: " + token);

    validateToken(token);
}

waitForToken();

// 3. אימות token בפיירבייס
function validateToken(token) {

    log("בודק token בפיירבייס...");

    db.ref("users").once("value").then(snap => {

        let approved = false;

        snap.forEach(child => {
            const u = child.val();
            if (u.token === token && u.approved === true) {
                approved = true;
            }
        });

        if (!approved) {
            log("token לא מאומת → הפניה ל-forbidden.html");
            window.location.href = "forbidden.html";
            return;
        }

        log("token תקין! טוען פוסטים...");

        loadPosts();
    })
    .catch(err => {
        log("שגיאת Firebase: " + err.message);
    });
}

// 4. טעינת פוסטים
function loadPosts() {

    db.ref("posts").once("value").then(snap => {

        let html = "";

        snap.forEach(pSnap => {
            const p = pSnap.val();
            html += `
                <div style="border:1px solid #ccc;padding:12px;margin:8px;">
                    <h3>${p.title}</h3>
                    <p>${p.text}</p>
                    <small>מאת: ${p.author}</small>
                </div>
            `;
        });

        if (html === "") html = "<p>אין עדיין פוסטים.</p>";

        document.getElementById("posts").innerHTML = html;

        log("הפוסטים נטענו בהצלחה!");
    });
}

</script>
</body>
</html>