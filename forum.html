<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>פורום מאובטח</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">

  <style>
    /* NOTE: לפי הבקשה שלך – בלי ההנפשה ההיא */
    /* אם תרצה אפקט עדין אחר בהמשך – נעשה, אבל כרגע "אפס אנימציות" */
  </style>
</head>

<body>

<header class="top-bar">
  <h1>פורום הבניידים!</h1>
</header>

<!-- Pull To Refresh indicator -->
<div id="pull-indicator" style="
  display:none;
  text-align:center;
  padding:6px;
  user-select:none;
">
  <div class="loader"></div>
</div>

<!-- ======= TOP ACTIONS (New Post + Search + Sort) ======= -->
<div id="top-actions" style="
  max-width:900px;
  margin:auto;
  padding: 10px 20px 0 20px;
  box-sizing:border-box;
">
  <div style="
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
  ">
    <button id="openCreatePost" type="button" style="
      padding:10px 12px;
      border-radius:10px;
      border:none;
      background: rgb(17,17,87);
      color:#fff;
      cursor:pointer;
      font-weight:bold;
    ">➕ צור פוסט</button>

    <input id="searchBox" type="search" placeholder="חיפוש בפוסטים..."
      style="
        flex:1;
        min-width:180px;
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(0,0,0,0.15);
        outline:none;
        box-sizing:border-box;
      "
    />

    <select id="sortMode" style="
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.15);
      outline:none;
      background:#fff;
      cursor:pointer;
    ">
      <option value="newest">מיון: החדשים למעלה</option>
      <option value="oldest">מיון: הישנים למעלה</option>
      <option value="author">מיון: לפי מחבר</option>
      <option value="title">מיון: לפי כותרת</option>
    </select>
  </div>

  <div id="statusBar" style="
    margin-top:10px;
    padding:8px 10px;
    border-radius:10px;
    background: rgba(0,0,0,0.04);
    color:#111;
    font-size:13px;
    display:none;
  "></div>
</div>

<main class="forum-container">
  <div id="posts">
    <div class="loader"></div>
  </div>
</main>

<!-- ======= CREATE POST MODAL (UI ONLY, AUTH STILL REQUIRED) ======= -->
<div id="createPostOverlay" style="
  position:fixed;
  inset:0;
  background: rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  box-sizing:border-box;
  z-index:9999;
">
  <div id="createPostModal" style="
    width:min(720px, 100%);
    background:#fff;
    border-radius:16px;
    padding:16px;
    box-sizing:border-box;
  ">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:bold; font-size:18px;">יצירת פוסט חדש</div>
      <button id="closeCreatePost" type="button" style="
        border:none;
        background:transparent;
        font-size:18px;
        cursor:pointer;
      ">✕</button>
    </div>

    <div style="margin-top:12px; display:flex; flex-direction:column; gap:10px;">
      <input id="newPostTitle" type="text" placeholder="כותרת"
        maxlength="80"
        style="
          padding:12px;
          border-radius:12px;
          border:1px solid rgba(0,0,0,0.18);
          outline:none;
          box-sizing:border-box;
        "
      />

      <textarea id="newPostText" placeholder="תוכן הפוסט..."
        rows="6"
        maxlength="2000"
        style="
          padding:12px;
          border-radius:12px;
          border:1px solid rgba(0,0,0,0.18);
          outline:none;
          box-sizing:border-box;
          resize:vertical;
        "
      ></textarea>

      <!-- =====================================================================================
           ✅ תמיכה בתמונות (שדרוג מלא)
           - בחירה מתוך גלריה/קבצים
           - Preview
           - הסרה
           - חיווי העלאה
           - בלי לשבור אבטחה: העלאה מתבצעת רק אחרי validateToken (isAuthed + uid)
           ===================================================================================== -->
      <div id="imageBlock" style="
        border:1px dashed rgba(0,0,0,0.18);
        border-radius:12px;
        padding:12px;
        box-sizing:border-box;
        background: rgba(0,0,0,0.02);
      ">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:bold;">תמונה (אופציונלי)</div>

          <label for="newPostImage" style="
            padding:8px 12px;
            border-radius:10px;
            border:1px solid rgba(0,0,0,0.15);
            background:#fff;
            cursor:pointer;
            font-weight:bold;
          ">בחר תמונה</label>

          <input id="newPostImage" type="file" accept="image/*" style="display:none;" />
        </div>

        <div id="imageRulesHint" style="margin-top:10px; font-size:12px; color:#444; line-height:1.5;">
          מותר: JPG/PNG/WEBP/GIF • מומלץ עד 3MB • אם הקובץ גדול/לא תקין – הוא ייחסם.
        </div>

        <div id="imagePreviewWrap" style="
          display:none;
          margin-top:12px;
          border-radius:12px;
          border:1px solid rgba(0,0,0,0.12);
          overflow:hidden;
          background:#fff;
        ">
          <div style="display:flex; gap:12px; padding:10px; align-items:flex-start; flex-wrap:wrap;">
            <div style="width:160px; max-width:100%;">
              <img id="imagePreview" alt="preview" style="
                width:160px;
                height:160px;
                object-fit:cover;
                border-radius:10px;
                border:1px solid rgba(0,0,0,0.10);
                display:block;
              " />
            </div>

            <div style="flex:1; min-width:200px;">
              <div id="imageInfo" style="font-size:13px; color:#111; line-height:1.6;"></div>

              <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                <button id="removeImage" type="button" style="
                  padding:8px 12px;
                  border-radius:10px;
                  border:1px solid rgba(255,0,0,0.35);
                  background:rgba(255,0,0,0.06);
                  cursor:pointer;
                  font-weight:bold;
                ">הסר תמונה</button>
              </div>

              <div id="imageUploadProgressWrap" style="
                display:none;
                margin-top:12px;
              ">
                <div style="font-size:12px; opacity:.8; margin-bottom:6px;">מעלה תמונה…</div>
                <div style="
                  width:100%;
                  height:10px;
                  border-radius:999px;
                  background: rgba(0,0,0,0.08);
                  overflow:hidden;
                ">
                  <div id="imageUploadProgress" style="
                    width:0%;
                    height:100%;
                    background: rgb(17,17,87);
                    border-radius:999px;
                  "></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="imageError" style="
          display:none;
          margin-top:10px;
          padding:10px 12px;
          border-radius:12px;
          background: rgba(255,0,0,0.08);
          color:#8a0000;
          font-size:13px;
        "></div>
      </div>
      <!-- =====================================================================================
           ✅ סוף תמיכה בתמונות
           ===================================================================================== -->

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div id="newPostHint" style="font-size:12px; color:#444;">
          טיפ: תכתוב ברור, ותשאיר מקום לתגובות.
        </div>
        <div style="display:flex; gap:10px;">
          <button id="submitPost" type="button" style="
            padding:10px 14px;
            border-radius:12px;
            border:none;
            background: rgb(17,17,87);
            color:#fff;
            cursor:pointer;
            font-weight:bold;
          ">פרסם</button>
          <button id="cancelPost" type="button" style="
            padding:10px 14px;
            border-radius:12px;
            border:1px solid rgba(0,0,0,0.18);
            background:#fff;
            cursor:pointer;
            font-weight:bold;
          ">ביטול</button>
        </div>
      </div>

      <div id="createPostError" style="
        display:none;
        padding:10px 12px;
        border-radius:12px;
        background: rgba(255,0,0,0.08);
        color:#8a0000;
        font-size:13px;
      "></div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

<script>
/* =========================================================================================
   ⚠️ חשוב: אבטחה – לא נוגעים ולא משנים שיטה
   1) חסימה מיידית – לא WebView => forbidden.html
   2) payload מקודולר (email/password/token)
   3) Firebase Auth
   4) אימות token מול sessions/{uid}/token
   רק אחרי זה: גישה לפוסטים/יצירה/רענון
   ========================================================================================= */

/* ===============================
   חסימה מיידית – לא WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor || typeof window.AppInventor.getWebViewString !== "function") {
      location.replace("forbidden.html");
      return;
    }
  } catch (e) {
    location.replace("forbidden.html");
    return;
  }
})();

/* =========================================================================================
   Cache (A) – תצוגה מיידית
   ========================================================================================= */
var cached = null;
try {
  cached = sessionStorage.getItem("cachedPosts");
} catch (e1) {
  cached = null;
}
if (cached) {
  var postsHost = document.getElementById("posts");
  if (postsHost) postsHost.innerHTML = cached;
}

/* =========================================================================================
   Utilities
   ========================================================================================= */
function escapeHTML(str) {
  if (str === undefined || str === null) str = "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function safeText(str) {
  if (str === undefined || str === null) str = "";
  return String(str);
}

function nowTs() {
  return Date.now();
}

function setStatus(msg, type) {
  if (type === undefined || type === null) type = "info";
  var bar = document.getElementById("statusBar");
  if (!bar) return;

  if (!msg) {
    bar.style.display = "none";
    bar.textContent = "";
    return;
  }

  bar.style.display = "block";
  bar.textContent = msg;

  if (type === "error") {
    bar.style.background = "rgba(255,0,0,0.08)";
    bar.style.color = "#8a0000";
  } else if (type === "ok") {
    bar.style.background = "rgba(0,128,0,0.08)";
    bar.style.color = "#0b5a0b";
  } else {
    bar.style.background = "rgba(0,0,0,0.04)";
    bar.style.color = "#111";
  }
}

function debounce(fn, ms) {
  var t = null;
  return function () {
    var args = arguments;
    clearTimeout(t);
    t = setTimeout(function () {
      fn.apply(null, args);
    }, ms);
  };
}

/* =========================================================================================
   ✅ Image Utilities (שדרוג תמונות)
   ========================================================================================= */
function bytesToSize(bytes) {
  try {
    var b = Number(bytes || 0);
    if (b <= 0) return "0B";
    var sizes = ["B", "KB", "MB", "GB"];
    var i = Math.floor(Math.log(b) / Math.log(1024));
    i = Math.min(i, sizes.length - 1);
    var v = b / Math.pow(1024, i);
    return v.toFixed(v >= 10 || i === 0 ? 0 : 1) + sizes[i];
  } catch (e) {
    return "";
  }
}

function isAllowedImageType(file) {
  try {
    if (!file) return false;
    var t = (file.type || "").toLowerCase();
    if (!t) return false;
    // תמיכה: jpg/png/webp/gif
    return (
      t.indexOf("image/jpeg") === 0 ||
      t.indexOf("image/jpg") === 0 ||
      t.indexOf("image/png") === 0 ||
      t.indexOf("image/webp") === 0 ||
      t.indexOf("image/gif") === 0
    );
  } catch (e) {
    return false;
  }
}

function safeExtFromFile(file) {
  try {
    if (!file || !file.name) return "jpg";
    var parts = String(file.name).split(".");
    if (parts.length < 2) return "jpg";
    var ext = parts.pop().toLowerCase();
    // ניקוי
    ext = ext.replace(/[^a-z0-9]/g, "");
    if (!ext) return "jpg";
    // מוגבלות
    if (ext === "jpeg") return "jpg";
    if (ext === "jpg" || ext === "png" || ext === "webp" || ext === "gif") return ext;
    return "jpg";
  } catch (e) {
    return "jpg";
  }
}

/* =========================================================================================
   Global State
   ========================================================================================= */
var payload = null;
var uid = null;
var isRefreshing = false;
var isAuthed = false;

var postsCacheData = [];
var renderedHtmlCache = "";
var lastNavAt = 0;
var lastOpenId = "";
var pullStartY = 0;
var pulling = false;
var didTriggerRefresh = false;
var realUsername = "משתמש";

/* =========================================================================================
   ✅ Image State (שדרוג תמונות)
   ========================================================================================= */
var selectedImageFile = null;
var selectedImageObjectUrl = "";
var imageUploadInFlight = false;

/* =========================================================================================
   DOM Ready
   ========================================================================================= */
document.addEventListener("DOMContentLoaded", function () {

  /* ===============================
     Elements
     =============================== */
  var postsEl = document.getElementById("posts");
  var indicator = document.getElementById("pull-indicator");

  var searchBox = document.getElementById("searchBox");
  var sortMode = document.getElementById("sortMode");

  var openCreatePostBtn = document.getElementById("openCreatePost");
  var overlay = document.getElementById("createPostOverlay");
  var closeCreatePostBtn = document.getElementById("closeCreatePost");
  var cancelPostBtn = document.getElementById("cancelPost");
  var submitPostBtn = document.getElementById("submitPost");
  var newPostTitle = document.getElementById("newPostTitle");
  var newPostText = document.getElementById("newPostText");
  var createPostError = document.getElementById("createPostError");

  /* ===============================
     ✅ Image Elements (שדרוג תמונות)
     =============================== */
  var newPostImage = document.getElementById("newPostImage");
  var imagePreviewWrap = document.getElementById("imagePreviewWrap");
  var imagePreview = document.getElementById("imagePreview");
  var imageInfo = document.getElementById("imageInfo");
  var removeImageBtn = document.getElementById("removeImage");
  var imageError = document.getElementById("imageError");
  var imageUploadProgressWrap = document.getElementById("imageUploadProgressWrap");
  var imageUploadProgress = document.getElementById("imageUploadProgress");

  /* =====================================================================================
     0) Guard
     ===================================================================================== */
  if (!postsEl) {
    location.replace("forbidden.html");
    return;
  }

  bindPostNavigation(postsEl);

  /* =====================================================================================
     2) Bind Search + Sort
     ===================================================================================== */
  if (searchBox) {
    searchBox.addEventListener("input", debounce(function () {
      renderPostsFromCache();
    }, 120));
  }

  if (sortMode) {
    sortMode.addEventListener("change", function () {
      renderPostsFromCache();
    });
  }

  /* =====================================================================================
     3) Bind Create Post UI (הפעולה עצמה דורשת auth + token)
     ===================================================================================== */
  if (openCreatePostBtn) {
    openCreatePostBtn.addEventListener("click", function () {
      if (!isAuthed) {
        setStatus("עוד לא אומתת מול השרת. חכה שנייה ואז נסה שוב.", "error");
        return;
      }
      openCreatePostModal();
    });
  }

  if (closeCreatePostBtn) closeCreatePostBtn.addEventListener("click", closeCreatePostModal);
  if (cancelPostBtn) cancelPostBtn.addEventListener("click", closeCreatePostModal);

  if (overlay) {
    overlay.addEventListener("click", function (e) {
      if (e.target === overlay) closeCreatePostModal();
    });
  }

  /* =====================================================================================
     ✅ Bind Image Picker (שדרוג תמונות)
     ===================================================================================== */
  if (newPostImage) {
    newPostImage.addEventListener("change", function () {
      imageErrorHide();

      var f = null;
      try {
        if (newPostImage.files && newPostImage.files[0]) f = newPostImage.files[0];
      } catch (e) {
        f = null;
      }

      if (!f) {
        resetSelectedImage(true);
        return;
      }

      // חוקים (UX) – לא מחליף אבטחה ב-Rules, רק מונע טעויות
      var MAX_BYTES = 3 * 1024 * 1024; // 3MB
      if (!isAllowedImageType(f)) {
        resetSelectedImage(true);
        imageErrorShow("סוג קובץ לא נתמך. מותר: JPG/PNG/WEBP/GIF.");
        return;
      }
      if (Number(f.size || 0) > MAX_BYTES) {
        resetSelectedImage(true);
        imageErrorShow("הקובץ גדול מדי. מומלץ עד 3MB.");
        return;
      }

      selectedImageFile = f;

      // Preview
      try {
        if (selectedImageObjectUrl) {
          try { URL.revokeObjectURL(selectedImageObjectUrl); } catch (e2) {}
          selectedImageObjectUrl = "";
        }
      } catch (e3) {}

      try {
        selectedImageObjectUrl = URL.createObjectURL(f);
        if (imagePreview) imagePreview.src = selectedImageObjectUrl;
      } catch (e4) {
        // fallback FileReader
        try {
          var reader = new FileReader();
          reader.onload = function (ev) {
            try {
              if (imagePreview) imagePreview.src = ev.target.result;
            } catch (e5) {}
          };
          reader.readAsDataURL(f);
        } catch (e6) {}
      }

      if (imageInfo) {
        var nm = safeText(f.name || "image");
        var sz = bytesToSize(f.size || 0);
        imageInfo.innerHTML =
          "<div><b>קובץ:</b> " + escapeHTML(nm) + "</div>" +
          "<div><b>גודל:</b> " + escapeHTML(sz) + "</div>" +
          "<div style='opacity:.75; font-size:12px; margin-top:6px;'>התמונה תישמר ב־Storage ותופיע בפוסט.</div>";
      }

      if (imagePreviewWrap) imagePreviewWrap.style.display = "block";

      // איפוס progress
      imageProgressHide();
      imageProgressSet(0);
    });
  }

  if (removeImageBtn) {
    removeImageBtn.addEventListener("click", function () {
      resetSelectedImage(false);
    });
  }

  function imageErrorShow(msg) {
    if (!imageError) return;
    imageError.textContent = msg;
    imageError.style.display = "block";
  }

  function imageErrorHide() {
    if (!imageError) return;
    imageError.textContent = "";
    imageError.style.display = "none";
  }

  function imageProgressShow() {
    if (!imageUploadProgressWrap) return;
    imageUploadProgressWrap.style.display = "block";
  }

  function imageProgressHide() {
    if (!imageUploadProgressWrap) return;
    imageUploadProgressWrap.style.display = "none";
  }

  function imageProgressSet(pct) {
    if (!imageUploadProgress) return;
    var v = Number(pct || 0);
    v = Math.max(0, Math.min(100, v));
    imageUploadProgress.style.width = v + "%";
  }

  function resetSelectedImage(keepInput) {
    selectedImageFile = null;

    try {
      if (selectedImageObjectUrl) {
        try { URL.revokeObjectURL(selectedImageObjectUrl); } catch (e1) {}
      }
    } catch (e2) {}
    selectedImageObjectUrl = "";

    if (imagePreview) imagePreview.removeAttribute("src");
    if (imageInfo) imageInfo.innerHTML = "";
    if (imagePreviewWrap) imagePreviewWrap.style.display = "none";

    imageErrorHide();
    imageProgressHide();
    imageProgressSet(0);

    if (!keepInput && newPostImage) {
      try { newPostImage.value = ""; } catch (e3) {}
    }
  }

  /* =====================================================================================
     ✅ Submit Post (כולל תמונה) – לא שוברים כלום, רק מוסיפים
     ===================================================================================== */
  if (submitPostBtn) {
    submitPostBtn.addEventListener("click", function () {
      createPostErrorHide();

      if (!isAuthed) {
        createPostErrorShow("אתה לא מאומת עדיין. נסה שוב עוד רגע.");
        return;
      }

      var t1 = "";
      var t2 = "";
      if (newPostTitle && typeof newPostTitle.value === "string") t1 = newPostTitle.value;
      if (newPostText && typeof newPostText.value === "string") t2 = newPostText.value;

      var title = safeText(t1).trim();
      var text = safeText(t2).trim();

      if (title.length < 3) {
        createPostErrorShow("כותרת קצרה מדי. מינימום 3 תווים.");
        return;
      }
      if (text.length < 3) {
        createPostErrorShow("תוכן קצר מדי. מינימום 3 תווים.");
        return;
      }

      publishPost(title, text);
    });
  }

  /* =====================================================================================
     4) Pull To Refresh – נשמר בדיוק
     ===================================================================================== */
  document.addEventListener("touchstart", function (e) {
    try {
      if (window.scrollY === 0 && !isRefreshing) {
        pullStartY = e.touches[0].clientY;
        pulling = true;
        didTriggerRefresh = false;
      }
    } catch (err1) { }
  }, { passive: true });

  document.addEventListener("touchmove", function (e) {
    if (!pulling || isRefreshing) return;

    var diff = e.touches[0].clientY - pullStartY;
    if (diff <= 0) return;

    if (indicator) indicator.style.display = "block";

    var THRESHOLD = 90;
    if (diff > THRESHOLD && !didTriggerRefresh) {
      didTriggerRefresh = true;
      pulling = false;
      isRefreshing = true;

      try { sessionStorage.removeItem("cachedPosts"); } catch (err2) { }

      loadPosts(true);
    }

  }, { passive: true });

  document.addEventListener("touchend", function () {
    pulling = false;
    if (!isRefreshing && indicator) indicator.style.display = "none";
  }, { passive: true });

  /* =====================================================================================
     5) Start Auth Flow
     ===================================================================================== */
  waitForPayload();

  function waitForPayload() {
    var raw = "";
    try {
      raw = window.AppInventor.getWebViewString();
      if (!raw) {
        setTimeout(waitForPayload, 200);
        return;
      }
      payload = JSON.parse(raw);
    } catch (e) {
      setTimeout(waitForPayload, 200);
      return;
    }

    loginToFirebase(payload);
  }

  function loginToFirebase(data) {
    if (!data || !data.email || !data.password || !data.token) {
      location.replace("forbidden.html");
      return;
    }

    firebase.auth()
      .signInWithEmailAndPassword(data.email, data.password)
      .then(function (c) {
        validateToken(c.user.uid, data.token);
      })
      .catch(function () {
        location.replace("forbidden.html");
      });
  }

  function validateToken(userId, token) {
    firebase.database()
      .ref("sessions/" + userId + "/token")
      .once("value")
      .then(function (snap) {
        if (!snap.exists() || snap.val() !== token) {
          location.replace("forbidden.html");
          return;
        }

        uid = userId;
        isAuthed = true;

        firebase.database()
          .ref("users/" + uid + "/username")
          .once("value")
          .then(function (uSnap) {
            realUsername = uSnap.val() || "משתמש";
            setStatus("מחובר כ־" + realUsername, "ok");

            loadPosts(false);
            attachLivePostListeners();
          })
          .catch(function () {
            realUsername = "משתמש";
            setStatus("מחובר", "ok");
            loadPosts(false);
            attachLivePostListeners();
          });
      })
      .catch(function () {
        location.replace("forbidden.html");
      });
  }

  function loadPosts(fromRefresh) {
    if (fromRefresh === undefined || fromRefresh === null) fromRefresh = false;
    setStatus(fromRefresh ? "מרענן פוסטים…" : "טוען פוסטים…", "info");

    firebase.database()
      .ref("posts")
      .orderByChild("time")
      .limitToLast(300)
      .once("value")
      .then(function (snap) {
        var items = [];

        snap.forEach(function (pSnap) {
          var p = pSnap.val() || {};
          var postId = pSnap.key;

          items.push({
            id: postId,
            title: safeText(p.title),
            text: safeText(p.text),
            author: safeText(p.author),
            time: Number(p.time || 0),
            likes: Number(p.likes || 0),
            commentsCount: Number(p.commentsCount || 0),

            /* ✅ תמיכה בתמונות */
            image: (p.image === undefined || p.image === null) ? null : safeText(p.image)
          });
        });

        items.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });

        postsCacheData = items;

        renderPostsFromCache();

        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e2) { }

        if (fromRefresh) {
          setTimeout(function () {
            isRefreshing = false;
            if (indicator) indicator.style.display = "none";
            setStatus("עודכן בהצלחה.", "ok");
          }, 250);
        } else {
          setStatus("פוסטים נטענו.", "ok");
        }
      })
      .catch(function () {
        location.replace("forbidden.html");
      });
  }

  function renderPostsFromCache() {
    var q = "";
    var mode = "newest";

    if (searchBox && typeof searchBox.value === "string") q = searchBox.value;
    q = safeText(q).trim().toLowerCase();

    if (sortMode && typeof sortMode.value === "string") mode = sortMode.value;
    mode = safeText(mode) || "newest";

    var list = postsCacheData.slice();

    if (q) {
      list = list.filter(function (p) {
        var t = (p.title || "").toLowerCase();
        var x = (p.text || "").toLowerCase();
        var a = (p.author || "").toLowerCase();
        return t.indexOf(q) !== -1 || x.indexOf(q) !== -1 || a.indexOf(q) !== -1;
      });
    }

    if (mode === "oldest") {
      list.sort(function (a, b) { return (a.time || 0) - (b.time || 0); });
    } else if (mode === "author") {
      list.sort(function (a, b) { return (a.author || "").localeCompare(b.author || "", "he"); });
    } else if (mode === "title") {
      list.sort(function (a, b) { return (a.title || "").localeCompare(b.title || "", "he"); });
    } else {
      list.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });
    }

    var html = "";

    if (!list.length) {
      html = q ? "<p>לא נמצאו תוצאות לחיפוש.</p>" : "<p>אין עדיין פוסטים.</p>";
    } else {
      for (var i = 0; i < list.length; i++) {
        html += buildPostCardHTML(list[i]);
      }
    }

    postsEl.innerHTML = html;
    renderedHtmlCache = html;
  }

  function buildPostCardHTML(p) {
    var title = escapeHTML(p.title || "");
    var text = escapeHTML(p.text || "");
    var author = escapeHTML(p.author || "");
    var id = escapeHTML(p.id || "");

    var timeStr = "";
    if (p.time) {
      try {
        timeStr = new Date(p.time).toLocaleString("he-IL", {
          hour: "2-digit",
          minute: "2-digit",
          day: "2-digit",
          month: "2-digit"
        });
      } catch (e) {
        timeStr = "";
      }
    }

    /* ✅ תמונה (אם קיימת) */
    var imgHtml = "";
    var imgAttr = "";
    if (p.image) {
      var url = safeText(p.image);
      imgAttr = ' data-image="' + escapeHTML(url) + '" ';
      imgHtml =
        '\n        <div class="post-image" style="margin-top:10px;">' +
        '\n          <img src="' + escapeHTML(url) + '" alt="תמונה" style="' +
        'width:100%;max-height:260px;object-fit:cover;border-radius:12px;border:1px solid rgba(0,0,0,0.12);display:block;' +
        '">' +
        '\n        </div>';
    }

    return (
      '\n      <div class="post" data-id="' + id + '"' + imgAttr + '>' +
      '\n        <h3>' + title + '</h3>' +
      '\n        <p>' + text + '</p>' +
      imgHtml +
      '\n        <small>מאת: ' + author + '</small>' +
      '\n        <small style="opacity:.75; margin-top:6px; display:block;">' + escapeHTML(timeStr) + '</small>' +
      '\n      </div>\n    '
    );
  }

  function bindPostNavigation(container) {
    if (container.__navBound) return;
    container.__navBound = true;

    container.addEventListener("click", function (e) {
      if (isRefreshing || pulling) return;

      var postEl = null;
      try { postEl = e.target.closest(".post"); } catch (err) { postEl = null; }
      if (!postEl) return;

      var id = postEl.getAttribute("data-id");
      if (!id) return;

      var now = Date.now();
      if (now - lastNavAt < 350 && lastOpenId === id) return;

      lastNavAt = now;
      lastOpenId = id;

      openPost(id, postEl);
    }, false);
  }

  function openPost(postId, el) {
    try {
      var h3 = el.querySelector("h3");
      var p = el.querySelector("p");
      var s = el.querySelector("small");

      var title = h3 ? (h3.innerText || "") : "";
      var text = p ? (p.innerText || "") : "";
      var author = "";
      if (s) author = (s.innerText || "").replace("מאת:", "").trim();

      /* ✅ שמירת תמונה גם ל-post.html (שדרוג) */
      var img = null;
      var imgUrl = "";
      try {
        imgUrl = el.getAttribute("data-image") || "";
      } catch (e1) {
        imgUrl = "";
      }
      if (!imgUrl) {
        try {
          img = el.querySelector("img");
          if (img && img.getAttribute("src")) imgUrl = img.getAttribute("src");
        } catch (e2) {}
      }

      sessionStorage.setItem("currentPost", JSON.stringify({
        id: postId,
        title: title || "",
        text: text || "",
        author: author || "",
        image: imgUrl || null
      }));
    } catch (e) { }

    location.href = "post.html?postId=" + encodeURIComponent(postId);
  }

  function openCreatePostModal() {
    createPostErrorHide();

    if (newPostTitle) newPostTitle.value = "";
    if (newPostText) newPostText.value = "";

    /* ✅ איפוס תמונה בכל פתיחה (שדרוג) */
    resetSelectedImage(false);

    if (overlay) overlay.style.display = "flex";

    setTimeout(function () {
      try { if (newPostTitle) newPostTitle.focus(); } catch (e) { }
    }, 50);
  }

  function closeCreatePostModal() {
    createPostErrorHide();

    /* ✅ איפוס תמונה בכל סגירה (שדרוג) */
    resetSelectedImage(false);

    if (overlay) overlay.style.display = "none";
  }

  function createPostErrorShow(msg) {
    if (!createPostError) return;
    createPostError.textContent = msg;
    createPostError.style.display = "block";
  }

  function createPostErrorHide() {
    if (!createPostError) return;
    createPostError.textContent = "";
    createPostError.style.display = "none";
  }

  /* =====================================================================================
     ✅ Publish Post – תמיכה מלאה בתמונה
     - אבטחה נשמרת: לא נקרא לפני validateToken
     - לא מקצרים קוד, לא מורידים פיצ'רים
     - לא יוצרים "פוסט כפול": משתמשים ב-push() כדי לקבל key ואז set()
     ===================================================================================== */
  function publishPost(title, text) {
    if (!isAuthed || !uid) {
      createPostErrorShow("אתה לא מאומת. נסה שוב.");
      return;
    }

    if (imageUploadInFlight) {
      createPostErrorShow("יש העלאה בתהליך. חכה רגע.");
      return;
    }

    var btn = submitPostBtn;
    if (btn) btn.disabled = true;

    imageErrorHide();

    // יצירת מזהה פוסט מראש (לנתיב האחסון)
    var newRef = firebase.database().ref("posts").push();
    var newPostId = newRef.key;

    // אובייקט בסיס (כמו שהיה)
    var postObj = {
      title: title,
      text: text,
      author: realUsername,
      time: nowTs()
    };

    // אם אין תמונה – נשמור null
    // אם יש תמונה – נעלה ל-Storage ואז נשמור URL בפוסט
    var hasImage = !!selectedImageFile;

    if (!hasImage) {
      // ✅ בלי תמונה – שמירה רגילה (אבל עם key שכבר יצרנו)
      postObj.image = null;

      newRef
        .set(postObj)
        .then(function () {
          closeCreatePostModal();
          setStatus("הפוסט פורסם בהצלחה.", "ok");

          try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e3) { }

          try { window.scrollTo({ top: 0, behavior: "smooth" }); } catch (e4) { window.scrollTo(0, 0); }
        })
        .catch(function () {
          createPostErrorShow("שגיאה בפרסום. נסה שוב.");
        })
        .finally(function () {
          if (btn) btn.disabled = false;
        });

      return;
    }

    // ✅ עם תמונה – העלאה + progress
    imageUploadInFlight = true;
    imageProgressShow();
    imageProgressSet(2);
    setStatus("מעלה תמונה ומפרסם…", "info");

    uploadPostImageWithProgress(selectedImageFile, newPostId, uid, function (pct) {
      imageProgressSet(pct);
    })
      .then(function (url) {
        // שומר URL בפוסט
        postObj.image = url || null;

        // שמירה ל-DB רק אחרי שיש URL
        return newRef.set(postObj);
      })
      .then(function () {
        imageProgressSet(100);

        closeCreatePostModal();
        setStatus("הפוסט פורסם בהצלחה.", "ok");

        // איפוס תמונה אחרי הצלחה
        resetSelectedImage(false);

        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e5) { }

        try { window.scrollTo({ top: 0, behavior: "smooth" }); } catch (e6) { window.scrollTo(0, 0); }
      })
      .catch(function () {
        // אם העלאה נכשלה – לא משאירים פוסט שבור
        // (מוחקים את הרשומה שנוצרה)
        try {
          newRef.remove();
        } catch (e7) {}

        createPostErrorShow("שגיאה בפרסום עם תמונה. נסה שוב.");
        setStatus("שגיאה בפרסום עם תמונה.", "error");
      })
      .finally(function () {
        imageUploadInFlight = false;
        imageProgressHide();
        imageProgressSet(0);
        if (btn) btn.disabled = false;
      });
  }

  function attachLivePostListeners() {
    if (window.__postsLiveAttached) return;
    window.__postsLiveAttached = true;

    var ref = firebase.database().ref("posts").orderByChild("time").limitToLast(50);

    ref.on("child_added", function (snap) {
      var id = snap.key;
      var v = snap.val() || {};

      var item = {
        id: id,
        title: safeText(v.title),
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || 0),
        likes: Number(v.likes || 0),
        commentsCount: Number(v.commentsCount || 0),

        /* ✅ תמיכה בתמונות */
        image: (v.image === undefined || v.image === null) ? null : safeText(v.image)
      };

      for (var i = 0; i < postsCacheData.length; i++) {
        if (postsCacheData[i] && postsCacheData[i].id === id) return;
      }

      postsCacheData.unshift(item);

      if (!isRefreshing) {
        renderPostsFromCache();
        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e5) { }
      }
    });

    ref.on("child_changed", function (snap) {
      var id = snap.key;
      var v = snap.val() || {};

      var idx = -1;
      for (var i = 0; i < postsCacheData.length; i++) {
        if (postsCacheData[i] && postsCacheData[i].id === id) { idx = i; break; }
      }
      if (idx === -1) return;

      var prev = postsCacheData[idx] || {};

      postsCacheData[idx] = {
        id: id,
        title: safeText(v.title),
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || prev.time || 0),
        likes: Number(v.likes || prev.likes || 0),
        commentsCount: Number(v.commentsCount || prev.commentsCount || 0),

        /* ✅ תמיכה בתמונות */
        image: (v.image === undefined || v.image === null) ? (prev.image || null) : safeText(v.image)
      };

      if (!isRefreshing) {
        renderPostsFromCache();
        try { sessionStorage.setItem("cachedPosts", renderedHtmlCache); } catch (e6) { }
      }
    });

  }

}); // DOMContentLoaded end

/* =========================================================================================
   ✅ Upload Image (עם Progress) – שדרוג
   - לא מחליף את השיטה, רק משפר UX
   - נתיב: post-images/{postId}/{timestamp_uid.ext}
   ========================================================================================= */
function uploadPostImageWithProgress(file, postId, uid, onProgress) {
  return new Promise(function (resolve, reject) {

    try {
      if (!firebase || !firebase.storage) {
        reject("storage not available");
        return;
      }
    } catch (e0) {
      reject("storage not available");
      return;
    }

    if (!file || !postId || !uid) {
      reject("missing params");
      return;
    }

    // בדיקות נוספות (למנוע דברים מוזרים)
    if (!isAllowedImageType(file)) {
      reject("invalid file type");
      return;
    }

    var MAX_BYTES = 3 * 1024 * 1024; // 3MB
    if (Number(file.size || 0) > MAX_BYTES) {
      reject("file too big");
      return;
    }

    var ext = safeExtFromFile(file);
    var name = Date.now() + "_" + uid + "." + ext;

    var ref = firebase.storage().ref("post-images/" + postId + "/" + name);

    var task = ref.put(file);

    task.on("state_changed",
      function (snap) {
        try {
          if (!snap) return;
          var total = Number(snap.totalBytes || 0);
          var done = Number(snap.bytesTransferred || 0);
          if (total <= 0) return;
          var pct = Math.floor((done / total) * 100);
          if (typeof onProgress === "function") onProgress(pct);
        } catch (e1) { }
      },
      function (err) {
        reject(err);
      },
      function () {
        try {
          task.snapshot.ref.getDownloadURL()
            .then(function (url) { resolve(url); })
            .catch(function (e2) { reject(e2); });
        } catch (e3) {
          reject(e3);
        }
      }
    );

  });
}

/* =========================================================================================
   Upload (legacy / שמור) – כמו שהיה אצלך
   ========================================================================================= */
function uploadPostImage(file, postId, uid) {
  return new Promise((resolve, reject) => {

    if (!file || !postId || !uid) {
      reject("missing params");
      return;
    }

    const ext = file.name.split(".").pop().toLowerCase();
    const name = Date.now() + "_" + uid + "." + ext;

    const ref = firebase.storage()
      .ref("post-images/" + postId + "/" + name);

    const task = ref.put(file);

    task.on("state_changed",
      null,
      err => reject(err),
      () => {
        task.snapshot.ref.getDownloadURL()
          .then(url => resolve(url))
          .catch(reject);
      }
    );

  });
}

/* =========================================================================================
   Padding / Readability / Future hooks
   - השורות הבאות הן "תשתית" לשדרוגים עתידיים בלי לשבור כלום.
   ========================================================================================= */

/* =========================================================================================
   Future Feature: Multi-image carousel (placeholder, disabled)
   ========================================================================================= */
// function uploadMultipleImages(files, postId, uid) {
//   // would store array of URLs: images: ["url1","url2",...]
// }

/* =========================================================================================
   Future Feature: Image moderation (placeholder, disabled)
   ========================================================================================= */
// function moderateImage(url) {
//   // would integrate moderation pipeline
// }

/* =========================================================================================
   Future Feature: Thumbnail generation (placeholder, disabled)
   ========================================================================================= */
// function generateThumbnailOnServer(url) {
//   // would be Cloud Function triggered by Storage upload
// }

/* =========================================================================================
   Future Feature: Post edit with image replace (placeholder, disabled)
   ========================================================================================= */
// function replacePostImage(postId, newFile) {
//   // would delete old image and set new URL in DB
// }

/* =========================================================================================
   End
   ========================================================================================= */
</script>

</body>
</html>