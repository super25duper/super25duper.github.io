<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>פורום מאובטח</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">

  <style>
    /* אנימציית מעבר (B) */
    .post {
      transition: transform .15s ease, opacity .15s ease;
      cursor: pointer;
    }
    .post:active {
      transform: scale(0.97);
      opacity: .85;
    }
  </style>
</head>

<body>

<header class="top-bar">
  <h1>פורום הבניידים!</h1>
</header>

<!-- Pull To Refresh indicator -->
<div id="pull-indicator" style="
  display:none;
  text-align:center;
  padding:6px;
  user-select:none;
">
  <div class="loader"></div>
</div>

<main class="forum-container">
  <div id="posts">
    <div class="loader"></div>
  </div>
</main>

<script>
/* ===============================
   חסימה מיידית – לא WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor) {
      location.replace("forbidden.html");
    }
  } catch (e) {
    location.replace("forbidden.html");
  }
})();

/* ===============================
   Cache (A)
   =============================== */
const cached = sessionStorage.getItem("cachedPosts");
if (cached) {
  document.getElementById("posts").innerHTML = cached;
}

/* ===============================
   Main
   =============================== */
document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let isRefreshing = false;

  /* ===============================
     Payload מקודולר
     =============================== */
  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch (e) {
      return setTimeout(waitForPayload, 200);
    }
    loginToFirebase(payload);
  }

  waitForPayload();

  /* ===============================
     Firebase Auth
     =============================== */
  function loginToFirebase(data) {
    if (!data.email || !data.password || !data.token) {
      location.replace("forbidden.html");
      return;
    }

    firebase.auth()
      .signInWithEmailAndPassword(data.email, data.password)
      .then(c => validateToken(c.user.uid, data.token))
      .catch(() => location.replace("forbidden.html"));
  }

  /* ===============================
     אימות token
     =============================== */
  function validateToken(uid, token) {
    firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then(snap => {
        if (!snap.exists() || snap.val() !== token) {
          location.replace("forbidden.html");
          return;
        }
        loadPosts();
      })
      .catch(() => location.replace("forbidden.html"));
  }

  /* ===============================
     טעינת פוסטים
     =============================== */
  function loadPosts(fromRefresh = false) {
  firebase.database()
    .ref("posts")
    .once("value")
    .then(snap => {

      let html = "";

      snap.forEach(pSnap => {
        const p = pSnap.val();
        const postId = pSnap.key;

        html += `
          <div class="post" data-id="${postId}">
            <h3>${p.title || ""}</h3>
            <p>${p.text || ""}</p>
            <small>מאת: ${p.author || ""}</small>
          </div>
        `;
      });

      if (!html) html = "<p>אין עדיין פוסטים.</p>";

      const postsEl = document.getElementById("posts");
      postsEl.innerHTML = html;

      /* Cache (A) */
      sessionStorage.setItem("cachedPosts", html);

      /* ===============================
         חיבור קליקים – FIX יציב 100%
         =============================== */
      postsEl.onclick = function (e) {
        const postEl = e.target.closest(".post");
        if (!postEl) return;

        const id = postEl.dataset.id;
        if (!id) return;

        openPost(id, postEl);
      };

      if (fromRefresh) {
        setTimeout(() => {
          isRefreshing = false;
          indicator.style.display = "none";
        }, 300);
      }
    })
    .catch(() => location.replace("forbidden.html"));
}
  /* ===============================
     מעבר לפוסט (A + B)
     =============================== */
  function openPost(postId, el) {
    const title = el.querySelector("h3")?.innerText || "";
    const text = el.querySelector("p")?.innerText || "";
    const author = el.querySelector("small")?.innerText.replace("מאת: ","") || "";

    sessionStorage.setItem("currentPost", JSON.stringify({
      id: postId,
      title,
      text,
      author
    }));

    setTimeout(() => {
      location.href = "post.html?postId=" + encodeURIComponent(postId);
    }, 120);
  }

  /* ===============================
     Pull To Refresh
     =============================== */
  let startY = 0;
  let pulling = false;
  const THRESHOLD = 90;
  const indicator = document.getElementById("pull-indicator");

  document.addEventListener("touchstart", e => {
    if (scrollY === 0 && !isRefreshing) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  });

  document.addEventListener("touchmove", e => {
    if (!pulling || isRefreshing) return;
    const diff = e.touches[0].clientY - startY;
    if (diff <= 0) return;

    indicator.style.display = "block";

    if (diff > THRESHOLD) {
      pulling = false;
      isRefreshing = true;
      sessionStorage.removeItem("cachedPosts");
      loadPosts(true);
    }
  });

  document.addEventListener("touchend", () => {
    pulling = false;
    if (!isRefreshing) indicator.style.display = "none";
  });

});
</script>

</body>
</html>