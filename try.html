<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Firebase Storage Upload DEBUG (v8) - Single File</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: monospace;
      max-width: 900px;
      margin: 20px auto;
      padding: 10px;
    }
    button {
      padding: 10px 16px;
      margin-top: 10px;
    }
    pre {
      background: #111;
      color: #0f0;
      padding: 10px;
      height: 340px;
      overflow-y: auto;
      font-size: 12px;
    }
    .warn { color: #ffb300; }
    .err { color: #ff5252; }
    .ok  { color: #69f0ae; }
  </style>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBf-12UCoHpIMg81MWaer7DmtfVla95X9M",
    authDomain: "try-a-69b75.firebaseapp.com",
    projectId: "try-a-69b75",
    storageBucket: "try-a-69b75.firebasestorage.app",
    messagingSenderId: "136796358688",
    appId: "1:136796358688:web:f6d41df5505e26ec0b5445",
    measurementId: "G-ST0TTENTGF"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
  <!-- Firebase v8 SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<h2>Firebase Storage Upload – DEBUG (v8) | קובץ יחיד</h2>

<p>
  <b>URL:</b> <span id="urlText"></span><br>
  <b>Origin:</b> <span id="originText"></span>
</p>

<input id="fileInput" type="file" accept="image/*"><br>
<button id="uploadBtn" disabled>UPLOAD</button>
<button id="cancelBtn" disabled>CANCEL</button>

<p id="status"></p>

<h3>LOG OUTPUT</h3>
<pre id="log"></pre>

<script>
  const logBox = document.getElementById("log");
  const status = document.getElementById("status");
  const urlText = document.getElementById("urlText");
  const originText = document.getElementById("originText");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");
  const cancelBtn = document.getElementById("cancelBtn");

  urlText.textContent = location.href;
  originText.textContent = location.origin;

  function logLine(prefixClass, ...args) {
    console.log(...args);
    const line = args.map(a => typeof a === "object" ? JSON.stringify(a, null, 2) : String(a)).join(" ");
    if (prefixClass) {
      logBox.innerHTML += `<span class="${prefixClass}">${line.replace(/</g,"&lt;")}</span>\n`;
    } else {
      logBox.textContent += line + "\n";
    }
    logBox.scrollTop = logBox.scrollHeight;
  }

  function log(...args){ logLine("", ...args); }
  function ok(...args){ logLine("ok", ...args); }
  function warn(...args){ logLine("warn", ...args); }
  function err(...args){ logLine("err", ...args); }

  ok("=== SCRIPT START ===");
  log("[Env] href:", location.href);
  log("[Env] origin:", location.origin);

  if (location.protocol === "file:") {
    warn("[WARN] אתה פותח ב-file://. זה לפעמים גורם לבקשות להיחסם/להיתקע. מומלץ לפתוח דרך http://localhost (Live Server).");
  } else {
    ok("[OK] אתה על HTTP/HTTPS.");
  }

  /* ==============================
     Firebase CONFIG (בתוך הדף)
     ============================== */
  const firebaseConfig = {
    apiKey: "AIzaSyAb6crKn7LDVhYtFMUtErtZNKEL6lfW5pA",
    authDomain: "bigone-86490.firebaseapp.com",
    databaseURL: "https://bigone-86490-default-rtdb.firebaseio.com",
    projectId: "bigone-86490",
    storageBucket: "bigone-86490.appspot.com",
    messagingSenderId: "543555505186",
    appId: "1:543555505186:web:46f992f414561830b50e7b",
    measurementId: "G-GVPSS1D63D"
  };

  try {
    firebase.initializeApp(firebaseConfig);
    ok("[Firebase] initializeApp OK");
  } catch (e) {
    err("[Firebase] initializeApp FAILED");
    err(e?.message || e);
  }

  let storage = null;
  try {
    storage = firebase.storage();
    ok("[Firebase] storage() OK");
  } catch (e) {
    err("[Firebase] storage() FAILED");
    err(e?.message || e);
  }

  // אופציונלי: בדיקה שה-bucket נראה נכון
  try {
    const bucketFromSdk = storage?._delegate?._bucket?.bucket;
    log("[Firebase] bucket from SDK:", bucketFromSdk || "(unknown)");
  } catch {}

  /* ==============================
     UI + UPLOAD DEBUG
     ============================== */
  let file = null;
  let uploadTask = null;
  let stallTimer = null;
  let lastProgressTime = 0;

  function clearStallTimer() {
    if (stallTimer) clearInterval(stallTimer);
    stallTimer = null;
  }

  function startStallMonitor() {
    clearStallTimer();
    lastProgressTime = Date.now();
    stallTimer = setInterval(() => {
      const diff = Date.now() - lastProgressTime;
      if (diff > 8000) {
        warn(`[STALL] אין התקדמות כבר ${Math.round(diff/1000)} שניות. אם זה נשאר על 0% -> חסימה ברשת/סביבה או בעיית הרשאות.`);
        warn(`[HINT] בדוק DevTools > Network אם יש בקשות ל-firebasestorage.googleapis.com שנתקעות ב-(pending).`);
        clearStallTimer();
      }
    }, 1000);
  }

  fileInput.addEventListener("change", () => {
    log("[UI] file input change event");
    file = fileInput.files[0] || null;

    if (!file) {
      warn("[UI] No file selected");
      uploadBtn.disabled = true;
      return;
    }

    ok("[UI] File selected:");
    log({
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified
    });

    uploadBtn.disabled = false;
    status.textContent = "קובץ נבחר: " + file.name;
  });

  cancelBtn.addEventListener("click", () => {
    log("[UI] Cancel clicked");
    if (uploadTask) {
      try {
        uploadTask.cancel();
        warn("[UPLOAD] cancel() called");
      } catch (e) {
        err("[UPLOAD] cancel() failed:", e?.message || e);
      }
    }
  });

  uploadBtn.addEventListener("click", () => {
    log("[UI] Upload button clicked");

    if (!file) { err("[ERROR] Clicked upload but file is null"); return; }
    if (!storage) { err("[ERROR] storage is null"); return; }

    // אם יש העלאה קודמת תקועה - נבטל
    if (uploadTask) {
      warn("[UPLOAD] Previous task exists -> canceling it first");
      try { uploadTask.cancel(); } catch {}
      uploadTask = null;
      clearStallTimer();
    }

    ok("[UPLOAD] Starting upload");

    try {
      const safeName = file.name.replace(/[^\w.\-]+/g, "_");
      const path = `debug_uploads/${Date.now()}_${safeName}`;

      log("[UPLOAD] Path:", path);

      const storageRef = storage.ref(path);
      log("[UPLOAD] storage.ref created");
      log("[UPLOAD] fullPath:", storageRef.fullPath);

      // מטא-דאטה מפורטת (עוזר ב-debug)
      const metadata = {
        contentType: file.type || "application/octet-stream",
        cacheControl: "public,max-age=3600"
      };
      log("[UPLOAD] metadata:", metadata);

      // התחלת העלאה
      uploadTask = storageRef.put(file, metadata);
      ok("[UPLOAD] put() called");
      cancelBtn.disabled = false;

      startStallMonitor();

      uploadTask.on(
        "state_changed",
        snapshot => {
          lastProgressTime = Date.now();

          const p = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          log(`[UPLOAD] progress ${p.toFixed(1)}%`, {
            bytesTransferred: snapshot.bytesTransferred,
            totalBytes: snapshot.totalBytes,
            state: snapshot.state
          });

          status.textContent = `מעלה... ${p.toFixed(0)}%`;
        },
        error => {
          clearStallTimer();
          cancelBtn.disabled = true;

          err("[UPLOAD] ERROR callback fired");
          err({
            code: error.code,
            message: error.message,
            name: error.name,
            serverResponse: error.serverResponse || null
          });

          status.textContent = "שגיאה: " + error.message;
        },
        async () => {
          clearStallTimer();
          cancelBtn.disabled = true;

          ok("[UPLOAD] COMPLETE callback fired");

          try {
            const url = await uploadTask.snapshot.ref.getDownloadURL();
            ok("[UPLOAD] Download URL:");
            log(url);
            status.textContent = "העלאה הושלמה";
          } catch (e) {
            err("[UPLOAD] getDownloadURL failed:", e?.message || e);
            status.textContent = "הועלה אבל נכשל בקבלת URL";
          }
        }
      );
    } catch (e) {
      clearStallTimer();
      cancelBtn.disabled = true;

      err("[FATAL] Exception during upload");
      err(e?.message || e);
    }
  });

  ok("=== SCRIPT READY ===");
  warn("[NEXT] אם זה עדיין נתקע על 0%: פתח DevTools > Network וחפש בקשות ל-firebasestorage.googleapis.com והסטטוס שלהן (pending/blocked/canceled).");
</script>

</body>
</html>