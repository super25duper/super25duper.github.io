<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>העלאת תמונה ל-Firebase Storage</title>

  <!-- Firebase v8 (כמו אצלך) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- הקובץ שלך שמכיל firebase.initializeApp(...) -->
  <script src="firebaseConfig.js"></script>

  <style>
    body { font-family: Arial, sans-serif; direction: rtl; padding: 16px; }
    .box { max-width: 520px; margin: 0 auto; border: 1px solid rgba(0,0,0,.15); border-radius: 14px; padding: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,.2); background:#fff; cursor:pointer; font-weight:bold; }
    button.primary { border:none; background: rgb(17,17,87); color:#fff; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .meta { font-size: 12px; opacity: .75; }
    .err { margin-top: 10px; padding: 10px; border-radius: 10px; background: rgba(255,0,0,.08); color:#8a0000; display:none; }
    .ok  { margin-top: 10px; padding: 10px; border-radius: 10px; background: rgba(0,128,0,.08); color:#0b5a0b; display:none; }
    .progress-wrap { margin-top: 10px; height: 10px; border-radius: 999px; overflow:hidden; border: 1px solid rgba(0,0,0,.15); background: rgba(0,0,0,.04); }
    .progress-bar { height: 100%; width: 0%; background: rgb(17,17,87); }
    img { margin-top: 12px; max-width:100%; border-radius: 12px; border: 1px solid rgba(0,0,0,.15); display:none; }
    a { word-break: break-all; }
    input[type="file"] { display:none; }
  </style>
</head>
<body>
  <div class="box">
    <h2 style="margin:0 0 6px 0;">העלאת תמונה בלבד</h2>
    <div class="meta">בחר תמונה והעלה ל-Firebase Storage. אין DB, אין פוסטים, כלום.</div>

    <div style="margin-top:12px;" class="row">
      <button id="chooseBtn" class="primary" type="button">בחר תמונה</button>
      <button id="uploadBtn" type="button" disabled>העלה</button>
      <button id="resetBtn" type="button">איפוס</button>
      <span id="fileInfo" class="meta"></span>
    </div>

    <input id="fileInput" type="file" accept="image/*" />

    <div class="progress-wrap" id="progressWrap" style="display:none;">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="meta" id="progressText" style="display:none;">0%</div>

    <img id="preview" alt="תצוגה מקדימה" />

    <div id="okBox" class="ok"></div>
    <div id="errBox" class="err"></div>
  </div>

  <script>
    // -------------------------
    // Helpers
    // -------------------------
    function safeText(x){ return (x === undefined || x === null) ? "" : String(x); }
    function bytesToHuman(n){
      try{
        var x = Number(n||0);
        if (!x) return "0B";
        if (x < 1024) return x + "B";
        if (x < 1024*1024) return Math.round(x/1024) + "KB";
        return (Math.round((x/(1024*1024))*10)/10) + "MB";
      }catch(e){ return ""; }
    }
    function showErr(msg){
      okBox.style.display="none"; okBox.innerHTML="";
      errBox.style.display="block"; errBox.textContent = msg;
    }
    function showOk(html){
      errBox.style.display="none"; errBox.textContent="";
      okBox.style.display="block"; okBox.innerHTML = html;
    }
    function setProgress(pct){
      var p = Math.max(0, Math.min(100, Number(pct||0)));
      progressWrap.style.display="block";
      progressText.style.display="block";
      progressBar.style.width = p + "%";
      progressText.textContent = p + "%";
    }
    function resetUI(){
      selectedFile = null;
      fileInput.value = "";
      fileInfo.textContent = "";
      uploadBtn.disabled = true;

      preview.src = "";
      preview.style.display = "none";

      progressWrap.style.display="none";
      progressText.style.display="none";
      progressBar.style.width = "0%";

      errBox.style.display="none"; errBox.textContent="";
      okBox.style.display="none"; okBox.innerHTML="";
      isUploading = false;
    }

    // -------------------------
    // UI refs
    // -------------------------
    var chooseBtn = document.getElementById("chooseBtn");
    var uploadBtn = document.getElementById("uploadBtn");
    var resetBtn  = document.getElementById("resetBtn");
    var fileInput = document.getElementById("fileInput");
    var fileInfo  = document.getElementById("fileInfo");
    var preview   = document.getElementById("preview");
    var errBox    = document.getElementById("errBox");
    var okBox     = document.getElementById("okBox");
    var progressWrap = document.getElementById("progressWrap");
    var progressBar  = document.getElementById("progressBar");
    var progressText = document.getElementById("progressText");

    // -------------------------
    // State
    // -------------------------
    var selectedFile = null;
    var isUploading = false;

    // -------------------------
    // Events
    // -------------------------
    chooseBtn.addEventListener("click", function(){
      try { fileInput.click(); } catch(e) {}
    });

    resetBtn.addEventListener("click", function(){
      // אם יש העלאה פעילה - פשוט מאפס UI (לא חייב cancel)
      resetUI();
    });

    fileInput.addEventListener("change", function(){
      resetUI(); // חשוב: שלא יתקע אחרי שגיאה קודמת
      var f = (fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null;
      if (!f) return;

      // ולידציה בסיסית
      var type = safeText(f.type).toLowerCase();
      if (type.indexOf("image/") !== 0) {
        showErr("זה לא קובץ תמונה.");
        return;
      }
      var MAX = 10 * 1024 * 1024; // 10MB (בכוונה פשוט ויותר סלחני)
      if (Number(f.size||0) > MAX) {
        showErr("התמונה גדולה מדי: " + bytesToHuman(f.size) + ". מקסימום 10MB.");
        return;
      }

      selectedFile = f;
      fileInfo.textContent = safeText(f.name) + " (" + bytesToHuman(f.size) + ")";
      uploadBtn.disabled = false;

      // תצוגה מקדימה דרך FileReader (יציב בוובויו)
      try{
        var r = new FileReader();
        r.onerror = function(){ /* לא קריטי */ };
        r.onload = function(){
          var dataUrl = safeText(r.result||"");
          if (dataUrl && dataUrl.indexOf("data:") === 0){
            preview.src = dataUrl;
            preview.style.display = "block";
          }
        };
        r.readAsDataURL(f);
      }catch(e){}
    });

    uploadBtn.addEventListener("click", function(){
      if (!selectedFile) { showErr("לא נבחרה תמונה."); return; }
      if (isUploading) return;
      isUploading = true;

      errBox.style.display="none"; errBox.textContent="";
      okBox.style.display="none"; okBox.innerHTML="";
      setProgress(1);

      uploadBtn.disabled = true;
      chooseBtn.disabled = true;

      // נתיב פשוט באחסון
      var ext = "jpg";
      try {
        var n = safeText(selectedFile.name);
        if (n.indexOf(".") !== -1) ext = n.split(".").pop().toLowerCase();
      } catch(e){ ext = "jpg"; }

      var fileName = Date.now() + "_" + Math.random().toString(16).slice(2) + "." + ext;
      var path = "uploads/" + fileName;

      // העלאה רגילה: put(file)
      var ref = firebase.storage().ref(path);
      var task = ref.put(selectedFile, { contentType: selectedFile.type || "application/octet-stream" });

      // watchdog נגד "מעלה בלי סוף"
      var finished = false;
      var watchdog = setTimeout(function(){
        if (finished) return;
        try { if (task && typeof task.cancel === "function") task.cancel(); } catch(e){}
        showErr("העלאה נתקעה (Timeout). נסה שוב.");
        resetAfterUploadFail();
      }, 90000); // 90 שניות

      function resetAfterUploadFail(){
        finished = true;
        try { clearTimeout(watchdog); } catch(e){}
        progressWrap.style.display="none";
        progressText.style.display="none";
        progressBar.style.width="0%";
        chooseBtn.disabled = false;
        uploadBtn.disabled = !selectedFile;
        isUploading = false;
      }

      task.on("state_changed",
        function(snap){
          try{
            var bt = Number(snap.bytesTransferred||0);
            var tt = Number(snap.totalBytes||0);
            if (tt > 0) setProgress(Math.round((bt/tt)*100));
          }catch(e){}
        },
        function(err){
          resetAfterUploadFail();
          showErr("שגיאה בהעלאה: " + safeText(err && err.message ? err.message : err));
        },
        function(){
          if (finished) return;
          finished = true;
          try { clearTimeout(watchdog); } catch(e){}

          task.snapshot.ref.getDownloadURL().then(function(url){
            setProgress(100);
            chooseBtn.disabled = false;
            uploadBtn.disabled = false;
            isUploading = false;

            showOk(
              'הועלה בהצלחה.<br>' +
              '<b>Path:</b> ' + escapeHtml(path) + '<br>' +
              '<b>URL:</b> <a href="' + escapeHtml(url) + '" target="_blank" rel="noopener">פתח קישור</a>'
            );
          }).catch(function(e){
            chooseBtn.disabled = false;
            uploadBtn.disabled = false;
            isUploading = false;
            showErr("הקובץ הועלה אבל נכשל לקבל URL: " + safeText(e && e.message ? e.message : e));
          });
        }
      );
    });

    function escapeHtml(s){
      s = safeText(s);
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // init
    resetUI();
  </script>
</body>
</html>