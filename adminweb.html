<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Admin Mobile v2 â€” ×¢×•×‘×“</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- YOUR CONFIG (must call firebase.initializeApp inside OR fallback below will init) -->
  <script src="firebaseConfig.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,0.07);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.20);
      --txt: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.66);
      --muted2: rgba(255,255,255,0.48);
      --ok:#2fe28a;
      --warn:#ffb020;
      --danger:#ff4d4d;
      --shadow: 0 14px 60px rgba(0,0,0,0.55);
      --r: 18px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }

    *{ box-sizing:border-box; }

    /* âœ… FIX: background seam / repeat */
    html, body{ min-height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      color: var(--txt);
      overflow-x:hidden;
      /* âœ… IMPORTANT: avoid last item hidden under bottom nav */
      padding-bottom: calc(96px + var(--safeBot));
      background: none;
      position: relative;
    }
    body::before{
      content:"";
      position: fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(59,130,246,0.25), transparent 60%),
        radial-gradient(820px 520px at 90% 10%, rgba(139,92,246,0.20), transparent 60%),
        radial-gradient(900px 650px at 50% 115%, rgba(47,226,138,0.12), transparent 60%),
        var(--bg);
      background-repeat: no-repeat;
      background-attachment: fixed;
    }

    .wrapText{ overflow-wrap:anywhere; word-break:break-word; }
    .container{
      width:100%;
      max-width:560px;
      margin:0 auto;
      padding:12px;
      padding-top: calc(12px + var(--safeTop));
    }
    .topbar{
      position: sticky;
      top:0;
      z-index:30;
      margin:-12px -12px 12px;
      padding:12px;
      padding-top: calc(12px + var(--safeTop));
      backdrop-filter: blur(12px);
      background: rgba(11,16,32,0.75);
      border-bottom: 1px solid var(--stroke);
    }
    .brandRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width:38px; height:38px;
      border-radius:14px;
      flex:0 0 auto;
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92));
      box-shadow: 0 10px 22px rgba(59,130,246,0.18);
    }
    .brandTxt{ min-width:0; }
    .brandTxt .t{ font-weight:950; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .brandTxt .s{ font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .pill{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      max-width:45%;
      min-width:120px;
      justify-content:center;
    }
    .pill span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
    .dot{ width:8px; height:8px; border-radius:99px; background: var(--muted2); }
    .pill.ok .dot{ background: var(--ok); }
    .pill.warn .dot{ background: var(--warn); }
    .pill.err .dot{ background: var(--danger); }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; min-width:0; }
    .in, select, textarea{
      width:100%;
      max-width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.28);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    textarea{ min-height:120px; resize:vertical; }
    .in::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.45); }
    .mono{ font-family: var(--mono); }

    .card{
      border:1px solid var(--stroke);
      background: var(--panel);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .card .hd .h{ font-weight:950; font-size:13px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .card .bd{ padding:12px; }

    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      color: var(--txt);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      max-width:100%;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border:none; background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92)); }
    .btn.danger{
      border:1px solid rgba(255,77,77,0.45);
      background: rgba(255,77,77,0.12);
      color:#ffd1d1;
    }
    .btn.ghost{ background: transparent; border: 1px dashed var(--stroke2); }
    .btn.small{ padding:10px 10px; border-radius:12px; font-size:12px; }
    .wide{ width:100%; }

    .muted{ color: var(--muted); }
    .mini{ font-size:12px; color: var(--muted); line-height:1.45; }
    .sep{ height:1px; background: var(--stroke); margin:10px 0; }

    .list{ display:flex; flex-direction:column; gap:10px; }
    .post{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .post .title{ font-weight:950; font-size:14px; line-height:1.25; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; font-size:12px; color: var(--muted); min-width:0; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.20);
      max-width:100%;
      min-width:0;
    }
    .chip b{ color: var(--txt); max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .snippet{ font-size:13px; line-height:1.45; color: rgba(255,255,255,0.90); }
    .tools{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      z-index:40;
      padding-bottom: var(--safeBot);
      background: rgba(11,16,32,0.82);
      backdrop-filter: blur(12px);
      border-top: 1px solid var(--stroke);
    }
    .bottomNav .bar{
      max-width:560px;
      margin:0 auto;
      padding:10px 12px;
      display:grid;
      /* âœ… 4 tabs now */
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap:8px;
    }
    .navBtn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.05);
      border-radius:16px;
      padding:10px 8px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      font-weight:950;
      font-size:13px;
      color: var(--muted);
      user-select:none;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn.active{
      color: var(--txt);
      background: rgba(59,130,246,0.18);
      border-color: rgba(59,130,246,0.35);
    }

    .toast{
      position: fixed;
      left:12px; right:12px;
      bottom: calc(90px + var(--safeBot));
      z-index:90;
      max-width:560px;
      margin:0 auto;
      display:none;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-size:13px;
      line-height:1.35;
    }
    .toast.ok{ border-color: rgba(47,226,138,0.35); background: rgba(47,226,138,0.12); }
    .toast.warn{ border-color: rgba(255,176,32,0.45); background: rgba(255,176,32,0.12); }
    .toast.err{ border-color: rgba(255,77,77,0.45); background: rgba(255,77,77,0.12); }

    .overlay{
      position: fixed;
      inset:0;
      z-index:80;
      display:none;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,0.62);
      padding:12px;
      padding-bottom: calc(12px + var(--safeBot));
    }
    .sheet{
      width:100%;
      max-width:560px;
      border:1px solid var(--stroke);
      background: rgba(15,20,40,0.96);
      border-radius:22px;
      box-shadow: 0 24px 90px rgba(0,0,0,0.68);
      overflow:hidden;
      max-height:86vh;
      display:flex;
      flex-direction:column;
    }
    .sheetHd{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,0.03);
      min-width:0;
    }
    .sheetHd .ttl{ font-weight:1000; font-size:14px; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .sheetBd{ padding:12px; overflow:auto; min-width:0; }
    .sheetFt{
      padding:12px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,0.02);
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .cNode{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius:16px;
      padding:10px;
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .cHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
    }
    .cMeta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color: var(--muted);
      font-size:12px;
      min-width:0;
    }
    .cText{
      font-size:13px;
      line-height:1.45;
      color: rgba(255,255,255,0.90);
      white-space: pre-wrap;
    }
    .indent{
      margin-right:10px;
      padding-right:10px;
      border-right:2px dashed rgba(255,255,255,0.12);
    }

    .hidden{ display:none !important; }
    .prog{
      height:10px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .prog > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92));
    }

    /* âœ… NEW: Users monitor UI */
    .uCard{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-shadow: 0 10px 34px rgba(0,0,0,0.30);
    }
    .uHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .uName{
      font-weight:1000;
      font-size:14px;
      line-height:1.25;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .uSub{
      font-size:12px;
      color: var(--muted);
      margin-top:4px;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      font-family: var(--mono);
      opacity:0.85;
    }
    .uStatus{
      flex:0 0 auto;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.20);
      font-size:12px;
      font-weight:950;
      color: var(--muted);
      user-select:none;
    }
    .uStatus .sDot{ width:8px; height:8px; border-radius:99px; background: var(--muted2); }
    .uCard.online .uStatus{ color: rgba(255,255,255,0.90); border-color: rgba(47,226,138,0.35); background: rgba(47,226,138,0.10); }
    .uCard.online .uStatus .sDot{ background: var(--ok); }
    .uCard.offline .uStatus{ border-color: rgba(255,176,32,0.25); background: rgba(255,176,32,0.08); }

    .uGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      min-width:0;
    }
    .uLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.18);
      border-radius:14px;
      padding:10px 10px;
      min-width:0;
    }
    .uLine .k{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .uLine .v{
      font-size:13px;
      color: rgba(255,255,255,0.92);
      font-weight:950;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .uFooter{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:2px;
    }
    .uBadge{
      font-size:12px;
      color: var(--muted);
    }
    .uActions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .spacerBottom{
      height: 10px; /* small extra, body has main padding-bottom */
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brandRow">
        <div class="brand">
          <div class="logo">A</div>
          <div class="brandTxt">
            <div class="t">Admin Mobile v2</div>
            <div class="s">××•×‘×™×™×œ × ×§×™ Â· ×¢×¨×™×›×”/××—×™×§×”/×¢×©×”-×¡×“×¨ Â· ×¢×•×‘×“</div>
          </div>
        </div>
        <div id="authPill" class="pill warn">
          <span class="dot"></span>
          <span id="authTxt">×˜×•×¢×Ÿâ€¦</span>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <input id="qSearch" class="in" type="search" placeholder="×—×™×¤×•×© ×¤×•×¡×˜ (×›×•×ª×¨×ª/×˜×§×¡×˜/××—×‘×¨/ID)..." />
        <button id="btnRefresh" class="btn" type="button">ğŸ”„</button>
      </div>
    </div>

    <div id="viewLogin" class="card">
      <div class="hd">
        <div class="h">×›× ×™×¡×”</div>
        <div class="mini">admins/{uid}=true</div>
      </div>
      <div class="bd">
        <div class="row">
          <input id="loginEmail" class="in" type="email" placeholder="××™××™×™×œ ××“××™×Ÿ" />
          <input id="loginPass" class="in" type="password" placeholder="×¡×™×¡××”" />
        </div>
        <div class="row" style="margin-top:10px;">
          <button id="btnLogin" class="btn primary wide" type="button">ğŸ” ×”×ª×—×‘×¨</button>
          <button id="btnLogout" class="btn danger wide hidden" type="button">â‹ ×”×ª× ×ª×§</button>
        </div>
        <div class="sep"></div>
        <div class="mini">×× ×”×ª×—×‘×¨×ª ××‘×œ ××ª×” ×œ× ××“××™×Ÿ â€” ×”××¢×¨×›×ª ×ª× ×ª×§ ××•×˜×•××˜×™×ª.</div>
      </div>
    </div>

    <div id="viewPosts" class="hidden" style="margin-top:12px;">
      <div class="card">
        <div class="hd">
          <div class="h">×¤×•×¡×˜×™×</div>
          <div class="mini" id="badgePosts">â€”</div>
        </div>
        <div class="bd">
          <div class="row">
            <select id="sortSel" class="in" style="width:auto; flex:1; min-width: 160px;">
              <option value="newest" selected>×—×“×©×™× ×œ××¢×œ×”</option>
              <option value="oldest">×™×©× ×™× ×œ××¢×œ×”</option>
              <option value="lastComment">×ª×’×•×‘×” ××—×¨×•× ×”</option>
              <option value="comments">×›××•×ª ×ª×’×•×‘×•×ª</option>
            </select>
            <select id="limitSel" class="in" style="width:auto; flex:1; min-width: 140px;">
              <option value="50">50</option>
              <option value="120" selected>120</option>
              <option value="300">300</option>
            </select>
          </div>

          <div class="sep"></div>

          <div id="postsList" class="list">
            <div class="mini muted">×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª ×¤×•×¡×˜×™×â€¦</div>
          </div>

          <div class="sep"></div>
          <button id="btnLoadMore" class="btn ghost wide" type="button">â¬‡ï¸ ×˜×¢×Ÿ ×¢×•×“</button>
        </div>
      </div>
      <div class="spacerBottom"></div>
    </div>

    <!-- âœ… NEW: Users Control screen -->
    <div id="viewUsers" class="hidden" style="margin-top:12px;">
      <div class="card">
        <div class="hd">
          <div class="h">×‘×§×¨×ª ××©×ª××©×™×</div>
          <div class="mini" id="usersBadge">â€”</div>
        </div>
        <div class="bd">
          <div class="row">
            <input id="usersSearch" class="in" type="search" placeholder="×—×™×¤×•×© ××©×ª××© (×©×/uid)..." style="flex:2; min-width:200px;" />
            <button id="btnUsersRefresh" class="btn" type="button">ğŸ”„</button>
          </div>

          <div class="sep"></div>

          <div id="usersList" class="list">
            <div class="mini muted">×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª × ×™×˜×•×¨â€¦</div>
          </div>
        </div>
      </div>
      <div class="spacerBottom"></div>
    </div>

    <div id="viewTools" class="hidden" style="margin-top:12px;">
      <div class="card">
        <div class="hd">
          <div class="h">×›×œ×™×</div>
          <div class="mini">××¢×¨×›×ª</div>
        </div>
        <div class="bd">
          <button id="btnFixAll" class="btn primary wide" type="button">ğŸ§¹ ×¢×©×” ×¡×“×¨ ×œ×›×œ ×”×¤×•×¡×˜×™×</button>
          <div class="mini" style="margin-top:8px;">
            ××ª×§×Ÿ ×œ×›×œ ×¤×•×¡×˜: <span class="mono">commentsCount</span> + <span class="mono">lastCommentTime</span>
          </div>

          <div class="sep"></div>

          <div class="mini muted" id="toolsMsg">â€”</div>
          <div class="prog" style="margin-top:10px;"><div id="progBar"></div></div>
          <div class="mini muted" id="progTxt" style="margin-top:8px;">â€”</div>

          <div class="sep"></div>
          <button id="btnExportVisible" class="btn wide" type="button">ğŸ“¦ ×™×™×¦× ×¤×•×¡×˜×™× ×‘×ª×¦×•×’×” (JSON)</button>

          <!-- âœ… REMOVED: LIVE MONITOR moved to Users tab -->
        </div>
      </div>
      <div class="spacerBottom"></div>
    </div>

    <div id="viewRename" class="hidden" style="margin-top:12px;">
      <div class="card">
        <div class="hd">
          <div class="h">×©×™× ×•×™ ×©× ××©×ª××©</div>
          <div class="mini">×©× × ×•×›×—×™ â†’ ×—×“×©</div>
        </div>
        <div class="bd">
          <div class="row">
            <input id="oldName" class="in" placeholder="×©× × ×•×›×—×™ (×œ×“×•×’××”: yossi)" />
            <input id="newName" class="in" placeholder="×©× ×—×“×© (×œ×“×•×’××”: yossi_pro)" />
          </div>
          <div class="row" style="margin-top:10px;">
            <button id="btnRename" class="btn primary wide" type="button">âœï¸ ×©× ×” ×©× ×‘×›×œ ××§×•×</button>
          </div>
          <div class="sep"></div>
          <div class="mini muted" id="renameMsg">â€”</div>
        </div>
      </div>
      <div class="spacerBottom"></div>
    </div>
  </div>

  <div class="bottomNav">
    <div class="bar">
      <div id="navPosts" class="navBtn active">ğŸ“° ×¤×•×¡×˜×™×</div>
      <div id="navUsers" class="navBtn">ğŸ‘¥ ××©×ª××©×™×</div>
      <div id="navTools" class="navBtn">ğŸ§° ×›×œ×™×</div>
      <div id="navRename" class="navBtn">ğŸ‘¤ ×©×™× ×•×™ ×©×</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <div id="overlay" class="overlay">
    <div class="sheet">
      <div class="sheetHd">
        <div class="ttl" id="sheetTitle">×¢×¨×™×›×”</div>
        <button id="btnCloseSheet" class="btn small" type="button">âœ•</button>
      </div>

      <div class="sheetBd">
        <div class="mini muted wrapText" id="sheetPath">â€”</div>
        <div class="sep"></div>

        <div id="editorFields"></div>

        <div class="sep"></div>

        <details>
          <summary class="btn ghost wide">ğŸ§¾ ××ª×§×“×: JSON ××œ×</summary>
          <div style="margin-top:10px;">
            <textarea id="rawJson" class="in mono" style="min-height:180px;" placeholder="JSON ××œ×"></textarea>
            <button id="btnSaveJson" class="btn wide" type="button">ğŸ’¾ ×©××•×¨ JSON (SET)</button>
            <div class="mini muted" style="margin-top:6px;">×–×” ××—×œ×™×£ ××ª ×›×œ ×”Ö¾node ×‘× ×ª×™×‘.</div>
          </div>
        </details>

        <div class="sep"></div>

        <details id="commentsBox" class="hidden">
          <summary class="btn wide">ğŸ’¬ ×ª×’×•×‘×•×ª ×œ×¤×•×¡×˜</summary>
          <div id="commentsWrap"></div>
        </details>
      </div>

      <div class="sheetFt">
        <button id="btnSaveFields" class="btn primary" type="button">ğŸ’¾ ×©××•×¨</button>
        <button id="btnDeleteNode" class="btn danger" type="button">ğŸ—‘ ××—×§</button>
      </div>
    </div>
  </div>

<script>
/* ===============================
   ×—×¡×™××” ××™×™×“×™×ª â€“ ×œ× WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor || typeof window.AppInventor.getWebViewString !== "function") {
      location.replace("forbidden.html");
      return;
    }
  } catch (e) {
    location.replace("forbidden.html");
    return;
  }
})();

/* ========================================================================================= */
/* ============ HARDEN INIT (works with ANY firebaseConfig.js style) ============ */
(function(){
  function showInitErr(msg){
    var t = document.getElementById("toast");
    if(t){
      t.classList.remove("ok","warn","err");
      t.classList.add("err");
      t.textContent = msg;
      t.style.display = "block";
    }
    var pill = document.getElementById("authPill");
    var txt = document.getElementById("authTxt");
    if(pill && txt){
      pill.classList.remove("ok","warn","err");
      pill.classList.add("err");
      txt.textContent = "Config/Init ×©×’×•×™";
    }
  }

  try{
    if(typeof firebase === "undefined" || !firebase || !firebase.initializeApp){
      showInitErr("Firebase SDK ×œ× × ×˜×¢×Ÿ");
      return;
    }

    if(firebase.apps && firebase.apps.length === 0){
      // try known globals
      var cfg = null;
      if(typeof firebaseConfig !== "undefined" && firebaseConfig) cfg = firebaseConfig;
      else if(typeof window.firebaseConfig !== "undefined" && window.firebaseConfig) cfg = window.firebaseConfig;
      else if(typeof config !== "undefined" && config) cfg = config;
      else if(typeof window.config !== "undefined" && window.config) cfg = window.config;

      if(cfg){
        firebase.initializeApp(cfg);
      }else{
        showInitErr("firebaseConfig.js × ×˜×¢×Ÿ ××‘×œ ×‘×œ×™ firebase.initializeApp ×•×’× ×‘×œ×™ ××•×‘×™×™×§×˜ config ×’×œ×•×‘×œ×™");
        return;
      }
    }
  }catch(e){
    showInitErr("Init × ×›×©×œ: " + (e && e.message ? e.message : e));
  }
})();

/* =========================
   CONFIG (paths)
========================= */
var ADMIN_PATH = "admins";
var POSTS_PATH = "posts";
var COMMENTS_PATH = "comments";
var USERS_PATH = "users";
var REPLIES_PATH = "replies";
var STORAGE_POST_FOLDER = "post-images";
var MAX_REPLIES_DEPTH = 10;

/* âœ… forum presence monitoring (READ-ONLY) */
var PRESENCE_PATH = "presence";
var PRESENCE_LIST_LIMIT = 0; // 0 = all. If you ever need: set to e.g. 3000
/* âœ… /presence */

/* =========================
   STATE
========================= */
var S = {
  user:null,
  uid:"",
  isAdmin:false,
  posts:[],
  postsMap:{},
  want:120,
  busy:false,
  current:{ type:"", path:"", postId:"", obj:null },

  /* âœ… users monitor */
  presenceArr:[],
  presenceMap:{}
  /* âœ… /users monitor */
};

/* =========================
   HELPERS
========================= */
function el(id){ return document.getElementById(id); }
function safe(v){ return (v===undefined||v===null) ? "" : String(v); }
function num(v){ var n=Number(v||0); return isNaN(n)?0:n; }
function escapeHtml(s){
  s = safe(s);
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function pretty(v){ try{ return JSON.stringify(v,null,2); }catch(e){ return safe(v); } }
function tryParseJson(txt){ try{ return {ok:true, v: JSON.parse(txt)}; }catch(e){ return {ok:false, e:e}; } }
function fmtDate(ts){
  try{ ts = num(ts); if(!ts) return "â€”"; return new Date(ts).toLocaleString("he-IL"); }
  catch(e){ return "â€”"; }
}
function toast(msg,type){
  var t = el("toast");
  t.classList.remove("ok","warn","err");
  if(type) t.classList.add(type);
  t.textContent = msg || "";
  t.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(function(){ t.style.display="none"; }, 2300);
}
function pill(type,text){
  var p = el("authPill"), t = el("authTxt");
  p.classList.remove("ok","warn","err");
  p.classList.add(type);
  t.textContent = text || "";
}
function confirmDanger(msg){ return window.confirm("âš ï¸ " + msg + "\n\n×”×× ××ª×” ×‘×˜×•×—?"); }
function setBusy(flag){
  S.busy = !!flag;
  el("btnRefresh").disabled = S.busy;
  el("btnFixAll").disabled = S.busy;
  el("btnRename").disabled = S.busy;
  el("btnLoadMore").disabled = S.busy;

  // users refresh stays usable, but prevent spam during heavy ops
  if(el("btnUsersRefresh")) el("btnUsersRefresh").disabled = S.busy;
}
function prog(pct, text){
  pct = Math.max(0, Math.min(100, Math.round(Number(pct||0))));
  el("progBar").style.width = pct + "%";
  el("progTxt").textContent = text || (pct + "%");
}
function progReset(){
  el("progBar").style.width = "0%";
  el("progTxt").textContent = "â€”";
}


function formatDuration(ms){
  ms = num(ms);
  if(ms <= 0) return "â€”";
  var s = Math.floor(ms/1000);
  if(s < 60) return "×¤×—×•×ª ××“×§×”";
  var m = Math.floor(s/60); s = s%60;
  if(m < 60) return m + " ×“×§×•×ª";
  var h = Math.floor(m/60); m = m%60;
  if(h < 24){
    if(m === 0) return h + " ×©×¢×•×ª";
    return h + " ×©×¢×•×ª ×•" + m + " ×“×§×•×ª";
  }
  var d = Math.floor(h/24); h = h%24;
  if(h === 0) return d + " ×™××™×";
  return d + " ×™××™× ×•" + h + " ×©×¢×•×ª";
}

function isSameDay(a,b){
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function pad2(n){ return (n<10 ? "0" : "") + n; }

function formatLastSeenHuman(ts){
  ts = Number(ts || 0);
  if(!ts) return "â€”";

  var now = Date.now();
  var diffMs = now - ts;
  if(diffMs < 0) diffMs = 0;

  var mins = Math.floor(diffMs / 60000);

  // ×××© ×¢×›×©×™×•
  if(mins <= 1) return "×œ×¤× ×™ ×“×§×”";

  // ×¢×“ ×©×¢×”
  if(mins < 60){
    if(mins === 15) return "×œ×¤× ×™ ×¨×‘×¢ ×©×¢×”";
    if(mins === 30) return "×œ×¤× ×™ ×—×¦×™ ×©×¢×”";
    return "×œ×¤× ×™ " + mins + " ×“×§×•×ª";
  }

  var hours = Math.floor(mins / 60);
  var remM = mins % 60;

  // ×§×‘×™×¢×ª ×”×™×•×/××ª××•×œ ×œ×¤×™ ×–××Ÿ ××§×•××™
  var dNow = new Date(now);
  var dTs  = new Date(ts);

  function sameDate(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }

  // ××ª××•×œ
  var dY = new Date(dNow);
  dY.setDate(dNow.getDate() - 1);

  // ×”×™×•×: ×©×¢×•×ª
  if(sameDate(dNow, dTs)){
    if(hours === 1) return remM ? ("×œ×¤× ×™ ×©×¢×” ×•" + remM + " ×“×§×•×ª") : "×œ×¤× ×™ ×©×¢×”";
    if(hours === 2) return remM ? ("×œ×¤× ×™ ×©×¢×ª×™×™× ×•" + remM + " ×“×§×•×ª") : "×œ×¤× ×™ ×©×¢×ª×™×™×";
    return remM ? ("×œ×¤× ×™ " + hours + " ×©×¢×•×ª ×•" + remM + " ×“×§×•×ª") : ("×œ×¤× ×™ " + hours + " ×©×¢×•×ª");
  }

  // ××ª××•×œ ×‘×©×¢×”
  if(sameDate(dY, dTs)){
    return "××ª××•×œ ×‘×©×¢×” " + pad2(dTs.getHours()) + ":" + pad2(dTs.getMinutes());
  }

  // ×™××™× (×¢×“ 7 ×™××™×)
  var startOfToday = new Date(dNow.getFullYear(), dNow.getMonth(), dNow.getDate()).getTime();
  var startOfThat  = new Date(dTs.getFullYear(), dTs.getMonth(), dTs.getDate()).getTime();
  var days = Math.floor((startOfToday - startOfThat) / 86400000);

  if(days === 1) return "×œ×¤× ×™ ×™×•×";
  if(days > 1 && days < 7) return "×œ×¤× ×™ " + days + " ×™××™×";

  // ××¢×‘×¨ ×œ×©×‘×•×¢ â€” ×ª××¨×™×š ×¨×’×™×œ
  return dTs.toLocaleString("he-IL");
}

/* âœ… /time formatting */

/* =========================
   NAV
========================= */
function setActive(tab){
  ["navPosts","navUsers","navTools","navRename"].forEach(function(id){
    el(id).classList.toggle("active", id===tab);
  });
  el("viewPosts").classList.toggle("hidden", tab!=="navPosts");
  el("viewUsers").classList.toggle("hidden", tab!=="navUsers");
  el("viewTools").classList.toggle("hidden", tab!=="navTools");
  el("viewRename").classList.toggle("hidden", tab!=="navRename");
}
el("navPosts").onclick = function(){ setActive("navPosts"); };
el("navUsers").onclick = function(){ setActive("navUsers"); renderUsersList(); };
el("navTools").onclick = function(){ setActive("navTools"); };
el("navRename").onclick = function(){ setActive("navRename"); };

/* =========================
   AUTH + ADMIN CHECK
========================= */
function checkAdmin(uid){
  return firebase.database().ref(ADMIN_PATH + "/" + uid).once("value").then(function(s){
    var v = s.exists() ? s.val() : null;
    return (v===true || v===1 || v==="true");
  });
}

function login(){
  var email = safe(el("loginEmail").value).trim();
  var pass  = safe(el("loginPass").value);
  if(!email || !pass){ toast("×—×¡×¨ ××™××™×™×œ/×¡×™×¡××”","warn"); return; }
  pill("warn","××ª×—×‘×¨â€¦");
  firebase.auth().signInWithEmailAndPassword(email, pass)
    .catch(function(err){
      pill("err","×›×©×œ ×”×ª×—×‘×¨×•×ª");
      toast("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + safe(err && err.message || err), "err");
    });
}
function logout(){ firebase.auth().signOut(); }

el("btnLogin").onclick = login;
el("btnLogout").onclick = logout;

/* =========================
   POSTS LOAD + FILTER/SORT
========================= */
function normalizePost(id, v){
  v = v || {};
  return {
    id:id,
    title: safe(v.title),
    text: safe(v.text),
    author: safe(v.author || v.username || v.user || v.name),
    time: num(v.time),
    likes: num(v.likes),
    commentsCount: (v.commentsCount===undefined || v.commentsCount===null) ? null : num(v.commentsCount),
    lastCommentTime: num(v.lastCommentTime),
    imagePath: safe(v.imagePath || ""),
    raw: v
  };
}

function resetAndLoadPosts(){
  if(!S.isAdmin) return;
  S.want = num(el("limitSel").value || 120) || 120;
  el("postsList").innerHTML = '<div class="mini muted">×˜×•×¢×Ÿâ€¦</div>';
  loadPosts(S.want);
}

function loadPosts(want){
  if(!S.isAdmin) return;
  setBusy(true);

  var sort = safe(el("sortSel").value || "newest");
  var q = safe(el("qSearch").value).trim().toLowerCase();

  return firebase.database().ref(POSTS_PATH).orderByChild("time").limitToLast(want).once("value")
    .then(function(snap){
      var arr = [];
      snap.forEach(function(ch){ arr.push(normalizePost(ch.key, ch.val())); });

      if(sort==="oldest"){
        arr.sort(function(a,b){ return num(a.time)-num(b.time); });
      }else if(sort==="comments"){
        arr.sort(function(a,b){ return num(b.commentsCount)-num(a.commentsCount); });
      }else if(sort==="lastComment"){
        arr.sort(function(a,b){
          var ta = num(a.lastCommentTime)||num(a.time);
          var tb = num(b.lastCommentTime)||num(b.time);
          return tb-ta;
        });
      }else{
        arr.sort(function(a,b){ return num(b.time)-num(a.time); });
      }

      if(q){
        arr = arr.filter(function(p){
          var blob = (p.id+" "+p.title+" "+p.text+" "+p.author).toLowerCase();
          return blob.indexOf(q)!==-1;
        });
      }

      S.posts = arr;
      S.postsMap = {};
      arr.forEach(function(p){ S.postsMap[p.id]=p; });

      el("badgePosts").textContent = "×›××•×ª: " + arr.length;
      renderPosts();
    })
    .catch(function(err){
      toast("×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×•×¡×˜×™×: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
}

function shorten(t,n){
  t = safe(t);
  if(t.length<=n) return t;
  return t.slice(0,n) + "â€¦";
}

function renderPosts(){
  var host = el("postsList");
  host.innerHTML = "";
  if(!S.posts.length){
    host.innerHTML = '<div class="mini muted">××™×Ÿ ×¤×•×¡×˜×™× ×‘×ª×¦×•×’×”.</div>';
    return;
  }

  S.posts.forEach(function(p){
    var cc = (p.commentsCount===null) ? "?" : String(num(p.commentsCount));
    var lc = p.lastCommentTime ? fmtDate(p.lastCommentTime) : "â€”";

    var card = document.createElement("div");
    card.className = "post";
    card.innerHTML = `
      <div class="title wrapText">${escapeHtml(p.title || "(×œ×œ× ×›×•×ª×¨×ª)")}</div>
      <div class="chips">
        <span class="chip">ID: <b class="mono">${escapeHtml(p.id)}</b></span>
        <span class="chip">×××ª: <b class="wrapText">${escapeHtml(p.author || "â€”")}</b></span>
        <span class="chip">×–××Ÿ: <b>${escapeHtml(fmtDate(p.time))}</b></span>
        <span class="chip">×ª×’×•×‘×•×ª: <b class="mono">${escapeHtml(cc)}</b></span>
        <span class="chip">××—×¨×•× ×”: <b>${escapeHtml(lc)}</b></span>
      </div>
      <div class="snippet wrapText">${escapeHtml(shorten(p.text, 180))}</div>
      <div class="tools">
        <button class="btn small" data-act="edit">âœï¸ ×¢×¨×•×š</button>
        <button class="btn small" data-act="comments">ğŸ’¬ ×ª×’×•×‘×•×ª</button>
        <button class="btn small" data-act="recalc">ğŸ§® ×ª×§×Ÿ ××•× ×™×</button>
        <button class="btn small danger" data-act="delete">ğŸ—‘ ××—×§</button>
      </div>
    `;

    card.addEventListener("click", function(e){
      var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
      if(!b) return;
      var act = b.getAttribute("data-act");
      if(act==="edit") openPostEditor(p.id, false);
      if(act==="comments") openPostEditor(p.id, true);
      if(act==="recalc") recalcPostMeta(p.id, true);
      if(act==="delete") deepDeletePost(p.id, true);
    });

    host.appendChild(card);
  });
}

el("btnRefresh").onclick = function(){ resetAndLoadPosts(); };
el("sortSel").onchange = function(){ resetAndLoadPosts(); };
el("limitSel").onchange = function(){ resetAndLoadPosts(); };
el("qSearch").oninput = function(){ renderPosts(); };
el("btnLoadMore").onclick = function(){
  S.want = S.want + (num(el("limitSel").value||120)||120);
  loadPosts(S.want);
};

/* =========================
   EDITOR SHEET
========================= */
function fieldInput(label, id, value, mono){
  var wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="mini">${escapeHtml(label)}</div>
    <input id="${escapeHtml(id)}" class="in ${mono?'mono':''}" value="${escapeHtml(value||"")}">
  `;
  return wrap;
}
function fieldArea(label, id, value){
  var wrap = document.createElement("div");
  wrap.innerHTML = `
    <div class="mini">${escapeHtml(label)}</div>
    <textarea id="${escapeHtml(id)}" class="in">${escapeHtml(value||"")}</textarea>
  `;
  return wrap;
}

function openSheet(title, path, type, postId, obj){
  S.current = { type:type, path:path, postId:postId||"", obj:obj||{} };
  el("sheetTitle").textContent = title;
  el("sheetPath").textContent = "Path: " + path;
  el("rawJson").value = pretty(obj||{});

  var host = el("editorFields");
  host.innerHTML = "";

  if(type==="post"){
    host.appendChild(fieldInput("×›×•×ª×¨×ª", "f_title", safe(obj.title)));
    host.appendChild(fieldArea("×ª×•×›×Ÿ", "f_text", safe(obj.text)));
    host.appendChild(fieldInput("××—×‘×¨", "f_author", safe(obj.author||obj.username||obj.user||obj.name)));
    host.appendChild(fieldInput("time (timestamp)", "f_time", String(num(obj.time)), true));
    host.appendChild(fieldInput("likes", "f_likes", String(num(obj.likes)), true));
    host.appendChild(fieldInput("commentsCount", "f_commentsCount", (obj.commentsCount===undefined||obj.commentsCount===null)?"":String(num(obj.commentsCount)), true));
    host.appendChild(fieldInput("lastCommentTime", "f_lastCommentTime", String(num(obj.lastCommentTime)), true));
    host.appendChild(fieldInput("imagePath", "f_imagePath", safe(obj.imagePath||""), true));

    el("commentsBox").classList.remove("hidden");
    el("btnDeleteNode").textContent = "ğŸ—‘ ××—×§ ×¤×•×¡×˜ (×¢××•×§)";
  }else{
    host.appendChild(fieldInput("××—×‘×¨", "f_author", safe(obj.author||obj.username||obj.user||obj.name)));
    host.appendChild(fieldArea("×˜×§×¡×˜", "f_text", safe(obj.text||obj.body||obj.message)));
    host.appendChild(fieldInput("time (timestamp)", "f_time", String(num(obj.time)), true));

    el("commentsBox").classList.add("hidden");
    el("btnDeleteNode").textContent = "ğŸ—‘ ××—×§ ×ª×’×•×‘×” (×¢× ×™×œ×“×™×)";
  }

  el("overlay").style.display = "flex";
}

function closeSheet(){
  el("overlay").style.display = "none";
  el("commentsWrap").innerHTML = "";
  el("commentsBox").open = false;
}

el("btnCloseSheet").onclick = closeSheet;
el("overlay").addEventListener("click", function(e){
  if(e.target === el("overlay")) closeSheet();
});

/* =========================
   POST EDIT
========================= */
function openPostEditor(postId, autoLoadComments){
  var p = S.postsMap[postId];
  if(!p){ toast("×œ× ××¦××ª×™ ×¤×•×¡×˜ ×‘×ª×¦×•×’×”","warn"); return; }
  var path = POSTS_PATH + "/" + postId;
  openSheet("âœï¸ ×¢×¨×™×›×ª ×¤×•×¡×˜", path, "post", postId, p.raw || {});
  if(autoLoadComments){
    el("commentsBox").open = true;
    loadCommentsForPost(postId);
  }
}

function openCommentEditor(path, postId, obj){
  openSheet("âœï¸ ×¢×¨×™×›×ª ×ª×’×•×‘×”", path, "comment", postId, obj||{});
}

/* SAVE FIELDS */
el("btnSaveFields").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  if(!c.path) return;

  if(c.type==="post"){
    var up = {};
    up[c.path + "/title"] = safe(el("f_title").value);
    up[c.path + "/text"] = safe(el("f_text").value);
    up[c.path + "/author"] = safe(el("f_author").value) || null;
    up[c.path + "/time"] = num(el("f_time").value);
    up[c.path + "/likes"] = num(el("f_likes").value);

    var cc = safe(el("f_commentsCount").value).trim();
    up[c.path + "/commentsCount"] = (cc==="" ? null : num(cc));

    up[c.path + "/lastCommentTime"] = num(el("f_lastCommentTime").value);

    var ip = safe(el("f_imagePath").value).trim();
    up[c.path + "/imagePath"] = ip ? ip : null;

    if(!confirmDanger("×œ×©××•×¨ ×¤×•×¡×˜?")) return;

    setBusy(true);
    firebase.database().ref().update(up)
      .then(function(){
        toast("× ×©××¨ âœ…","ok");
        return resetAndLoadPosts();
      })
      .catch(function(err){
        toast("×©×’×™××” ×‘×©××™×¨×”: " + safe(err && err.message || err), "err");
      })
      .finally(function(){ setBusy(false); });
  }else{
    var author = safe(el("f_author").value);
    var text = safe(el("f_text").value);
    var time = num(el("f_time").value);

    var up2 = {};
    up2[c.path + "/author"] = author || null;
    up2[c.path + "/username"] = author || null;
    up2[c.path + "/user"] = author || null;
    up2[c.path + "/name"] = author || null;

    up2[c.path + "/text"] = text;
    up2[c.path + "/body"] = text;
    up2[c.path + "/message"] = text;

    up2[c.path + "/time"] = time;

    if(!confirmDanger("×œ×©××•×¨ ×ª×’×•×‘×”?")) return;

    setBusy(true);
    firebase.database().ref().update(up2)
      .then(function(){
        toast("×ª×’×•×‘×” × ×©××¨×” âœ…","ok");
        if(c.postId){
          return recalcPostMeta(c.postId, false).then(function(){
            return loadCommentsForPost(c.postId);
          }).then(resetAndLoadPosts);
        }
        return resetAndLoadPosts();
      })
      .catch(function(err){
        toast("×©×’×™××” ×‘×©××™×¨×”: " + safe(err && err.message || err), "err");
      })
      .finally(function(){ setBusy(false); });
  }
};

/* SAVE JSON (SET) */
el("btnSaveJson").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  var parsed = tryParseJson(safe(el("rawJson").value));
  if(!parsed.ok){ toast("JSON ×œ× ×ª×§×™×Ÿ","err"); return; }
  if(!confirmDanger("×œ×©××•×¨ JSON (SET)? ×–×” ××—×œ×™×£ ×”×›×œ.")) return;

  setBusy(true);
  firebase.database().ref(c.path).set(parsed.v)
    .then(function(){
      toast("JSON × ×©××¨ âœ…","ok");
      if(c.type==="comment" && c.postId){
        return recalcPostMeta(c.postId, false).then(function(){
          return loadCommentsForPost(c.postId);
        }).then(resetAndLoadPosts);
      }
      return resetAndLoadPosts();
    })
    .catch(function(err){
      toast("×©×’×™××”: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
};

/* DELETE */
el("btnDeleteNode").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  if(!c.path) return;

  if(c.type==="post"){
    deepDeletePost(c.postId, false);
    return;
  }

  if(!confirmDanger("×œ××—×•×§ ×ª×’×•×‘×”? ×›×œ ×”×™×œ×“×™× ×©×œ×” ×™××—×§×• ××•×˜×•××˜×™×ª.")) return;

  setBusy(true);
  firebase.database().ref(c.path).remove()
    .then(function(){
      toast("×ª×’×•×‘×” × ××—×§×” âœ…","ok");
      if(c.postId){
        return recalcPostMeta(c.postId, false).then(function(){
          return loadCommentsForPost(c.postId);
        }).then(resetAndLoadPosts);
      }
      return resetAndLoadPosts();
    })
    .catch(function(err){
      toast("×©×’×™××” ×‘××—×™×§×”: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
};

/* =========================
   COMMENTS TREE
========================= */
function pickRepliesContainers(v){
  var arr = [];
  if(v && typeof v==="object"){
    if(v.replies && typeof v.replies==="object") arr.push({name:"replies", obj:v.replies});
    if(v.reply && typeof v.reply==="object") arr.push({name:"reply", obj:v.reply});
    if(v.responses && typeof v.responses==="object") arr.push({name:"responses", obj:v.responses});
    if(v.children && typeof v.children==="object") arr.push({name:"children", obj:v.children});
    if(v.subReplies && typeof v.subReplies==="object") arr.push({name:"subReplies", obj:v.subReplies});
  }
  return arr;
}

function loadCommentsForPost(postId){
  el("commentsWrap").innerHTML = '<div class="mini muted">×˜×•×¢×Ÿ ×ª×’×•×‘×•×ªâ€¦</div>';

  return Promise.all([
    firebase.database().ref(COMMENTS_PATH + "/" + postId).once("value"),
    firebase.database().ref(REPLIES_PATH + "/" + postId).once("value")
  ])
  .then(function(res){
    var snapC = res[0];
    var snapR = res[1];

    var commentsObj = snapC.exists() ? (snapC.val()||{}) : {};
    var repliesRoot = snapR.exists() ? (snapR.val()||{}) : {};

    el("commentsWrap").innerHTML = "";

    if(!commentsObj || typeof commentsObj!=="object" || !Object.keys(commentsObj).length){
      el("commentsWrap").innerHTML = '<div class="mini muted">××™×Ÿ ×ª×’×•×‘×•×ª ×œ×¤×•×¡×˜ ×”×–×”.</div>';
      return;
    }

    var keys = Object.keys(commentsObj);
    keys.sort(function(a,b){ return num((commentsObj[a]||{}).time) - num((commentsObj[b]||{}).time); });

    keys.forEach(function(cid){
      var path = COMMENTS_PATH + "/" + postId + "/" + cid;

      // ×ª×’×•×‘×” ×¨××©×™×ª
      var node = buildCommentNode(postId, cid, path, commentsObj[cid], 0);

      // replies ×©×©×™×™×›×™× ×œ×ª×’×•×‘×” ×”×–×•: replies/{postId}/{cid}/...
      var rObj = (repliesRoot && repliesRoot[cid] && typeof repliesRoot[cid]==="object") ? repliesRoot[cid] : null;
      if(rObj && Object.keys(rObj).length){
        var wrap = document.createElement("div");
        wrap.className = "indent";
        wrap.style.marginTop = "10px";

        var rKeys = Object.keys(rObj);
        rKeys.sort(function(a,b){ return num((rObj[a]||{}).time) - num((rObj[b]||{}).time); });

        rKeys.forEach(function(rid){
          var rPath = REPLIES_PATH + "/" + postId + "/" + cid + "/" + rid;
          wrap.appendChild(buildReplyNode(postId, rid, rPath, rObj[rid], 0));
        });

        node.appendChild(wrap);
      }

      el("commentsWrap").appendChild(node);
    });
  })
  .catch(function(err){
    el("commentsWrap").innerHTML = '<div class="mini muted wrapText">×©×’×™××”: '+escapeHtml(safe(err && err.message || err))+'</div>';
  });
}
function replyChildKeys(node){
  if(!node || typeof node!=="object") return [];
  var reserved = {author:1, text:1, time:1, username:1, user:1, name:1, body:1, message:1};
  return Object.keys(node).filter(function(k){
    if(reserved[k]) return false;
    return node[k] && typeof node[k]==="object";
  });
}

function buildReplyNode(postId, key, path, data, depth){
  data = data || {};
  var author = safe(data.author || data.username || data.user || data.name || "â€”");
  var text = safe(data.text || data.body || data.message || "");
  var time = num(data.time);

  var box = document.createElement("div");
  box.className = "cNode" + (depth>0 ? " indent" : "");
  box.innerHTML = `
    <div class="cHead">
      <div class="cMeta">
        <span class="chip">key: <b class="mono">${escapeHtml(key)}</b></span>
        <span class="chip">×××ª: <b class="wrapText">${escapeHtml(author)}</b></span>
        <span class="chip">×–××Ÿ: <b>${escapeHtml(time?fmtDate(time):"â€”")}</b></span>
      </div>
      <div class="tools">
        <button class="btn small" data-act="edit">âœï¸</button>
        <button class="btn small danger" data-act="del">ğŸ—‘</button>
      </div>
    </div>
    <div class="cText wrapText">${escapeHtml(text)}</div>
  `;

  box.addEventListener("click", function(e){
    var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
    if(!b) return;
    var act = b.getAttribute("data-act");

    if(act==="edit"){
      openCommentEditor(path, postId, data);
    }

    if(act==="del"){
      if(!confirmDanger("×œ××—×•×§ ×ª×’×•×‘×”? ×”×™×œ×“×™× ×©×œ×” ×™××—×§×• ××•×˜×•××˜×™×ª.")) return;
      setBusy(true);
      firebase.database().ref(path).remove()
        .then(function(){
          toast("× ××—×§ âœ…","ok");
          return recalcPostMeta(postId, false).then(function(){
            return loadCommentsForPost(postId);
          }).then(resetAndLoadPosts);
        })
        .catch(function(err){
          toast("×©×’×™××”: "+safe(err && err.message || err), "err");
        })
        .finally(function(){ setBusy(false); });
    }
  });

  var kids = replyChildKeys(data);
  if(kids.length && depth < MAX_REPLIES_DEPTH){
    kids.sort(function(a,b){
      return num((data[a]||{}).time) - num((data[b]||{}).time);
    });
    kids.forEach(function(kid){
      box.appendChild(buildReplyNode(postId, kid, path + "/" + kid, data[kid], depth+1));
    });
  }

  return box;
}

function buildCommentNode(postId, key, path, data, depth){
  data = data || {};
  var author = safe(data.author || data.username || data.user || data.name || "â€”");
  var text = safe(data.text || data.body || data.message || "");
  var time = num(data.time);

  var box = document.createElement("div");
  box.className = "cNode" + (depth>0 ? " indent" : "");
  box.innerHTML = `
    <div class="cHead">
      <div class="cMeta">
        <span class="chip">key: <b class="mono">${escapeHtml(key)}</b></span>
        <span class="chip">×××ª: <b class="wrapText">${escapeHtml(author)}</b></span>
        <span class="chip">×–××Ÿ: <b>${escapeHtml(time?fmtDate(time):"â€”")}</b></span>
      </div>
      <div class="tools">
        <button class="btn small" data-act="edit">âœï¸</button>
        <button class="btn small danger" data-act="del">ğŸ—‘</button>
      </div>
    </div>
    <div class="cText wrapText">${escapeHtml(text)}</div>
  `;

  box.addEventListener("click", function(e){
    var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
    if(!b) return;
    var act = b.getAttribute("data-act");
    if(act==="edit"){
      openCommentEditor(path, postId, data);
    }
    if(act==="del"){
      if(!confirmDanger("×œ××—×•×§ ×ª×’×•×‘×”? ×”×™×œ×“×™× ×©×œ×” ×™××—×§×• ××•×˜×•××˜×™×ª.")) return;
      setBusy(true);
      var up = {};
      up[path] = null;

      if(depth===0){
        up[REPLIES_PATH + "/" + postId + "/" + key] = null;
      }

      firebase.database().ref().update(up)
        .then(function(){
          toast("× ××—×§ âœ…","ok");
          return recalcPostMeta(postId, false).then(function(){
            return loadCommentsForPost(postId);
          }).then(resetAndLoadPosts);
        })
        .catch(function(err){
          toast("×©×’×™××”: "+safe(err && err.message || err), "err");
        })
        .finally(function(){ setBusy(false); });
    }
  });

  if(depth < MAX_REPLIES_DEPTH){
    pickRepliesContainers(data).forEach(function(cn){
      var o = cn.obj || {};
      var rKeys = Object.keys(o);
      if(!rKeys.length) return;

      rKeys.sort(function(a,b){ return num((o[a]||{}).time) - num((o[b]||{}).time); });
      rKeys.forEach(function(rid){
        var childPath = path + "/" + cn.name + "/" + rid;
        box.appendChild(buildCommentNode(postId, rid, childPath, o[rid], depth+1));
      });
    });
  }
  return box;
}

/* =========================
   META RECALC + FIX ALL
========================= */
function computeMetaFromCommentsObj(obj){
  var commentsCount = 0;
  var lastTime = 0;

  function isObj(v){ return !!v && typeof v === "object"; }

  function isCommentLike(node){
    if(!isObj(node)) return false;

    var hasText =
      (node.text!==undefined && node.text!==null && safe(node.text)!=="") ||
      (node.body!==undefined && node.body!==null && safe(node.body)!=="") ||
      (node.message!==undefined && node.message!==null && safe(node.message)!=="");

    var hasAuthor =
      (node.author!==undefined && node.author!==null && safe(node.author)!=="") ||
      (node.username!==undefined && node.username!==null && safe(node.username)!=="") ||
      (node.user!==undefined && node.user!==null && safe(node.user)!=="") ||
      (node.name!==undefined && node.name!==null && safe(node.name)!=="");

    var hasTime = (node.time!==undefined && node.time!==null && num(node.time)>0);

    return (hasTime && (hasText || hasAuthor)) || (hasText && hasAuthor);
  }

  var seen = [];
  function wasSeen(o){
    for(var i=0;i<seen.length;i++){ if(seen[i]===o) return true; }
    return false;
  }

  function walk(node, depth){
    if(!isObj(node) || depth<=0) return;
    if(wasSeen(node)) return;
    seen.push(node);

    var t = num(node.time);
    if(t>lastTime) lastTime = t;

    if(isCommentLike(node)) commentsCount += 1;

    pickRepliesContainers(node).forEach(function(cn){
      var o = cn.obj || {};
      Object.keys(o).forEach(function(k){
        walk(o[k], depth-1);
      });
    });

    Object.keys(node).forEach(function(k){
      var v = node[k];
      if(!isObj(v)) return;
      if(k==="replies" || k==="reply" || k==="responses" || k==="children" || k==="subReplies") return;
      walk(v, depth-1);
    });
  }

  if(obj && typeof obj==="object"){
    Object.keys(obj).forEach(function(cid){
      walk(obj[cid], MAX_REPLIES_DEPTH + 8);
    });
  }

  return { commentsCount: num(commentsCount), lastCommentTime: num(lastTime) };
}
function maxTimeDeep(root, depth){
  var last = 0;
  depth = num(depth || 60);

  var seen = [];
  function mark(o){
    for(var i=0;i<seen.length;i++){ if(seen[i]===o) return true; }
    seen.push(o);
    return false;
  }

  function walk(node, d){
    if(!node || typeof node !== "object" || d < 0) return;
    if(mark(node)) return;

    var t = num(node.time);
    if(t > last) last = t;

    Object.keys(node).forEach(function(k){
      var v = node[k];
      if(v && typeof v === "object") walk(v, d-1);
    });
  }

  walk(root, depth);
  return last;
}
function recalcPostMeta(postId, showToast){
  if(showToast) toast("××ª×§×Ÿ ××•× ×™×â€¦","warn");

  return Promise.all([
    firebase.database().ref(COMMENTS_PATH + "/" + postId).once("value"),
    firebase.database().ref(REPLIES_PATH + "/" + postId).once("value")
  ])
  .then(function(res){
    var snapC = res[0];
    var snapR = res[1];

    var commentsObj = snapC.exists() ? (snapC.val()||{}) : {};
    var repliesObj  = snapR.exists() ? (snapR.val()||{}) : {};

    var meta = computeMetaFromCommentsObj(commentsObj);
    var repliesLast = maxTimeDeep(repliesObj, MAX_REPLIES_DEPTH + 25);
    var finalLast = Math.max(num(meta.lastCommentTime), num(repliesLast));

    var up = {};
    up[POSTS_PATH + "/" + postId + "/commentsCount"] = num(meta.commentsCount);
    up[POSTS_PATH + "/" + postId + "/lastCommentTime"] = num(finalLast);

    return firebase.database().ref().update(up).then(function(){
      if(showToast) toast("××•× ×™× ×¢×•×“×›× ×• âœ…","ok");
    });
  })
  .catch(function(err){
    toast("×©×’×™××” ×‘×ª×™×§×•×Ÿ ××•× ×™×: " + safe(err && err.message || err), "err");
  });
}

function fixAllPosts(){
  if(!S.isAdmin) return;
  if(!confirmDanger("â€œ×¢×©×” ×¡×“×¨â€ ×™×¨×•×¥ ×¢×œ ×”×¨×‘×” ×¤×•×¡×˜×™× (××•×’×‘×œ ×œ-300). ×œ×”××©×™×š?")) return;

  setBusy(true);
  progReset();
  el("toolsMsg").textContent = "×˜×•×¢×Ÿ ×¤×•×¡×˜×™×â€¦";
  prog(2,"×˜×•×¢×Ÿ ×¨×©×™××ª ×¤×•×¡×˜×™×â€¦");

  var HARD_LIMIT = 300;

  firebase.database().ref(POSTS_PATH).orderByChild("time").limitToLast(HARD_LIMIT).once("value")
    .then(function(snap){
      var ids = [];
      snap.forEach(function(ch){ ids.push(ch.key); });

      if(!ids.length){
        el("toolsMsg").textContent = "××™×Ÿ ×¤×•×¡×˜×™× ×œ×ª×§×Ÿ.";
        toast("××™×Ÿ ×¤×•×¡×˜×™× ×œ×ª×§×Ÿ","warn");
        return;
      }

      el("toolsMsg").textContent = "××ª×—×™×œâ€¦ ("+ids.length+")";
      var i=0;

      function step(){
        if(i>=ids.length){
          prog(100,"×¡×™×•× âœ…");
          el("toolsMsg").textContent = "×¡×™×™××ª×™ â€œ×¢×©×” ×¡×“×¨â€ ×¢×œ " + ids.length + " ×¤×•×¡×˜×™×.";
          toast("×¡×™×™××ª×™ âœ…","ok");
          return resetAndLoadPosts();
        }
        var pct = Math.round((i/ids.length)*100);
        prog(pct, "××ª×§×Ÿ ("+(i+1)+"/"+ids.length+")");
        el("toolsMsg").textContent = "×¤×•×¡×˜: " + ids[i];

        recalcPostMeta(ids[i], false).finally(function(){
          i++;
          setTimeout(step, 25);
        });
      }
      step();
    })
    .catch(function(err){
      el("toolsMsg").textContent = "×©×’×™××”: " + safe(err && err.message || err);
      toast("×©×’×™××” ×‘×¢×©×”-×¡×“×¨: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
}
el("btnFixAll").onclick = fixAllPosts;

/* =========================
   DEEP DELETE POST
========================= */
function deepDeletePost(postId, closeSheetAfter){
  if(!postId) return;
  if(!confirmDanger("×œ××—×•×§ ×¤×•×¡×˜ ×¢××•×§?\nposts/"+postId+"\n×•×’× comments/"+postId+"\n×•×’× ×ª××•× ×•×ª ×‘-storage ×× ×™×©")) return;

  setBusy(true);
  toast("××•×—×§â€¦","warn");

  var up = {};
  up[POSTS_PATH + "/" + postId] = null;
  up[COMMENTS_PATH + "/" + postId] = null;
  up[REPLIES_PATH + "/" + postId] = null;

  firebase.database().ref().update(up)
    .then(function(){
      var folderRef = firebase.storage().ref(STORAGE_POST_FOLDER + "/" + postId);
      return folderRef.listAll().then(function(res){
        var ps = [];
        (res.items||[]).forEach(function(itemRef){ ps.push(itemRef.delete().catch(function(){})); });
        return Promise.all(ps);
      }).catch(function(){});
    })
    .then(function(){
      toast("×¤×•×¡×˜ × ××—×§ âœ…","ok");
      if(closeSheetAfter) closeSheet();
      return resetAndLoadPosts();
    })
    .catch(function(err){
      toast("×©×’×™××” ×‘××—×™×§×”: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
}

/* =========================
   EXPORT visible posts
========================= */
el("btnExportVisible").onclick = function(){
  if(!S.isAdmin) return;
  var data = (S.posts||[]).map(function(p){
    return {
      id: p.id,
      title: p.title,
      text: p.text,
      author: p.author,
      time: p.time,
      likes: p.likes,
      commentsCount: p.commentsCount,
      lastCommentTime: p.lastCommentTime,
      imagePath: p.imagePath
    };
  });

  var blob = new Blob([pretty(data)], {type:"application/json"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "posts_export_" + Date.now() + ".json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(function(){ try{ URL.revokeObjectURL(url);}catch(e){} }, 1200);
  toast("×™×•×¦× ×§×•×‘×¥ âœ…","ok");
};

/* =========================
   RENAME
========================= */
function applyUpdatesChunked(updates, chunkSize){
  chunkSize = chunkSize || 450;
  var keys = Object.keys(updates||{});
  if(!keys.length) return Promise.resolve(0);

  var i=0, applied=0;
  function step(){
    if(i>=keys.length) return Promise.resolve(applied);
    var part = {};
    for(var k=0; k<chunkSize && i<keys.length; k++, i++){
      part[keys[i]] = updates[keys[i]];
    }
    return firebase.database().ref().update(part).then(function(){
      applied += Object.keys(part).length;
      return step();
    });
  }
  return step();
}

function renameInCommentTree(rootObj, rootPath, oldName, newName, depth){
  depth = depth || MAX_REPLIES_DEPTH;
  var up = {};

  function setIfMatch(node, path, d){
    if(!node || typeof node!=="object") return;

    ["author","username","user","name"].forEach(function(f){
      if(node[f] !== undefined && node[f] !== null && safe(node[f]) === oldName){
        up[path + "/" + f] = newName;
      }
    });

    if(d<=0) return;
    pickRepliesContainers(node).forEach(function(cn){
      var o = cn.obj || {};
      Object.keys(o).forEach(function(k){
        setIfMatch(o[k], path + "/" + cn.name + "/" + k, d-1);
      });
    });
  }

  if(rootObj && typeof rootObj==="object"){
    Object.keys(rootObj).forEach(function(k){
      setIfMatch(rootObj[k], rootPath + "/" + k, depth);
    });
  }

  return up;
}

function renameEverywhere(oldName, newName){
  oldName = safe(oldName).trim();
  newName = safe(newName).trim();

  if(!oldName || !newName){ toast("×—×¡×¨ ×©× × ×•×›×—×™ ××• ×—×“×©","warn"); return; }
  if(oldName === newName){ toast("××™×Ÿ ×©×™× ×•×™","warn"); return; }
  if(!confirmDanger("×œ×©× ×•×ª ×©× ×‘×›×œ ××§×•×?\n×: " + oldName + "\n×œ: " + newName)) return;

  setBusy(true);
  progReset();
  el("renameMsg").textContent = "××ª×—×™×œâ€¦";
  toast("×¢×•×‘×“â€¦","warn");

  var totalUpdates = 0;

  prog(5,"×¡×•×¨×§ usersâ€¦");
  firebase.database().ref(USERS_PATH).limitToLast(6000).once("value")
    .then(function(snap){
      var up = {};
      var matched = 0;

      snap.forEach(function(ch){
        var uid = ch.key;
        var v = ch.val() || {};
        if(safe(v.username) === oldName){
          up[USERS_PATH + "/" + uid + "/username"] = newName;
          matched++;
        }
      });

      el("renameMsg").textContent = "users: × ××¦××• " + matched + " ×”×ª×××•×ª.";
      prog(18,"××¢×“×›×Ÿ usersâ€¦");
      return applyUpdatesChunked(up, 500).then(function(n){ totalUpdates += n; });
    })
    .then(function(){
      prog(30,"×¡×•×¨×§ postsâ€¦");
      return firebase.database().ref(POSTS_PATH).limitToLast(1500).once("value");
    })
    .then(function(ps){
      var up = {};
      var matched = 0;

      ps.forEach(function(ch){
        var id = ch.key;
        var v = ch.val() || {};
        var base = POSTS_PATH + "/" + id;

        ["author","username","user","name"].forEach(function(f){
          if(v[f] !== undefined && v[f] !== null && safe(v[f]) === oldName){
            up[base + "/" + f] = newName;
            matched++;
          }
        });
      });

      el("renameMsg").textContent += "\nposts: ×”×ª×××•×ª ×©×“×”: " + matched;
      prog(48,"××¢×“×›×Ÿ postsâ€¦");
      return applyUpdatesChunked(up, 450).then(function(n){ totalUpdates += n; });
    })
    .then(function(){
      prog(60,"×¡×•×¨×§ commentsâ€¦");
      return firebase.database().ref(COMMENTS_PATH).limitToLast(900).once("value");
    })
    .then(function(cs){
      var bigUp = {};
      var roots = 0;

      cs.forEach(function(ch){
        var postId = ch.key;
        var obj = ch.val() || {};
        roots++;

        var local = renameInCommentTree(obj, COMMENTS_PATH + "/" + postId, oldName, newName, MAX_REPLIES_DEPTH);
        Object.keys(local).forEach(function(k){ bigUp[k] = local[k]; });
      });

      el("renameMsg").textContent += "\ncomments roots: " + roots + " | updates: " + Object.keys(bigUp).length;
      prog(82,"××¢×“×›×Ÿ commentsâ€¦");
      return applyUpdatesChunked(bigUp, 350).then(function(n){ totalUpdates += n; });
    })
    .then(function(){
      prog(100,"×¡×™×•× âœ…");
      el("renameMsg").textContent += "\n×¡×”×´×› ×©×™× ×•×™×™×: " + totalUpdates;
      toast("×¡×™×™××ª×™ âœ…","ok");
      return resetAndLoadPosts();
    })
    .catch(function(err){
      el("renameMsg").textContent = "×©×’×™××”: " + safe(err && err.message || err);
      toast("×©×’×™××”: " + safe(err && err.message || err), "err");
    })
    .finally(function(){ setBusy(false); });
}
el("btnRename").onclick = function(){ renameEverywhere(el("oldName").value, el("newName").value); };

/* =========================
   FIX: qSearch render filter without reload (keeps original list)
========================= */
(function(){
  var lastQ = "";
  el("qSearch").addEventListener("input", function(){
    var q = safe(el("qSearch").value).trim().toLowerCase();
    if(q === lastQ) return;
    lastQ = q;

    if(!q){
      renderPosts();
      return;
    }
    var filtered = (S.posts||[]).filter(function(p){
      var blob = (p.id+" "+p.title+" "+p.text+" "+p.author).toLowerCase();
      return blob.indexOf(q)!==-1;
    });
    var host = el("postsList");
    host.innerHTML = "";
    if(!filtered.length){
      host.innerHTML = '<div class="mini muted">××™×Ÿ ×ª×•×¦××•×ª.</div>';
      return;
    }
    filtered.forEach(function(p){
      var cc = (p.commentsCount===null) ? "?" : String(num(p.commentsCount));
      var lc = p.lastCommentTime ? fmtDate(p.lastCommentTime) : "â€”";
      var card = document.createElement("div");
      card.className = "post";
      card.innerHTML = `
        <div class="title wrapText">${escapeHtml(p.title || "(×œ×œ× ×›×•×ª×¨×ª)")}</div>
        <div class="chips">
          <span class="chip">ID: <b class="mono">${escapeHtml(p.id)}</b></span>
          <span class="chip">×××ª: <b class="wrapText">${escapeHtml(p.author || "â€”")}</b></span>
          <span class="chip">×–××Ÿ: <b>${escapeHtml(fmtDate(p.time))}</b></span>
          <span class="chip">×ª×’×•×‘×•×ª: <b class="mono">${escapeHtml(cc)}</b></span>
          <span class="chip">××—×¨×•× ×”: <b>${escapeHtml(lc)}</b></span>
        </div>
        <div class="snippet wrapText">${escapeHtml(shorten(p.text, 180))}</div>
        <div class="tools">
          <button class="btn small" data-act="edit">âœï¸ ×¢×¨×•×š</button>
          <button class="btn small" data-act="comments">ğŸ’¬ ×ª×’×•×‘×•×ª</button>
          <button class="btn small" data-act="recalc">ğŸ§® ×ª×§×Ÿ ××•× ×™×</button>
          <button class="btn small danger" data-act="delete">ğŸ—‘ ××—×§</button>
        </div>
      `;
      card.addEventListener("click", function(e){
        var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
        if(!b) return;
        var act = b.getAttribute("data-act");
        if(act==="edit") openPostEditor(p.id, false);
        if(act==="comments") openPostEditor(p.id, true);
        if(act==="recalc") recalcPostMeta(p.id, true);
        if(act==="delete") deepDeletePost(p.id, true);
      });
      host.appendChild(card);
    });
  });
})();

/* =========================
   âœ… USERS MONITOR (presence)
   DB structure:
   presence/{uid} = { connectedAt, isOnline, lastSeen, username }
========================= */
var _presenceRef = null;
var _presenceHandler = null;

function normalizePresence(uid, v){
  v = v || {};
  return {
    uid: uid,
    username: safe(v.username || v.name || v.author || v.user || ""),
    isOnline: (v.isOnline === true),
    connectedAt: num(v.connectedAt),
    lastSeen: num(v.lastSeen)
  };
}

function sortPresence(arr){
  // Online first, and online sorted by latest connectedAt
  // Offline sorted by latest lastSeen
  arr.sort(function(a,b){
    var ao = a.isOnline ? 1 : 0;
    var bo = b.isOnline ? 1 : 0;
    if(bo !== ao) return bo - ao;

    if(a.isOnline && b.isOnline){
      return num(b.connectedAt) - num(a.connectedAt);
    }
    return num(b.lastSeen) - num(a.lastSeen);
  });
  return arr;
}

function renderUsersList(){
  var host = el("usersList");
  if(!host) return;

  var q = safe(el("usersSearch").value).trim().toLowerCase();
  var arr = (S.presenceArr || []).slice();

  if(q){
    arr = arr.filter(function(x){
      var blob = (safe(x.username) + " " + safe(x.uid)).toLowerCase();
      return blob.indexOf(q) !== -1;
    });
  }

  if(!arr.length){
    host.innerHTML = '<div class="mini muted">××™×Ÿ ××©×ª××©×™× ×‘×ª×¦×•×’×”.</div>';
    return;
  }

  host.innerHTML = "";
  arr.forEach(function(x){
    var isOnline = !!x.isOnline;
    var name = x.username || "××©×ª××© ×œ×œ× ×©×";
    var lastSeenLabel = isOnline ? "×¢×›×©×™×•" : formatLastSeenHuman(x.lastSeen);
    var conn = computeConnectionInfo(isOnline, x.connectedAt, x.lastSeen);

    var card = document.createElement("div");
    card.className = "uCard " + (isOnline ? "online" : "offline");

    card.innerHTML = `
      <div class="uHead">
        <div style="min-width:0;">
          <div class="uName">${escapeHtml(name)}</div>
          <div class="uSub wrapText">${escapeHtml(x.uid)}</div>
        </div>
        <div class="uStatus">
          <span class="sDot"></span>
          <span>${isOnline ? "××•× ×œ×™×™×Ÿ" : "××•×¤×œ×™×™×Ÿ"}</span>
        </div>
      </div>

      <div class="uGrid">
        <div class="uLine">
          <div class="k">× ×¨××” ×œ××—×¨×•× ×”</div>
          <div class="v">${escapeHtml(lastSeenLabel)}</div>
        </div>
        <div class="uLine">
          <div class="k">${escapeHtml(conn.label)}</div>
          <div class="v">${escapeHtml(conn.value)}</div>
        </div>
      </div>
    `;

    host.appendChild(card);
  });

  // keep badge updated even when filtered
  var onlineCount = (S.presenceArr||[]).filter(function(x){ return !!x.isOnline; }).length;
  el("usersBadge").textContent = "××•× ×œ×™×™×Ÿ: " + onlineCount + " | ×¡×”×´×›: " + (S.presenceArr||[]).length;
}

function stopPresenceWatch(){
  try{
    if(_presenceRef && _presenceHandler){
      _presenceRef.off("value", _presenceHandler);
    }
  }catch(e){}

  _presenceRef = null;
  _presenceHandler = null;

  S.presenceArr = [];
  S.presenceMap = {};

  if(el("usersBadge")) el("usersBadge").textContent = "â€”";
  if(el("usersList")) el("usersList").innerHTML = '<div class="mini muted">×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª × ×™×˜×•×¨â€¦</div>';
}

function startPresenceWatch(){
  if(!S.isAdmin) return;
  stopPresenceWatch();

  var ref = firebase.database().ref(PRESENCE_PATH);
  if(PRESENCE_LIST_LIMIT && PRESENCE_LIST_LIMIT > 0){
    // if ever needed
    ref = ref.orderByChild("lastSeen").limitToLast(PRESENCE_LIST_LIMIT);
  }
  _presenceRef = ref;

  _presenceHandler = function(snap){
    var arr = [];
    var map = {};

    snap.forEach(function(ch){
      var uid = ch.key;
      var item = normalizePresence(uid, ch.val());

      map[uid] = item;
      arr.push(item);
    });

    sortPresence(arr);

    S.presenceArr = arr;
    S.presenceMap = map;

    renderUsersList();
  };

  _presenceRef.on("value", _presenceHandler, function(err){
    toast("×©×’×™××” ×‘× ×™×˜×•×¨ ××©×ª××©×™×: " + safe(err && err.message || err), "err");
  });

  if(el("usersList")) el("usersList").innerHTML = '<div class="mini muted">×˜×•×¢×Ÿ ××©×ª××©×™×â€¦</div>';
}

if(el("usersSearch")){
  el("usersSearch").oninput = function(){ renderUsersList(); };
}
if(el("btnUsersRefresh")){
  el("btnUsersRefresh").onclick = function(){
    if(!S.isAdmin) return;
    startPresenceWatch();
    toast("××¨×¢× ×Ÿ ××©×ª××©×™×â€¦","warn");
  };
}
/* =========================
   âœ… /USERS MONITOR
========================= */

/* =========================
   AUTH STATE (after init is guaranteed)
========================= */
(function(){
  try{
    pill("warn","×œ× ××—×•×‘×¨");
    firebase.auth().onAuthStateChanged(function(u){
      S.user = u || null;
      S.uid = u ? u.uid : "";

      if(!u){
        S.isAdmin = false;
        pill("warn","×œ× ××—×•×‘×¨");
        el("btnLogin").classList.remove("hidden");
        el("btnLogout").classList.add("hidden");
        el("viewLogin").classList.remove("hidden");
        el("viewPosts").classList.add("hidden");
        el("viewUsers").classList.add("hidden");
        el("viewTools").classList.add("hidden");
        el("viewRename").classList.add("hidden");
        el("postsList").innerHTML = '<div class="mini muted">×”×ª×—×‘×¨ ×›×“×™ ×œ×¨××•×ª ×¤×•×¡×˜×™×â€¦</div>';

        stopPresenceWatch();

        return;
      }

      pill("warn","×‘×•×“×§ ××“××™×Ÿâ€¦");
      checkAdmin(u.uid).then(function(isAdmin){
        S.isAdmin = !!isAdmin;
        if(!S.isAdmin){
          pill("err","×œ× ××“××™×Ÿ");
          toast("×œ× ××“××™×Ÿ (admins/{uid}!=true)","err");

          stopPresenceWatch();

          return firebase.auth().signOut();
        }

        pill("ok","××“××™×Ÿ ××—×•×‘×¨");
        el("btnLogin").classList.add("hidden");
        el("btnLogout").classList.remove("hidden");
        el("viewLogin").classList.add("hidden");

        setActive("navPosts");
        el("viewPosts").classList.remove("hidden");
        el("viewUsers").classList.remove("hidden");
        el("viewTools").classList.remove("hidden");
        el("viewRename").classList.remove("hidden");

        resetAndLoadPosts();
        startPresenceWatch();
      }).catch(function(err){
        pill("err","×©×’×™××”");
        toast("×©×’×™××” ×‘×‘×“×™×§×ª ××“××™×Ÿ: " + safe(err && err.message || err), "err");

        stopPresenceWatch();
      });
    });
  }catch(e){
    pill("err","Init/Auth ×©×’×•×™");
    toast("Init/Auth × ×›×©×œ: " + safe(e && e.message || e), "err");
  }
})();

/* =========================
   FIX ALL BUTTON + EXPORT already bound
========================= */
toast("××•×›×Ÿ âœ…","ok");
</script>
</body>
</html>
