<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Admin Mobile â€” × ×™×”×•×œ ×¤×•×¨×•×</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="firebaseConfig.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(255,255,255,0.07);
      --card2: rgba(255,255,255,0.10);
      --stroke: rgba(255,255,255,0.12);
      --stroke2: rgba(255,255,255,0.20);
      --txt: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.68);
      --muted2: rgba(255,255,255,0.50);
      --ok:#2fe28a;
      --warn:#ffb020;
      --danger:#ff4d4d;
      --blue:#3b82f6;
      --violet:#8b5cf6;
      --shadow: 0 16px 60px rgba(0,0,0,0.55);
      --r:18px;
      --r2:14px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --safeTop: env(safe-area-inset-top);
      --safeBot: env(safe-area-inset-bottom);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 500px at 10% -10%, rgba(59,130,246,0.25), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(139,92,246,0.22), transparent 60%),
        radial-gradient(900px 600px at 50% 110%, rgba(47,226,138,0.12), transparent 60%),
        var(--bg);
      color:var(--txt);
      min-height:100vh;
      padding-bottom: calc(68px + var(--safeBot));
    }
    a{ color:inherit; }
    .app{
      max-width: 520px;
      margin:0 auto;
      padding: 12px;
      padding-top: calc(12px + var(--safeTop));
    }

    /* Top */
    .top{
      position: sticky;
      top:0;
      z-index:20;
      margin: -12px -12px 12px;
      padding: 12px 12px 10px;
      padding-top: calc(12px + var(--safeTop));
      backdrop-filter: blur(12px);
      background: rgba(11,16,32,0.72);
      border-bottom: 1px solid var(--stroke);
    }
    .brandRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92));
      box-shadow: 0 10px 22px rgba(59,130,246,0.18);
      flex:0 0 auto;
    }
    .brandTxt{
      min-width:0;
    }
    .brandTxt .t{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandTxt .s{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-top:2px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      font-size:12px;
      color:var(--muted);
      user-select:none;
      flex:0 0 auto;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background:var(--muted2); }
    .pill.ok .dot{ background:var(--ok); }
    .pill.warn .dot{ background:var(--warn); }
    .pill.err .dot{ background:var(--danger); }

    /* Search */
    .searchRow{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .in{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.28);
      color: var(--txt);
      outline:none;
      font-size:14px;
    }
    .in::placeholder{ color: rgba(255,255,255,0.45); }

    /* Cards */
    .card{
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 12px;
      border-bottom:1px solid var(--stroke);
      background: rgba(255,255,255,0.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .card .hd .h{
      font-weight:900;
      font-size:13px;
    }
    .card .bd{
      padding: 12px;
    }
    .muted{ color:var(--muted); }
    .mono{ font-family:var(--mono); }
    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .sp{ height:1px; background:var(--stroke); margin: 10px 0; }

    /* Buttons */
    .btn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      color:var(--txt);
      padding: 12px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92));
    }
    .btn.danger{
      border:1px solid rgba(255,77,77,0.45);
      background: rgba(255,77,77,0.10);
      color: #ffd1d1;
    }
    .btn.ghost{
      background: transparent;
      border: 1px dashed var(--stroke2);
      box-shadow:none;
    }
    .btn.small{
      padding: 10px 10px;
      font-size:12px;
      border-radius: 12px;
    }
    .btn.wide{ width:100%; justify-content:center; }

    /* Posts list */
    .list{ display:flex; flex-direction:column; gap:10px; }
    .post{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius: 18px;
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .post .t{
      font-weight:900;
      font-size:14px;
      line-height:1.25;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.22);
    }
    .chip b{ color:var(--txt); }
    .post .tools{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-start;
    }
    .snippet{
      font-size:13px;
      color: rgba(255,255,255,0.88);
      line-height:1.4;
      white-space: pre-wrap;
    }

    /* Bottom nav */
    .bottomNav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding-bottom: var(--safeBot);
      z-index:30;
      background: rgba(11,16,32,0.78);
      backdrop-filter: blur(12px);
      border-top:1px solid var(--stroke);
    }
    .bottomNav .bar{
      max-width: 520px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      padding: 10px 12px;
    }
    .navBtn{
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 10px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      font-weight:900;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn.active{
      color: var(--txt);
      background: rgba(59,130,246,0.18);
      border-color: rgba(59,130,246,0.35);
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: calc(78px + var(--safeBot));
      z-index: 50;
      max-width: 520px;
      margin:0 auto;
      display:none;
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke2);
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: var(--txt);
      font-size:13px;
      line-height:1.35;
    }
    .toast.ok{ border-color: rgba(47,226,138,0.35); background: rgba(47,226,138,0.12); }
    .toast.err{ border-color: rgba(255,77,77,0.45); background: rgba(255,77,77,0.12); }
    .toast.warn{ border-color: rgba(255,176,32,0.45); background: rgba(255,176,32,0.12); }

    /* Sheet modal */
    .overlay{
      position: fixed;
      inset:0;
      z-index: 60;
      background: rgba(0,0,0,0.62);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 12px;
      padding-bottom: calc(12px + var(--safeBot));
    }
    .sheet{
      width: min(520px, 100%);
      border:1px solid var(--stroke);
      background: rgba(15,20,40,0.96);
      border-radius: 22px;
      box-shadow: 0 24px 90px rgba(0,0,0,0.68);
      overflow:hidden;
      max-height: 88vh;
      display:flex;
      flex-direction:column;
    }
    .sheetHd{
      padding: 12px;
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(255,255,255,0.03);
    }
    .sheetHd .ttl{
      font-weight: 1000;
      font-size: 14px;
    }
    .sheetBd{
      padding: 12px;
      overflow:auto;
    }
    .sheetFt{
      padding: 12px;
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,0.02);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 10px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    textarea.in{ min-height: 110px; resize: vertical; }
    .mini{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }

    /* Progress */
    .prog{
      height: 10px;
      border-radius: 999px;
      border:1px solid var(--stroke2);
      background: rgba(255,255,255,0.06);
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,0.95), rgba(139,92,246,0.92));
    }

    /* Comments */
    .cNode{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .cHead{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .cMeta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      color:var(--muted);
      font-size:12px;
    }
    .cText{
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.4;
      color: rgba(255,255,255,0.90);
    }
    .indent{
      margin-right: 10px;
      padding-right: 10px;
      border-right: 2px dashed rgba(255,255,255,0.12);
    }

    .hidden{ display:none !important; }
  </style>
</head>

<body>
  <div class="top">
    <div class="brandRow">
      <div class="brand">
        <div class="logo">A</div>
        <div class="brandTxt">
          <div class="t">Admin Mobile â€” × ×™×”×•×œ ×¤×•×¨×•×</div>
          <div class="s">Realtime DB Â· ×¢×¨×™×›×”/××—×™×§×”/×¢×©×”-×¡×“×¨ Â· ××•×‘×™×™×œÖ¾×¤×™×¨×¡×˜</div>
        </div>
      </div>
      <div id="authPill" class="pill warn">
        <span class="dot"></span>
        <span id="authTxt">×œ× ××—×•×‘×¨</span>
      </div>
    </div>

    <div class="searchRow">
      <input id="q" class="in" type="search" placeholder="×—×¤×© ×¤×•×¡×˜ ×œ×¤×™ ×›×•×ª×¨×ª/×˜×§×¡×˜/××—×‘×¨/IDâ€¦" />
      <button id="btnRefresh" class="btn" type="button">ğŸ”„</button>
    </div>
  </div>

  <div class="app">
    <!-- LOGIN -->
    <div id="viewLogin" class="card">
      <div class="hd">
        <div class="h">×›× ×™×¡×”</div>
        <div class="muted" style="font-size:12px;">admins/{uid}=true</div>
      </div>
      <div class="bd">
        <div class="field">
          <label>××™××™×™×œ</label>
          <input id="loginEmail" class="in" type="email" placeholder="admin@example.com">
        </div>
        <div class="field">
          <label>×¡×™×¡××”</label>
          <input id="loginPass" class="in" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="row">
          <button id="btnLogin" class="btn primary wide" type="button">ğŸ” ×”×ª×—×‘×¨</button>
          <button id="btnLogout" class="btn danger wide hidden" type="button">â‹ ×”×ª× ×ª×§×•×ª</button>
        </div>
        <div class="sp"></div>
        <div class="mini" id="loginNote">×˜×™×¤: ×©××•×¨ ××©×ª××© ××“××™×Ÿ × ×¤×¨×“.</div>
      </div>
    </div>

    <!-- POSTS -->
    <div id="viewPosts" class="hidden">
      <div class="card" style="margin-top:12px;">
        <div class="hd">
          <div class="h">×¤×•×¡×˜×™×</div>
          <div class="muted" style="font-size:12px;">
            <span id="badgePosts">â€”</span>
          </div>
        </div>
        <div class="bd">
          <div class="row" style="justify-content:space-between;">
            <select id="limitSel" class="in" style="padding:10px 12px; width:auto; min-width: 150px;">
              <option value="50">50</option>
              <option value="120" selected>120</option>
              <option value="300">300</option>
            </select>
            <select id="sortSel" class="in" style="padding:10px 12px; width:auto; min-width: 170px;">
              <option value="newest" selected>×—×“×©×™× ×œ××¢×œ×”</option>
              <option value="oldest">×™×©× ×™× ×œ××¢×œ×”</option>
              <option value="lastComment">×ª×’×•×‘×” ××—×¨×•× ×”</option>
              <option value="comments">×›××•×ª ×ª×’×•×‘×•×ª</option>
              <option value="author">××—×‘×¨</option>
              <option value="title">×›×•×ª×¨×ª</option>
            </select>
          </div>

          <div class="sp"></div>

          <div id="postsList" class="list">
            <div class="muted">×”×ª×—×‘×¨ ×›×“×™ ×œ×˜×¢×•×Ÿâ€¦</div>
          </div>

          <div class="sp"></div>
          <button id="btnLoadMore" class="btn ghost wide hidden" type="button">â¬‡ï¸ ×˜×¢×Ÿ ×¢×•×“ (×¢×•×“ 120)</button>
        </div>
      </div>
    </div>

    <!-- TOOLS -->
    <div id="viewTools" class="hidden">
      <div class="card" style="margin-top:12px;">
        <div class="hd">
          <div class="h">×›×œ×™×</div>
          <div class="muted" style="font-size:12px;">××”×™×¨ ×•××“×•×™×§</div>
        </div>
        <div class="bd">
          <button id="btnFixAll" class="btn primary wide" type="button">ğŸ§¹ ×¢×©×” ×¡×“×¨ ×œ×›×œ ×”×¤×•×¡×˜×™×</button>
          <div class="mini" style="margin-top:8px;">
            ××ª×§×Ÿ ×œ×›×œ ×¤×•×¡×˜: <span class="mono">commentsCount</span> + <span class="mono">lastCommentTime</span> ×œ×¤×™ ×”×¢×¥ ×‘Ö¾<span class="mono">comments/{postId}</span>
          </div>

          <div class="sp"></div>

          <div class="field">
            <label>×™×™×¦×•× ×¤×•×¡×˜×™× ×©××•×¦×’×™× ×¢×›×©×™×• (JSON)</label>
            <button id="btnExport" class="btn wide" type="button">ğŸ“¦ Export</button>
          </div>

          <div class="sp"></div>

          <div class="field">
            <label>DB Quick (××•×¤×¦×™×•× ×œ×™ â€” ×œ××ª×§×“××™×)</label>
            <input id="quickPath" class="in mono" placeholder='×œ××©×œ: posts/POSTID/title'>
            <textarea id="quickVal" class="in mono" placeholder='value JSON (×œ××©×œ "×›×•×ª×¨×ª") ××• {"a":1}'></textarea>
            <div class="row">
              <button id="btnQSet" class="btn primary" type="button">SET</button>
              <button id="btnQUpdate" class="btn" type="button">UPDATE</button>
              <button id="btnQRemove" class="btn danger" type="button">REMOVE</button>
            </div>
            <div class="mini">SET ××—×œ×™×£ ×”×›×œ. UPDATE ×¨×§ ×œ××•×‘×™×™×§×˜.</div>
          </div>

          <div class="sp"></div>

          <div id="toolsStatus" class="mini muted">â€”</div>
          <div class="prog" style="margin-top:10px;">
            <div id="progBar" class="bar"></div>
          </div>
          <div id="progTxt" class="mini muted" style="margin-top:8px;">â€”</div>
        </div>
      </div>
    </div>

    <!-- USERS -->
    <div id="viewUsers" class="hidden">
      <div class="card" style="margin-top:12px;">
        <div class="hd">
          <div class="h">××©×ª××©×™×</div>
          <div class="muted" style="font-size:12px;">×©×™× ×•×™ Username ×—×›×</div>
        </div>
        <div class="bd">
          <div class="field">
            <label>UID</label>
            <input id="uidInput" class="in mono" placeholder="UID ×©×œ ×”××©×ª××© (users/{uid})">
          </div>
          <div class="field">
            <label>Username ×—×“×©</label>
            <input id="newUsernameInput" class="in" placeholder="×œ××©×œ: Yossi_Pro">
          </div>

          <div class="row">
            <button id="btnRenameUser" class="btn primary wide" type="button">âœï¸ ×¢×“×›×Ÿ Username ×‘×›×œ ××§×•×</button>
          </div>

          <div class="mini" style="margin-top:8px;">
            ××” ×–×” ×¢×•×©×”:
            <br>1) ××¢×“×›×Ÿ <span class="mono">users/{uid}/username</span>
            <br>2) ×¡×•×¨×§ ×¤×•×¡×˜×™×/×ª×’×•×‘×•×ª ×•××—×œ×™×£ ×©×“×•×ª ××—×‘×¨ ×¨×œ×•×•× ×˜×™×™× (author/username/user ×•×›×•â€™)
            <br><b>×©×™××• ×œ×‘:</b> ×–×” ×›×œ×™ â€œ×›×‘×“â€ ×× ×™×© ×”××•×Ÿ × ×ª×•× ×™×.
          </div>

          <div class="sp"></div>
          <div id="usersStatus" class="mini muted">â€”</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <div class="bottomNav">
    <div class="bar">
      <div id="navPosts" class="navBtn active">ğŸ“° ×¤×•×¡×˜×™×</div>
      <div id="navTools" class="navBtn">ğŸ§° ×›×œ×™×</div>
      <div id="navUsers" class="navBtn">ğŸ‘¤ ××©×ª××©×™×</div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Sheet: Editor (post/comment/reply) -->
  <div id="overlay" class="overlay">
    <div class="sheet">
      <div class="sheetHd">
        <div class="ttl" id="sheetTitle">×¢×¨×™×›×”</div>
        <button id="btnSheetClose" class="btn small" type="button">âœ•</button>
      </div>
      <div class="sheetBd">
        <div class="mini muted" id="sheetPath">â€”</div>
        <div class="sp"></div>

        <div id="editorFields"></div>

        <div class="sp"></div>

        <details>
          <summary class="btn ghost wide" style="justify-content:center;">ğŸ§¾ ××ª×§×“×: ×¢×¨×™×›×ª JSON ××œ××”</summary>
          <div style="margin-top:10px;">
            <textarea id="rawJson" class="in mono" style="min-height:180px;" placeholder="JSON ××œ× ×©×œ ×”××•×‘×™×™×§×˜"></textarea>
            <button id="btnSaveJson" class="btn wide" type="button">ğŸ’¾ ×©××•×¨ JSON (SET)</button>
            <div class="mini muted" style="margin-top:6px;">×–×” ××—×œ×™×£ ××ª ×›×œ ×”Ö¾node ×‘× ×ª×™×‘.</div>
          </div>
        </details>

        <div class="sp"></div>

        <details id="commentsSection" class="hidden">
          <summary class="btn wide" style="justify-content:center;">ğŸ’¬ ×ª×’×•×‘×•×ª ×œ×¤×•×¡×˜</summary>
          <div id="commentsWrap" style="margin-top:10px;"></div>
        </details>
      </div>
      <div class="sheetFt">
        <button id="btnSaveFields" class="btn primary" type="button">ğŸ’¾ ×©××•×¨</button>
        <button id="btnDeleteNode" class="btn danger" type="button">ğŸ—‘ ××—×§</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
var ADMIN_PATH = "admins";
var POSTS_PATH = "posts";
var COMMENTS_PATH = "comments";
var USERS_PATH = "users";
var STORAGE_POST_FOLDER = "post-images"; // post-images/{postId}/...

var MAX_REPLIES_DEPTH = 8; // ×¨×™× ×“×•×¨ + ×¡×¨×™×§×” ×œ×¢×•××§ ×ª×ª×™-×ª×’×•×‘×•×ª

/* =========================
   STATE
========================= */
var S = {
  user: null,
  uid: "",
  isAdmin: false,
  posts: [],
  postsMap: {},
  lastKey: null,
  loading: false,
  current: { type:"", path:"", postId:"", obj:null }
};

/* =========================
   DOM
========================= */
function el(id){ return document.getElementById(id); }
function txt(id, v){ var x=el(id); if(x) x.textContent = v; }
function show(id, on){ var x=el(id); if(x) x.classList.toggle("hidden", !on); }
function pill(type, text){
  var p=el("authPill"), t=el("authTxt");
  if(!p||!t) return;
  p.classList.remove("ok","warn","err");
  p.classList.add(type);
  t.textContent = text || "";
}
function toast(msg, type){
  var box=el("toast");
  box.classList.remove("ok","err","warn");
  if(type) box.classList.add(type);
  box.textContent = msg || "";
  box.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(function(){ box.style.display="none"; }, 2400);
}
function confirmDanger(msg){
  return window.confirm("âš ï¸ " + msg + "\n\n×”×× ××ª×” ×‘×˜×•×—?");
}
function safe(v){ return (v===undefined || v===null) ? "" : String(v); }
function num(v){ var n=Number(v||0); return isNaN(n)?0:n; }
function fmtDate(ts){
  try{ ts = Number(ts||0)||0; if(!ts) return "â€”"; return new Date(ts).toLocaleString("he-IL"); }
  catch(e){ return "â€”"; }
}
function escapeHtml(s){
  s=safe(s);
  return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
}
function pretty(v){
  try{ return JSON.stringify(v, null, 2); }catch(e){ return safe(v); }
}
function tryParseJson(s){
  try{ return {ok:true, v: JSON.parse(s)}; }catch(e){ return {ok:false, e:e}; }
}
function prog(pct, text){
  pct = Math.max(0, Math.min(100, Math.round(Number(pct||0))));
  el("progBar").style.width = pct + "%";
  txt("progTxt", text || (pct+"%"));
}
function progReset(){
  el("progBar").style.width = "0%";
  txt("progTxt","â€”");
}

/* =========================
   NAV
========================= */
function setActiveNav(which){
  ["navPosts","navTools","navUsers"].forEach(function(id){
    el(id).classList.toggle("active", id===which);
  });
  show("viewPosts", which==="navPosts");
  show("viewTools", which==="navTools");
  show("viewUsers", which==="navUsers");
}
el("navPosts").onclick = function(){ setActiveNav("navPosts"); };
el("navTools").onclick = function(){ setActiveNav("navTools"); };
el("navUsers").onclick = function(){ setActiveNav("navUsers"); };

/* =========================
   ADMIN CHECK
========================= */
function checkAdmin(uid){
  return firebase.database().ref(ADMIN_PATH + "/" + uid).once("value").then(function(s){
    var v = s.exists() ? s.val() : null;
    return (v===true || v===1 || v==="true");
  });
}

/* =========================
   AUTH
========================= */
function login(){
  var email = safe(el("loginEmail").value).trim();
  var pass = safe(el("loginPass").value);
  if(!email || !pass){ toast("×—×¡×¨ ××™××™×™×œ/×¡×™×¡××”", "warn"); return; }

  pill("warn","××ª×—×‘×¨â€¦");
  firebase.auth().signInWithEmailAndPassword(email, pass)
    .catch(function(err){
      pill("err","×›×©×œ ×”×ª×—×‘×¨×•×ª");
      toast("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + safe(err && err.message || err), "err");
    });
}
function logout(){
  firebase.auth().signOut();
}
el("btnLogin").onclick = login;
el("btnLogout").onclick = logout;

firebase.auth().onAuthStateChanged(function(u){
  S.user = u || null;
  S.uid = u ? u.uid : "";
  if(!u){
    S.isAdmin = false;
    pill("warn","×œ× ××—×•×‘×¨");
    show("btnLogin", true);
    show("btnLogout", false);
    show("viewPosts", false);
    show("viewTools", false);
    show("viewUsers", false);
    txt("postsList","×”×ª×—×‘×¨ ×›×“×™ ×œ×˜×¢×•×Ÿâ€¦");
    txt("badgePosts","â€”");
    return;
  }

  pill("warn","×‘×•×“×§ ××“××™×Ÿâ€¦");
  checkAdmin(u.uid).then(function(isAdmin){
    S.isAdmin = !!isAdmin;
    if(!S.isAdmin){
      pill("err","××—×•×‘×¨ ××š ×œ× ××“××™×Ÿ");
      toast("×”××©×ª××© ×”×–×” ×œ× ××•×’×“×¨ ××“××™×Ÿ ×‘Ö¾admins/{uid}", "err");
      return firebase.auth().signOut();
    }

    pill("ok","××—×•×‘×¨ ×›××“××™×Ÿ");
    show("btnLogin", false);
    show("btnLogout", true);

    // default view
    setActiveNav("navPosts");
    show("viewPosts", true);
    show("viewTools", true);
    show("viewUsers", true);

    // initial load
    resetAndLoadPosts();
  }).catch(function(){
    pill("err","×©×’×™××” ×‘×‘×“×™×§×ª ××“××™×Ÿ");
  });
});

/* =========================
   POSTS LOAD (paging by time)
========================= */
function resetAndLoadPosts(){
  S.posts = [];
  S.postsMap = {};
  S.lastKey = null;
  el("postsList").innerHTML = '<div class="muted">×˜×•×¢×Ÿâ€¦</div>';
  show("btnLoadMore", false);
  loadPostsPage(true);
}

function getSortKey(p, sort){
  if(sort==="comments") return num(p.commentsCount);
  if(sort==="author") return safe(p.author).toLowerCase();
  if(sort==="title") return safe(p.title).toLowerCase();
  if(sort==="lastComment"){
    var t = num(p.lastCommentTime) || num(p.time);
    return t;
  }
  return num(p.time);
}

function normalizePost(id, v){
  v = v || {};
  return {
    id: id,
    title: safe(v.title),
    text: safe(v.text),
    author: safe(v.author || v.username || v.user || v.name),
    authorUid: safe(v.authorUid || v.uid || v.userId),
    time: num(v.time),
    likes: num(v.likes),
    commentsCount: (v.commentsCount===undefined || v.commentsCount===null) ? null : num(v.commentsCount),
    lastCommentTime: num(v.lastCommentTime),
    imagePath: safe(v.imagePath || ""),
    raw: v
  };
}

function loadPostsPage(reset){
  if(!S.isAdmin) return;
  if(S.loading) return;
  S.loading = true;

  var limit = num(el("limitSel").value || 120) || 120;
  var sort = safe(el("sortSel").value || "newest");
  var q = safe(el("q").value).trim().toLowerCase();

  var ref = firebase.database().ref(POSTS_PATH).orderByChild("time");
  if(S.lastKey){
    // paging with time is tricky; simplest: keep increasing limit using load more.
    // We'll implement "load more" by increasing limit each time (mobile friendly, minimal complexity).
  }

  // strategy: always load last N by time where N = currentLoaded + limit
  var want = S.posts.length + limit;
  ref.limitToLast(want).once("value").then(function(snap){
    var arr = [];
    snap.forEach(function(ch){
      arr.push(normalizePost(ch.key, ch.val()));
    });

    // sort client
    if(sort==="oldest"){
      arr.sort(function(a,b){ return num(a.time)-num(b.time); });
    }else if(sort==="author"){
      arr.sort(function(a,b){ return safe(a.author).localeCompare(safe(b.author),"he"); });
    }else if(sort==="title"){
      arr.sort(function(a,b){ return safe(a.title).localeCompare(safe(b.title),"he"); });
    }else if(sort==="comments"){
      arr.sort(function(a,b){ return num(b.commentsCount)-num(a.commentsCount); });
    }else if(sort==="lastComment"){
      arr.sort(function(a,b){
        var ta = num(a.lastCommentTime)||num(a.time);
        var tb = num(b.lastCommentTime)||num(b.time);
        return tb-ta;
      });
    }else{
      arr.sort(function(a,b){ return num(b.time)-num(a.time); });
    }

    // filter
    if(q){
      arr = arr.filter(function(p){
        var blob = (p.id+" "+p.title+" "+p.text+" "+p.author+" "+p.authorUid).toLowerCase();
        return blob.indexOf(q)!==-1;
      });
    }

    S.posts = arr;
    S.postsMap = {};
    arr.forEach(function(p){ S.postsMap[p.id]=p; });

    txt("badgePosts", "×›××•×ª: " + arr.length);
    renderPosts();

    // show load more
    show("btnLoadMore", true);
  }).catch(function(err){
    toast("×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×•×¡×˜×™×: " + safe(err && err.message || err), "err");
  }).finally(function(){
    S.loading = false;
  });
}

function renderPosts(){
  var host = el("postsList");
  host.innerHTML = "";
  if(!S.posts.length){
    host.innerHTML = '<div class="muted">××™×Ÿ ×¤×•×¡×˜×™× ×‘×ª×¦×•×’×”.</div>';
    return;
  }
  S.posts.forEach(function(p){
    host.appendChild(buildPostCard(p));
  });
}

function shorten(t, n){
  t = safe(t);
  if(t.length <= n) return t;
  return t.slice(0,n) + "â€¦";
}

function chip(label, value, mono){
  return '<span class="chip">'+escapeHtml(label)+': <b class="'+(mono?'mono':'')+'">'+escapeHtml(value)+'</b></span>';
}

function buildPostCard(p){
  var d = document.createElement("div");
  d.className = "post";

  var cc = (p.commentsCount===null ? "?" : String(num(p.commentsCount)));
  var lc = p.lastCommentTime ? fmtDate(p.lastCommentTime) : "â€”";

  d.innerHTML = `
    <div class="t">${escapeHtml(p.title || "(×œ×œ× ×›×•×ª×¨×ª)")}</div>
    <div class="chips">
      ${chip("ID", p.id, true)}
      ${chip("×××ª", p.author || "â€”")}
      ${chip("×–××Ÿ", fmtDate(p.time))}
      ${chip("×ª×’×•×‘×•×ª", cc, true)}
      ${chip("××—×¨×•× ×”", lc)}
    </div>
    <div class="snippet">${escapeHtml(shorten(p.text, 160))}</div>
    <div class="tools">
      <button class="btn small" data-act="edit">âœï¸ ×¢×¨×•×š</button>
      <button class="btn small" data-act="comments">ğŸ’¬ ×ª×’×•×‘×•×ª</button>
      <button class="btn small" data-act="recalc">ğŸ§® ×ª×§×Ÿ ××•× ×™×</button>
      <button class="btn small danger" data-act="delete">ğŸ—‘ ××—×§ ×¤×•×¡×˜</button>
    </div>
  `;

  d.addEventListener("click", function(e){
    var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
    if(!b) return;
    var act = b.getAttribute("data-act");
    if(act==="edit") openEditorForPost(p.id, false);
    if(act==="comments") openEditorForPost(p.id, true);
    if(act==="recalc") recalcPostMeta(p.id, true);
    if(act==="delete") deepDeletePost(p.id);
  });

  return d;
}

el("btnRefresh").onclick = function(){
  if(!S.isAdmin) return;
  resetAndLoadPosts();
};
el("limitSel").onchange = resetAndLoadPosts;
el("sortSel").onchange = resetAndLoadPosts;
el("q").oninput = function(){
  // ×¡×™× ×•×Ÿ ××™×“×™ ×¢×œ ××” ×©×›×‘×¨ × ×˜×¢×Ÿ
  renderPostsFromQuery();
};

function renderPostsFromQuery(){
  var q = safe(el("q").value).trim().toLowerCase();
  if(!q){
    renderPosts();
    return;
  }
  var host = el("postsList");
  host.innerHTML = "";
  var filtered = S.posts.filter(function(p){
    var blob = (p.id+" "+p.title+" "+p.text+" "+p.author+" "+p.authorUid).toLowerCase();
    return blob.indexOf(q)!==-1;
  });
  txt("badgePosts", "×›××•×ª: " + filtered.length);
  if(!filtered.length){
    host.innerHTML = '<div class="muted">×œ× × ××¦××• ×ª×•×¦××•×ª.</div>';
    return;
  }
  filtered.forEach(function(p){ host.appendChild(buildPostCard(p)); });
}
el("btnLoadMore").onclick = function(){
  loadPostsPage(false);
};

/* =========================
   COMMENTS TREE HELPERS
========================= */
function pickRepliesContainers(v){
  var arr = [];
  if(v && typeof v==="object"){
    if(v.replies && typeof v.replies==="object") arr.push({name:"replies", obj:v.replies});
    if(v.reply && typeof v.reply==="object") arr.push({name:"reply", obj:v.reply});
    if(v.responses && typeof v.responses==="object") arr.push({name:"responses", obj:v.responses});
    if(v.children && typeof v.children==="object") arr.push({name:"children", obj:v.children});
    if(v.subReplies && typeof v.subReplies==="object") arr.push({name:"subReplies", obj:v.subReplies});
  }
  return arr;
}

function computeMetaFromCommentsObj(obj){
  // commentsCount: ×¨×§ ×ª×’×•×‘×•×ª ×‘×¨××” ×”×¨××©×•× ×”
  // lastCommentTime: max time ××›×œ ×”×¢×¥ (×›×•×œ×œ ×ª×ª×™)
  var countTop = 0;
  var lastTime = 0;

  function walk(node, depth){
    if(!node || typeof node!=="object") return;
    if(node.time!==undefined && node.time!==null){
      var t = num(node.time);
      if(t>lastTime) lastTime = t;
    }
    if(depth<=0) return;
    pickRepliesContainers(node).forEach(function(cn){
      var o = cn.obj || {};
      Object.keys(o).forEach(function(k){
        walk(o[k], depth-1);
      });
    });
  }

  if(obj && typeof obj==="object"){
    var keys = Object.keys(obj);
    countTop = keys.length;
    keys.forEach(function(cid){
      walk(obj[cid], MAX_REPLIES_DEPTH);
    });
  }
  return { commentsCount: countTop, lastCommentTime: lastTime };
}

/* =========================
   SHEET EDITOR
========================= */
function openSheet(title, path, type, postId, obj){
  S.current = { type:type, path:path, postId:postId||"", obj: obj||{} };
  txt("sheetTitle", title);
  txt("sheetPath", "Path: " + path);
  el("rawJson").value = pretty(obj||{});

  // clean fields
  var host = el("editorFields");
  host.innerHTML = "";

  // build fields by type
  if(type==="post"){
    host.appendChild(fieldInput("×›×•×ª×¨×ª", "f_title", safe(obj.title), 120));
    host.appendChild(fieldArea("×ª×•×›×Ÿ", "f_text", safe(obj.text), 6000));
    host.appendChild(fieldInput("××—×‘×¨ (×©×)", "f_author", safe(obj.author || obj.username || ""), 80));
    host.appendChild(fieldInput("UID ××—×‘×¨ (××•×¤×¦×™×•× ×œ×™)", "f_authorUid", safe(obj.authorUid || obj.uid || obj.userId || ""), 120, true));
    host.appendChild(fieldInput("time (timestamp)", "f_time", String(num(obj.time)), 30, true));
    host.appendChild(fieldInput("likes", "f_likes", String(num(obj.likes)), 30, true));
    host.appendChild(fieldInput("commentsCount", "f_commentsCount", (obj.commentsCount===undefined||obj.commentsCount===null)?"":String(num(obj.commentsCount)), 30, true));
    host.appendChild(fieldInput("lastCommentTime", "f_lastCommentTime", String(num(obj.lastCommentTime)), 30, true));
    host.appendChild(fieldInput("imagePath (××•×¤×¦×™×•× ×œ×™)", "f_imagePath", safe(obj.imagePath||""), 240, true));

    // show comments section
    show("commentsSection", true);
  }
  else if(type==="comment"){
    host.appendChild(fieldInput("××—×‘×¨ (×©×)", "f_author", safe(obj.author || obj.username || obj.user || ""), 80));
    host.appendChild(fieldInput("UID ××—×‘×¨ (××•×¤×¦×™×•× ×œ×™)", "f_authorUid", safe(obj.uid || obj.userId || obj.authorUid || ""), 120, true));
    host.appendChild(fieldArea("×˜×§×¡×˜", "f_text", safe(obj.text || obj.body || obj.message || ""), 6000));
    host.appendChild(fieldInput("time (timestamp)", "f_time", String(num(obj.time)), 30, true));
    show("commentsSection", false);
  }
  else{
    // fallback
    host.appendChild(fieldArea("××•×‘×™×™×§×˜ (×¨××” JSON ×œ××˜×”)", "f_text", "", 0));
    show("commentsSection", false);
  }

  // delete button label by type
  el("btnDeleteNode").textContent = (type==="post") ? "ğŸ—‘ ××—×§ ×¤×•×¡×˜ (×¢××•×§)" : "ğŸ—‘ ××—×§";

  el("overlay").style.display = "flex";
}

function closeSheet(){
  el("overlay").style.display = "none";
  el("commentsWrap").innerHTML = "";
}
el("btnSheetClose").onclick = closeSheet;
el("overlay").addEventListener("click", function(e){
  if(e.target === el("overlay")) closeSheet();
});

function fieldInput(label, id, value, max, mono){
  var wrap = document.createElement("div");
  wrap.className = "field";
  wrap.innerHTML = `
    <label>${escapeHtml(label)}</label>
    <input id="${escapeHtml(id)}" class="in ${mono?'mono':''}" maxlength="${max||240}" value="${escapeHtml(value||"")}">
  `;
  return wrap;
}
function fieldArea(label, id, value, max){
  var wrap = document.createElement("div");
  wrap.className = "field";
  wrap.innerHTML = `
    <label>${escapeHtml(label)}</label>
    <textarea id="${escapeHtml(id)}" class="in" ${max?('maxlength="'+max+'"'):""}>${escapeHtml(value||"")}</textarea>
  `;
  return wrap;
}

function openEditorForPost(postId, autoLoadComments){
  var p = S.postsMap[postId];
  if(!p){ toast("×œ× ××¦××ª×™ ×¤×•×¡×˜ ×‘×ª×¦×•×’×”", "warn"); return; }

  var path = POSTS_PATH + "/" + postId;
  openSheet("âœï¸ ×¢×¨×™×›×ª ×¤×•×¡×˜", path, "post", postId, p.raw || {});
  if(autoLoadComments){
    loadCommentsForPost(postId);
    el("commentsSection").open = true;
  }else{
    el("commentsSection").open = false;
    el("commentsWrap").innerHTML = "";
  }
}

function openEditorForComment(path, postId, obj){
  openSheet("âœï¸ ×¢×¨×™×›×ª ×ª×’×•×‘×”", path, "comment", postId, obj||{});
}

/* =========================
   SAVE / DELETE IN SHEET
========================= */
el("btnSaveFields").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  if(!c.path) return;

  if(c.type==="post"){
    var updates = {};
    updates[c.path + "/title"] = safe(el("f_title").value);
    updates[c.path + "/text"] = safe(el("f_text").value);
    updates[c.path + "/author"] = safe(el("f_author").value) || null;

    var au = safe(el("f_authorUid").value).trim();
    if(au) updates[c.path + "/authorUid"] = au;
    else updates[c.path + "/authorUid"] = null;

    updates[c.path + "/time"] = num(el("f_time").value);
    updates[c.path + "/likes"] = num(el("f_likes").value);

    var cc = safe(el("f_commentsCount").value).trim();
    updates[c.path + "/commentsCount"] = (cc==="" ? null : num(cc));

    updates[c.path + "/lastCommentTime"] = num(el("f_lastCommentTime").value);

    var ip = safe(el("f_imagePath").value).trim();
    updates[c.path + "/imagePath"] = (ip ? ip : null);

    if(!confirmDanger("×œ×©××•×¨ ×©×“×•×ª ×œ×¤×•×¡×˜?")) return;

    firebase.database().ref().update(updates).then(function(){
      toast("× ×©××¨ âœ…", "ok");
      return resetAndLoadPosts();
    }).catch(function(err){
      toast("×©×’×™××” ×‘×©××™×¨×”: " + safe(err && err.message || err), "err");
    });
  }

  if(c.type==="comment"){
    var up = {};
    // × × ×¡×” ×œ×¢×“×›×Ÿ ×›××” ×©××•×ª ××¤×©×¨×™×™× ×›×“×™ ×œ×”×ª××™× ×œ×›×œ ×¡×›×™××”
    var author = safe(el("f_author").value);
    var au2 = safe(el("f_authorUid").value).trim();
    var text = safe(el("f_text").value);
    var time = num(el("f_time").value);

    up[c.path + "/author"] = author || null;
    up[c.path + "/username"] = author || null;
    up[c.path + "/user"] = author || null;

    if(au2){
      up[c.path + "/uid"] = au2;
      up[c.path + "/userId"] = au2;
      up[c.path + "/authorUid"] = au2;
    }

    up[c.path + "/text"] = text;
    up[c.path + "/body"] = text;
    up[c.path + "/message"] = text;

    up[c.path + "/time"] = time;

    if(!confirmDanger("×œ×©××•×¨ ×ª×’×•×‘×”?")) return;

    firebase.database().ref().update(up).then(function(){
      toast("×ª×’×•×‘×” × ×©××¨×” âœ…", "ok");
      if(c.postId){
        return recalcPostMeta(c.postId, false).then(function(){
          return loadCommentsForPost(c.postId);
        }).then(resetAndLoadPosts);
      }
      return resetAndLoadPosts();
    }).catch(function(err){
      toast("×©×’×™××” ×‘×©××™×¨×”: " + safe(err && err.message || err), "err");
    });
  }
};

el("btnSaveJson").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  var parsed = tryParseJson(safe(el("rawJson").value));
  if(!parsed.ok){ toast("JSON ×œ× ×ª×§×™×Ÿ", "err"); return; }
  if(!confirmDanger("×œ×©××•×¨ JSON (SET) ×œ× ×ª×™×‘ ×”×–×”? ×–×” ××—×œ×™×£ ×”×›×œ.")) return;

  firebase.database().ref(c.path).set(parsed.v).then(function(){
    toast("JSON × ×©××¨ âœ…", "ok");
    if(c.type==="comment" && c.postId){
      return recalcPostMeta(c.postId, false).then(function(){
        return loadCommentsForPost(c.postId);
      }).then(resetAndLoadPosts);
    }
    return resetAndLoadPosts();
  }).catch(function(err){
    toast("×©×’×™××”: " + safe(err && err.message || err), "err");
  });
};

el("btnDeleteNode").onclick = function(){
  if(!S.isAdmin) return;
  var c = S.current;
  if(!c.path) return;

  if(c.type==="post"){
    deepDeletePost(c.postId, true);
    return;
  }

  if(!confirmDanger("×œ××—×•×§ ××ª ×”Ö¾node ×”×–×”? ×›×œ ×”×™×œ×“×™× ×©×œ×• ×™××—×§×• ×’×.")) return;

  firebase.database().ref(c.path).remove().then(function(){
    toast("× ××—×§ âœ…", "ok");
    if(c.postId){
      return recalcPostMeta(c.postId, false).then(function(){
        return loadCommentsForPost(c.postId);
      }).then(resetAndLoadPosts);
    }
    return resetAndLoadPosts();
  }).catch(function(err){
    toast("×©×’×™××” ×‘××—×™×§×”: " + safe(err && err.message || err), "err");
  });
};

/* =========================
   COMMENTS LOAD + RENDER
========================= */
function loadCommentsForPost(postId){
  var wrap = el("commentsWrap");
  wrap.innerHTML = '<div class="muted">×˜×•×¢×Ÿ ×ª×’×•×‘×•×ªâ€¦</div>';

  return firebase.database().ref(COMMENTS_PATH + "/" + postId).once("value").then(function(s){
    var obj = s.exists() ? (s.val()||{}) : {};
    wrap.innerHTML = "";
    if(!obj || typeof obj!=="object" || !Object.keys(obj).length){
      wrap.innerHTML = '<div class="muted">××™×Ÿ ×ª×’×•×‘×•×ª ×œ×¤×•×¡×˜ ×”×–×”.</div>';
      return;
    }

    // sort top-level by time asc
    var keys = Object.keys(obj);
    keys.sort(function(a,b){
      return num((obj[a]||{}).time) - num((obj[b]||{}).time);
    });

    keys.forEach(function(cid){
      var path = COMMENTS_PATH + "/" + postId + "/" + cid;
      wrap.appendChild(buildCommentNode({
        postId: postId,
        key: cid,
        path: path,
        data: obj[cid],
        depth: 0
      }));
    });
  }).catch(function(err){
    wrap.innerHTML = '<div class="muted">×©×’×™××” ×‘×˜×¢×™× ×”: '+escapeHtml(safe(err && err.message || err))+'</div>';
  });
}

function buildCommentNode(o){
  var postId = safe(o.postId);
  var key = safe(o.key);
  var path = safe(o.path);
  var data = o.data || {};
  var depth = num(o.depth);

  var author = safe(data.author || data.username || data.user || data.name || "â€”");
  var auid = safe(data.uid || data.userId || data.authorUid || "");
  var text = safe(data.text || data.body || data.message || "");
  var time = num(data.time);

  var box = document.createElement("div");
  box.className = "cNode" + (depth>0 ? " indent" : "");
  box.innerHTML = `
    <div class="cHead">
      <div class="cMeta">
        <span class="chip">key: <b class="mono">${escapeHtml(key)}</b></span>
        <span class="chip">×××ª: <b>${escapeHtml(author)}</b></span>
        <span class="chip">×–××Ÿ: <b>${escapeHtml(time?fmtDate(time):"â€”")}</b></span>
        ${auid ? `<span class="chip">uid: <b class="mono">${escapeHtml(auid)}</b></span>` : ``}
      </div>
      <div class="row">
        <button class="btn small" data-act="edit">âœï¸</button>
        <button class="btn small danger" data-act="del">ğŸ—‘</button>
      </div>
    </div>
    <div class="cText">${escapeHtml(text)}</div>
  `;

  box.addEventListener("click", function(e){
    var b = e.target && e.target.closest ? e.target.closest("button[data-act]") : null;
    if(!b) return;
    var act = b.getAttribute("data-act");
    if(act==="edit"){
      openEditorForComment(path, postId, data);
    }
    if(act==="del"){
      if(!confirmDanger("×œ××—×•×§ ×ª×’×•×‘×”? ×›×œ ×ª×ª×™-×”×ª×’×•×‘×•×ª ×©×œ×” ×™××—×§×• ×’×.")) return;
      firebase.database().ref(path).remove().then(function(){
        toast("×ª×’×•×‘×” × ××—×§×” âœ…", "ok");
        return recalcPostMeta(postId, false).then(function(){
          return loadCommentsForPost(postId);
        }).then(resetAndLoadPosts);
      }).catch(function(err){
        toast("×©×’×™××” ×‘××—×™×§×”: " + safe(err && err.message || err), "err");
      });
    }
  });

  // children (replies)
  if(depth < MAX_REPLIES_DEPTH){
    pickRepliesContainers(data).forEach(function(cn){
      var obj = cn.obj || {};
      var rKeys = Object.keys(obj);
      if(!rKeys.length) return;

      rKeys.sort(function(a,b){
        return num((obj[a]||{}).time) - num((obj[b]||{}).time);
      });

      rKeys.forEach(function(rid){
        var childPath = path + "/" + cn.name + "/" + rid;
        box.appendChild(buildCommentNode({
          postId: postId,
          key: rid,
          path: childPath,
          data: obj[rid],
          depth: depth + 1
        }));
      });
    });
  }

  return box;
}

/* =========================
   META RECALC (single post + fix all)
========================= */
function recalcPostMeta(postId, showToast){
  postId = safe(postId);
  if(!postId) return Promise.resolve();

  if(showToast) toast("××ª×§×Ÿ ××•× ×™×â€¦", "warn");

  return firebase.database().ref(COMMENTS_PATH + "/" + postId).once("value").then(function(s){
    var obj = s.exists() ? (s.val()||{}) : {};
    var meta = computeMetaFromCommentsObj(obj);

    var up = {};
    up[POSTS_PATH + "/" + postId + "/commentsCount"] = num(meta.commentsCount);
    up[POSTS_PATH + "/" + postId + "/lastCommentTime"] = num(meta.lastCommentTime);

    return firebase.database().ref().update(up).then(function(){
      if(showToast) toast("××•× ×™× ×¢×•×“×›× ×• âœ…", "ok");
    });
  }).catch(function(err){
    toast("×©×’×™××” ×‘×ª×™×§×•×Ÿ ××•× ×™×: " + safe(err && err.message || err), "err");
  });
}

function fixAllPosts(){
  if(!S.isAdmin) return;
  if(!confirmDanger("×œ×¢×©×•×ª ×¡×“×¨ ×œ×›×œ ×”×¤×•×¡×˜×™× ×©× ×˜×¢× ×• ××”-DB? (×™×›×•×œ ×œ×§×—×ª ×–××Ÿ)")) return;

  // × ×˜×¢×Ÿ ×¢×“ N ×¤×•×¡×˜×™× (×›××Ÿ: 300) ×›×“×™ ×œ× ×œ×”×¨×•×’ ××•×‘×™×™×œ. ××¤×©×¨ ×œ×©× ×•×ª.
  var HARD_LIMIT = 300;

  progReset();
  prog(2, "×˜×•×¢×Ÿ ×¨×©×™××ª ×¤×•×¡×˜×™×â€¦");
  el("toolsStatus").textContent = "××ª×—×™×œâ€¦";

  firebase.database().ref(POSTS_PATH).orderByChild("time").limitToLast(HARD_LIMIT).once("value").then(function(s){
    var ids = [];
    s.forEach(function(ch){ ids.push(ch.key); });

    if(!ids.length){
      toast("××™×Ÿ ×¤×•×¡×˜×™× ×œ×ª×§×Ÿ", "warn");
      progReset();
      return;
    }

    var i=0;
    function step(){
      if(i>=ids.length){
        prog(100, "×¡×™×•× âœ…");
        el("toolsStatus").textContent = "×¡×™×™××ª×™ â€œ×¢×©×” ×¡×“×¨â€ ×¢×œ " + ids.length + " ×¤×•×¡×˜×™×.";
        toast("×¡×™×™××ª×™ âœ…", "ok");
        return resetAndLoadPosts();
      }
      var pct = Math.round((i/ids.length)*100);
      prog(pct, "××ª×§×Ÿ ("+(i+1)+"/"+ids.length+") " + ids[i]);
      el("toolsStatus").textContent = "×¢×•×‘×“ ×¢×œ postId=" + ids[i];

      recalcPostMeta(ids[i], false).finally(function(){
        i++;
        setTimeout(step, 25);
      });
    }
    step();
  }).catch(function(err){
    toast("×©×’×™××” ×‘×¢×©×”-×¡×“×¨: " + safe(err && err.message || err), "err");
    el("toolsStatus").textContent = "×©×’×™××”: " + safe(err && err.message || err);
  });
}
el("btnFixAll").onclick = fixAllPosts;

/* =========================
   DEEP DELETE POST (posts + comments + optional storage folder)
========================= */
function deepDeletePost(postId, fromSheet){
  postId = safe(postId);
  if(!postId) return;
  if(!S.isAdmin) return;

  if(!confirmDanger("××•×—×§ ×¤×•×¡×˜ ×¢××•×§:\nposts/"+postId+"\n×•×’× comments/"+postId+"\n(×•×›×œ ×”×™×œ×“×™×)")) return;

  toast("××•×—×§â€¦", "warn");

  var up = {};
  up[POSTS_PATH + "/" + postId] = null;
  up[COMMENTS_PATH + "/" + postId] = null;

  // 1) DB remove (multi-path)
  firebase.database().ref().update(up).then(function(){
    // 2) Storage best-effort cleanup
    var folderRef = firebase.storage().ref(STORAGE_POST_FOLDER + "/" + postId);
    return folderRef.listAll().then(function(res){
      var ps = [];
      (res.items || []).forEach(function(itemRef){
        ps.push(itemRef.delete().catch(function(){}));
      });
      return Promise.all(ps);
    }).catch(function(){ /* ignore */ });
  }).then(function(){
    toast("×¤×•×¡×˜ × ××—×§ âœ…", "ok");
    if(fromSheet) closeSheet();
    return resetAndLoadPosts();
  }).catch(function(err){
    toast("×©×’×™××” ×‘××—×™×§×”: " + safe(err && err.message || err), "err");
  });
}

/* =========================
   EXPORT POSTS JSON (visible)
========================= */
el("btnExport").onclick = function(){
  if(!S.isAdmin) return;
  var data = S.posts.map(function(p){
    return {
      id: p.id,
      title: p.title,
      text: p.text,
      author: p.author,
      authorUid: p.authorUid,
      time: p.time,
      likes: p.likes,
      commentsCount: p.commentsCount,
      lastCommentTime: p.lastCommentTime,
      imagePath: p.imagePath
    };
  });
  var blob = new Blob([pretty(data)], {type:"application/json"});
  var url = URL.createObjectURL(blob);
  var a = document.createElement("a");
  a.href = url;
  a.download = "posts_export_" + Date.now() + ".json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(function(){ try{ URL.revokeObjectURL(url); }catch(e){} }, 1200);
  toast("×™×•×¦× ×§×•×‘×¥ JSON âœ…", "ok");
};

/* =========================
   QUICK DB (Tools)
========================= */
el("btnQSet").onclick = function(){
  if(!S.isAdmin) return;
  var path = safe(el("quickPath").value).trim();
  var parsed = tryParseJson(safe(el("quickVal").value));
  if(!path){ toast("×—×¡×¨ path", "warn"); return; }
  if(!parsed.ok){ toast("value JSON ×œ× ×ª×§×™×Ÿ", "err"); return; }
  if(!confirmDanger("SET ×œ× ×ª×™×‘: "+path+" ?")) return;

  firebase.database().ref(path).set(parsed.v).then(function(){
    toast("SET OK âœ…", "ok");
    resetAndLoadPosts();
  }).catch(function(e){ toast("×©×’×™××”: "+safe(e && e.message || e), "err"); });
};

el("btnQUpdate").onclick = function(){
  if(!S.isAdmin) return;
  var path = safe(el("quickPath").value).trim();
  var parsed = tryParseJson(safe(el("quickVal").value));
  if(!path){ toast("×—×¡×¨ path", "warn"); return; }
  if(!parsed.ok || typeof parsed.v!=="object" || parsed.v===null || Array.isArray(parsed.v)){
    toast("UPDATE ×“×•×¨×© ××•×‘×™×™×§×˜ JSON", "err"); return;
  }
  if(!confirmDanger("UPDATE ×œ× ×ª×™×‘: "+path+" ?")) return;

  firebase.database().ref(path).update(parsed.v).then(function(){
    toast("UPDATE OK âœ…", "ok");
    resetAndLoadPosts();
  }).catch(function(e){ toast("×©×’×™××”: "+safe(e && e.message || e), "err"); });
};

el("btnQRemove").onclick = function(){
  if(!S.isAdmin) return;
  var path = safe(el("quickPath").value).trim();
  if(!path){ toast("×—×¡×¨ path", "warn"); return; }
  if(!confirmDanger("REMOVE ×œ× ×ª×™×‘: "+path+" ?")) return;

  firebase.database().ref(path).remove().then(function(){
    toast("REMOVE OK âœ…", "ok");
    resetAndLoadPosts();
  }).catch(function(e){ toast("×©×’×™××”: "+safe(e && e.message || e), "err"); });
};

/* =========================
   RENAME USER (UID -> username everywhere)
========================= */
function shouldUpdateAuthorFields(obj, uid){
  // ×× ×™×© uid/userId/authorUid ×ª×•×× -> ×‘×˜×•×— ×©×–×” ×”××©×ª××©
  var u = safe(uid);
  if(!u) return false;
  var candidates = [
    safe(obj.uid), safe(obj.userId), safe(obj.authorUid)
  ].filter(Boolean);
  if(candidates.indexOf(u)!==-1) return true;
  return false;
}

function collectRenameUpdatesInTree(rootObj, rootPath, uid, newName, depth){
  depth = depth || MAX_REPLIES_DEPTH;
  var updates = {};

  function applyForNode(node, path){
    if(!node || typeof node!=="object") return;

    if(shouldUpdateAuthorFields(node, uid)){
      // × ×¢×“×›×Ÿ ×›××” ×©×“×•×ª × ×¤×•×¦×™× ×›×“×™ ×œ×›×¡×•×ª ×¡×›×™××•×ª ×©×•× ×•×ª
      updates[path + "/author"] = newName;
      updates[path + "/username"] = newName;
      updates[path + "/user"] = newName;
      updates[path + "/name"] = newName;
    }

    if(depth<=0) return;

    pickRepliesContainers(node).forEach(function(cn){
      var o = cn.obj || {};
      Object.keys(o).forEach(function(k){
        applyForNode(o[k], path + "/" + cn.name + "/" + k);
      });
    });
  }

  // top-level map
  if(rootObj && typeof rootObj==="object"){
    Object.keys(rootObj).forEach(function(k){
      applyForNode(rootObj[k], rootPath + "/" + k);
    });
  }
  return updates;
}

function renameUserEverywhere(uid, newName){
  uid = safe(uid).trim();
  newName = safe(newName).trim();
  if(!uid || !newName){
    toast("×—×¡×¨ UID ××• Username", "warn");
    return;
  }
  if(!confirmDanger("×œ×¢×“×›×Ÿ username ×‘×›×œ ××§×•× ×¢×‘×•×¨ UID ×”×–×”?\nUID: "+uid+"\nNew: "+newName)) return;

  txt("usersStatus","××ª×—×™×œâ€¦");
  progReset();
  prog(2, "××¢×“×›×Ÿ users/{uid}â€¦");
  toast("×¢×•×‘×“â€¦", "warn");

  var allUpdates = {};
  allUpdates[USERS_PATH + "/" + uid + "/username"] = newName;

  // 1) Update users/{uid}/username
  firebase.database().ref().update(allUpdates).then(function(){
    // 2) Scan posts (limited) + update author fields when authorUid matches
    prog(10, "×¡×•×¨×§ ×¤×•×¡×˜×™×â€¦");
    return firebase.database().ref(POSTS_PATH).limitToLast(1000).once("value");
  }).then(function(psSnap){
    var up = {};

    psSnap.forEach(function(ch){
      var id = ch.key;
      var v = ch.val() || {};
      var pPath = POSTS_PATH + "/" + id;

      // ×× ×™×© authorUid/uid/userId ×ª×•×× -> ×¢×“×›×Ÿ
      if(shouldUpdateAuthorFields(v, uid)){
        up[pPath + "/author"] = newName;
        up[pPath + "/username"] = newName;
        up[pPath + "/user"] = newName;
        up[pPath + "/name"] = newName;
      }
    });

    prog(25, "××¢×“×›×Ÿ ×¤×•×¡×˜×™×â€¦");
    return firebase.database().ref().update(up);
  }).then(function(){
    // 3) Scan comments roots (limited) and update matching nodes
    prog(40, "×¡×•×¨×§ ×ª×’×•×‘×•×ª ×œ×¤×™ ×¤×•×¡×˜×™×â€¦");
    return firebase.database().ref(COMMENTS_PATH).limitToLast(700).once("value");
  }).then(function(csSnap){
    var bigUp = {};
    var roots = [];
    csSnap.forEach(function(ch){
      roots.push({ postId: ch.key, obj: (ch.val()||{}) });
    });

    // build updates from each comments tree (client side)
    var total = roots.length || 1;
    roots.forEach(function(r, i){
      var rootPath = COMMENTS_PATH + "/" + r.postId;
      var local = collectRenameUpdatesInTree(r.obj, rootPath, uid, newName, MAX_REPLIES_DEPTH);
      Object.keys(local).forEach(function(k){ bigUp[k]=local[k]; });

      var pct = 40 + Math.round(((i+1)/total)*40);
      prog(pct, "×‘×•× ×” ×¢×“×›×•× ×™× ×œ×ª×’×•×‘×•×ª ("+(i+1)+"/"+total+")â€¦");
    });

    prog(85, "××¢×“×›×Ÿ ×ª×’×•×‘×•×ªâ€¦");
    // ×¢×“×›×•×Ÿ ×’×“×•×œ ××—×“ (×× ×”××•×Ÿ ×©×™× ×•×™×™× â€” ×–×” ×¢×“×™×™×Ÿ ×¢×œ×•×œ ×œ×”×™×•×ª ×›×‘×“)
    return firebase.database().ref().update(bigUp);
  }).then(function(){
    prog(100, "×¡×™×•× âœ…");
    txt("usersStatus","×¡×™×™××ª×™ ×œ×¢×“×›×Ÿ username ×‘×›×œ ××§×•× (×‘××¡×’×¨×ª ×”×¡×¨×™×§×”).");
    toast("×¡×™×™××ª×™ âœ…", "ok");
    resetAndLoadPosts();
  }).catch(function(err){
    progReset();
    txt("usersStatus","×©×’×™××”: " + safe(err && err.message || err));
    toast("×©×’×™××”: " + safe(err && err.message || err), "err");
  });
}
el("btnRenameUser").onclick = function(){
  renameUserEverywhere(el("uidInput").value, el("newUsernameInput").value);
};

/* =========================
   Notes / UX
========================= */
toast("××•×›×Ÿ âœ…", "ok");
</script>
</body>
</html>