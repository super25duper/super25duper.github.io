×”×¤× ××ª×™.

<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¤×•×¨×•× ×××•×‘×˜×—</title>

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

  <!-- Your config -->
  <script src="firebaseConfig.js"></script>
  <link rel="stylesheet" href="css/forum.css" />

  <style>
    /* ×œ×¤×™ ×”×‘×§×©×”: ×‘×œ×™ ×× ×™××¦×™×•×ª */

    /* ===== Image support (UI only) ===== */
    .post-image-wrap { margin-top: 10px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,0,0,0.12); background: rgba(0,0,0,0.03); }
    .post-image { width: 100%; height: auto; display: block; max-height: 360px; object-fit: cover; background:#fff; }

    .image-chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(0,0,0,0.12); background:rgba(0,0,0,0.03); font-size:12px; opacity:.9; user-select:none; }

    .image-actions-row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }

    .img-btn { padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,0.18); background:#fff; cursor:pointer; font-weight:bold; }
    .img-btn-primary { border:none; background: rgb(17,17,87); color:#fff; }
    .img-btn-danger { border:1px solid rgba(255,0,0,0.35); background:rgba(255,0,0,0.06); color:#8a0000; }

    .img-preview { width:100%; border-radius:12px; border:1px solid rgba(0,0,0,0.12); overflow:hidden; background:rgba(0,0,0,0.03); }
    .img-preview img { width:100%; height:auto; display:block; max-height:320px; object-fit:cover; background:#fff; }

    .progress-wrap { width:100%; height:10px; border-radius:999px; border:1px solid rgba(0,0,0,0.12); overflow:hidden; background:rgba(0,0,0,0.04); }
    .progress-bar { height:100%; width:0%; background: rgb(17,17,87); }

    /* Fullscreen image viewer overlay (no animation) */
    #imageViewerOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.78); display:none; align-items:center; justify-content:center; padding:16px; box-sizing:border-box; z-index:10000; }
    #imageViewerInner { width:min(920px, 100%); background:rgba(255,255,255,0.96); border-radius:16px; padding:12px; box-sizing:border-box; }
    #imageViewerInner img { width:100%; height:auto; display:block; border-radius:14px; background:#fff; border:1px solid rgba(0,0,0,0.12); max-height:78vh; object-fit:contain; }
    #imageViewerTop { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    #closeImageViewer { border:none; background:transparent; font-size:18px; cursor:pointer; padding:8px 10px; border-radius:10px; }

    /* Mini preview overlay */
    #miniImageOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding:16px; box-sizing:border-box; z-index:12000; }
    #miniImageInner { width:min(520px, 100%); background:rgba(255,255,255,0.98); border-radius:16px; padding:12px; box-sizing:border-box; border:1px solid rgba(0,0,0,0.12); }
    #miniImageTop { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
    #miniCloseBtn { border:none; background:transparent; font-size:18px; cursor:pointer; padding:8px 10px; border-radius:10px; }
    #miniPreviewImg { width:100%; height:auto; display:block; border-radius:14px; border:1px solid rgba(0,0,0,0.12); background:#fff; max-height:62vh; object-fit:contain; }
    #miniHint { margin-top:8px; font-size:12px; opacity:.75; text-align:center; }

    /* Requested UI tweaks */
    .post-user-border { border-right: 4px solid rgba(0,0,0,0.15); padding-right: 12px; box-sizing: border-box; }

    .post-meta-row { margin-top:8px; display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap; direction:ltr; }
    .post-meta-left { display:flex; flex-direction:column; align-items:flex-start; gap:6px; min-width:140px; }
    .post-meta-right { display:flex; flex-direction:column; align-items:flex-end; gap:6px; min-width:140px; }

    .has-image-flag { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(17,17,87,0.18); background:rgb(17,17,87); color:#fff; font-size:12px; font-weight:bold; user-select:none; white-space:nowrap; cursor:pointer; }
    .has-image-flag:active { opacity:.92; }
  </style>
</head>

<body>
  <header class="top-bar">
    <h1 class="coteret">×¤×•×¨×•× ×”×‘× ×™×™×“×™×</h1>
  </header>

  <!-- Pull To Refresh indicator -->
  <div id="pull-indicator" style="display:none;text-align:center;padding:6px;user-select:none;">
    <div class="loader"></div>
  </div>

  <!-- ======= TOP ACTIONS ======= -->
  <div id="top-actions" style="max-width:900px;margin:auto;padding:10px 20px 0 20px;box-sizing:border-box;">
    <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
      <button id="openCreatePost" type="button" style="padding:10px 12px;border-radius:10px;border:none;background:rgb(17,17,87);color:#fff;cursor:pointer;font-weight:bold;">â• ×¦×•×¨ ×¤×•×¡×˜</button>

      <input id="searchBox" type="search" placeholder="×—×™×¤×•×© ×‘×¤×•×¡×˜×™×..." style="flex:1;min-width:180px;padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);outline:none;box-sizing:border-box;" />

      <select id="sortMode" style="padding:10px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);outline:none;background:#fff;cursor:pointer;">
        <option value="lastComment" selected>××™×•×Ÿ: ×ª×’×•×‘×” ××—×¨×•× ×”</option>
        <option value="newest">××™×•×Ÿ: ×”×—×“×©×™× ×œ××¢×œ×”</option>
        <option value="oldest">××™×•×Ÿ: ×”×™×©× ×™× ×œ××¢×œ×”</option>
        <option value="author">××™×•×Ÿ: ×œ×¤×™ ××—×‘×¨</option>
        <option value="title">××™×•×Ÿ: ×œ×¤×™ ×›×•×ª×¨×ª</option>
      </select>
    </div>

    <div id="statusBar" style="margin-top:10px;padding:8px 10px;border-radius:10px;background:rgba(0,0,0,0.04);color:#111;font-size:13px;display:none;"></div>
  </div>

  <main class="forum-container">
    <div id="posts"><div class="loader"></div></div>
  </main>

  <!-- ======= CREATE POST MODAL ======= -->
  <div id="createPostOverlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:16px;box-sizing:border-box;z-index:9999;">
    <div id="createPostModal" style="width:min(720px,100%);background:#fff;border-radius:16px;padding:16px;box-sizing:border-box;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div style="font-weight:bold;font-size:18px;">×™×¦×™×¨×ª ×¤×•×¡×˜ ×—×“×©</div>
        <button id="closeCreatePost" type="button" style="border:none;background:transparent;font-size:18px;cursor:pointer;">âœ•</button>
      </div>

      <div style="margin-top:12px;display:flex;flex-direction:column;gap:10px;">
        <input id="newPostTitle" type="text" placeholder="×›×•×ª×¨×ª" maxlength="80"
          style="padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.18);outline:none;box-sizing:border-box;" />

        <textarea id="newPostText" placeholder="×ª×•×›×Ÿ ×”×¤×•×¡×˜..." rows="6" maxlength="2000"
          style="padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.18);outline:none;box-sizing:border-box;resize:vertical;"></textarea>

        <!-- IMAGE UPLOAD UI -->
        <div id="newPostImageBlock" style="border:1px solid rgba(0,0,0,0.10);border-radius:14px;padding:12px;background:rgba(0,0,0,0.02);">
          <div class="image-actions-row">
            <div style="display:flex;flex-direction:column;gap:4px;">
              <div style="font-weight:bold;">×ª××•× ×” ×œ×¤×•×¡×˜ (××•×¤×¦×™×•× ×œ×™)</div>
              <div id="newPostImageMeta" style="font-size:12px;opacity:.75;">×¤×•×¨××˜×™× × ×ª××›×™×: JPG/PNG/WebP. ××•××œ×¥ ×¢×“ 9MB.</div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button id="chooseImageBtn" type="button" class="img-btn img-btn-primary">×‘×—×¨ ×ª××•× ×”</button>
              <button id="removeImageBtn" type="button" class="img-btn img-btn-danger" style="display:none;">×”×¡×¨ ×ª××•× ×”</button>
            </div>
          </div>

          <input id="newPostImage" type="file" accept="image/*" style="display:none;" />

          <div id="imagePreviewWrap" style="display:none;margin-top:12px;">
            <div class="img-preview"><img id="imagePreview" alt="×ª×¦×•×’×” ××§×“×™××”" src="" /></div>

            <div style="margin-top:10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
              <span id="imageChip" class="image-chip" style="display:none;">ğŸ–¼ï¸ ×ª××•× ×” ××•×›× ×”</span>
              <span id="imageWarn" style="display:none;font-size:12px;color:#7a4b00;opacity:.95;"></span>
            </div>

            <div id="uploadProgressArea" style="display:none;margin-top:10px;">
              <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
                <span style="font-size:12px;opacity:.75;">××¢×œ×” ×ª××•× ×”â€¦</span>
                <span id="uploadProgressText" style="font-size:12px;opacity:.75;">0%</span>
              </div>
              <div class="progress-wrap" style="margin-top:6px;">
                <div id="uploadProgressBar" class="progress-bar"></div>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
          <div id="newPostHint" style="font-size:12px;color:#444;">×˜×™×¤: ×ª×›×ª×•×‘ ×‘×¨×•×¨, ×•×ª×©××™×¨ ××§×•× ×œ×ª×’×•×‘×•×ª.</div>
          <div style="display:flex;gap:10px;">
            <button id="submitPost" type="button" style="padding:10px 14px;border-radius:12px;border:none;background:rgb(17,17,87);color:#fff;cursor:pointer;font-weight:bold;">×¤×¨×¡×</button>
            <button id="cancelPost" type="button" style="padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,0.18);background:#fff;cursor:pointer;font-weight:bold;">×‘×™×˜×•×œ</button>
          </div>
        </div>

        <div id="createPostError" style="display:none;padding:10px 12px;border-radius:12px;background:rgba(255,0,0,0.08);color:#8a0000;font-size:13px;"></div>
      </div>
    </div>
  </div>

  <!-- FULLSCREEN VIEWER -->
  <div id="imageViewerOverlay">
    <div id="imageViewerInner">
      <div id="imageViewerTop">
        <div style="font-weight:bold;">×ª××•× ×”</div>
        <button id="closeImageViewer" type="button">âœ•</button>
      </div>
      <img id="imageViewerImg" alt="×ª××•× ×”" src="" />
      <div style="margin-top:10px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
        <span id="imageViewerHint" style="font-size:12px;opacity:.75;">×œ×—×¥ ××—×•×¥ ×œ×ª×™×‘×” ×›×“×™ ×œ×¡×’×•×¨</span>
      </div>
    </div>
  </div>

  <!-- MINI PREVIEW -->
  <div id="miniImageOverlay">
    <div id="miniImageInner">
      <div id="miniImageTop">
        <div style="font-weight:bold;">×ª×¦×•×’×” ××§×“×™××”</div>
        <button id="miniCloseBtn" type="button">âœ•</button>
      </div>
      <img id="miniPreviewImg" alt="×ª××•× ×”" src="" />
      <div id="miniHint">×œ×—×¥ ××—×•×¥ ×œ×ª×™×‘×” ×›×“×™ ×œ×¡×’×•×¨</div>
    </div>
  </div>

  <script>
    /* =========================================================================================
       ××‘×˜×—×” â€“ ×œ× × ×•×’×¢×™× ×‘×©×™×˜×”:
       1) ×—×¡×™××” ××™×™×“×™×ª â€“ ×œ× WebView => forbidden.html
       2) payload ××§×•×“×•×œ×¨ (email/password/token)
       3) Firebase Auth
       4) ××™××•×ª token ××•×œ sessions/{uid}/token
       ========================================================================================= */

    (function () {
      try {
        var ua = navigator.userAgent || "";
        var isKodular = (window.AppInventor && typeof window.AppInventor.getWebViewString === "function");
        var isIphoneSafari = (/iPhone/.test(ua) && /Safari/.test(ua) && !/CriOS|FxiOS|EdgiOS|OPiOS/.test(ua));
        if (!(isKodular || isIphoneSafari)) location.replace("forbidden.html");
      } catch (e) {
        location.replace("forbidden.html");
      }
    })();

    /* =========================================================================================
       Utilities
       ========================================================================================= */
    function safeText(x) { if (x === undefined || x === null) return ""; return String(x); }
    function escapeHTML(str) {
      if (str === undefined || str === null) str = "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function sanitizeImageUrl(url) {
      if (url === undefined || url === null) return "";
      var u = safeText(url).trim();
      if (!u) return "";
      if (u.indexOf("https://") === 0 || u.indexOf("http://") === 0) return u;
      return "";
    }
    function bytesToHuman(n) {
      try {
        var x = Number(n || 0);
        if (!x) return "0B";
        if (x < 1024) return x + "B";
        if (x < 1024 * 1024) return Math.round(x / 1024) + "KB";
        return (Math.round((x / (1024 * 1024)) * 10) / 10) + "MB";
      } catch (e) { return ""; }
    }
    function isLikelyImageFile(file) {
      try {
        if (!file) return false;
        var t = safeText(file.type || "").toLowerCase();
        if (t.indexOf("image/") === 0) return true;
        var n = safeText(file.name || "").toLowerCase();
        return (n.indexOf(".jpg") > -1 || n.indexOf(".jpeg") > -1 || n.indexOf(".png") > -1 || n.indexOf(".webp") > -1);
      } catch (e) { return false; }
    }

    function setStatus(msg, type) {
      if (type === undefined || type === null) type = "info";
      var bar = document.getElementById("statusBar");
      if (!bar) return;

      if (!msg) {
        bar.style.display = "none";
        bar.textContent = "";
        return;
      }

      bar.style.display = "block";
      bar.textContent = msg;

      if (type === "error") { bar.style.background = "rgba(255,0,0,0.08)"; bar.style.color = "#8a0000"; }
      else if (type === "ok") { bar.style.background = "rgba(0,128,0,0.08)"; bar.style.color = "#0b5a0b"; }
      else if (type === "warn") { bar.style.background = "rgba(255,165,0,0.10)"; bar.style.color = "#7a4b00"; }
      else { bar.style.background = "rgba(0,0,0,0.04)"; bar.style.color = "#111"; }
    }

    function userColor(key) {
      var colors = ["#60a5fa","#34d399","#f472b6","#fbbf24","#a78bfa","#fb7185","#22d3ee"];
      var hash = 0, s = safeText(key || "");
      for (var i = 0; i < s.length; i++) hash = s.charCodeAt(i) + ((hash << 5) - hash);
      return colors[Math.abs(hash) % colors.length];
    }

    /* =========================================================================================
       Secure Image Flow (SIGNED URL)
       - DB stores imagePath only
       - Viewer fetches short-lived signed URL via Cloud Function getImageUrl (2 minutes)
       ========================================================================================= */
    var GET_IMAGE_URL_ENDPOINT = "https://us-central1-bigone-86490.cloudfunctions.net/getImageUrl";
    var _idTokenCache = { token: "", at: 0 };
    var _signedUrlCache = {};     // path -> { url, expiresAt, fetchedAt }
    var _signedUrlInFlight = {};  // path -> Promise

    function getIdTokenFast(forceRefresh) {
      return new Promise(function (resolve, reject) {
        try {
          var now = Date.now();
          if (!forceRefresh && _idTokenCache.token && (now - (_idTokenCache.at || 0) < 45000)) {
            resolve(_idTokenCache.token);
            return;
          }
          var u = null;
          try { u = firebase.auth().currentUser; } catch (eU) { u = null; }
          if (!u || typeof u.getIdToken !== "function") { reject("no_user"); return; }

          u.getIdToken(!!forceRefresh)
            .then(function (t) { _idTokenCache.token = safeText(t || ""); _idTokenCache.at = Date.now(); resolve(_idTokenCache.token); })
            .catch(reject);
        } catch (e0) { reject(e0); }
      });
    }

    function getCachedSignedUrlForPath(path) {
      try {
        var p = safeText(path || "");
        if (!p) return "";
        var c = _signedUrlCache[p];
        if (!c || !c.url) return "";
        var now = Date.now();
        var exp = Number(c.expiresAt || 0) || 0;
        if (exp && (now + 12000) >= exp) return ""; // refresh early
        return sanitizeImageUrl(c.url || "");
      } catch (e) { return ""; }
    }

    function _extractSignedUrlFromPayload(data) {
      try {
        if (!data || typeof data !== "object") return { url: "", expiresAt: 0 };
        var u = "";
        if (!u && data.url) u = data.url;
        if (!u && data.signedUrl) u = data.signedUrl;
        if (!u && data.downloadUrl) u = data.downloadUrl;
        if (!u && data.result && data.result.url) u = data.result.url;
        if (!u && data.data && data.data.url) u = data.data.url;

        var exp = 0;
        if (data.expiresAt != null) exp = Number(data.expiresAt || 0) || 0;
        if (!exp && data.expires != null) exp = Number(data.expires || 0) || 0;
        if (!exp && data.expiration != null) exp = Number(data.expiration || 0) || 0;
        if (!exp && data.exp != null) exp = Number(data.exp || 0) || 0;

        u = sanitizeImageUrl(u);
        if (!u) return { url: "", expiresAt: 0 };
        if (!exp) exp = Date.now() + (110 * 1000);
        return { url: u, expiresAt: exp };
      } catch (e) { return { url: "", expiresAt: 0 }; }
    }

    function _fetchSignedUrlHTTP(path, token, paramName) {
      var p = safeText(path || "").trim();
      if (!p) return Promise.reject("missing_path");
      var key = safeText(paramName || "path");
      var url = GET_IMAGE_URL_ENDPOINT + "?" + encodeURIComponent(key) + "=" + encodeURIComponent(p);
      return fetch(url, {
        method: "GET",
        headers: { "Authorization": "Bearer " + safeText(token || "") }
      });
    }

    function fetchSignedUrlForPath(path, force) {
      return new Promise(function (resolve, reject) {
        try {
          var p = safeText(path || "").trim();
          if (!p) { reject("missing_path"); return; }

          if (!force) {
            var cached = getCachedSignedUrlForPath(p);
            if (cached) { resolve({ url: cached, expiresAt: (_signedUrlCache[p] ? _signedUrlCache[p].expiresAt : 0) }); return; }
          }

          if (_signedUrlInFlight[p]) { _signedUrlInFlight[p].then(resolve).catch(reject); return; }

          _signedUrlInFlight[p] = (function () {
            var usedParam = "path";

            function parseResp(resp) {
              if (!resp) throw "bad_status";
              return resp.text().then(function (txt) {
                var data = null;
                try { data = JSON.parse(txt); } catch (e) { data = null; }
                if (!resp.ok) {
                  var msg = "";
                  if (data && typeof data === "object") msg = data.error ? String(data.error) : (JSON.stringify(data).slice(0, 220));
                  else msg = (txt || "").slice(0, 220);
                  throw ("bad_status_" + (resp.status || 0) + ":" + msg);
                }
                return data || {};
              });
            }

            function attemptWith(token, paramName) {
              usedParam = paramName;
              return _fetchSignedUrlHTTP(p, token, paramName)
                .then(parseResp)
                .then(function (data) {
                  var ex = _extractSignedUrlFromPayload(data);
                  if (!ex || !ex.url) throw "bad_payload";
                  _signedUrlCache[p] = { url: ex.url, expiresAt: ex.expiresAt, fetchedAt: Date.now() };
                  return { url: ex.url, expiresAt: ex.expiresAt };
                });
            }

            return getIdTokenFast(true)
              .then(function (token) {
                return attemptWith(token, "path")
                  .catch(function () { return attemptWith(token, "filePath"); })
                  .catch(function () { return attemptWith(token, "imagePath"); });
              })
              .catch(function (err) {
                var s = safeText(err || "");
                var isAuth = (s.indexOf("bad_status_401") === 0 || s.indexOf("bad_status_403") === 0 || s === "no_user");
                if (!isAuth) throw err;
                return getIdTokenFast(true).then(function (token2) {
                  return attemptWith(token2, usedParam || "path")
                    .catch(function () { return attemptWith(token2, "path"); })
                    .catch(function () { return attemptWith(token2, "filePath"); })
                    .catch(function () { return attemptWith(token2, "imagePath"); });
                });
              });
          })();

          _signedUrlInFlight[p]
            .then(function (r) { try { delete _signedUrlInFlight[p]; } catch (eD) {} resolve(r); })
            .catch(function (e) { try { delete _signedUrlInFlight[p]; } catch (eD2) {} reject(e); });

        } catch (e0) {
          try { var p2 = safeText(path || "").trim(); if (p2 && _signedUrlInFlight[p2]) delete _signedUrlInFlight[p2]; } catch (eX) {}
          reject(e0);
        }
      });
    }

    /* =========================================================================================
       Image viewers
       ========================================================================================= */
    function bindImgLoadErrorOnce(imgEl) {
      if (!imgEl || imgEl.__boundLoadErr) return;
      imgEl.__boundLoadErr = true;

      imgEl.addEventListener("load", function () {
        try { setStatus("", "info"); } catch (e) {}
      });
      imgEl.addEventListener("error", function () {
        try {
          var current = (imgEl.getAttribute("src") || "").trim();
          if (!current) return;
          setStatus("×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×ª××•× ×”.", "error");
        } catch (e2) {}
      });
    }

    function openImageViewer(url) {
      var overlay = document.getElementById("imageViewerOverlay");
      var img = document.getElementById("imageViewerImg");
      var closeBtn = document.getElementById("closeImageViewer");
      if (!overlay || !img) return;

      var safe = sanitizeImageUrl(url);
      if (!safe) return;

      bindImgLoadErrorOnce(img);
      img.setAttribute("src", safe);
      overlay.style.display = "flex";

      if (closeBtn && !closeBtn.__bound) {
        closeBtn.__bound = true;
        closeBtn.addEventListener("click", function () {
          overlay.style.display = "none";
          img.setAttribute("src", "");
        });
      }

      if (!overlay.__bound) {
        overlay.__bound = true;
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay) {
            overlay.style.display = "none";
            img.setAttribute("src", "");
          }
        });
      }
    }

    function openMiniImagePreview(url) {
      var overlay = document.getElementById("miniImageOverlay");
      var img = document.getElementById("miniPreviewImg");
      var closeBtn = document.getElementById("miniCloseBtn");
      if (!overlay || !img) return;

      var safe = sanitizeImageUrl(url);
      if (!safe) return;

      bindImgLoadErrorOnce(img);
      img.setAttribute("src", safe);
      overlay.style.display = "flex";

      if (closeBtn && !closeBtn.__bound) {
        closeBtn.__bound = true;
        closeBtn.addEventListener("click", function () {
          overlay.style.display = "none";
          img.setAttribute("src", "");
        });
      }

      if (!overlay.__bound) {
        overlay.__bound = true;
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay) {
            overlay.style.display = "none";
            img.setAttribute("src", "");
          }
        });
      }
    }

    /* =========================================================================================
       Upload: storage path only (secure)
       ========================================================================================= */
    function uploadPostImageToPathEx(blobOrFile, contentType, ext, postId, uid, onProgress) {
      return new Promise(function (resolve, reject) {
        try {
          if (!blobOrFile || !postId || !uid) { reject("missing params"); return; }

          var safeExt = safeText(ext || "").toLowerCase();
          if (!safeExt) safeExt = "jpg";
          if (safeExt.length > 8) safeExt = "jpg";

          var name = Date.now() + "_" + uid + "." + safeExt;
          var fullPath = "post-images/" + postId + "/" + name;
          var ref = firebase.storage().ref(fullPath);

          var meta = {};
          try {
            if (contentType) meta.contentType = contentType;
            meta.cacheControl = "private, max-age=120";
          } catch (eM) {}

          var task = null;
          try { task = ref.put(blobOrFile, meta); }
          catch (ePut) { task = ref.put(blobOrFile); }

          task.on("state_changed",
            function (snap) {
              try {
                if (!snap) return;
                var bytes = Number(snap.bytesTransferred || 0);
                var total = Number(snap.totalBytes || 0);
                if (total > 0) {
                  var pct = Math.round((bytes / total) * 100);
                  if (typeof onProgress === "function") onProgress(pct);
                }
              } catch (eP) {}
            },
            function (err) { reject(err); },
            function () { resolve(fullPath); }
          );
        } catch (e0) { reject(e0); }
      });
    }

    /* =========================================================================================
       Lightweight image prep on publish (stable + best-effort)
       ========================================================================================= */
    function supportsWebPExport() {
      try {
        var c = document.createElement("canvas");
        if (!c || typeof c.toDataURL !== "function") return false;
        var u = c.toDataURL("image/webp");
        return (u && u.indexOf("data:image/webp") === 0);
      } catch (e) { return false; }
    }

    function dataURLToBlob(dataUrl) {
      try {
        var parts = safeText(dataUrl || "").split(",");
        if (parts.length < 2) return null;
        var meta = parts[0], b64 = parts[1];
        var mime = "application/octet-stream";
        var m = /data:([^;]+);base64/i.exec(meta);
        if (m && m[1]) mime = m[1];
        var bin = atob(b64);
        var len = bin.length;
        var arr = new Uint8Array(len);
        for (var i = 0; i < len; i++) arr[i] = bin.charCodeAt(i);
        return new Blob([arr], { type: mime });
      } catch (e) { return null; }
    }

    function canvasToBlobSafe(canvas, outType, quality, cb) {
      try {
        if (canvas && typeof canvas.toBlob === "function") {
          canvas.toBlob(function (blob) { cb(blob); }, outType, quality);
          return;
        }
      } catch (e1) {}
      try {
        var dataUrl = "";
        try { dataUrl = canvas.toDataURL(outType, quality); } catch (e2) { dataUrl = canvas.toDataURL(); }
        cb(dataURLToBlob(dataUrl));
      } catch (e3) { cb(null); }
    }

    function getPreviewUrlForFile(file, done) {
      try {
        if (window.URL && typeof URL.createObjectURL === "function") {
          try {
            var u = URL.createObjectURL(file);
            done(u, true);
            return;
          } catch (eObj) {}
        }
      } catch (e0) {}
      try {
        var r = new FileReader();
        r.onerror = function () { done("", false); };
        r.onload = function () { done(safeText(r.result || ""), false); };
        r.readAsDataURL(file);
      } catch (e1) { done("", false); }
    }

    function yieldToUI() {
      return new Promise(function (resolve) { try { setTimeout(resolve, 0); } catch (e) { resolve(); } });
    }

    function prepareImageForUpload(file, warnEl) {
      return new Promise(function (resolve) {
        try {
          if (!file) { resolve({ blob: null, contentType: "", ext: "" }); return; }

          var origType = safeText(file.type || "").toLowerCase();
          var origName = safeText(file.name || "");
          var ext = "";
          if (origName.indexOf(".") !== -1) ext = origName.split(".").pop().toLowerCase();

          var size = Number(file.size || 0);
          var SHOULD_TRY = size > (700 * 1024);

          var isHeic = (origType.indexOf("heic") > -1 || origType.indexOf("heif") > -1 || ext === "heic" || ext === "heif");
          if (isHeic) {
            try {
              if (warnEl) { warnEl.style.display = "block"; warnEl.textContent = "×ª××•× ×ª HEIC/HEIF: ×ª×•×¢×œ×” ×›××• ×©×”×™× (×œ×œ× ××•×¤×˜×™××™×–×¦×™×”) ×›×“×™ ×œ×× ×•×¢ ×›×©×œ×™×."; }
            } catch (eW0) {}
            resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "heic" });
            return;
          }

          if (!SHOULD_TRY) { resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" }); return; }

          var canWebp = supportsWebPExport();
          var outType = "image/jpeg", outExt = "jpg";
          if (canWebp) { outType = "image/webp"; outExt = "webp"; }
          else if (origType === "image/png" || ext === "png") { outType = "image/png"; outExt = "png"; }

          var maxDim = 1600;
          var quality = 0.82;

          yieldToUI()
            .then(function () {
              if (typeof createImageBitmap === "function") {
                return createImageBitmap(file).then(function (bmp) { return { kind: "bitmap", src: bmp }; })
                  .catch(function () { return { kind: "img", src: null }; });
              }
              return { kind: "img", src: null };
            })
            .then(function (decoded) {
              if (decoded && decoded.kind === "bitmap" && decoded.src) return decoded;

              return new Promise(function (resolveImg) {
                getPreviewUrlForFile(file, function (srcUrl, canRevoke) {
                  if (!srcUrl) { resolveImg({ kind: "fail" }); return; }
                  var img = new Image();
                  img.onload = function () {
                    try { if (canRevoke && srcUrl) URL.revokeObjectURL(srcUrl); } catch (eRv) {}
                    resolveImg({ kind: "img", src: img });
                  };
                  img.onerror = function () {
                    try { if (canRevoke && srcUrl) URL.revokeObjectURL(srcUrl); } catch (eRv2) {}
                    resolveImg({ kind: "fail" });
                  };
                  img.src = srcUrl;
                });
              });
            })
            .then(function (decoded) {
              try {
                if (!decoded || decoded.kind === "fail" || !decoded.src) {
                  resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
                  return;
                }

                var w = 0, h = 0;
                if (decoded.kind === "bitmap") { w = decoded.src.width || 0; h = decoded.src.height || 0; }
                else { w = decoded.src.naturalWidth || decoded.src.width || 0; h = decoded.src.naturalHeight || decoded.src.height || 0; }

                if (!w || !h) {
                  try { if (decoded.kind === "bitmap" && decoded.src && decoded.src.close) decoded.src.close(); } catch (eC) {}
                  resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
                  return;
                }

                if (Math.max(w, h) <= maxDim && size < (2.2 * 1024 * 1024)) {
                  try { if (warnEl) { warnEl.style.display = "block"; warnEl.textContent = "×”×ª××•× ×” × ×‘×—×¨×” ×›×¤×™ ×©×”×™× (××™×Ÿ ×¦×•×¨×š ×‘×›×™×•×•×¥)."; } } catch (eW2) {}
                  try { if (decoded.kind === "bitmap" && decoded.src && decoded.src.close) decoded.src.close(); } catch (eC2) {}
                  resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
                  return;
                }

                var scale = 1;
                if (w > maxDim || h > maxDim) scale = Math.min(maxDim / w, maxDim / h);
                var nw = Math.max(1, Math.round(w * scale));
                var nh = Math.max(1, Math.round(h * scale));

                var canvas = document.createElement("canvas");
                canvas.width = nw; canvas.height = nh;
                var ctx = canvas.getContext("2d");
                if (!ctx) {
                  try { if (decoded.kind === "bitmap" && decoded.src && decoded.src.close) decoded.src.close(); } catch (eC3) {}
                  resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
                  return;
                }

                ctx.imageSmoothingEnabled = true;
                try { ctx.imageSmoothingQuality = "high"; } catch (eQ) {}
                ctx.drawImage(decoded.src, 0, 0, nw, nh);

                try { if (decoded.kind === "bitmap" && decoded.src && decoded.src.close) decoded.src.close(); } catch (eC4) {}

                yieldToUI().then(function () {
                  canvasToBlobSafe(canvas, outType, quality, function (blob) {
                    try {
                      if (!blob) { resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" }); return; }
                      try { if (Number(blob.size || 0) >= Number(file.size || 0)) { resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" }); return; } } catch (eSz) {}

                      try { if (warnEl) { warnEl.style.display = "block"; warnEl.textContent = "×‘×•×¦×¢×” ××•×¤×˜×™××™×–×¦×™×” ×œ×ª××•× ×” ×›×“×™ ×œ×”××™×¥ ×˜×¢×™× ×”."; } } catch (eWarn) {}
                      resolve({ blob: blob, contentType: outType, ext: outExt });
                    } catch (eFin) {
                      resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
                    }
                  });
                });
              } catch (e2) {
                try { if (decoded.kind === "bitmap" && decoded.src && decoded.src.close) decoded.src.close(); } catch (eC5) {}
                resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
              }
            })
            .catch(function () {
              resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: ext || "jpg" });
            });

        } catch (e0) {
          resolve({ blob: file, contentType: file.type || "application/octet-stream", ext: "jpg" });
        }
      });
    }

    /* =========================================================================================
       Presence tracking (fixed)
       ========================================================================================= */
    var uid = null;
    var isAuthed = false;
    var realUsername = "××©×ª××©";
    var presenceRef = null;
    var presenceStartAt = 0;
    var presenceHeartbeatTimer = null;

    function startPresenceTracking() {
      try {
        if (!uid || !isAuthed) return;
        presenceStartAt = Date.now();
        presenceRef = firebase.database().ref("presence/" + uid);

        presenceRef.update({
          username: realUsername || "××©×ª××©",
          isOnline: true,
          connectedAt: presenceStartAt,
          lastSeen: presenceStartAt
        });

        if (presenceHeartbeatTimer) { clearInterval(presenceHeartbeatTimer); presenceHeartbeatTimer = null; }
        presenceHeartbeatTimer = setInterval(function () {
          try { presenceRef.update({ lastSeen: Date.now() }); } catch (e1) {}
        }, 10000);

        presenceRef.onDisconnect().update({
          isOnline: false,
          lastSeen: firebase.database.ServerValue.TIMESTAMP
        });
      } catch (e) {}
    }

    function stopPresenceTracking() {
      try {
        if (!presenceRef || !presenceStartAt) return;
        var sessionTime = Math.floor((Date.now() - presenceStartAt) / 1000);

        presenceRef.update({
          isOnline: false,
          lastSeen: Date.now(),
          sessionTime: sessionTime,
          totalTime: firebase.database.ServerValue.increment(sessionTime)
        });

        if (presenceHeartbeatTimer) { clearInterval(presenceHeartbeatTimer); presenceHeartbeatTimer = null; }
      } catch (e) {}
    }

    window.addEventListener("pagehide", stopPresenceTracking);
    window.addEventListener("beforeunload", stopPresenceTracking);

    /* =========================================================================================
       App state
       ========================================================================================= */
    var payload = null;
    var isRefreshing = false;

    var postsCacheData = [];
    var lastNavAt = 0;
    var lastOpenId = "";

    /* image selection state */
    var selectedImageFile = null;
    var selectedImagePreviewUrl = "";
    var selectedImagePreviewCanRevoke = false;
    var selectedImagePrepared = null;
    var isPublishingNow = false;

    function nowTs() { return Date.now(); }

    function debounce(fn, ms) {
      var t = null;
      return function () {
        var args = arguments;
        clearTimeout(t);
        t = setTimeout(function () { fn.apply(null, args); }, ms);
      };
    }

    /* =========================================================================================
       DOM Ready
       ========================================================================================= */
    document.addEventListener("DOMContentLoaded", function () {
      var postsEl = document.getElementById("posts");
      var indicator = document.getElementById("pull-indicator");

      var searchBox = document.getElementById("searchBox");
      var sortMode = document.getElementById("sortMode");

      var openCreatePostBtn = document.getElementById("openCreatePost");
      var overlay = document.getElementById("createPostOverlay");
      var closeCreatePostBtn = document.getElementById("closeCreatePost");
      var cancelPostBtn = document.getElementById("cancelPost");
      var submitPostBtn = document.getElementById("submitPost");
      var newPostTitle = document.getElementById("newPostTitle");
      var newPostText = document.getElementById("newPostText");
      var createPostError = document.getElementById("createPostError");

      /* image ui */
      var newPostImage = document.getElementById("newPostImage");
      var chooseImageBtn = document.getElementById("chooseImageBtn");
      var removeImageBtn = document.getElementById("removeImageBtn");
      var imagePreviewWrap = document.getElementById("imagePreviewWrap");
      var imagePreview = document.getElementById("imagePreview");
      var imageChip = document.getElementById("imageChip");
      var imageWarn = document.getElementById("imageWarn");
      var uploadProgressArea = document.getElementById("uploadProgressArea");
      var uploadProgressText = document.getElementById("uploadProgressText");
      var uploadProgressBar = document.getElementById("uploadProgressBar");
      var newPostImageMeta = document.getElementById("newPostImageMeta");

      if (!postsEl) { location.replace("forbidden.html"); return; }

      /* sort memory */
      var rememberedSortMode = "lastComment";
      try { rememberedSortMode = sessionStorage.getItem("forumSortMode") || "lastComment"; } catch (eSM) { rememberedSortMode = "lastComment"; }
      try { if (sortMode) sortMode.value = rememberedSortMode; } catch (eSV) {}

      function rememberSortMode(v) { try { sessionStorage.setItem("forumSortMode", safeText(v || "newest")); } catch (eR) {} }

      /* click delegation: chip + image */
      if (!postsEl.__imgBound) {
        postsEl.__imgBound = true;
        postsEl.addEventListener("click", function (e) {
          // chip -> mini preview
          var chip = null;
          try { chip = e.target.closest(".has-image-flag"); } catch (er) { chip = null; }
          if (chip) {
            try { e.preventDefault(); e.stopPropagation(); } catch (eS) {}
            try {
              var postEl = chip.closest(".post");
              if (!postEl) return;

              var url = sanitizeImageUrl(postEl.getAttribute("data-image") || "");
              var path = safeText(postEl.getAttribute("data-image-path") || "").trim();

              if (!url && path) {
                setStatus("×˜×•×¢×Ÿ ×ª××•× ×”â€¦", "info");
                fetchSignedUrlForPath(path, false)
                  .then(function (r) {
                    var su = sanitizeImageUrl(r && r.url ? r.url : "");
                    if (su) { postEl.setAttribute("data-image", su); openMiniImagePreview(su); setStatus("", "info"); return; }
                    setStatus("×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×ª××•× ×”.", "error");
                  })
                  .catch(function (err) {
                    var s = safeText(err || "");
                    if (s && s.length > 30) s = s.slice(0, 30);
                    setStatus("×œ× ×”×¦×œ×—×ª×™ ×œ×˜×¢×•×Ÿ ××ª ×”×ª××•× ×”." + (s ? " (" + s + ")" : ""), "error");
                  });
                return;
              }

              if (url) openMiniImagePreview(url);
            } catch (eM) {}
            return;
          }

          // click on .post-image -> fullscreen
          var img = null;
          try { img = e.target.closest(".post-image"); } catch (er2) { img = null; }
          if (img) {
            var src = sanitizeImageUrl(img.getAttribute("data-full") || img.getAttribute("src") || "");
            if (src) openImageViewer(src);
          }
        }, false);
      }

      function createPostErrorShow(msg) {
        if (!createPostError) return;
        createPostError.textContent = msg;
        createPostError.style.display = "block";
      }
      function createPostErrorHide() {
        if (!createPostError) return;
        createPostError.textContent = "";
        createPostError.style.display = "none";
      }

      function setUploadProgress(pct) {
        try {
          var x = Math.max(0, Math.min(100, Number(pct || 0)));
          if (uploadProgressArea) uploadProgressArea.style.display = "block";
          if (uploadProgressText) uploadProgressText.textContent = x + "%";
          if (uploadProgressBar) uploadProgressBar.style.width = x + "%";
        } catch (e) {}
      }

      function clearSelectedImage(resetInput) {
        try {
          if (selectedImagePreviewUrl && selectedImagePreviewCanRevoke) {
            try { URL.revokeObjectURL(selectedImagePreviewUrl); } catch (eRv) {}
          }
        } catch (e0) {}

        selectedImageFile = null;
        selectedImagePreviewUrl = "";
        selectedImagePreviewCanRevoke = false;
        selectedImagePrepared = null;

        try {
          if (imagePreview) imagePreview.setAttribute("src", "");
          if (imagePreviewWrap) imagePreviewWrap.style.display = "none";
          if (removeImageBtn) removeImageBtn.style.display = "none";
          if (imageChip) imageChip.style.display = "none";
          if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }

          if (uploadProgressArea) uploadProgressArea.style.display = "none";
          if (uploadProgressText) uploadProgressText.textContent = "0%";
          if (uploadProgressBar) uploadProgressBar.style.width = "0%";

          if (resetInput && newPostImage) newPostImage.value = "";
          if (newPostImageMeta) newPostImageMeta.textContent = "×¤×•×¨××˜×™× × ×ª××›×™×: JPG/PNG/WebP. ××•××œ×¥ ×¢×“ 9MB.";
        } catch (e1) {}
      }

      /* create post modal */
      function openCreatePostModal() {
        createPostErrorHide();
        if (newPostTitle) newPostTitle.value = "";
        if (newPostText) newPostText.value = "";
        clearSelectedImage(true);
        isPublishingNow = false;
        if (overlay) overlay.style.display = "flex";
        setTimeout(function () { try { if (newPostTitle) newPostTitle.focus(); } catch (e) {} }, 50);
      }

      function closeCreatePostModal() {
        createPostErrorHide();
        if (overlay) overlay.style.display = "none";
        clearSelectedImage(true);
        isPublishingNow = false;
      }

      if (openCreatePostBtn) {
        openCreatePostBtn.addEventListener("click", function () {
          if (!isAuthed) { setStatus("×¢×•×“ ×œ× ××•××ª×ª ××•×œ ×”×©×¨×ª. ×—×›×” ×©× ×™×™×” ×•××– × ×¡×” ×©×•×‘.", "error"); return; }
          openCreatePostModal();
        });
      }
      if (closeCreatePostBtn) closeCreatePostBtn.addEventListener("click", closeCreatePostModal);
      if (cancelPostBtn) cancelPostBtn.addEventListener("click", closeCreatePostModal);
      if (overlay) overlay.addEventListener("click", function (e) { if (e.target === overlay) closeCreatePostModal(); });

      /* search/sort */
      if (searchBox) searchBox.addEventListener("input", debounce(function () { renderPostsFromCache(); }, 120));
      if (sortMode) sortMode.addEventListener("change", function () { rememberSortMode(sortMode.value); renderPostsFromCache(); });

      /* image choose/remove */
      if (chooseImageBtn && newPostImage) {
        chooseImageBtn.addEventListener("click", function () {
          try { newPostImage.value = ""; newPostImage.click(); } catch (e) {}
        });
      }
      if (removeImageBtn) removeImageBtn.addEventListener("click", function () { clearSelectedImage(true); });

      if (newPostImage) {
        newPostImage.addEventListener("change", function () {
          try {
            var f = (newPostImage.files && newPostImage.files[0]) ? newPostImage.files[0] : null;
            if (!f) return;

            if (!isLikelyImageFile(f)) { createPostErrorShow("×§×•×‘×¥ ×œ× × ×ª××š. ×‘×—×¨ ×ª××•× ×” (JPG/PNG/WebP)."); clearSelectedImage(true); return; }

            var MAX = 9 * 1024 * 1024;
            if (Number(f.size || 0) > MAX) { createPostErrorShow("×”×ª××•× ×” ×’×“×•×œ×” ××“×™ (" + bytesToHuman(f.size) + "). ××•××œ×¥ ×¢×“ 9MB."); clearSelectedImage(true); return; }

            selectedImageFile = f;
            selectedImagePrepared = null;
            if (imageWarn) { imageWarn.style.display = "none"; imageWarn.textContent = ""; }

            try {
              if (selectedImagePreviewUrl && selectedImagePreviewCanRevoke) {
                try { URL.revokeObjectURL(selectedImagePreviewUrl); } catch (eRv0) {}
              }
            } catch (eRv1) {}

            selectedImagePreviewUrl = "";
            selectedImagePreviewCanRevoke = false;

            try {
              if (imagePreviewWrap) imagePreviewWrap.style.display = "block";
              if (removeImageBtn) removeImageBtn.style.display = "inline-block";
              if (imageChip) { imageChip.style.display = "inline-flex"; imageChip.textContent = "ğŸ–¼ï¸ " + bytesToHuman(f.size); }
              if (newPostImageMeta) newPostImageMeta.textContent = "× ×‘×—×¨×” ×ª××•× ×”: " + safeText(f.name) + " (" + bytesToHuman(f.size) + ")";
            } catch (eUI) {}

            getPreviewUrlForFile(f, function (srcUrl, canRevoke) {
              try {
                if (srcUrl) {
                  selectedImagePreviewUrl = srcUrl;
                  selectedImagePreviewCanRevoke = !!canRevoke;
                  if (imagePreview) imagePreview.setAttribute("src", selectedImagePreviewUrl);
                }
              } catch (ePrev) {}
            });

          } catch (e2) {}
        });
      }

      /* publish */
      function publishPost(title, text) {
        if (!isAuthed || !uid) { createPostErrorShow("××ª×” ×œ× ×××•××ª. × ×¡×” ×©×•×‘."); return; }
        if (isPublishingNow) return;
        isPublishingNow = true;

        var btn = submitPostBtn;
        if (btn) btn.disabled = true;

        var postsRef = firebase.database().ref("posts");
        var newRef = postsRef.push();
        var postId = newRef.key;

        var postObj = {
          title: title,
          text: text,
          author: realUsername,
          time: nowTs(),
          image: null,
          imagePath: null
        };

        // no image
        if (!selectedImageFile) {
          newRef.set(postObj)
            .then(function () {
              closeCreatePostModal();
              setStatus("×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”.", "ok");
              try { window.scrollTo(0, 0); } catch (eS) {}
            })
            .catch(function () { createPostErrorShow("×©×’×™××” ×‘×¤×¨×¡×•×. × ×¡×” ×©×•×‘."); setStatus("×©×’×™××” ×‘×¤×¨×¡×•×.", "error"); })
            .finally(function () { if (btn) btn.disabled = false; isPublishingNow = false; });
          return;
        }

        setStatus("××›×™×Ÿ ×ª××•× ×”â€¦", "info");
        setUploadProgress(1);

        prepareImageForUpload(selectedImageFile, imageWarn)
          .then(function (prepared) {
            selectedImagePrepared = prepared || null;
            var blobToUpload = (selectedImagePrepared && selectedImagePrepared.blob) ? selectedImagePrepared.blob : selectedImageFile;
            var ct = (selectedImagePrepared && selectedImagePrepared.contentType) ? selectedImagePrepared.contentType : safeText(selectedImageFile.type || "");
            var ext0 = (selectedImagePrepared && selectedImagePrepared.ext) ? safeText(selectedImagePrepared.ext || "") : "";
            if (!ext0) {
              var n0 = safeText(selectedImageFile.name || "");
              if (n0.indexOf(".") !== -1) ext0 = n0.split(".").pop().toLowerCase();
            }
            if (!ext0) ext0 = "jpg";

            setStatus("××¢×œ×” ×ª××•× ×”â€¦", "info");
            setUploadProgress(2);

            return uploadPostImageToPathEx(blobToUpload, ct, ext0, postId, uid, function (pct) { setUploadProgress(pct); });
          })
          .then(function (imagePath) {
            postObj.image = null;
            postObj.imagePath = safeText(imagePath || "");
            setStatus("×©×•××¨ ×¤×•×¡×˜â€¦", "info");
            setUploadProgress(100);
            return newRef.set(postObj);
          })
          .then(function () {
            closeCreatePostModal();
            setStatus("×”×¤×•×¡×˜ ×¤×•×¨×¡× ×‘×”×¦×œ×—×”.", "ok");
            try { window.scrollTo(0, 0); } catch (eS2) {}
          })
          .catch(function () {
            try { if (postId) firebase.database().ref("posts/" + postId).remove(); } catch (eRm) {}
            createPostErrorShow("×©×’×™××” ×‘×”×¢×œ××ª ×ª××•× ×”/×¤×¨×¡×•×. × ×¡×” ×©×•×‘.");
            setStatus("×©×’×™××” ×‘×¤×¨×¡×•×.", "error");
          })
          .finally(function () {
            if (uploadProgressArea) uploadProgressArea.style.display = "none";
            if (btn) btn.disabled = false;
            isPublishingNow = false;
          });
      }

      if (submitPostBtn) {
        submitPostBtn.addEventListener("click", function () {
          createPostErrorHide();
          if (!isAuthed) { createPostErrorShow("××ª×” ×œ× ×××•××ª ×¢×“×™×™×Ÿ. × ×¡×” ×©×•×‘ ×¢×•×“ ×¨×’×¢."); return; }
          if (isPublishingNow) return;

          var title = safeText(newPostTitle && newPostTitle.value ? newPostTitle.value : "").trim();
          var text = safeText(newPostText && newPostText.value ? newPostText.value : "").trim();

          if (title.length < 3) { createPostErrorShow("×›×•×ª×¨×ª ×§×¦×¨×” ××“×™. ××™× ×™××•× 3 ×ª×•×•×™×."); return; }
          if (text.length < 3) { createPostErrorShow("×ª×•×›×Ÿ ×§×¦×¨ ××“×™. ××™× ×™××•× 3 ×ª×•×•×™×."); return; }

          if (selectedImageFile) {
            if (!isLikelyImageFile(selectedImageFile)) { createPostErrorShow("×”×ª××•× ×” ×©× ×‘×—×¨×” ×œ× ×ª×§×™× ×”. ×‘×—×¨ ×ª××•× ×” ××—×“×©."); clearSelectedImage(true); return; }
            var MAX2 = 9 * 1024 * 1024;
            if (Number(selectedImageFile.size || 0) > MAX2) { createPostErrorShow("×”×ª××•× ×” ×’×“×•×œ×” ××“×™. ×‘×—×¨ ×ª××•× ×” ×§×˜× ×” ×™×•×ª×¨."); return; }
          }

          publishPost(title, text);
        });
      }

      /* pull-to-refresh */
      var pullStartY = 0;
      var pulling = false;
      var didTriggerRefresh = false;

      document.addEventListener("touchstart", function (e) {
        try {
          if (window.scrollY === 0 && !isRefreshing) {
            pullStartY = e.touches[0].clientY;
            pulling = true;
            didTriggerRefresh = false;
          }
        } catch (err1) {}
      }, { passive: true });

      document.addEventListener("touchmove", function (e) {
        if (!pulling || isRefreshing) return;
        var diff = e.touches[0].clientY - pullStartY;
        if (diff <= 0) return;

        if (indicator) indicator.style.display = "block";

        var THRESHOLD = 90;
        if (diff > THRESHOLD && !didTriggerRefresh) {
          didTriggerRefresh = true;
          pulling = false;
          isRefreshing = true;
          loadPosts(true);
        }
      }, { passive: true });

      document.addEventListener("touchend", function () {
        pulling = false;
        if (!isRefreshing && indicator) indicator.style.display = "none";
      }, { passive: true });

      /* forum navigation */
      if (!postsEl.__navBound) {
        postsEl.__navBound = true;
        postsEl.addEventListener("click", function (e) {
          if (isRefreshing || pulling) return;

          try { if (e.target.closest(".has-image-flag")) return; } catch (eC) {}
          try { if (e.target.closest(".post-image")) return; } catch (eI) {}

          var postEl = null;
          try { postEl = e.target.closest(".post"); } catch (err) { postEl = null; }
          if (!postEl) return;

          var id = postEl.getAttribute("data-id");
          if (!id) return;

          var now = Date.now();
          if (now - lastNavAt < 350 && lastOpenId === id) return;
          lastNavAt = now; lastOpenId = id;

          openPost(id, postEl);
        }, false);
      }

      function openPost(postId, el) {
        try {
          var h3 = el.querySelector("h3");
          var p = el.querySelector("p");
          var authorEl = el.querySelector('[data-role="author"]');
          var author = authorEl ? (authorEl.innerText || "").replace("×××ª:", "").trim() : "";

          var title = h3 ? (h3.innerText || "") : "";
          var text = p ? (p.innerText || "") : "";

          var imageUrl = sanitizeImageUrl(el.getAttribute("data-image") || "");
          var imagePath = safeText(el.getAttribute("data-image-path") || "").trim();

          // best-effort prefetch signed url before navigation (optional)
          if (imagePath && !imageUrl) {
            fetchSignedUrlForPath(imagePath, false)
              .then(function (r) {
                var su = sanitizeImageUrl(r && r.url ? r.url : "");
                if (su) { el.setAttribute("data-image", su); imageUrl = su; }
                sessionStorage.setItem("currentPost", JSON.stringify({ id: postId, title: title, text: text, author: author, image: imageUrl, imagePath: imagePath }));
                location.href = "post.html?postId=" + encodeURIComponent(postId);
              })
              .catch(function () {
                sessionStorage.setItem("currentPost", JSON.stringify({ id: postId, title: title, text: text, author: author, image: imageUrl, imagePath: imagePath }));
                location.href = "post.html?postId=" + encodeURIComponent(postId);
              });
            return;
          }

          sessionStorage.setItem("currentPost", JSON.stringify({ id: postId, title: title, text: text, author: author, image: imageUrl, imagePath: imagePath }));
        } catch (e0) {}

        location.href = "post.html?postId=" + encodeURIComponent(postId);
      }

      /* rendering */
      function buildPostCardHTML(p) {
        var idRaw = safeText(p.id || "");
        var id = escapeHTML(idRaw);

        var title = escapeHTML(p.title || "");
        var text = escapeHTML(p.text || "");
        var author = escapeHTML(p.author || "");

        var authorColor = escapeHTML(userColor(p.author || ""));
        var timeStr = "";
        if (p.time) {
          try {
            timeStr = new Date(p.time).toLocaleString("he-IL", { hour: "2-digit", minute: "2-digit", day: "2-digit", month: "2-digit" });
          } catch (eT) { timeStr = ""; }
        }

        var imgPath = safeText(p.imagePath || "").trim();
        var signed = "";
        if (imgPath) signed = getCachedSignedUrlForPath(imgPath) || "";
        var hasImage = !!imgPath;

        var imageBadgeHtml = hasImage ? '<span class="has-image-flag" title="×œ×—×¥ ×œ×ª×¦×•×’×” ××§×“×™××”">×ª××•× ×”</span>' : "";

        return (
          '\n<div class="post" data-id="' + id + '" data-image="' + escapeHTML(signed || "") + '" data-image-path="' + escapeHTML(imgPath || "") + '" style="border-right:4px solid ' + authorColor + ';">' +
            '\n  <h3>' + title + '</h3>' +
            '\n  <p>' + text + '</p>' +
            '\n  <div class="post-meta-row">' +
            '\n    <div class="post-meta-left">' +
                    imageBadgeHtml +
            '\n      <small class="post-time-small">' + escapeHTML(timeStr) + '</small>' +
            '\n    </div>' +
            '\n    <div class="post-meta-right" style="text-align:right;">' +
            '\n      <small data-role="author" style="color:' + authorColor + ';">×××ª: ' + author + '</small>' +
            '\n    </div>' +
            '\n  </div>' +
          '\n</div>\n'
        );
      }

      function renderPostsFromCache() {
        var q = safeText(searchBox && searchBox.value ? searchBox.value : "").trim().toLowerCase();
        var mode = safeText(sortMode && sortMode.value ? sortMode.value : rememberedSortMode) || "newest";

        var list = postsCacheData.slice();

        if (q) {
          list = list.filter(function (p) {
            var t = (p.title || "").toLowerCase();
            var x = (p.text || "").toLowerCase();
            var a = (p.author || "").toLowerCase();
            var hasImg = (p.imagePath ? "×ª××•× ×”" : "");
            return (t.indexOf(q) !== -1 || x.indexOf(q) !== -1 || a.indexOf(q) !== -1 || hasImg.indexOf(q) !== -1);
          });
        }

        if (mode === "oldest") list.sort(function (a, b) { return (a.time || 0) - (b.time || 0); });
        else if (mode === "author") list.sort(function (a, b) { return (a.author || "").localeCompare(b.author || "", "he"); });
        else if (mode === "title") list.sort(function (a, b) { return (a.title || "").localeCompare(b.title || "", "he"); });
        else if (mode === "lastComment") {
          // minimal: fallback to time (×× ××™×Ÿ lastCommentTime ×‘×“××˜×”, ×–×” × ×©××¨ ×™×¦×™×‘)
          list.sort(function (a, b) {
            var ta = Number(a.lastCommentTime || 0) || 0;
            var tb = Number(b.lastCommentTime || 0) || 0;
            if (!ta) ta = Number(a.time || 0) || 0;
            if (!tb) tb = Number(b.time || 0) || 0;
            return tb - ta;
          });
        } else {
          list.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });
        }

        var html = "";
        if (!list.length) html = q ? "<p>×œ× × ××¦××• ×ª×•×¦××•×ª ×œ×—×™×¤×•×©.</p>" : "<p>××™×Ÿ ×¢×“×™×™×Ÿ ×¤×•×¡×˜×™×.</p>";
        else {
          for (var i = 0; i < list.length; i++) html += buildPostCardHTML(list[i]);
        }
        postsEl.innerHTML = html;
      }

      /* load posts */
      function loadPosts(fromRefresh) {
        if (fromRefresh === undefined || fromRefresh === null) fromRefresh = false;
        setStatus(fromRefresh ? "××¨×¢× ×Ÿ ×¤×•×¡×˜×™×â€¦" : "×˜×•×¢×Ÿ ×¤×•×¡×˜×™×â€¦", "info");

        firebase.database().ref("posts").orderByChild("time").limitToLast(300).once("value")
          .then(function (snap) {
            var items = [];
            snap.forEach(function (pSnap) {
              var p = pSnap.val() || {};
              items.push({
                id: pSnap.key,
                title: safeText(p.title),
                text: safeText(p.text),
                author: safeText(p.author),
                time: Number(p.time || 0),
                lastCommentTime: Number(p.lastCommentTime || 0),
                imagePath: safeText(p.imagePath || "")
              });
            });

            items.sort(function (a, b) { return (b.time || 0) - (a.time || 0); });
            postsCacheData = items;

            renderPostsFromCache();

            if (fromRefresh) {
              setTimeout(function () {
                isRefreshing = false;
                if (indicator) indicator.style.display = "none";
                setStatus("×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”.", "ok");
              }, 250);
            } else {
              setStatus("×¤×•×¡×˜×™× × ×˜×¢× ×•.", "ok");
            }
          })
          .catch(function () { location.replace("forbidden.html"); });
      }

      /* auth flow */
      function waitForPayload() {
        var raw = "";
        try {
          raw = window.AppInventor.getWebViewString();
          if (!raw) { setTimeout(waitForPayload, 200); return; }
          payload = JSON.parse(raw);
        } catch (e) {
          setTimeout(waitForPayload, 200);
          return;
        }
        loginToFirebase(payload);
      }

      function loginToFirebase(data) {
        if (!data || !data.email || !data.password || !data.token) { location.replace("forbidden.html"); return; }
        firebase.auth().signInWithEmailAndPassword(data.email, data.password)
          .then(function (c) { validateToken(c.user.uid, data.token); })
          .catch(function () { location.replace("forbidden.html"); });
      }

      function validateToken(userId, token) {
        firebase.database().ref("sessions/" + userId + "/token").once("value")
          .then(function (snap) {
            if (!snap.exists() || snap.val() !== token) { location.replace("forbidden.html"); return; }
            uid = userId;
            isAuthed = true;

            firebase.database().ref("users/" + uid + "/username").once("value")
              .then(function (uSnap) {
                realUsername = uSnap.val() || "××©×ª××©";
                startPresenceTracking();
                setStatus("××—×•×‘×¨ ×›Ö¾" + realUsername, "ok");
                loadPosts(false);
              })
              .catch(function () {
                realUsername = "××©×ª××©";
                startPresenceTracking();
                setStatus("××—×•×‘×¨", "ok");
                loadPosts(false);
              });
          })
          .catch(function () { location.replace("forbidden.html"); });
      }

      waitForPayload();
    });
  </script>
</body>
</html>