<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¦×¤×™×™×” ×‘×¤×•×¡×˜</title>

  <!-- ğŸš« ×—×¡×™××” ××™×™×“×™×ª ×œ×“×¤×“×¤×Ÿ ×¨×’×™×œ -->
  <script>
    (function () {
      try {
        if (!window.AppInventor) location.replace("forbidden.html");
      } catch {
        location.replace("forbidden.html");
      }
    })();
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
  <link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>×¦×¤×™×™×” ×‘×¤×•×¡×˜</h1>
</header>

<main class="forum-container">

  <div id="post"></div>

  <button id="openMain" class="add-comment-btn">×”×•×¡×£ ×ª×’×•×‘×”</button>

  <div id="mainComposer" class="composer hidden">
    <textarea id="mainText" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
    <div class="composer-actions">
      <button id="sendMain">×©×œ×—</button>
      <button id="closeMain">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <section class="comments">
    <h3>×ª×’×•×‘×•×ª</h3>
    <div id="comments"></div>
  </section>

</main>

<script>
/* ===============================
   Helpers
   =============================== */
function escapeHTML(s=""){return s.replace(/[&<>"']/g,m=>({
"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
}[m]))}

function userColor(key){
  const c=["#60a5fa","#34d399","#f472b6","#fbbf24","#a78bfa","#fb7185","#22d3ee"];
  let h=0;for(let i=0;i<key.length;i++)h=key.charCodeAt(i)+((h<<5)-h);
  return c[Math.abs(h)%c.length];
}

/* ===============================
   Auth + Init
   =============================== */
let payload, uid, username="××©×ª××©";
const postId=new URLSearchParams(location.search).get("postId");
if(!postId) location.replace("forbidden.html");

function waitPayload(){
  try{
    const raw=window.AppInventor.getWebViewString();
    if(!raw) return setTimeout(waitPayload,200);
    payload=JSON.parse(raw);
  }catch{return setTimeout(waitPayload,200)}
  login();
}
waitPayload();

function login(){
  firebase.auth().signInWithEmailAndPassword(payload.email,payload.password)
  .then(c=>{
    uid=c.user.uid;
    return firebase.database().ref("sessions/"+uid+"/token").once("value");
  })
  .then(s=>{
    if(!s.exists()||s.val()!==payload.token) throw 0;
    return firebase.database().ref("users/"+uid+"/username").once("value");
  })
  .then(s=>{
    username=s.val()||"××©×ª××©";
    loadPost();
    loadComments();
  })
  .catch(()=>location.replace("forbidden.html"));
}

/* ===============================
   Post
   =============================== */
function loadPost(){
  const cached=sessionStorage.getItem("currentPost");
  if(cached){
    const p=JSON.parse(cached);
    document.getElementById("post").innerHTML=`
      <div class="post">
        <h3>${escapeHTML(p.title)}</h3>
        <p>${escapeHTML(p.text)}</p>
        <small>×××ª: ${escapeHTML(p.author)}</small>
      </div>`;
    return;
  }
  firebase.database().ref("posts/"+postId).once("value").then(s=>{
    const p=s.val();
    document.getElementById("post").innerHTML=`
      <div class="post">
        <h3>${escapeHTML(p.title)}</h3>
        <p>${escapeHTML(p.text)}</p>
        <small>×××ª: ${escapeHTML(p.author)}</small>
      </div>`;
  });
}

/* ===============================
   Comments
   =============================== */
const commentsBox=document.getElementById("comments");

function loadComments(){
  firebase.database().ref("comments/"+postId).once("value").then(s=>{
    commentsBox.innerHTML="";
    s.forEach(cs=>{
      renderComment(cs.key,cs.val());
    });
  });
}

function renderComment(id,c){
  const div=document.createElement("div");
  div.className="comment";
  div.style.borderRightColor=userColor(c.author);

  div.innerHTML=`
    <div class="comment-meta">
      <b>${escapeHTML(c.author)}</b>
      <small>${new Date(c.time).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})}</small>
    </div>
    <p>${escapeHTML(c.text)}</p>
    <div class="comment-actions">
      <button onclick="openReply('${id}')">×”×©×‘</button>
      <span id="count-${id}" onclick="toggleReplies('${id}')">×˜×•×¢×Ÿ ×ª×’×•×‘×•×ªâ€¦</span>
    </div>
    <div class="replies hidden" id="replies-${id}"></div>
  `;
  commentsBox.appendChild(div);
  updateReplyCount(id);
}

/* ===============================
   Replies
   =============================== */
function updateReplyCount(id){
  firebase.database().ref("replies/"+postId+"/"+id).once("value").then(s=>{
    const c=s.numChildren();
    const el=document.getElementById("count-"+id);
    el.textContent=c?`${c} ×ª×’×•×‘×•×ª â–¾`:"××™×Ÿ ×ª×’×•×‘×•×ª";
  });
}

function toggleReplies(id){
  const box=document.getElementById("replies-"+id);
  if(!box.classList.contains("hidden")){
    box.classList.add("hidden"); return;
  }
  box.classList.remove("hidden");
  box.innerHTML="";
  firebase.database().ref("replies/"+postId+"/"+id).once("value").then(s=>{
    s.forEach(r=>{
      const d=r.val();
      box.innerHTML+=`
        <div class="reply">
          <b>${escapeHTML(d.author)}</b>
          <small>${new Date(d.time).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"})}</small>
          <p>${escapeHTML(d.text)}</p>
        </div>`;
    });
  });
}

function openReply(id){
  const box=document.getElementById("replies-"+id);
  box.classList.remove("hidden");
  box.innerHTML=`
    <textarea id="rt-${id}" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
    <button onclick="sendReply('${id}')">×©×œ×—</button>`;
}

function sendReply(id){
  const ta=document.getElementById("rt-"+id);
  if(!ta.value.trim()) return;
  firebase.database().ref("replies/"+postId+"/"+id).push({
    text:ta.value,
    author:username,
    time:Date.now()
  }).then(()=>{
    updateReplyCount(id);
    toggleReplies(id);
  });
}

/* ===============================
   Main composer
   =============================== */
openMain.onclick=()=>{
  mainComposer.classList.remove("hidden");
  mainText.focus();
};
closeMain.onclick=()=>{
  mainComposer.classList.add("hidden");
  mainText.value="";
};
sendMain.onclick=()=>{
  if(!mainText.value.trim())return;
  firebase.database().ref("comments/"+postId).push({
    text:mainText.value,
    author:username,
    time:Date.now()
  }).then(()=>{
    closeMain.onclick();
    loadComments();
  });
};
</script>

</body>
</html>