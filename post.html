<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¦×¤×™×™×” ×‘×¤×•×¡×˜</title>

  <!-- =====================================================================================
       ğŸš« ×—×¡×™××” ××™×™×“×™×ª ×œ×“×¤×“×¤×Ÿ ×¨×’×™×œ (××‘×˜×—×”: ×œ× ××©× ×™× ×©×™×˜×”)
       1) ×—×™×™×‘ WebView (AppInventor)
       2) ×—×™×™×‘ getWebViewString ×¤×•× ×§×¦×™×”
       ×× ×œ× => forbidden.html
       ===================================================================================== -->
  <script>
    (function () {
      try {
        if (!window.AppInventor || typeof window.AppInventor.getWebViewString !== "function") {
          location.replace("forbidden.html");
        }
      } catch (e) {
        location.replace("forbidden.html");
      }
    })();
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/forum.css" />
  <link rel="stylesheet" href="css/post.css" />
</head>

<body>

<header class="top-bar">
  <h1>×¦×¤×™×™×” ×‘×¤×•×¡×˜</h1>
</header>

<main class="forum-container">

  <!-- =====================================================================================
       POST HEADER AREA
       ===================================================================================== -->
  <div id="post"></div>

  <!-- =====================================================================================
       STATUS BAR (UX ×©×“×¨×•×’ - ×œ× ×¤×•×’×¢ ×‘××‘×˜×—×”)
       ===================================================================================== -->
  <div id="statusBar" style="
    display:none;
    margin: 10px 0 14px 0;
    padding:10px 12px;
    border-radius:12px;
    background: rgba(0,0,0,0.05);
    color:#111;
    font-size:13px;
  "></div>

  <!-- =====================================================================================
       MAIN COMMENT COMPOSER
       ===================================================================================== -->
  <div id="mainComposer" class="composer hidden">
    <textarea id="mainText" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>

    <div class="composer-actions">
      <button type="button" id="sendMainBtn">×©×œ×—</button>
      <button type="button" id="closeMainBtn">×‘×™×˜×•×œ</button>
    </div>

    <!-- extra UX (×©×“×¨×•×’) -->
    <div id="mainComposerHint" style="
      margin-top:8px;
      font-size:12px;
      opacity:0.75;
      line-height:1.5;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    ">
      <span>×˜×™×¤: ×ª×’×•×‘×” ×˜×•×‘×” ×”×™× ×§×¦×¨×”, ×‘×¨×•×¨×”, ×•××›×‘×“×ª.</span>
      <span id="mainCharCount">0/800</span>
    </div>
  </div>

  <!-- =====================================================================================
       OPEN MAIN COMPOSER BUTTON
       ===================================================================================== -->
  <button id="openMain" class="add-comment-btn" type="button">
    ×”×•×¡×£ ×ª×’×•×‘×”
  </button>

  <!-- =====================================================================================
       COMMENTS
       ===================================================================================== -->
  <section class="comments">
    <h3>×ª×’×•×‘×•×ª</h3>

    <!-- search inside comments (×©×“×¨×•×’, ×œ× ××‘×˜×œ ×›×œ×•×) -->
    <div style="
      display:flex;
      gap:10px;
      align-items:center;
      margin: 10px 0 12px 0;
      flex-wrap:wrap;
    ">
      <input id="commentSearch" type="search" placeholder="×—×™×¤×•×© ×‘×ª×’×•×‘×•×ª..."
        style="
          flex:1;
          min-width:180px;
          padding:10px 12px;
          border-radius:10px;
          border:1px solid rgba(0,0,0,0.15);
          outline:none;
          box-sizing:border-box;
        "
      />
      <select id="commentSort" style="
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(0,0,0,0.15);
        outline:none;
        background:#fff;
        cursor:pointer;
      ">
        <option value="newest">××™×•×Ÿ: ×”×—×“×©×•×ª ×œ××¢×œ×”</option>
        <option value="oldest">××™×•×Ÿ: ×”×™×©× ×•×ª ×œ××¢×œ×”</option>
        <option value="author">××™×•×Ÿ: ×œ×¤×™ ××—×‘×¨</option>
      </select>
    </div>

    <div id="comments">
      <div class="loader"></div>
    </div>

    <!-- load more (×©×“×¨×•×’ - ××•×¤×¦×™×•× ×œ×™) -->
    <div id="commentsFooter" style="
      margin-top:14px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    ">
      <button id="loadMoreComments" type="button" style="
        display:none;
        padding:10px 14px;
        border-radius:12px;
        border:1px solid rgba(0,0,0,0.15);
        background:#fff;
        cursor:pointer;
        font-weight:bold;
      ">×˜×¢×Ÿ ×¢×•×“ ×ª×’×•×‘×•×ª</button>
    </div>
  </section>

</main>

<script>
/* =========================================================================================
   âš ï¸ ××‘×˜×—×” â€“ ×©×™×˜×” ×œ× ××©×ª× ×”:
   1) ×—×¡×™××” ××™×™×“×™×ª ×‘×“×¤×“×¤×Ÿ ×¨×’×™×œ (AppInventor + getWebViewString)
   2) payload ××§×•×“×•×œ×¨ (email/password/token)
   3) Firebase Auth signInWithEmailAndPassword
   4) ××™××•×ª token ××•×œ sessions/{uid}/token
   ×¨×§ ××—×¨×™ ×–×”: ×©×œ×™×¤×•×ª DB + ×›×ª×™×‘×•×ª ×ª×’×•×‘×”/×ª×’×•×‘×”-×¢×œ-×ª×’×•×‘×”
   ========================================================================================= */

/* ===============================
   Helpers
   =============================== */
function escapeHTML(str = "") {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function safeText(str = "") {
  return String(str || "");
}

function userColor(key) {
  const colors = [
    "#60a5fa",
    "#34d399",
    "#f472b6",
    "#fbbf24",
    "#a78bfa",
    "#fb7185",
    "#22d3ee"
  ];
  let hash = 0;
  const s = String(key || "");
  for (let i = 0; i < s.length; i++) {
    hash = s.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

function fmtTime(ts) {
  try {
    return new Date(ts).toLocaleTimeString("he-IL", {
      hour: "2-digit",
      minute: "2-digit"
    });
  } catch {
    return "";
  }
}

function fmtDateTime(ts) {
  try {
    return new Date(ts).toLocaleString("he-IL", {
      day: "2-digit",
      month: "2-digit",
      hour: "2-digit",
      minute: "2-digit"
    });
  } catch {
    return "";
  }
}

function setStatus(msg, type = "info") {
  const bar = document.getElementById("statusBar");
  if (!bar) return;

  if (!msg) {
    bar.style.display = "none";
    bar.textContent = "";
    return;
  }

  bar.style.display = "block";
  bar.textContent = msg;

  if (type === "error") {
    bar.style.background = "rgba(255,0,0,0.08)";
    bar.style.color = "#8a0000";
  } else if (type === "ok") {
    bar.style.background = "rgba(0,128,0,0.08)";
    bar.style.color = "#0b5a0b";
  } else if (type === "warn") {
    bar.style.background = "rgba(255,165,0,0.10)";
    bar.style.color = "#7a4b00";
  } else {
    bar.style.background = "rgba(0,0,0,0.05)";
    bar.style.color = "#111";
  }
}

function debounce(fn, ms) {
  let t = null;
  return function (...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), ms);
  };
}

function clampTextLen(s, maxLen) {
  const x = safeText(s);
  if (x.length <= maxLen) return x;
  return x.slice(0, maxLen);
}

function nowTs() {
  return Date.now();
}

/* =========================================================================================
   ×”×¦×’×ª ×¤×•×¡×˜ ××”Ö¾sessionStorage (×× ×§×™×™×) â€“ ×˜×¢×™× ×” ××™×™×“×™×ª (×¤×™×¦'×¨ × ×©××¨)
   ========================================================================================= */
(function showCachedPostIfExists() {
  const cachedPost = sessionStorage.getItem("currentPost");
  if (!cachedPost) return;

  try {
    const p = JSON.parse(cachedPost);
    const host = document.getElementById("post");
    if (!host) return;

    host.innerHTML = `
      <div class="post">
        <h3>${escapeHTML(p.title || "")}</h3>
        <p>${escapeHTML(p.text || "")}</p>
        <small>×××ª: ${escapeHTML(p.author || "")}</small>
      </div>
    `;
  } catch (e) {
    sessionStorage.removeItem("currentPost");
  }
})();

/* =========================================================================================
   Main
   ========================================================================================= */
document.addEventListener("DOMContentLoaded", function () {

  /* ===============================
     DOM Elements
     =============================== */
  const postContainer = document.getElementById("post");
  const commentsBox = document.getElementById("comments");

  const openMainBtn = document.getElementById("openMain");
  const mainComposer = document.getElementById("mainComposer");
  const mainText = document.getElementById("mainText");
  const sendMainBtn = document.getElementById("sendMainBtn");
  const closeMainBtn = document.getElementById("closeMainBtn");
  const mainCharCount = document.getElementById("mainCharCount");

  const commentSearch = document.getElementById("commentSearch");
  const commentSort = document.getElementById("commentSort");
  const loadMoreCommentsBtn = document.getElementById("loadMoreComments");

  /* ===============================
     Guard
     =============================== */
  if (!postContainer || !commentsBox) {
    location.replace("forbidden.html");
    return;
  }

  /* ===============================
     PostId ×—×•×‘×”
     =============================== */
  const postId = new URLSearchParams(location.search).get("postId");
  if (!postId) {
    location.replace("forbidden.html");
    return;
  }

  /* =====================================================================================
     Global State (×œ××¡×š ×¤×•×¡×˜)
     ===================================================================================== */
  let payload = null;
  let uid = null;
  let username = "××©×ª××©";
  let isAuthed = false;

  // ×× ×™×¢×ª ×“××‘×œ-×©×œ×™×—×•×ª (×ª×’×•×‘×•×ª / replies)
  let mainSending = false;
  const replySendingMap = Object.create(null);

  // Comments cache (×œ××™×•×Ÿ/×—×™×¤×•×© ×‘×œ×™ ×œ×©×‘×•×¨ ×©×•× ×“×‘×¨)
  let commentsCache = [];
  let commentsRenderedHtml = "";
  let commentsLimit = 200;          // ×©×•××¨ ×›××• ×©×”×™×”
  let commentsPagingStep = 200;     // ×©×“×¨×•×’: "×˜×¢×Ÿ ×¢×•×“"
  let canLoadMore = false;

  // Live listeners (×©×“×¨×•×’)
  let liveCommentsRef = null;
  let liveCommentsAttached = false;

  // Replies UI cache
  const repliesOpenState = Object.create(null);          // id => boolean
  const repliesLiveRefs = Object.create(null);           // id => firebase ref
  const repliesLiveAttached = Object.create(null);       // id => boolean

  // Payload wait hard limit (××•× ×¢ "×˜×¢×™× ×” ××™× ×¡×•×¤×™×ª" ×‘-WebView ×ª×§×•×œ)
  const PAYLOAD_MAX_MS = 12000; // 12s
  const PAYLOAD_POLL_MS = 200;
  const payloadStartAt = nowTs();

  /* =====================================================================================
     Composer UX: ×¡×¤×™×¨×ª ×ª×•×•×™× (×©×“×¨×•×’)
     ===================================================================================== */
  const MAIN_MAX = 800;
  if (mainText && mainCharCount) {
    const updateCount = () => {
      const len = safeText(mainText.value).length;
      mainCharCount.textContent = `${len}/${MAIN_MAX}`;
    };
    mainText.addEventListener("input", updateCount);
    updateCount();
  }

  /* =====================================================================================
     Bind composer buttons (feature × ×©××¨)
     ===================================================================================== */
  openMainBtn.addEventListener("click", openMain);
  closeMainBtn.addEventListener("click", closeMain);
  sendMainBtn.addEventListener("click", sendMain);

  function openMain() {
    mainComposer.classList.remove("hidden");
    openMainBtn.style.display = "none";

    setTimeout(() => {
      try { mainText.focus(); } catch {}
      try {
        mainComposer.scrollIntoView({ behavior: "smooth", block: "center" });
      } catch {}
    }, 50);
  }

  function closeMain() {
    mainComposer.classList.add("hidden");
    openMainBtn.style.display = "block";
    mainText.value = "";
    if (mainCharCount) mainCharCount.textContent = `0/${MAIN_MAX}`;
  }

  /* =====================================================================================
     Search + Sort for comments (×©×“×¨×•×’ - ×œ× ××‘×˜×œ ×¤×™×¦'×¨)
     ===================================================================================== */
  if (commentSearch) {
    commentSearch.addEventListener("input", debounce(() => {
      renderCommentsFromCache();
    }, 120));
  }

  if (commentSort) {
    commentSort.addEventListener("change", () => {
      renderCommentsFromCache();
    });
  }

  if (loadMoreCommentsBtn) {
    loadMoreCommentsBtn.addEventListener("click", () => {
      commentsLimit += commentsPagingStep;
      setStatus("×˜×•×¢×Ÿ ×¢×•×“ ×ª×’×•×‘×•×ªâ€¦", "info");
      loadComments(false, true);
    });
  }

  /* =====================================================================================
     Auth Flow Start
     ===================================================================================== */
  waitForPayload();

  /* =====================================================================================
     1ï¸âƒ£ ×§×‘×œ×ª payload ××§×•×“×•×œ×¨
     - ×¢× Hard limit ×›×“×™ ×©×œ× ×™×”×™×• ×œ×•×¤×™× ××™× ×¡×•×¤×™×™×
     ===================================================================================== */
  function waitForPayload() {
    try {
      const elapsed = nowTs() - payloadStartAt;
      if (elapsed > PAYLOAD_MAX_MS) {
        // ×× ×”×’×¢× ×• ×œ×›××Ÿ ×•×¢×“×™×™×Ÿ ××™×Ÿ payload â€“ ××©×”×• ×œ× ×ª×§×™×Ÿ => ×—×¡×™××”
        location.replace("forbidden.html");
        return;
      }

      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, PAYLOAD_POLL_MS);

      payload = JSON.parse(raw);
    } catch (e) {
      return setTimeout(waitForPayload, PAYLOAD_POLL_MS);
    }

    login();
  }

  /* =====================================================================================
     2ï¸âƒ£ ×”×ª×—×‘×¨×•×ª Firebase
     ===================================================================================== */
  function login() {
    if (!payload || !payload.email || !payload.password || !payload.token) {
      location.replace("forbidden.html");
      return;
    }

    setStatus("××××ª ×”×ª×—×‘×¨×•×ªâ€¦", "info");

    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then((cred) => {
        uid = cred.user.uid;
        return validateToken(uid, payload.token);
      })
      .then(() => fetchUsername(uid))
      .then((name) => {
        username = name || "××©×ª××©";
        isAuthed = true;

        setStatus("××—×•×‘×¨ ×›Ö¾" + username, "ok");

        // ×˜×•×¢× ×™× ×¤×•×¡×˜ ×¨×§ ×× ××™×Ÿ cached
        if (!sessionStorage.getItem("currentPost")) {
          loadPost();
        } else {
          // ×¢×“×™×™×Ÿ × ×•×•×“× ×©×”×¤×•×¡×˜ ×§×™×™× (×©×“×¨×•×’: ×‘×“×™×§×” ×©×§×˜×”)
          verifyPostExistsSilently();
        }

        // ×ª×’×•×‘×•×ª
        loadComments(true, false);

        // Live comments (×©×“×¨×•×’)
        attachLiveComments();

      })
      .catch(() => {
        location.replace("forbidden.html");
      });
  }

  /* =====================================================================================
     3ï¸âƒ£ ××™××•×ª token
     ===================================================================================== */
  function validateToken(uid, token) {
    return firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then((snap) => {
        if (!snap.exists() || snap.val() !== token) {
          location.replace("forbidden.html");
          throw new Error("invalid token");
        }
      });
  }

  /* =====================================================================================
     4ï¸âƒ£ ×©×œ×™×¤×ª ×©× ××©×ª××©
     ===================================================================================== */
  function fetchUsername(uid) {
    return firebase.database()
      .ref("users/" + uid + "/username")
      .once("value")
      .then((snap) => snap.val());
  }

  /* =====================================================================================
     5ï¸âƒ£ ×˜×¢×™× ×ª ×¤×•×¡×˜ ×Ö¾DB (fallback)
     ===================================================================================== */
  function loadPost() {
    setStatus("×˜×•×¢×Ÿ ×¤×•×¡×˜â€¦", "info");

    firebase.database()
      .ref("posts/" + postId)
      .once("value")
      .then((snap) => {
        if (!snap.exists()) {
          postContainer.innerHTML = "<p>×”×¤×•×¡×˜ ×œ× × ××¦×.</p>";
          setStatus("×”×¤×•×¡×˜ ×œ× × ××¦×.", "error");
          return;
        }

        const p = snap.val() || {};

        postContainer.innerHTML = `
          <div class="post">
            <h3>${escapeHTML(p.title || "")}</h3>
            <p>${escapeHTML(p.text || "")}</p>
            <small>×××ª: ${escapeHTML(p.author || "")}</small>
            <small style="opacity:.75; margin-top:6px; display:block;">
              ${escapeHTML(fmtDateTime(p.time || 0))}
            </small>
            <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
              <button type="button" class="post-action" data-action="copyLink"
                style="padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff;cursor:pointer;">
                ×”×¢×ª×§ ×§×™×©×•×¨
              </button>
              <button type="button" class="post-action" data-action="share"
                style="padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff;cursor:pointer;">
                ×©×ª×£
              </button>
              <button type="button" class="post-action" data-action="report"
                style="padding:8px 10px;border-radius:10px;border:1px solid rgba(255,0,0,0.35);background:rgba(255,0,0,0.06);cursor:pointer;">
                ×“×•×•×—
              </button>
            </div>
          </div>
        `;

        // bind actions (event delegation ×¢×œ ×”×¤×•×¡×˜)
        bindPostActions();

        setStatus("×¤×•×¡×˜ × ×˜×¢×Ÿ.", "ok");
      })
      .catch(() => {
        postContainer.innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×•×¡×˜.</p>";
        setStatus("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×¤×•×¡×˜.", "error");
      });
  }

  function verifyPostExistsSilently() {
    firebase.database()
      .ref("posts/" + postId)
      .once("value")
      .then((snap) => {
        if (!snap.exists()) {
          postContainer.innerHTML = "<p>×”×¤×•×¡×˜ ×œ× × ××¦×.</p>";
          setStatus("×”×¤×•×¡×˜ ×œ× × ××¦×.", "error");
        } else {
          bindPostActions();
        }
      })
      .catch(() => {});
  }

  /* =====================================================================================
     Post action buttons (×©×“×¨×•×’)
     ===================================================================================== */
  function bindPostActions() {
    // ××œ ×ª×—×‘×¨ ×¤×¢××™×™×
    if (postContainer.__actionsBound) return;
    postContainer.__actionsBound = true;

    postContainer.addEventListener("click", (e) => {
      const btn = e.target.closest(".post-action");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      if (!action) return;

      if (action === "copyLink") {
        const link = location.href;
        copyToClipboard(link);
        setStatus("×”×§×™×©×•×¨ ×”×•×¢×ª×§.", "ok");
      }

      if (action === "share") {
        // ×‘-WebView ×œ×¤×¢××™× ××™×Ÿ Web Share API, ××– × ×•×¤×œ×™× ×œ×”×¢×ª×§×”
        const link = location.href;
        tryShareOrCopy(link);
      }

      if (action === "report") {
        reportPost();
      }
    }, false);
  }

  function copyToClipboard(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text);
        return;
      }
    } catch {}
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.opacity = "0";
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand("copy"); } catch {}
    document.body.removeChild(ta);
  }

  function tryShareOrCopy(text) {
    try {
      if (navigator.share) {
        navigator.share({ title: "×¤×•×¨×•×", text: "×§×™×©×•×¨ ×œ×¤×•×¡×˜:", url: text })
          .then(() => setStatus("×©×•×ª×£.", "ok"))
          .catch(() => {
            copyToClipboard(text);
            setStatus("××™×Ÿ ×©×™×ª×•×£ ××•×‘× ×”. ×”×¢×ª×§×ª×™ ×§×™×©×•×¨.", "ok");
          });
      } else {
        copyToClipboard(text);
        setStatus("××™×Ÿ ×©×™×ª×•×£ ××•×‘× ×”. ×”×¢×ª×§×ª×™ ×§×™×©×•×¨.", "ok");
      }
    } catch {
      copyToClipboard(text);
      setStatus("×”×•×¢×ª×§ ×§×™×©×•×¨.", "ok");
    }
  }

  /* =====================================================================================
     Report post (×©×“×¨×•×’)
     - ×œ× ××•×—×§, ×œ× ×¤×•×’×¢ ×‘××‘×˜×—×”
     - ×¨×§ ×›×•×ª×‘ ×œ× ×ª×™×‘ reports/...
     ===================================================================================== */
  function reportPost() {
    if (!isAuthed || !uid) {
      setStatus("×œ× ×××•××ª. ×œ× × ×™×ª×Ÿ ×œ×“×•×•×—.", "error");
      return;
    }

    const reportObj = {
      type: "post",
      postId: postId,
      reporterUid: uid,
      reporterName: username,
      time: nowTs(),
      reason: "report"
    };

    firebase.database()
      .ref("reports")
      .push(reportObj)
      .then(() => setStatus("×“×•×•×— ×‘×”×¦×œ×—×”. ×ª×•×“×”.", "ok"))
      .catch(() => setStatus("×©×’×™××” ×‘×“×™×•×•×—.", "error"));
  }

  /* =====================================================================================
     6ï¸âƒ£ ×˜×¢×™× ×ª ×ª×’×•×‘×•×ª (×¢× cache + ×©×“×¨×•×’×™×)
     - ×œ× ××‘×˜×œ ×›×œ×•×: ×¢×“×™×™×Ÿ ×§×•×¨× comments/{postId}
     - ×¢×“×™×™×Ÿ limitToLast(200) ×›×‘×¨×™×¨×ª ××—×“×œ
     - ×©×“×¨×•×’: ××¤×©×¨ ×˜×¢×Ÿ ×¢×•×“
     ===================================================================================== */
  function loadComments(isFirst = false, isLoadMore = false) {
    if (!isAuthed) return;

    if (isFirst) {
      commentsBox.innerHTML = "<div class='loader'></div>";
    }

    const limit = Math.max(1, Number(commentsLimit || 200));

    firebase.database()
      .ref("comments/" + postId)
      .orderByChild("time")
      .limitToLast(limit)
      .once("value")
      .then((snap) => {
        const items = [];
        snap.forEach((cSnap) => {
          const v = cSnap.val() || {};
          items.push({
            id: cSnap.key,
            text: safeText(v.text),
            author: safeText(v.author),
            time: Number(v.time || 0)
          });
        });

        // ×”×× ×™×© ×¢×•×“? (×§×™×¨×•×‘ â€“ ×× ×§×™×‘×œ× ×• limit ×‘×“×™×•×§, × ×¦×™×’ ×›×¤×ª×•×¨)
        canLoadMore = items.length >= limit;
        if (loadMoreCommentsBtn) {
          loadMoreCommentsBtn.style.display = canLoadMore ? "inline-block" : "none";
        }

        commentsCache = items;

        // ×¨×™× ×“×•×¨ ×—×›× (×¢× ×—×™×¤×•×©/××™×•×Ÿ)
        renderCommentsFromCache();

        if (isLoadMore) {
          setStatus("× ×˜×¢× ×• ×¢×•×“ ×ª×’×•×‘×•×ª.", "ok");
        } else if (isFirst) {
          setStatus("×ª×’×•×‘×•×ª × ×˜×¢× ×•.", "ok");
        }
      })
      .catch(() => {
        commentsBox.innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×•×‘×•×ª.</p>";
        setStatus("×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×•×‘×•×ª.", "error");
      });
  }

  /* =====================================================================================
     Render comments from cache (×—×™×¤×•×© + ××™×•×Ÿ)
     ===================================================================================== */
  function renderCommentsFromCache() {
    const q = safeText(commentSearch?.value).trim().toLowerCase();
    const mode = safeText(commentSort?.value) || "newest";

    let list = commentsCache.slice();

    // ×—×™×¤×•×©
    if (q) {
      list = list.filter((c) => {
        const t = (c.text || "").toLowerCase();
        const a = (c.author || "").toLowerCase();
        return t.includes(q) || a.includes(q);
      });
    }

    // ××™×•×Ÿ
    if (mode === "oldest") {
      list.sort((a, b) => (a.time || 0) - (b.time || 0));
    } else if (mode === "author") {
      list.sort((a, b) => (a.author || "").localeCompare(b.author || "", "he"));
    } else {
      list.sort((a, b) => (b.time || 0) - (a.time || 0));
    }

    // HTML
    if (list.length === 0) {
      commentsBox.innerHTML = q ? "<p>×œ× × ××¦××• ×ª×•×¦××•×ª.</p>" : "<p>××™×Ÿ ×ª×’×•×‘×•×ª ×¢×“×™×™×Ÿ.</p>";
      commentsRenderedHtml = commentsBox.innerHTML;
      return;
    }

    commentsBox.innerHTML = "";
    for (const c of list) {
      renderComment(c.id, c);
    }

    commentsRenderedHtml = commentsBox.innerHTML;
  }

  /* =====================================================================================
     7ï¸âƒ£ Render single comment (×›×•×œ×œ replies feature = × ×©××¨)
     - ×ª×™×§×•×Ÿ ×§×¨×™×˜×™: ×‘×œ×™ onclick inline ×›×‘×¡×™×¡; ××‘×œ ×›×“×™ "×œ× ×œ×•×•×ª×¨ ×¢×œ ×¤×™×¦'×¨"
       × ×©××™×¨ ×’× window.* ×¤×•× ×§×¦×™×•×ª ×›×ª××™××•×ª, ×•×’× × ×•×¡×™×£ Event Delegation ×™×¦×™×‘.
     ===================================================================================== */
  function renderComment(id, c) {
    const color = userColor(c.author);

    const div = document.createElement("div");
    div.className = "comment";
    div.style.borderRightColor = color;
    div.setAttribute("data-comment-id", id);

    div.innerHTML = `
      <div class="comment-meta">
        <span class="comment-author">${escapeHTML(c.author || "")}</span>
        <span class="comment-time">${escapeHTML(fmtTime(c.time || 0))}</span>
      </div>

      <p>${escapeHTML(c.text || "")}</p>

      <!-- =========================
           Comment actions (×©×“×¨×•×’)
           ========================= -->
      <div class="comment-actions" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button type="button" class="btn-reply" data-action="openReply" data-id="${escapeHTML(id)}">×”×©×‘</button>

        <span class="reply-count"
              id="reply-count-${escapeHTML(id)}"
              data-action="toggleReplies"
              data-id="${escapeHTML(id)}"
              style="cursor:pointer; user-select:none;">
          ×˜×•×¢×Ÿ ×ª×’×•×‘×•×ªâ€¦
        </span>

        <button type="button"
                class="btn-copy"
                data-action="copyComment"
                data-id="${escapeHTML(id)}"
                style="padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff;cursor:pointer;">
          ×”×¢×ª×§
        </button>

        <button type="button"
                class="btn-report"
                data-action="reportComment"
                data-id="${escapeHTML(id)}"
                style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,0,0,0.35);background:rgba(255,0,0,0.06);cursor:pointer;">
          ×“×•×•×—
        </button>
      </div>

      <!-- =========================
           Replies container
           ========================= -->
      <div class="replies hidden" id="replies-${escapeHTML(id)}"></div>
    `;

    commentsBox.appendChild(div);

    // ×ª×©××™×¨: ×¨×¢× ×•×Ÿ ××•× ×” ×ª×’×•×‘×•×ª (×¤×™×¦'×¨ × ×©××¨)
    updateReplyCount(id);
  }

  /* =====================================================================================
     Delegation for comment actions (××•× ×¢ ×‘××’×™×, ×™×¦×™×‘ ×‘-WebView)
     ===================================================================================== */
  (function bindCommentDelegation() {
    if (commentsBox.__delegationBound) return;
    commentsBox.__delegationBound = true;

    commentsBox.addEventListener("click", (e) => {
      const el = e.target.closest("[data-action]");
      if (!el) return;

      const action = el.getAttribute("data-action");
      const id = el.getAttribute("data-id");
      if (!action || !id) return;

      if (action === "openReply") {
        openReply(id);
      }

      if (action === "toggleReplies") {
        toggleReplies(id);
      }

      if (action === "copyComment") {
        const commentNode = el.closest(".comment");
        const textNode = commentNode ? commentNode.querySelector("p") : null;
        const txt = textNode ? textNode.innerText : "";
        copyToClipboard(txt);
        setStatus("×”×ª×’×•×‘×” ×”×•×¢×ª×§×”.", "ok");
      }

      if (action === "reportComment") {
        reportComment(id);
      }
    }, false);
  })();

  /* =====================================================================================
     Replies feature â€“ × ×©××¨ + ××©×•×“×¨×’
     ===================================================================================== */

  // ×ª××™××•×ª ×œ×¤×•× ×§×¦×™×•×ª ×’×œ×•×‘×œ×™×•×ª ×©×”×™×• ×‘×§×•×“ ×©×œ×š (×œ× ××•×¨×™×“ ×¤×™×¦'×¨)
  window.updateReplyCount = updateReplyCount;
  window.toggleReplies = toggleReplies;
  window.openReply = openReply;
  window.sendReply = sendReply;

  function updateReplyCount(id) {
    if (!isAuthed) return;

    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .once("value")
      .then((s) => {
        const el = document.getElementById("reply-count-" + id);
        if (!el) return;
        const count = s.numChildren();
        el.textContent = count ? `${count} ×ª×’×•×‘×•×ª â–¾` : "××™×Ÿ ×ª×’×•×‘×•×ª";
      })
      .catch(() => {});
  }

  function toggleReplies(id) {
    const box = document.getElementById("replies-" + id);
    if (!box) return;

    const isOpen = !box.classList.contains("hidden");

    if (isOpen) {
      box.classList.add("hidden");
      repliesOpenState[id] = false;
      detachRepliesLive(id); // ×©×“×¨×•×’: ×œ× ×œ×”×©××™×¨ ×××–×™× ×™× ×¤×ª×•×—×™×
      return;
    }

    // ×¤×•×ª×—×™×
    box.classList.remove("hidden");
    repliesOpenState[id] = true;

    // ×˜×•×¢× ×™×
    box.innerHTML = "<div class='loader'></div>";

    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .orderByChild("time")
      .limitToLast(200)
      .once("value")
      .then((s) => {
        let html = "";

        if (!s.exists()) {
          html = `
            <div style="padding:10px 0; opacity:.75;">
              ××™×Ÿ ×ª×’×•×‘×•×ª ×¢×“×™×™×Ÿ. ×ª×”×™×” ×”×¨××©×•×Ÿ.
            </div>
          `;
        } else {
          const arr = [];
          s.forEach((r) => {
            const d = r.val() || {};
            arr.push({
              rid: r.key,
              author: safeText(d.author),
              text: safeText(d.text),
              time: Number(d.time || 0)
            });
          });

          // ×¡×“×¨: ×™×©× ×•×ª ×œ××¢×œ×” ×‘×ª×•×š replies (×§×¨×™× ×™×•×ª×¨)
          arr.sort((a, b) => (a.time || 0) - (b.time || 0));

          for (const d of arr) {
            html += buildReplyHTML(id, d);
          }
        }

        // ×§×•××¤×•×–×¨ reply ×œ××˜×” (×©×“×¨×•×’)
        html += buildReplyComposerHTML(id);

        box.innerHTML = html;

        // ×©×“×¨×•×’: Live replies ×¨×§ ×›×©×¤×ª×•×—
        attachRepliesLive(id);

        // ×¢×“×›×•×Ÿ ××•× ×”
        updateReplyCount(id);
      })
      .catch(() => {
        box.innerHTML = "<p>×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×’×•×‘×•×ª-×¢×œ-×ª×’×•×‘×”.</p>";
      });
  }

  function buildReplyHTML(commentId, d) {
    const c = userColor(d.author);

    return `
      <div class="reply" data-reply-id="${escapeHTML(d.rid || "")}" style="
        border-right: 4px solid ${escapeHTML(c)};
        padding:10px 10px;
        margin:10px 0;
        border-radius:10px;
        background: rgba(0,0,0,0.03);
      ">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <b>${escapeHTML(d.author || "")}</b>
          <small style="opacity:.75;">${escapeHTML(fmtTime(d.time || 0))}</small>
        </div>
        <p style="margin:8px 0 0 0;">${escapeHTML(d.text || "")}</p>

        <div style="margin-top:8px; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button"
                  data-reply-action="copyReply"
                  data-comment-id="${escapeHTML(commentId)}"
                  data-reply-id="${escapeHTML(d.rid || "")}"
                  style="padding:6px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff;cursor:pointer;">
            ×”×¢×ª×§
          </button>

          <button type="button"
                  data-reply-action="reportReply"
                  data-comment-id="${escapeHTML(commentId)}"
                  data-reply-id="${escapeHTML(d.rid || "")}"
                  style="padding:6px 10px;border-radius:10px;border:1px solid rgba(255,0,0,0.35);background:rgba(255,0,0,0.06);cursor:pointer;">
            ×“×•×•×—
          </button>
        </div>
      </div>
    `;
  }

  function buildReplyComposerHTML(commentId) {
    // ×§×•××¤×•×–×¨ ××©×•×“×¨×’ â€“ × ×©××¨ ×¤×™×¦'×¨ "openReply" ×”××§×•×¨×™, ××‘×œ ×’× ×ª××™×“ ×™×© ×ª×—×ª ×”×¨×©×™××”
    return `
      <div class="reply-composer" style="
        margin-top:12px;
        padding:12px;
        border-radius:12px;
        border:1px solid rgba(0,0,0,0.10);
        background:#fff;
      ">
        <div style="font-weight:bold; margin-bottom:8px;">×”×•×¡×£ ×ª×’×•×‘×” ×œ×ª×’×•×‘×”</div>

        <textarea id="reply-text-${escapeHTML(commentId)}"
                  placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."
                  maxlength="600"
                  rows="3"
                  style="
                    width:100%;
                    box-sizing:border-box;
                    padding:10px 12px;
                    border-radius:10px;
                    border:1px solid rgba(0,0,0,0.15);
                    outline:none;
                    resize:vertical;
                  "></textarea>

        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
          <small style="opacity:.75;">××§×¡×™××•× 600 ×ª×•×•×™×.</small>
          <div style="display:flex; gap:10px;">
            <button type="button"
                    class="reply-send-btn"
                    data-reply-action="sendReply"
                    data-id="${escapeHTML(commentId)}"
                    style="
                      padding:8px 12px;
                      border-radius:10px;
                      border:none;
                      background: rgb(17,17,87);
                      color:#fff;
                      cursor:pointer;
                      font-weight:bold;
                    ">×©×œ×—</button>
            <button type="button"
                    class="reply-close-btn"
                    data-reply-action="closeReplies"
                    data-id="${escapeHTML(commentId)}"
                    style="
                      padding:8px 12px;
                      border-radius:10px;
                      border:1px solid rgba(0,0,0,0.15);
                      background:#fff;
                      cursor:pointer;
                      font-weight:bold;
                    ">×¡×’×•×¨</button>
          </div>
        </div>

        <div id="reply-error-${escapeHTML(commentId)}" style="
          display:none;
          margin-top:10px;
          padding:10px 12px;
          border-radius:12px;
          background: rgba(255,0,0,0.08);
          color:#8a0000;
          font-size:13px;
        "></div>
      </div>
    `;
  }

  // Delegation ×‘×ª×•×š replies containers (×©×“×¨×•×’ ×™×¦×™×‘×•×ª)
  (function bindRepliesDelegation() {
    if (commentsBox.__repliesDelegationBound) return;
    commentsBox.__repliesDelegationBound = true;

    commentsBox.addEventListener("click", (e) => {
      const a = e.target.closest("[data-reply-action]");
      if (!a) return;

      const act = a.getAttribute("data-reply-action");
      const cid = a.getAttribute("data-id") || a.getAttribute("data-comment-id");
      const rid = a.getAttribute("data-reply-id");

      if (!act || !cid) return;

      if (act === "sendReply") {
        sendReply(cid);
      }

      if (act === "closeReplies") {
        // ×¡×’×™×¨×” ×›××• toggle
        toggleReplies(cid);
      }

      if (act === "copyReply") {
        const replyNode = a.closest(".reply");
        const p = replyNode ? replyNode.querySelector("p") : null;
        const txt = p ? p.innerText : "";
        copyToClipboard(txt);
        setStatus("×”×ª×’×•×‘×”-×¢×œ-×ª×’×•×‘×” ×”×•×¢×ª×§×”.", "ok");
      }

      if (act === "reportReply") {
        if (!rid) return;
        reportReply(cid, rid);
      }
    }, false);
  })();

  function openReply(id) {
    // ×ª××™××•×ª: ×‘×§×•×“ ×”××§×•×¨×™ openReply ×”×—×œ×™×£ ××ª ×ª×•×›×Ÿ ×”×ª×™×‘×”
    // ×›××Ÿ ×× ×—× ×• ××©×“×¨×’×™×: ×¤×©×•×˜ ××‘×˜×™×—×™× ×©×”×¨×©×™××” ×¤×ª×•×—×” + ×¤×•×§×•×¡ ×œ×˜×§×¡×˜××¨×™×”
    const box = document.getElementById("replies-" + id);
    if (!box) return;

    if (box.classList.contains("hidden")) {
      toggleReplies(id);
      // toggleReplies ×›×‘×¨ ×™×‘× ×” composer
      setTimeout(() => {
        const ta = document.getElementById("reply-text-" + id);
        try { ta && ta.focus(); } catch {}
      }, 150);
      return;
    }

    // ×× ×¤×ª×•×— â€“ ×¨×§ ×¤×•×§×•×¡
    const ta = document.getElementById("reply-text-" + id);
    try { ta && ta.focus(); } catch {}
  }

  function replyErrorShow(commentId, msg) {
    const el = document.getElementById("reply-error-" + commentId);
    if (!el) return;
    el.textContent = msg;
    el.style.display = "block";
  }

  function replyErrorHide(commentId) {
    const el = document.getElementById("reply-error-" + commentId);
    if (!el) return;
    el.textContent = "";
    el.style.display = "none";
  }

  function sendReply(id) {
    if (!isAuthed) return;

    const ta = document.getElementById("reply-text-" + id);
    if (!ta) return;

    replyErrorHide(id);

    const raw = safeText(ta.value).trim();
    if (!raw) return;

    // ×× ×™×¢×ª ×“××‘×œ-×©×œ×™×—×” ×œ-reply ×¡×¤×¦×™×¤×™
    if (replySendingMap[id]) return;
    replySendingMap[id] = true;

    const text = clampTextLen(raw, 600);

    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .push({
        text: text,
        author: username,
        time: nowTs()
      })
      .then(() => {
        ta.value = "";
        updateReplyCount(id);

        // ×× ×¤×ª×•×— â€“ × ×¨×¢× ×Ÿ ×¨×§ ××ª ×”×ª×™×‘×” ×‘×œ×™ ×œ×©×‘×•×¨
        // (Live listeners ×’× ×™×›× ×™×¡×•, ××‘×œ ×–×” × ×•×ª×Ÿ ×ª×’×•×‘×” ××™×™×“×™×ª)
        if (repliesOpenState[id]) {
          toggleReplies(id);
          // ×œ×¤×ª×•×— ×©×•×‘ ××—×¨×™ ×¨×¢× ×•×Ÿ (×›×“×™ ×œ×”×¦×™×’ ×¨×©×™××” + ×§×•××¤×•×–×¨ × ×§×™)
          setTimeout(() => toggleReplies(id), 50);
        }
      })
      .catch(() => {
        replyErrorShow(id, "×©×’×™××” ×‘×©×œ×™×—×”. × ×¡×” ×©×•×‘.");
      })
      .finally(() => {
        replySendingMap[id] = false;
      });
  }

  /* =====================================================================================
     Report comment / reply (×©×“×¨×•×’)
     ===================================================================================== */
  function reportComment(commentId) {
    if (!isAuthed || !uid) {
      setStatus("×œ× ×××•××ª. ×œ× × ×™×ª×Ÿ ×œ×“×•×•×—.", "error");
      return;
    }

    firebase.database()
      .ref("reports")
      .push({
        type: "comment",
        postId: postId,
        commentId: commentId,
        reporterUid: uid,
        reporterName: username,
        time: nowTs(),
        reason: "report"
      })
      .then(() => setStatus("×“×•×•×— ×‘×”×¦×œ×—×”.", "ok"))
      .catch(() => setStatus("×©×’×™××” ×‘×“×™×•×•×—.", "error"));
  }

  function reportReply(commentId, replyId) {
    if (!isAuthed || !uid) {
      setStatus("×œ× ×××•××ª. ×œ× × ×™×ª×Ÿ ×œ×“×•×•×—.", "error");
      return;
    }

    firebase.database()
      .ref("reports")
      .push({
        type: "reply",
        postId: postId,
        commentId: commentId,
        replyId: replyId,
        reporterUid: uid,
        reporterName: username,
        time: nowTs(),
        reason: "report"
      })
      .then(() => setStatus("×“×•×•×— ×‘×”×¦×œ×—×”.", "ok"))
      .catch(() => setStatus("×©×’×™××” ×‘×“×™×•×•×—.", "error"));
  }

  /* =====================================================================================
     Main comment send (×¤×™×¦'×¨ × ×©××¨ + ×ª×™×§×•× ×™×)
     ===================================================================================== */
  function sendMain() {
    if (!isAuthed) return;

    const raw = safeText(mainText.value).trim();
    if (!raw) return;

    // ×× ×™×¢×ª ×“××‘×œ-×©×œ×™×—×”
    if (mainSending) return;
    mainSending = true;

    sendMainBtn.disabled = true;

    const text = clampTextLen(raw, MAIN_MAX);

    firebase.database()
      .ref("comments/" + postId)
      .push({
        text: text,
        author: username,
        time: nowTs()
      })
      .then(() => {
        closeMain();
        // ×œ× ×—×•×‘×” reload ××œ× (×™×© live), ××‘×œ × ×©××™×¨ ×’× ×–×” ×œ×™×¦×™×‘×•×ª
        loadComments(false, false);
        setStatus("×ª×’×•×‘×” × ×©×œ×—×”.", "ok");
      })
      .catch(() => {
        setStatus("×©×’×™××” ×‘×©×œ×™×—×ª ×ª×’×•×‘×”.", "error");
      })
      .finally(() => {
        mainSending = false;
        sendMainBtn.disabled = false;
      });
  }

  /* =====================================================================================
     Live comments (×©×“×¨×•×’)
     - ×œ× ××‘×˜×œ ××ª loadComments
     - ×¨×§ ××•×¡×™×£ ×ª×’×•×‘×” ×‘×–××Ÿ ×××ª
     ===================================================================================== */
  function attachLiveComments() {
    if (liveCommentsAttached) return;
    liveCommentsAttached = true;

    liveCommentsRef = firebase.database()
      .ref("comments/" + postId)
      .orderByChild("time")
      .limitToLast(50);

    // New comment
    liveCommentsRef.on("child_added", (snap) => {
      const id = snap.key;
      const v = snap.val() || {};

      // ×× ×›×‘×¨ ×§×™×™× ×‘×§××© â€“ ×œ× ×œ×”×•×¡×™×£ ×›×¤×•×œ
      if (commentsCache.some((x) => x.id === id)) return;

      commentsCache.push({
        id,
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || 0)
      });

      // ×¨×™× ×“×•×¨ ××—×“×© (×™×›×‘×“ ×—×™×¤×•×©/××™×•×Ÿ)
      renderCommentsFromCache();
    });

    // Changed comment (×œ×©×™× ×•×™×™× ×¢×ª×™×“×™×™×)
    liveCommentsRef.on("child_changed", (snap) => {
      const id = snap.key;
      const v = snap.val() || {};

      const idx = commentsCache.findIndex((x) => x.id === id);
      if (idx === -1) return;

      commentsCache[idx] = {
        ...commentsCache[idx],
        text: safeText(v.text),
        author: safeText(v.author),
        time: Number(v.time || commentsCache[idx].time || 0)
      };

      renderCommentsFromCache();
    });
  }

  /* =====================================================================================
     Live replies (×¨×§ ×›×©×”×ª×™×‘×” ×¤×ª×•×—×”) â€“ ×©×“×¨×•×’
     ===================================================================================== */
  function attachRepliesLive(commentId) {
    if (repliesLiveAttached[commentId]) return;
    repliesLiveAttached[commentId] = true;

    const ref = firebase.database()
      .ref("replies/" + postId + "/" + commentId)
      .orderByChild("time")
      .limitToLast(25);

    repliesLiveRefs[commentId] = ref;

    ref.on("child_added", (snap) => {
      // ×× ×”×ª×™×‘×” × ×¡×’×¨×” ×‘×™× ×ª×™×™× â€“ ×œ× ×œ×¢×‘×•×“
      if (!repliesOpenState[commentId]) return;

      // × ×¨×¢× ×Ÿ ×¨×§ ××•× ×” (×”×›×™ ×—×©×•×‘)
      updateReplyCount(commentId);
      // ×•××ª ×”×ª×™×‘×” â€“ × ×¢×“×›×Ÿ ×‘×¦×•×¨×” ×‘×˜×•×—×”
      // ×›×“×™ ×œ×”×™×× ×¢ ××¤×™×¦×•×¦×™× ×©×œ DOM: ×¤×©×•×˜ × ×‘×¦×¢ toggle ×¨×¢× ×•×Ÿ ×§×œ
      const box = document.getElementById("replies-" + commentId);
      if (!box) return;

      // ×× ×‘×“×™×•×§ ×™×© loader / ××• ×©×”××©×ª××© ×‘×××¦×¢ ×›×ª×™×‘×”, ×œ× × ×˜×¨×™×“ ×™×•×ª×¨ ××“×™
      // × ×‘×¦×¢ ×¨×¢× ×•×Ÿ ×¢×“×™×Ÿ: ×× ××™×Ÿ textarea ×××•×§×“ ×›×¨×’×¢
      const active = document.activeElement;
      const isTypingHere = active && active.id === ("reply-text-" + commentId);
      if (isTypingHere) return;

      // ×¨×¢× ×•×Ÿ: ×œ×¡×’×•×¨ ×•×œ×¤×ª×•×— (××™×™×¦×¨ ×¨×©×™××” × ×§×™×™×”)
      try {
        box.classList.add("hidden");
        repliesOpenState[commentId] = false;
        toggleReplies(commentId);
      } catch {}
    });
  }

  function detachRepliesLive(commentId) {
    try {
      const ref = repliesLiveRefs[commentId];
      if (ref) ref.off();
    } catch {}
    repliesLiveRefs[commentId] = null;
    repliesLiveAttached[commentId] = false;
  }

  /* =====================================================================================
     Cleanup on unload (×©×“×¨×•×’ ×™×¦×™×‘×•×ª)
     ===================================================================================== */
  window.addEventListener("beforeunload", () => {
    try {
      if (liveCommentsRef) liveCommentsRef.off();
    } catch {}
    liveCommentsAttached = false;

    // replies listeners
    for (const k in repliesLiveRefs) {
      try {
        if (repliesLiveRefs[k]) repliesLiveRefs[k].off();
      } catch {}
    }
  });

  /* =====================================================================================
     FUTURE HOOKS (×©××•×¨×™× ×œ×©×“×¨×•×’×™× ×¢×ª×™×“×™×™× ×‘×œ×™ ×œ×©×‘×•×¨ ×›×œ×•×)
     ===================================================================================== */

  // 1) Like comment / reply (placeholder)
  // function likeComment(commentId) {}

  // 2) Edit own comment (placeholder)
  // function editComment(commentId, newText) {}

  // 3) Admin moderation tools (placeholder)
  // function deleteComment(commentId) {}

  // 4) Mention system (placeholder)
  // function parseMentions(text) {}

  // 5) Notifications (placeholder)
  // function notifyOnReply(commentId) {}

});
</script>

</body>
</html>