<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בפוסט</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
  <link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>צפייה בפוסט</h1>
</header>

<!-- Pull to refresh -->
<div id="pull-indicator">
  <div class="loader"></div>
</div>

<main class="forum-container">

  <!-- פוסט -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <!-- תגובות -->
  <section class="comments">

    <h3>תגובות</h3>

    <div id="comments">
      <div class="loader"></div>
    </div>

    <!-- כפתור הוספת תגובה -->
    <button id="openComment" class="add-comment-btn">
      הוסף תגובה
    </button>

    <!-- טופס תגובה -->
    <div id="commentBox" class="comment-box hidden">
      <textarea id="commentText" placeholder="כתוב תגובה..."></textarea>
      <div class="comment-actions">
        <button id="sendComment">שלח</button>
        <button id="cancelComment">ביטול</button>
      </div>
    </div>

  </section>

</main>

<script>
/* חסימה מיידית */
(function () {
  try {
    if (!window.AppInventor) location.replace("forbidden.html");
  } catch (e) {
    location.replace("forbidden.html");
  }
})();

document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let isRefreshing = false;

  const params = new URLSearchParams(location.search);
  const postId = params.get("postId");
  if (!postId) location.replace("forbidden.html");

  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch {
      return setTimeout(waitForPayload, 200);
    }
    login();
  }

  waitForPayload();

  function login() {
    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then(c => validate(c.user.uid, payload.token))
      .catch(() => location.replace("forbidden.html"));
  }

  function validate(uid, token) {
    firebase.database().ref("sessions/" + uid + "/token")
      .once("value")
      .then(snap => {
        if (!snap.exists() || snap.val() !== token)
          location.replace("forbidden.html");
        loadPost();
        loadComments();
      });
  }

  function loadPost() {
    firebase.database().ref("posts/" + postId)
      .once("value")
      .then(snap => {
        const p = snap.val();
        document.getElementById("post").innerHTML = `
          <div class="post">
            <h3>${p.title}</h3>
            <p>${p.text}</p>
            <small>מאת: ${p.author}</small>
          </div>
        `;
      });
  }

  function loadComments() {
    firebase.database().ref("comments/" + postId)
      .once("value")
      .then(snap => {
        let html = "";
        snap.forEach(cSnap => {
          const c = cSnap.val();
          const d = new Date(c.time);
          const t = d.getHours().toString().padStart(2,"0") + ":" +
                    d.getMinutes().toString().padStart(2,"0");
          html += `
            <div class="comment">
              <div class="comment-meta">
                <span class="comment-author">${c.author}</span>
                <span class="comment-time">${t}</span>
              </div>
              <p>${c.text}</p>
            </div>
          `;
        });
        document.getElementById("comments").innerHTML =
          html || "<p>אין תגובות עדיין.</p>";
      });
  }

  /* פתיחת טופס תגובה */
  const openBtn = document.getElementById("openComment");
  const box = document.getElementById("commentBox");
  const textarea = document.getElementById("commentText");

  openBtn.onclick = () => {
    box.classList.remove("hidden");
    openBtn.style.display = "none";
    setTimeout(() => {
      textarea.focus();
      textarea.scrollIntoView({ behavior: "smooth", block: "center" });
    }, 300);
  };

  document.getElementById("cancelComment").onclick = () => {
    box.classList.add("hidden");
    openBtn.style.display = "block";
    textarea.value = "";
  };

  document.getElementById("sendComment").onclick = () => {
    const text = textarea.value.trim();
    if (!text) return;

    firebase.database().ref("comments/" + postId).push({
      text,
      author: payload.username,
      time: Date.now()
    }).then(() => {
      textarea.value = "";
      box.classList.add("hidden");
      openBtn.style.display = "block";
      loadComments();
    });
  };

});
</script>

</body>
</html>