<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בפוסט</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
  <link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>צפייה בפוסט</h1>
</header>

<main class="forum-container">

  <!-- פוסט -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <!-- קומפוזר תגובה -->
  <div id="commentComposer" class="comment-composer hidden">
    <textarea id="commentText" placeholder="כתוב תגובה..."></textarea>
    <div class="comment-actions">
      <button id="sendComment">שלח</button>
      <button id="cancelComment">ביטול</button>
    </div>
  </div>

  <button id="openComment" class="add-comment-btn">
    הוסף תגובה
  </button>

  <!-- תגובות -->
  <section class="comments">
    <h3>תגובות</h3>
    <div id="comments">
      <div class="loader"></div>
    </div>
  </section>

</main>

<script>
/* חסימה מיידית */
(function () {
  try {
    if (!window.AppInventor) location.replace("forbidden.html");
  } catch {
    location.replace("forbidden.html");
  }
})();

document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let currentUserName = "";
  let replyTo = null;

  const params = new URLSearchParams(location.search);
  const postId = params.get("postId");
  if (!postId) location.replace("forbidden.html");

  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch {
      return setTimeout(waitForPayload, 200);
    }
    login();
  }

  waitForPayload();

  function login() {
    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then(c => validate(c.user.uid, payload.token))
      .catch(() => location.replace("forbidden.html"));
  }

  function validate(uid, token) {
    firebase.database().ref("sessions/" + uid + "/token")
      .once("value")
      .then(snap => {
        if (!snap.exists() || snap.val() !== token)
          location.replace("forbidden.html");

        return firebase.database().ref("users/" + uid + "/username").once("value");
      })
      .then(snap => {
        currentUserName = snap.val() || "משתמש";
        loadPost();
        loadComments();
      });
  }

  function loadPost() {
    firebase.database().ref("posts/" + postId)
      .once("value")
      .then(snap => {
        const p = snap.val();
        document.getElementById("post").innerHTML = `
          <div class="post">
            <h3>${p.title}</h3>
            <p>${p.text}</p>
            <small>מאת: ${p.author}</small>
          </div>
        `;
      });
  }

  function loadComments() {
    firebase.database().ref("comments/" + postId)
      .once("value")
      .then(snap => {
        let arr = [];
        snap.forEach(s => arr.push({ id: s.key, ...s.val() }));
        arr.sort((a,b) => b.time - a.time);

        let html = "";

        arr.forEach(c => {
          const t = new Date(c.time).toLocaleTimeString("he-IL",{hour:'2-digit',minute:'2-digit'});

          let repliesHtml = "";
          if (c.replies) {
            Object.values(c.replies).forEach(r => {
              const rt = new Date(r.time).toLocaleTimeString("he-IL",{hour:'2-digit',minute:'2-digit'});
              repliesHtml += `
                <div class="reply">
                  <div class="comment-meta">
                    <span>${r.author}</span>
                    <span>${rt}</span>
                  </div>
                  <p>${r.text}</p>
                </div>
              `;
            });
          }

          html += `
            <div class="comment">
              <div class="comment-meta">
                <span class="comment-author">${c.author}</span>
                <span class="comment-time">${t}</span>
              </div>
              <p>${c.text}</p>
              <button class="reply-btn" onclick="reply('${c.id}')">השב</button>
              ${repliesHtml ? `<div class="replies">${repliesHtml}</div>` : ""}
            </div>
          `;
        });

        document.getElementById("comments").innerHTML =
          html || "<p>אין תגובות עדיין.</p>";
      });
  }

  /* קומפוזר */
  const openBtn = document.getElementById("openComment");
  const box = document.getElementById("commentComposer");
  const textarea = document.getElementById("commentText");

  window.reply = function(id) {
    replyTo = id;
    openComposer();
  };

  function openComposer() {
    box.classList.remove("hidden");
    openBtn.style.display = "none";
    textarea.focus();
  }

  openBtn.onclick = () => {
    replyTo = null;
    openComposer();
  };

  document.getElementById("cancelComment").onclick = () => {
    box.classList.add("hidden");
    openBtn.style.display = "block";
    textarea.value = "";
    replyTo = null;
  };

  document.getElementById("sendComment").onclick = () => {
    const text = textarea.value.trim();
    if (!text) return;

    const data = {
      text,
      author: currentUserName,
      time: Date.now()
    };

    const ref = replyTo
      ? firebase.database().ref(`comments/${postId}/${replyTo}/replies`)
      : firebase.database().ref(`comments/${postId}`);

    ref.push(data).then(() => {
      textarea.value = "";
      box.classList.add("hidden");
      openBtn.style.display = "block";
      replyTo = null;
      loadComments();
    });
  };

});
</script>

</body>
</html>