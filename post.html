<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בפוסט</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
  <link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>צפייה בפוסט</h1>
</header>

<main class="forum-container">

  <!-- פוסט -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <!-- קומפוזר תגובה (קבוע מעל התגובות) -->
  <div id="commentComposer" class="comment-composer hidden">
    <textarea id="commentText" placeholder="כתוב תגובה..."></textarea>
    <div class="comment-actions">
      <button id="sendComment" type="button">שלח</button>
      <button id="cancelComment" type="button">ביטול</button>
    </div>
  </div>

  <!-- תגובות -->
  <section class="comments">
    <h3>תגובות</h3>
    <div id="comments">
      <div class="loader"></div>
    </div>

    <button id="openComment" class="add-comment-btn">
      הוסף תגובה
    </button>
  </section>

</main>

<script>
/* חסימה מיידית – לא WebView */
(function () {
  try {
    if (!window.AppInventor) location.replace("forbidden.html");
  } catch {
    location.replace("forbidden.html");
  }
})();

document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let currentUid = "";
  let currentUserName = "";
  let replyTo = null;

  const params = new URLSearchParams(location.search);
  const postId = params.get("postId");
  if (!postId) location.replace("forbidden.html");

  /* קבלת payload מהאפליקציה */
  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch {
      return setTimeout(waitForPayload, 200);
    }
    login();
  }
  waitForPayload();

  /* Firebase Auth */
  function login() {
    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then(c => {
        currentUid = c.user.uid;
        validate(currentUid, payload.token);
      })
      .catch(() => location.replace("forbidden.html"));
  }

  /* אימות token + שליפת שם משתמש */
  function validate(uid, token) {
    firebase.database().ref("sessions/" + uid + "/token")
      .once("value")
      .then(snap => {
        if (!snap.exists() || snap.val() !== token)
          location.replace("forbidden.html");

        return firebase.database()
          .ref("users/" + uid + "/username")
          .once("value");
      })
      .then(snap => {
        currentUserName = snap.val() || "משתמש";
        loadPost();
        loadComments();
      })
      .catch(() => location.replace("forbidden.html"));
  }

  /* טעינת פוסט */
  function loadPost() {
    firebase.database().ref("posts/" + postId)
      .once("value")
      .then(snap => {
        const p = snap.val();
        document.getElementById("post").innerHTML = `
          <div class="post">
            <h3>${p.title}</h3>
            <p>${p.text}</p>
            <small>מאת: ${p.author}</small>
          </div>
        `;
      });
  }

  /* טעינת תגובות (חדש → ישן) */
  function loadComments() {
    firebase.database().ref("comments/" + postId)
      .once("value")
      .then(snap => {

        const list = [];
        snap.forEach(cSnap => {
          list.push({ id: cSnap.key, ...cSnap.val() });
        });

        list.reverse(); // חדש למעלה

        let html = "";

        list.forEach(c => {
          const d = new Date(c.time);
          const t =
            d.getHours().toString().padStart(2,"0") + ":" +
            d.getMinutes().toString().padStart(2,"0");

          html += `
            <div class="comment">
              <div class="comment-meta">
                <span class="comment-author">${c.author}</span>
                <span class="comment-time">${t}</span>
              </div>
              <p>${c.text}</p>
              <button class="reply-btn" data-id="${c.id}">השב</button>
              <div class="replies" id="replies-${c.id}"></div>
            </div>
          `;
        });

        document.getElementById("comments").innerHTML =
          html || "<p>אין תגובות עדיין.</p>";

        attachReplyHandlers();
      });
  }

  /* כפתור הוספת תגובה */
  const openBtn = document.getElementById("openComment");
  const composer = document.getElementById("commentComposer");
  const textarea = document.getElementById("commentText");

  openBtn.onclick = () => {
    replyTo = null;
    composer.classList.remove("hidden");
    openBtn.style.display = "none";
    textarea.focus();
  };

  document.getElementById("cancelComment").onclick = () => {
    composer.classList.add("hidden");
    openBtn.style.display = "block";
    textarea.value = "";
    replyTo = null;
  };

  /* שליחה */
  document.getElementById("sendComment").onclick = () => {
    const text = textarea.value.trim();
    if (!text) return;

    let ref;
    if (replyTo) {
      ref = firebase.database()
        .ref(`comments/${postId}/${replyTo}/replies`);
    } else {
      ref = firebase.database()
        .ref(`comments/${postId}`);
    }

    ref.push({
      text,
      author: currentUserName,
      time: Date.now()
    }).then(() => {
      textarea.value = "";
      composer.classList.add("hidden");
      openBtn.style.display = "block";
      replyTo = null;
      loadComments();
    });
  };

  /* Reply handlers */
  function attachReplyHandlers() {
    document.querySelectorAll(".reply-btn").forEach(btn => {
      btn.onclick = () => {
        replyTo = btn.dataset.id;
        composer.classList.remove("hidden");
        openBtn.style.display = "none";
        textarea.focus();
      };
    });
  }

});
</script>

</body>
</html>