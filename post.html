<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>爪驻 驻住</title>

  <!--  住 转 驻驻 专 -->
  <script>
    (function () {
      try {
        if (!window.AppInventor) {
          location.replace("forbidden.html");
        }
      } catch (e) {
        location.replace("forbidden.html");
      }
    })();
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- CSS ( 砖砖 ) -->
  <link rel="stylesheet" href="css/forum.css" />
  <link rel="stylesheet" href="css/post.css" />
</head>

<body>
  <header class="top-bar">
    <h1>爪驻 驻住</h1>
  </header>

  <main class="forum-container">
    <!-- 驻住 -->
    <div id="post">
      <div class="loader"></div>
    </div>

    <!-- 拽驻专 转 专砖转 -->
    <div id="mainComposer" class="composer hidden">
      <textarea id="mainText" placeholder="转 转..."></textarea>
      <div class="composer-actions">
        <button type="button" id="sendMainBtn">砖</button>
        <button type="button" id="closeMainBtn"></button>
      </div>
    </div>

    <!-- 驻转专 驻转转 拽驻专 -->
    <button id="openMain" class="add-comment-btn" type="button">住祝 转</button>

    <!-- 转转 -->
    <section class="comments">
      <h3>转转</h3>
      <div id="comments">
        <div class="loader"></div>
      </div>
    </section>
  </main>

  <script>
    /* ===============================
       Helpers
       =============================== */
    function escapeHTML(str = "") {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function userColor(key) {
      const colors = [
        "#60a5fa", // 
        "#34d399", // 专拽
        "#f472b6", // 专
        "#fbbf24", // 爪
        "#a78bfa", // 住
        "#fb7185", // 
        "#22d3ee"  // 专拽
      ];
      let hash = 0;
      const s = String(key || "");
      for (let i = 0; i < s.length; i++) {
        hash = s.charCodeAt(i) + ((hash << 5) - hash);
      }
      return colors[Math.abs(hash) % colors.length];
    }

    function fmtTime(ts) {
      try {
        return new Date(ts).toLocaleTimeString("he-IL", { hour: "2-digit", minute: "2-digit" });
      } catch {
        return "";
      }
    }

    /* ===============================
       Main
       =============================== */
    document.addEventListener("DOMContentLoaded", function () {
      const postContainer = document.getElementById("post");
      const commentsBox = document.getElementById("comments");

      const openMainBtn = document.getElementById("openMain");
      const mainComposer = document.getElementById("mainComposer");
      const mainText = document.getElementById("mainText");
      const sendMainBtn = document.getElementById("sendMainBtn");
      const closeMainBtn = document.getElementById("closeMainBtn");

      const postId = new URLSearchParams(location.search).get("postId");
      if (!postId) {
        location.replace("forbidden.html");
        return;
      }

      let payload = null;
      let uid = null;
      let username = "砖转砖";

      // 1) Wait payload from Kodular (WebViewString)
      function waitForPayload() {
        try {
          const raw = window.AppInventor.getWebViewString();
          if (!raw) return setTimeout(waitForPayload, 200);
          payload = JSON.parse(raw);
        } catch (e) {
          return setTimeout(waitForPayload, 200);
        }
        login();
      }

      // 2) Auth
      function login() {
        if (!payload || !payload.email || !payload.password || !payload.token) {
          location.replace("forbidden.html");
          return;
        }

        firebase.auth()
          .signInWithEmailAndPassword(payload.email, payload.password)
          .then((cred) => {
            uid = cred.user.uid;
            return validateToken(uid, payload.token);
          })
          .then(() => fetchUsername(uid))
          .then((name) => {
            username = name || "砖转砖";
            // After full auth+token+username
            loadPost();
            loadComments(); // stable ( live 专注)
          })
          .catch(() => {
            location.replace("forbidden.html");
          });
      }

      // 3) Token validation
      function validateToken(uid, token) {
        return firebase.database()
          .ref("sessions/" + uid + "/token")
          .once("value")
          .then((snap) => {
            if (!snap.exists() || snap.val() !== token) {
              location.replace("forbidden.html");
              throw new Error("invalid token");
            }
          });
      }

      // 4) Get real username
      function fetchUsername(uid) {
        return firebase.database()
          .ref("users/" + uid + "/username")
          .once("value")
          .then((snap) => snap.val());
      }

      // 5) Load post
      function loadPost() {
        firebase.database()
          .ref("posts/" + postId)
          .once("value")
          .then((snap) => {
            if (!snap.exists()) {
              postContainer.innerHTML = "<p>驻住  爪.</p>";
              return;
            }
            const p = snap.val();
            postContainer.innerHTML = `
              <div class="post">
                <h3>${escapeHTML(p.title || "")}</h3>
                <p>${escapeHTML(p.text || "")}</p>
                <small>转: ${escapeHTML(p.author || "")}</small>
              </div>
            `;
          })
          .catch(() => {
            postContainer.innerHTML = "<p>砖 注转 驻住.</p>";
          });
      }

      // 6) Load comments (newest -> oldest)
      function loadComments() {
        commentsBox.innerHTML = "<div class='loader'></div>";

        firebase.database()
          .ref("comments/" + postId)
          .orderByChild("time")
          .limitToLast(200)
          .once("value")
          .then((snap) => {
            const items = [];
            snap.forEach((cSnap) => {
              items.push({ id: cSnap.key, ...cSnap.val() });
            });

            // newest first
            items.sort((a, b) => (b.time || 0) - (a.time || 0));

            if (items.length === 0) {
              commentsBox.innerHTML = "<p> 转转 注.</p>";
              return;
            }

            let html = "";
            for (const c of items) {
              const color = userColor(c.author);
              html += `
                <div class="comment" style="border-right-color:${color}">
                  <div class="comment-meta">
                    <span class="comment-author">${escapeHTML(c.author || "")}</span>
                    <span class="comment-time">${escapeHTML(fmtTime(c.time))}</span>
                  </div>
                  <p>${escapeHTML(c.text || "")}</p>
                </div>
              `;
            }

            commentsBox.innerHTML = html;
          })
          .catch(() => {
            commentsBox.innerHTML = "<p>砖 注转 转转.</p>";
          });
      }

      // 7) Composer UI
      function openMain() {
        mainComposer.classList.remove("hidden");
        openMainBtn.style.display = "none";
        setTimeout(() => {
          mainText.focus();
          //  注 注 拽转 (WebView 驻注 爪专  驻注)
          mainComposer.scrollIntoView({ behavior: "smooth", block: "center" });
          setTimeout(() => mainComposer.scrollIntoView({ behavior: "smooth", block: "center" }), 250);
        }, 150);
      }

      function closeMain() {
        mainComposer.classList.add("hidden");
        openMainBtn.style.display = "block";
        mainText.value = "";
      }

      function sendMain() {
        const text = (mainText.value || "").trim();
        if (!text) return;

        // UI: disable to prevent double-send
        sendMainBtn.disabled = true;

        firebase.database()
          .ref("comments/" + postId)
          .push({
            text,
            author: username,
            time: Date.now()
          })
          .then(() => {
            closeMain();
            // reload list to show immediately (stable)
            loadComments();
          })
          .finally(() => {
            sendMainBtn.disabled = false;
          });
      }

      openMainBtn.addEventListener("click", openMain);
      closeMainBtn.addEventListener("click", closeMain);
      sendMainBtn.addEventListener("click", sendMain);

      // Start
      waitForPayload();
    });
  </script>
</body>
</html>