<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¦×¤×™×™×” ×‘×¤×•×¡×˜</title>

<!-- ğŸš« ×—×¡×™××” ××™×™×“×™×ª ×œ×“×¤×“×¤×Ÿ -->
<script>
(function(){
  try{
    if(!window.AppInventor){location.replace("forbidden.html")}
  }catch(e){location.replace("forbidden.html")}
})();
</script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="firebaseConfig.js"></script>

<link rel="stylesheet" href="css/forum.css">
<link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>×¦×¤×™×™×” ×‘×¤×•×¡×˜</h1>
</header>

<main class="forum-container">

  <!-- ×¤×•×¡×˜ -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <!-- ×§×•××¤×•×–×¨ ×¨××©×™ -->
  <div id="mainComposer" class="composer hidden">
    <textarea id="mainText" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
    <div class="composer-actions">
      <button onclick="sendMain()">×©×œ×—</button>
      <button onclick="closeMain()">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <button id="openMain" class="add-comment-btn">×”×•×¡×£ ×ª×’×•×‘×”</button>

  <!-- ×ª×’×•×‘×•×ª -->
  <section class="comments">
    <h3>×ª×’×•×‘×•×ª</h3>
    <div id="comments"></div>
  </section>

</main>

<script>
document.addEventListener("DOMContentLoaded",()=>{

let payload, uid, username;
const postId = new URLSearchParams(location.search).get("postId");
if(!postId) location.replace("forbidden.html");

/* ========= AUTH ========= */
function waitPayload(){
  try{
    const raw = window.AppInventor.getWebViewString();
    if(!raw) return setTimeout(waitPayload,200);
    payload = JSON.parse(raw);
  }catch{return setTimeout(waitPayload,200)}

  firebase.auth()
    .signInWithEmailAndPassword(payload.email,payload.password)
    .then(c=>{
      uid=c.user.uid;
      return firebase.database().ref("sessions/"+uid+"/token").once("value");
    })
    .then(s=>{
      if(!s.exists()||s.val()!==payload.token) location.replace("forbidden.html");
      return firebase.database().ref("users/"+uid+"/username").once("value");
    })
    .then(s=>{
      username=s.val()||"××©×ª××©";
      loadPost();
      listenComments();
    });
}
waitPayload();

/* ========= POST ========= */
function loadPost(){
 firebase.database().ref("posts/"+postId).once("value").then(s=>{
  const p=s.val();
  post.innerHTML=`
   <div class="post">
    <h3>${p.title}</h3>
    <p>${p.text}</p>
    <small>×××ª: ${p.author}</small>
   </div>`;
 });
}

/* ========= COMMENTS ========= */
const commentsBox=document.getElementById("comments");

function listenComments(){
 firebase.database().ref("comments/"+postId)
  .on("child_added",snap=>{
    renderComment(snap.key,snap.val());
  });
}

function renderComment(id, c) {
  const time = new Date(c.time).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});

  const div = document.createElement("div");
  div.className = "comment";

  div.innerHTML = `
    <div class="comment-meta">
      <span class="comment-author">${c.author}</span>
      <span class="comment-time">${time}</span>
    </div>

    <p>${c.text}</p>

    <div class="comment-actions-line">
      <button onclick="openReply('${id}')">×”×©×‘</button>
      <span class="reply-count" onclick="toggleReplies('${id}')">
        ×”×¦×’ ×ª×’×•×‘×•×ª â–¾
      </span>
    </div>

    <div class="replies hidden" id="replies-${id}"></div>
  `;

  commentsBox.appendChild(div);
}

/* ========= REPLIES ========= */
window.toggleReplies=(id)=>{
 const box=document.getElementById("replies-"+id);
 if(!box.classList.contains("hidden")){
  box.classList.add("hidden");return;
 }
 box.classList.remove("hidden");
 box.innerHTML="<div class='loader'></div>";

 firebase.database().ref("replies/"+postId+"/"+id)
  .once("value").then(s=>{
    let h="";
    s.forEach(r=>{
      const t=new Date(r.val().time)
        .toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
      h+=`
       <div class="reply">
        <b>${r.val().author}</b>
        <span>${t}</span>
        <p>${r.val().text}</p>
       </div>`;
    });
    box.innerHTML=h||"<small>××™×Ÿ ×ª×’×•×‘×•×ª</small>";
 });
};

/* ========= MAIN COMMENT ========= */
openMain.onclick=()=>{
 mainComposer.classList.remove("hidden");
 setTimeout(()=>{
  mainText.focus();
  mainComposer.scrollIntoView({block:"center"});
 },300);
};

window.closeMain=()=>{
 mainComposer.classList.add("hidden");
 mainText.value="";
};

window.sendMain=()=>{
 const text=mainText.value.trim();
 if(!text) return;
 firebase.database().ref("comments/"+postId).push({
  text,author:username,time:Date.now(),replyCount:0
 }).then(closeMain);
};

/* ========= REPLY ========= */
window.openReply=(id)=>{
 const box=document.getElementById("replies-"+id);
 box.classList.remove("hidden");
 box.innerHTML=`
  <textarea id="r-${id}" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
  <button onclick="sendReply('${id}')">×©×œ×—</button>`;
};

window.sendReply=(id)=>{
 const t=document.getElementById("r-"+id).value.trim();
 if(!t) return;
 firebase.database().ref("replies/"+postId+"/"+id).push({
  text:t,author:username,time:Date.now()
 });
 firebase.database().ref("comments/"+postId+"/"+id+"/replyCount")
  .transaction(n=>(n||0)+1);
 toggleReplies(id);
};

});
</script>

</body>
</html>