<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בפוסט</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
  <link rel="stylesheet" href="css/post.css">
</head>

<body>

<header class="top-bar">
  <h1>צפייה בפוסט</h1>
</header>

<main class="forum-container">

  <!-- פוסט -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <!-- אזור תגובה -->
  <section class="comments">

    <!-- קומפוזר תגובה -->
    <div id="composer" class="comment-box hidden">
      <textarea id="commentText" placeholder="כתוב תגובה..."></textarea>
      <div class="comment-actions">
        <button id="sendComment">שלח</button>
        <button id="cancelComment">ביטול</button>
      </div>
    </div>

    <button id="openComment" class="add-comment-btn">
      הוסף תגובה
    </button>

    <h3>תגובות</h3>

    <div id="comments">
      <div class="loader"></div>
    </div>

  </section>

</main>

<script>
/* ===============================
   חסימה מיידית – לא WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor) location.replace("forbidden.html");
  } catch {
    location.replace("forbidden.html");
  }
})();

document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let currentUid = "";
  let currentUserName = "";
  let isInitialLoad = true;
  const loadedComments = new Set();

  const params = new URLSearchParams(location.search);
  const postId = params.get("postId");
  if (!postId) location.replace("forbidden.html");

  /* ===============================
     קבלת payload
     =============================== */
  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch {
      return setTimeout(waitForPayload, 200);
    }
    login();
  }
  waitForPayload();

  /* ===============================
     Auth
     =============================== */
  function login() {
    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then(c => {
        currentUid = c.user.uid;
        return validate(currentUid, payload.token);
      })
      .catch(() => location.replace("forbidden.html"));
  }

  function validate(uid, token) {
    return firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then(snap => {
        if (!snap.exists() || snap.val() !== token)
          location.replace("forbidden.html");

        return firebase.database()
          .ref("users/" + uid + "/username")
          .once("value");
      })
      .then(snap => {
        currentUserName = snap.val() || "משתמש";
        loadPost();
        loadCommentsInitial();
      });
  }

  /* ===============================
     פוסט
     =============================== */
  function loadPost() {
    firebase.database()
      .ref("posts/" + postId)
      .once("value")
      .then(snap => {
        const p = snap.val();
        document.getElementById("post").innerHTML = `
          <div class="post">
            <h3>${p.title}</h3>
            <p>${p.text}</p>
            <small>מאת: ${p.author}</small>
          </div>
        `;
      });
  }

  /* ===============================
     טעינה ראשונית של תגובות
     =============================== */
  function loadCommentsInitial() {
    firebase.database()
      .ref("comments/" + postId)
      .orderByChild("time")
      .once("value")
      .then(snap => {
        let html = "";
        snap.forEach(cSnap => {
          loadedComments.add(cSnap.key);
          html = renderComment(cSnap.key, cSnap.val()) + html;
        });
        document.getElementById("comments").innerHTML =
          html || "<p>אין תגובות עדיין.</p>";

        isInitialLoad = false;
        listenForLiveComments();
      });
  }

  /* ===============================
     Live Update – תגובות חדשות
     =============================== */
  function listenForLiveComments() {
    firebase.database()
      .ref("comments/" + postId)
      .limitToLast(1)
      .on("child_added", snap => {

        if (isInitialLoad) return;
        if (loadedComments.has(snap.key)) return;

        loadedComments.add(snap.key);

        const container = document.getElementById("comments");
        const atTop = container.scrollTop < 50;

        const el = document.createElement("div");
        el.innerHTML = renderComment(snap.key, snap.val());

        container.prepend(el.firstElementChild);

        if (atTop) {
          container.scrollTop = 0;
        }
      });
  }

  /* ===============================
     רינדור תגובה
     =============================== */
  function renderComment(id, c) {
    const d = new Date(c.time);
    const t = d.getHours().toString().padStart(2,"0") + ":" +
              d.getMinutes().toString().padStart(2,"0");

    return `
      <div class="comment" data-id="${id}">
        <div class="comment-meta">
          <span class="comment-author">${c.author}</span>
          <span class="comment-time">${t}</span>
        </div>
        <p>${c.text}</p>
      </div>
    `;
  }

  /* ===============================
     UI – הוספת תגובה
     =============================== */
  const openBtn = document.getElementById("openComment");
  const box = document.getElementById("composer");
  const textarea = document.getElementById("commentText");

  openBtn.onclick = () => {
    box.classList.remove("hidden");
    openBtn.style.display = "none";

    setTimeout(() => {
      textarea.focus();
      box.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 150);
  };

  document.getElementById("cancelComment").onclick = () => {
    box.classList.add("hidden");
    openBtn.style.display = "block";
    textarea.value = "";
  };

  document.getElementById("sendComment").onclick = () => {
    const text = textarea.value.trim();
    if (!text) return;

    firebase.database()
      .ref("comments/" + postId)
      .push({
        text,
        author: currentUserName,
        time: Date.now()
      })
      .then(() => {
        textarea.value = "";
        box.classList.add("hidden");
        openBtn.style.display = "block";
      });
  };

});
</script>

</body>
</html>