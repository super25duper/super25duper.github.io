<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בפוסט</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <link rel="stylesheet" href="css/forum.css">
</head>

<body>

<header class="top-bar">
  <h1>צפייה בפוסט</h1>
</header>

<!-- Pull indicator -->
<div id="pull-indicator" style="display:none;text-align:center;padding:6px;">
  <div class="loader"></div>
</div>

<main class="forum-container">

  <!-- פוסט -->
  <div id="post">
    <div class="loader"></div>
  </div>

  <hr>

  <!-- תגובות -->
  <section class="comments">
    <h3>תגובות</h3>

    <div id="comments">
      <div class="loader"></div>
    </div>

    <!-- הוספת תגובה -->
    <div class="comment-form">
      <textarea id="commentText" placeholder="כתוב תגובה..."></textarea>
      <button id="sendComment">שלח תגובה</button>
    </div>
  </section>

</main>

<script>
/* ===============================
   חסימה מיידית – לא WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor) {
      window.location.replace("forbidden.html");
    }
  } catch (e) {
    window.location.replace("forbidden.html");
  }
})();

document.addEventListener("DOMContentLoaded", function () {

  let payload = null;
  let currentUID = null;
  let isRefreshing = false;

  /* ===============================
     חילוץ postId
     =============================== */
  const params = new URLSearchParams(window.location.search);
  const postId = params.get("postId");

  if (!postId) {
    window.location.replace("forbidden.html");
    return;
  }

  /* ===============================
     קבלת payload מקודולר
     =============================== */
  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) {
        setTimeout(waitForPayload, 200);
        return;
      }
      payload = JSON.parse(raw);
    } catch (e) {
      setTimeout(waitForPayload, 200);
      return;
    }
    loginToFirebase(payload);
  }

  waitForPayload();

  /* ===============================
     Firebase Auth
     =============================== */
  function loginToFirebase(data) {
    if (!data.email || !data.password || !data.token) {
      window.location.replace("forbidden.html");
      return;
    }

    firebase.auth()
      .signInWithEmailAndPassword(data.email, data.password)
      .then(function (cred) {
        currentUID = cred.user.uid;
        validateToken(currentUID, data.token);
      })
      .catch(function () {
        window.location.replace("forbidden.html");
      });
  }

  /* ===============================
     אימות token
     =============================== */
  function validateToken(uid, token) {
    firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then(function (snap) {
        if (!snap.exists() || snap.val() !== token) {
          window.location.replace("forbidden.html");
          return;
        }
        loadPost();
        loadComments();
      })
      .catch(function () {
        window.location.replace("forbidden.html");
      });
  }

  /* ===============================
     טעינת פוסט
     =============================== */
  function loadPost() {
    firebase.database()
      .ref("posts/" + postId)
      .once("value")
      .then(function (snap) {
        if (!snap.exists()) {
          document.getElementById("post").innerHTML = "<p>הפוסט לא נמצא.</p>";
          return;
        }

        const p = snap.val();
        document.getElementById("post").innerHTML = `
          <div class="post">
            <h3>${p.title || ""}</h3>
            <p>${p.text || ""}</p>
            <small>מאת: ${p.author || ""}</small>
          </div>
        `;
      });
  }

  /* ===============================
     טעינת תגובות
     =============================== */
  function loadComments() {
    firebase.database()
      .ref("comments/" + postId)
      .once("value")
      .then(function (snap) {
        let html = "";

        snap.forEach(function (cSnap) {
          const c = cSnap.val();
          html += `
            <div class="comment">
              <p>${c.text || ""}</p>
              <small>מאת: ${c.author || ""}</small>
            </div>
          `;
        });

        document.getElementById("comments").innerHTML =
          html || "<p>אין תגובות עדיין.</p>";
      });
  }

  /* ===============================
     שליחת תגובה
     =============================== */
  document.getElementById("sendComment").onclick = function () {
    const text = document.getElementById("commentText").value.trim();
    if (!text) return;

    const commentRef =
      firebase.database().ref("comments/" + postId).push();

    commentRef.set({
      text: text,
      author: payload.username || "משתמש",
      time: Date.now()
    }).then(function () {
      document.getElementById("commentText").value = "";
      loadComments();
    });
  };

  /* ===============================
     Pull To Refresh
     =============================== */
  let startY = 0;
  let pulling = false;
  const THRESHOLD = 90;
  const indicator = document.getElementById("pull-indicator");

  document.addEventListener("touchstart", function (e) {
    if (window.scrollY === 0 && !isRefreshing) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  });

  document.addEventListener("touchmove", function (e) {
    if (!pulling || isRefreshing) return;

    const diff = e.touches[0].clientY - startY;
    if (diff <= 0) return;

    indicator.style.display = "block";

    if (diff > THRESHOLD) {
      pulling = false;
      isRefreshing = true;

      loadPost();
      loadComments();

      setTimeout(function () {
        isRefreshing = false;
        indicator.style.display = "none";
      }, 400);
    }
  });

  document.addEventListener("touchend", function () {
    pulling = false;
    if (!isRefreshing) indicator.style.display = "none";
  });

});
</script>

</body>
</html>