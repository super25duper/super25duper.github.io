<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¦×¤×™×™×” ×‘×¤×•×¡×˜</title>

  <!-- ğŸš« ×—×¡×™××” ××™×™×“×™×ª ×œ×“×¤×“×¤×Ÿ ×¨×’×™×œ -->
  <script>
    (function () {
      try {
        if (!window.AppInventor) {
          location.replace("forbidden.html");
        }
      } catch (e) {
        location.replace("forbidden.html");
      }
    })();
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>

  <!-- CSS -->
  <link rel="stylesheet" href="css/forum.css" />
  <link rel="stylesheet" href="css/post.css" />
</head>

<body>

<header class="top-bar">
  <h1>×¦×¤×™×™×” ×‘×¤×•×¡×˜</h1>
</header>

<main class="forum-container">

  <!-- ×¤×•×¡×˜ -->
  <div id="post"></div>

  <!-- ×§×•××¤×•×–×¨ ×ª×’×•×‘×” ×¨××©×™×ª -->
  <div id="mainComposer" class="composer hidden">
    <textarea id="mainText" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
    <div class="composer-actions">
      <button type="button" id="sendMainBtn">×©×œ×—</button>
      <button type="button" id="closeMainBtn">×‘×™×˜×•×œ</button>
    </div>
  </div>

  <!-- ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ×§×•××¤×•×–×¨ -->
  <button id="openMain" class="add-comment-btn" type="button">
    ×”×•×¡×£ ×ª×’×•×‘×”
  </button>

  <!-- ×ª×’×•×‘×•×ª -->
  <section class="comments">
    <h3>×ª×’×•×‘×•×ª</h3>
    <div id="comments">
      <div class="loader"></div>
    </div>
  </section>

</main>

<script>
/* ===============================
   Helpers
   =============================== */
function escapeHTML(str = "") {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function userColor(key) {
  const colors = [
    "#60a5fa",
    "#34d399",
    "#f472b6",
    "#fbbf24",
    "#a78bfa",
    "#fb7185",
    "#22d3ee"
  ];
  let hash = 0;
  const s = String(key || "");
  for (let i = 0; i < s.length; i++) {
    hash = s.charCodeAt(i) + ((hash << 5) - hash);
  }
  return colors[Math.abs(hash) % colors.length];
}

function fmtTime(ts) {
  try {
    return new Date(ts).toLocaleTimeString("he-IL", {
      hour: "2-digit",
      minute: "2-digit"
    });
  } catch {
    return "";
  }
}

/* ===============================
   ×”×¦×’×ª ×¤×•×¡×˜ ××”Ö¾sessionStorage (×× ×§×™×™×)
   =============================== */
const cachedPost = sessionStorage.getItem("currentPost");

if (cachedPost) {
  try {
    const p = JSON.parse(cachedPost);
    document.getElementById("post").innerHTML = `
      <div class="post">
        <h3>${escapeHTML(p.title)}</h3>
        <p>${escapeHTML(p.text)}</p>
        <small>×××ª: ${escapeHTML(p.author)}</small>
      </div>
    `;
  } catch (e) {
    sessionStorage.removeItem("currentPost");
  }
}

/* ===============================
   Main
   =============================== */
document.addEventListener("DOMContentLoaded", function () {

  const postContainer = document.getElementById("post");
  const commentsBox = document.getElementById("comments");

  const openMainBtn = document.getElementById("openMain");
  const mainComposer = document.getElementById("mainComposer");
  const mainText = document.getElementById("mainText");
  const sendMainBtn = document.getElementById("sendMainBtn");
  const closeMainBtn = document.getElementById("closeMainBtn");

  const postId = new URLSearchParams(location.search).get("postId");
  if (!postId) {
    location.replace("forbidden.html");
    return;
  }

  let payload = null;
  let uid = null;
  let username = "××©×ª××©";

  /* ===============================
     1ï¸âƒ£ ×§×‘×œ×ª payload ××§×•×“×•×œ×¨
     =============================== */
  function waitForPayload() {
    try {
      const raw = window.AppInventor.getWebViewString();
      if (!raw) return setTimeout(waitForPayload, 200);
      payload = JSON.parse(raw);
    } catch (e) {
      return setTimeout(waitForPayload, 200);
    }
    login();
  }

  /* ===============================
     2ï¸âƒ£ ×”×ª×—×‘×¨×•×ª
     =============================== */
  function login() {
    if (!payload || !payload.email || !payload.password || !payload.token) {
      location.replace("forbidden.html");
      return;
    }

    firebase.auth()
      .signInWithEmailAndPassword(payload.email, payload.password)
      .then((cred) => {
        uid = cred.user.uid;
        return validateToken(uid, payload.token);
      })
      .then(() => fetchUsername(uid))
      .then((name) => {
        username = name || "××©×ª××©";

        if (!sessionStorage.getItem("currentPost")) {
          loadPost();
        }

        loadComments();
      })
      .catch(() => {
        location.replace("forbidden.html");
      });
  }

  function validateToken(uid, token) {
    return firebase.database()
      .ref("sessions/" + uid + "/token")
      .once("value")
      .then((snap) => {
        if (!snap.exists() || snap.val() !== token) {
          location.replace("forbidden.html");
          throw new Error("invalid token");
        }
      });
  }

  function fetchUsername(uid) {
    return firebase.database()
      .ref("users/" + uid + "/username")
      .once("value")
      .then((snap) => snap.val());
  }

  function loadPost() {
    firebase.database()
      .ref("posts/" + postId)
      .once("value")
      .then((snap) => {
        if (!snap.exists()) {
          postContainer.innerHTML = "<p>×”×¤×•×¡×˜ ×œ× × ××¦×.</p>";
          return;
        }
        const p = snap.val();
        postContainer.innerHTML = `
          <div class="post">
            <h3>${escapeHTML(p.title || "")}</h3>
            <p>${escapeHTML(p.text || "")}</p>
            <small>×××ª: ${escapeHTML(p.author || "")}</small>
          </div>
        `;
      });
  }

  function loadComments() {
    commentsBox.innerHTML = "<div class='loader'></div>";

    firebase.database()
      .ref("comments/" + postId)
      .orderByChild("time")
      .limitToLast(200)
      .once("value")
      .then((snap) => {
        const items = [];
        snap.forEach((cSnap) => {
          items.push({ id: cSnap.key, ...cSnap.val() });
        });

        items.sort((a, b) => (b.time || 0) - (a.time || 0));

        commentsBox.innerHTML = "";

        items.forEach(c => renderComment(c.id, c));
      });
  }

  function renderComment(id, c) {
    const color = userColor(c.author);

    const div = document.createElement("div");
    div.className = "comment";
    div.style.borderRightColor = color;

    div.innerHTML = `
      <div class="comment-meta">
        <span class="comment-author">${escapeHTML(c.author)}</span>
        <span class="comment-time">${fmtTime(c.time)}</span>
      </div>
      <p>${escapeHTML(c.text)}</p>

      <!-- === START replies feature === -->
      <div class="comment-actions">
        <button onclick="openReply('${id}')">×”×©×‘</button>
        <span id="reply-count-${id}" onclick="toggleReplies('${id}')">×˜×•×¢×Ÿ ×ª×’×•×‘×•×ªâ€¦</span>
      </div>
      <div class="replies hidden" id="replies-${id}"></div>
      <!-- === END replies feature === -->
    `;

    commentsBox.appendChild(div);

    updateReplyCount(id);
  }

  /* === START replies feature === */

  window.updateReplyCount = function (id) {
    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .once("value")
      .then(s => {
        const el = document.getElementById("reply-count-" + id);
        const count = s.numChildren();
        el.textContent = count ? `${count} ×ª×’×•×‘×•×ª â–¾` : "××™×Ÿ ×ª×’×•×‘×•×ª";
      });
  };

  window.toggleReplies = function (id) {
    const box = document.getElementById("replies-" + id);
    if (!box.classList.contains("hidden")) {
      box.classList.add("hidden");
      return;
    }

    box.classList.remove("hidden");
    box.innerHTML = "";

    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .once("value")
      .then(s => {
        s.forEach(r => {
          const d = r.val();
          box.innerHTML += `
            <div class="reply">
              <b>${escapeHTML(d.author)}</b>
              <small>${fmtTime(d.time)}</small>
              <p>${escapeHTML(d.text)}</p>
            </div>
          `;
        });
      });
  };

  window.openReply = function (id) {
    const box = document.getElementById("replies-" + id);
    box.classList.remove("hidden");
    box.innerHTML = `
      <textarea id="reply-text-${id}" placeholder="×›×ª×•×‘ ×ª×’×•×‘×”..."></textarea>
      <button onclick="sendReply('${id}')">×©×œ×—</button>
    `;
  };

  window.sendReply = function (id) {
    const ta = document.getElementById("reply-text-" + id);
    if (!ta.value.trim()) return;

    firebase.database()
      .ref("replies/" + postId + "/" + id)
      .push({
        text: ta.value,
        author: username,
        time: Date.now()
      })
      .then(() => {
        updateReplyCount(id);
        toggleReplies(id);
      });
  };

  /* === END replies feature === */

  openMainBtn.addEventListener("click", openMain);
  closeMainBtn.addEventListener("click", closeMain);
  sendMainBtn.addEventListener("click", sendMain);

  function openMain() {
    mainComposer.classList.remove("hidden");
    openMainBtn.style.display = "none";
    mainText.focus();
  }

  function closeMain() {
    mainComposer.classList.add("hidden");
    openMainBtn.style.display = "block";
    mainText.value = "";
  }

  function sendMain() {
    if (!mainText.value.trim()) return;

    firebase.database()
      .ref("comments/" + postId)
      .push({
        text: mainText.value,
        author: username,
        time: Date.now()
      })
      .then(() => {
        closeMain();
        loadComments();
      });
  }

  waitForPayload();
});
</script>

</body>
</html>