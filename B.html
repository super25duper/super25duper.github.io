<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>×”×ª×¨××•×ª ×¤×•×¨×•×</title>
  <link rel="icon" href="icons/forum-192.png" type="image/png">
  <link rel="manifest" href="manifest.json">

  <style>
    body {
      font-family: Arial;
      direction: rtl;
      text-align: center;
      margin-top: 40px;
    }
    input, button {
      padding: 8px;
      margin: 6px;
      width: 220px;
    }
    #appBox {
      display: none;
    }
  </style>
</head>
<body>

<h2>××¢×¨×›×ª ×”×ª×¨××•×ª</h2>

<!-- ×”×ª×—×‘×¨×•×ª -->
<div id="loginBox">
  <h3>×”×ª×—×‘×¨×•×ª</h3>
  <input id="username" placeholder="×©× ××©×ª××©">
  <input id="password" type="password" placeholder="×¡×™×¡××”">
  <br>
  <button id="login">×”×ª×—×‘×¨</button>
</div>

<!-- ××¤×œ×™×§×¦×™×” -->
<div id="appBox">
  <p id="userInfo"></p>
  <button id="enable">×”×¤×¢×œ ×”×ª×¨××•×ª</button>
  <br><br>
  <button id="logout">×”×ª× ×ª×§</button>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-messaging.js"></script>

<!-- firebaseconfig.js ×©×œ×š -->
<script src="firebaseConfig.js"></script>

<script>
  /* ===============================
   ×—×¡×™××” ××™×™×“×™×ª â€“ ×œ× WebView
   =============================== */
(function () {
  try {
    if (!window.AppInventor || typeof window.AppInventor.getWebViewString !== "function") {
      location.replace("forbidden.html");
      return;
    }
  } catch (e) {
    location.replace("forbidden.html");
    return;
  }
})();
  // Firebase services
  const auth = firebase.auth();
  const messaging = firebase.messaging();

  // ×©×™× ×•×™ ××¦×‘ ×œ×¤×™ ×”×ª×—×‘×¨×•×ª
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById("loginBox").style.display = "none";
      document.getElementById("appBox").style.display = "block";
      const name = user.email.split("@")[0];
      document.getElementById("userInfo").innerText =
        "××—×•×‘×¨ ×›Ö¾" + name;
    } else {
      document.getElementById("loginBox").style.display = "block";
      document.getElementById("appBox").style.display = "none";
    }
  });

  // ×”×ª×—×‘×¨×•×ª
  document.getElementById("login").onclick = async () => {
    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value;

    if (!username || !password) {
      alert("× × ×œ××œ× ×©× ××©×ª××© ×•×¡×™×¡××”");
      return;
    }

    const email = username + "@forum.local";

    try {
      await auth.signInWithEmailAndPassword(email, password);
    } catch (err) {
      alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª");
      console.error(err);
    }
  };

  // ×”×ª× ×ª×§×•×ª
  document.getElementById("logout").onclick = () => {
    auth.signOut();
  };

  // ×”×¤×¢×œ×ª ×”×ª×¨××•×ª
  document.getElementById("enable").onclick = async () => {
    const user = auth.currentUser;
    if (!user) {
      alert("×œ× ××—×•×‘×¨");
      return;
    }

    if (!("Notification" in window)) {
      alert("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª");
      return;
    }

    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("××™×Ÿ ×”×¨×©××” ×œ×”×ª×¨××•×ª");
      return;
    }

    const registration = await navigator.serviceWorker.register(
      "/firebase-messaging-sw.js"
    );

    const token = await messaging.getToken({
      vapidKey: "BCEbyZAb3xoWiC4QBcKLv0iZmWLxrJRcYyZD6B4ASDmYCeYdySqMwSGF534Y2v-3eBg5S8StsSb5tB4qTRYkXRk",
      serviceWorkerRegistration: registration
    });

    console.log("FCM TOKEN:", token);

    await db.ref(`userTokens/${user.uid}/tokens/${token}`).set({
      createdAt: Date.now()
    });

    alert("×”×ª×¨××•×ª ×”×•×¤×¢×œ×• ×‘×”×¦×œ×—×” ğŸ‰");
  };
</script>

</body>
</html>
